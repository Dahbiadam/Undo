<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>UNDO ‚Äì Habit Tracker</title>
<meta name="description" content="UNDO - Quit Bad, Build Good. Track and improve your habits."/>
<style>
  :root {
    --bg:#f8fafc; 
    --card:#ffffff; 
    --text:#0f1724; 
    --muted:#6b7280; 
    --border:#e6e7ea;
    --accent-from:#7c3aed; 
    --accent-to:#ec4899;
    --green-from:#10b981; 
    --green-to:#059669; 
    --danger:#ef4444;
    --radius: 16px;
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
  }
  
  .dark {
    --bg:#0b1220; 
    --card:#0f1724; 
    --text:#ffffff; 
    --muted:#94a3b8; 
    --border:#22303b;
    --shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  
  html {
    height: 100%;
    font-size: 16px;
  }
  
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    line-height: 1.5;
    min-height: 100vh;
    transition: background-color 0.5s, color 0.3s;
  }
  
  .wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
  }
  
  .card {
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: all 0.3s;
  }
  
  h1, h2, h3 {
    margin: 0;
    font-weight: 800;
  }
  
  .muted {
    color: var(--muted);
  }
  
  .small {
    font-size: 0.875rem;
  }
  
  .heading {
    font-weight: 800;
  }
  
  .btn {
    cursor: pointer;
    border: 0;
    padding: 0.75rem 1rem;
    border-radius: calc(var(--radius) - 4px);
    font-weight: 600;
    font-size: 0.9375rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s;
  }
  
  .btn:active {
    transform: scale(0.98);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--accent-from), var(--accent-to));
    color: white;
  }
  
  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
  }
  
  .btn-danger {
    background: var(--danger);
    color: white;
  }
  
  .btn-success {
    background: linear-gradient(135deg, var(--green-from), var(--green-to));
    color: white;
  }
  
  .btn-wide {
    width: 100%;
  }
  
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  input, select, textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: calc(var(--radius) - 4px);
    border: 2px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent-from);
  }
  
  textarea {
    min-height: 100px;
    resize: vertical;
  }
  
  .flex {
    display: flex;
  }
  
  .grid {
    display: grid;
  }
  
  .gap-4 {
    gap: 1rem;
  }
  
  .mb-4 {
    margin-bottom: 1rem;
  }
  
  .dotbar {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1rem;
  }
  
  .dot {
    height: 0.5rem;
    border-radius: 999px;
    background: #e5e7eb;
    width: 0.5rem;
    transition: all 0.3s;
  }
  
  .dot.active {
    width: 2rem;
    background: linear-gradient(90deg, var(--accent-from), var(--accent-to));
  }
  
  header.appbar {
    position: sticky;
    top: 0;
    z-index: 40;
    padding: 1rem 0;
    background: var(--card);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border);
    box-shadow: var(--shadow);
  }
  
  .notif {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    top: 1rem;
    z-index: 80;
    background: linear-gradient(135deg, var(--accent-from), var(--accent-to));
    color: white;
    padding: 1rem 1.5rem;
    border-radius: var(--radius);
    font-weight: 600;
    box-shadow: var(--shadow);
    opacity: 0;
    transition: opacity 0.3s;
    max-width: 90%;
    text-align: center;
  }
  
  .notif.show {
    opacity: 1;
    animation: bounce 0.5s;
  }
  
  @keyframes bounce {
    0%, 100% { transform: translateX(-50%) translateY(0); }
    50% { transform: translateX(-50%) translateY(-10px); }
  }
  
  .welcome-wrap {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    padding: 1.5rem;
  }
  
  .options-list button {
    display: block;
    width: 100%;
    text-align: left;
    padding: 1rem;
    border-radius: calc(var(--radius) - 4px);
    border: 2px solid var(--border);
    background: transparent;
    color: var(--text);
    margin-bottom: 0.75rem;
    font-weight: 600;
    transition: all 0.2s;
    font-size: 1rem;
  }
  
  .options-list button:hover {
    border-color: var(--accent-from);
    transform: translateX(4px);
  }
  
  .cols {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }
  
  @media (min-width: 992px) {
    .cols {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  .habit-card {
    padding: 1.5rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-bottom: 1.25rem;
    box-shadow: var(--shadow);
  }
  
  .green-panel {
    background: linear-gradient(135deg, var(--green-from), var(--green-to));
    color: white;
    padding: 1.5rem;
    border-radius: calc(var(--radius) - 4px);
    text-align: center;
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 0.375rem;
  }
  
  .day {
    aspect-ratio: 1/1;
    border-radius: 4px;
    background: var(--border);
    transition: all 0.2s;
  }
  
  .day.done {
    background: var(--green-from);
  }
  
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.25rem;
    z-index: 60;
    opacity: 0;
    transition: opacity 0.3s;
  }
  
  .modal-overlay.show {
    opacity: 1;
  }
  
  .modal {
    max-width: 640px;
    width: 100%;
    background: var(--card);
    padding: 1.5rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    transform: scale(0.95);
    opacity: 0;
    transition: all 0.3s;
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .modal.show {
    transform: scale(1);
    opacity: 1;
  }
  
  .breath-circle {
    width: 260px;
    height: 260px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
    margin: 0 auto 2rem;
    border: 12px solid rgba(102, 126, 234, 0.2);
  }
  
  .breath-circle.inhale {
    animation: breatheIn 4s ease-in-out;
  }
  
  .breath-circle.exhale {
    animation: breatheOut 4s ease-in-out;
  }

  @keyframes breatheIn {
    0% { transform: scale(1); border-color: rgba(102, 126, 234, 0.2); }
    100% { transform: scale(1.15); border-color: rgba(59, 130, 246, 0.4); box-shadow: 0 25px 70px rgba(59, 130, 246, 0.5); }
  }

  @keyframes breatheOut {
    0% { transform: scale(1.15); border-color: rgba(59, 130, 246, 0.4); }
    100% { transform: scale(0.9); border-color: rgba(147, 197, 253, 0.3); box-shadow: 0 15px 40px rgba(147, 197, 253, 0.3); }
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .spin {
    animation: spin 1s linear infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  .stat-box {
    padding: 1rem;
    border-radius: 12px;
    text-align: center;
  }
  
  .stat-box.yellow {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
  }
  
  .stat-box.orange {
    background: linear-gradient(135deg, #fed7aa, #fdba74);
  }
  
  .stat-box.red {
    background: linear-gradient(135deg, #fecaca, #fca5a5);
  }
  
  .dark .stat-box {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.25rem;
  }
  
  .section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  @media (max-width: 640px) {
    :root {
      --radius: 12px;
    }
    
    .breath-circle {
      width: 200px;
      height: 200px;
    }
    
    .modal {
      padding: 1rem;
    }
    
    .welcome-wrap {
      padding: 1rem;
    }
    
    .habit-card {
      padding: 1rem;
    }
    
    .btn {
      padding: 0.625rem 0.875rem;
    }
    
    input, select, textarea {
      padding: 0.625rem 0.875rem;
    }
    
    .calendar-grid {
      gap: 0.25rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    *,
    ::before,
    ::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

@media (max-width: 640px) {
  #header-buttons { display:none !important; }
  #btn-burger { display:inline-flex !important; }
}

#mobile-menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,0.9);
  display: none;
  z-index: 120;
  align-items: center;
  justify-content: center;
  color: white;
}
#mobile-menu-overlay.show { display:flex; }

#mobile-menu-overlay .menu-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
  text-align: center;
  font-size: 2rem;
}

#emergency-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, rgba(220,38,38,0.98), rgba(153,27,27,0.95));
  display: none;
  z-index: 200;
  color: white;
  align-items: center;
  justify-content: center;
  padding: 1.25rem;
}
#emergency-overlay.show { display:flex; }
.emergency-card {
  width: 100%;
  max-width: 720px;
  text-align: center;
  border-radius: 18px;
  padding: 1.5rem;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(239,68,68,0.45);
  border: 1px solid rgba(255,255,255,0.06);
}
.emergency-head { font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; margin-bottom: 0.5rem; }
.emergency-sub { font-size: 1.25rem; margin-bottom: 1rem; opacity:0.95; }

#emergency-video {
  width: 100%;
  height: 360px;
  max-height: 60vh;
  background: black;
  border-radius: 12px;
  object-fit: cover;
  border: 4px solid rgba(0,0,0,0.2);
}

.emergency-actions { display:flex; gap:1rem; margin-top:1rem; justify-content:center; flex-wrap:wrap; }
.btn-emergency { padding:1rem 1.25rem; border-radius:12px; font-size:1.125rem; font-weight:800; min-width:160px; }
.btn-done { background: linear-gradient(90deg, #10b981, #059669); color:white; }
.btn-relapsed { background: linear-gradient(90deg, #ef4444, #dc2626); color:white; }

#coach-text { font-size:1.125rem; min-height:60px; margin-top:1rem; font-weight:700; }
.typing { display:inline-block; }

#camera-fallback { width:100%; height:360px; background:black; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; opacity:1; }

.emergency-card .btn-relapsed:hover { box-shadow: 0 8px 30px rgba(255,0,0,0.35); transform:translateY(-2px); }
.emergency-card .btn-emergency:hover { box-shadow: 0 8px 30px rgba(255,255,255,0.06); transform:translateY(-2px); }

</style>
</head>
<body>
<div id="app">
  <div id="notification" class="notif" role="alert" aria-live="polite"></div>

  <header class="appbar" role="banner" id="main-header" style="display:none">
    <div class="wrap">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div>
          <h1 class="flex heading" style="align-items:center;gap:0.625rem;font-size:1.75rem">
            <span>UNDO</span>
          </h1>
          <div id="greeting" class="small muted">Hey Friend!</div>
        </div>
        <div class="flex" style="gap:0.5rem;align-items:center">
          <button id="btn-burger" class="btn btn-ghost" title="Menu" aria-label="Open menu" style="display:none;font-size:1.25rem">‚ò∞</button>
          <div id="header-buttons" style="display:flex;gap:0.5rem;align-items:center">
            <button id="btn-home" class="btn btn-ghost" title="Go Home">üè†</button>
            <button id="btn-breathe" class="btn btn-ghost" title="Breathing Exercise" aria-label="Open breathing exercise">üå¨Ô∏è</button>
            <button id="btn-why" class="btn btn-ghost" title="Why I Relapsed">üìù</button>
            <button id="btn-analytics" class="btn btn-ghost" title="Analytics">üìä</button>
            <button id="btn-dark" class="btn btn-ghost" title="Toggle Light/Dark Mode" aria-pressed="false">‚òÄÔ∏è</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:1.5rem">
    <section id="welcome" class="welcome-wrap">
      <div class="card" style="max-width:760px;padding:2rem;width:100%">
        <div id="welcome-loading" style="display:none;text-align:center">
          <div class="spin" style="width:4rem;height:4rem;border-radius:999px;border:0.375rem solid rgba(124, 58, 237, 0.2);border-top-color:var(--accent-from);margin:0 auto 1.5rem"></div>
          <div id="loading-text" class="heading" style="font-size:1.25rem;animation:pulse 2s infinite"></div>
        </div>

        <div id="welcome-content">
          <div style="text-align:center;margin-bottom:2rem">
            <div style="font-size:4rem;margin-bottom:0.5rem">‚Ü©Ô∏è</div>
            <h2 class="heading" style="font-size:2.5rem;margin:0.5rem 0">UNDO</h2>
            <div class="small muted" style="font-size:1.125rem">Quit Bad. Build Good.</div>
          </div>

          <div id="question-wrap" class="flex" style="flex-direction:column;gap:1rem">
            <div>
              <p id="q-text" class="heading" style="font-size:1.5rem;margin-bottom:1rem">What's your name?</p>
              <div id="q-input-wrap"></div>
            </div>

            <div class="flex" style="gap:0.75rem">
              <button id="btn-back-question" class="btn btn-ghost" style="flex:1;display:none">Back</button>
              <button id="btn-next-question" class="btn btn-primary" style="flex:1">Continue</button>
            </div>

            <div id="dotbar" class="dotbar"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="app-main" style="display:none">
      <div id="dashboard-view">
        <div class="cols">
          <div>
            <div class="section-header">
              <div class="section-title">
                <div style="font-size:1.5rem;color:var(--danger)">‚ùå</div>
                <div>
                  <div class="heading" style="font-size:1.5rem">Quit Habits (<span id="quit-count">0</span>)</div>
                  <div class="small muted">Track what you want to stop</div>
                </div>
              </div>
              <button id="add-quit" class="btn btn-danger">+ Add</button>
            </div>
            <div id="quit-list"></div>
          </div>

          <div>
            <div class="section-header">
              <div class="section-title">
                <div style="font-size:1.5rem;color:var(--green-from)">‚úÖ</div>
                <div>
                  <div class="heading" style="font-size:1.5rem">Build Habits (<span id="build-count">0</span>)</div>
                  <div class="small muted">Habits to build</div>
                </div>
              </div>
              <button id="add-build" class="btn btn-success">+ Add</button>
            </div>
            <div id="build-list"></div>
          </div>
        </div>
      </div>

      <div id="analytics-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üìä</span>
          Analytics
        </h2>
        <div id="analytics-content"></div>
      </div>

      <div id="why-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üìù</span>
          Why I Relapsed
        </h2>
        <div id="why-list"></div>
      </div>
    </section>
  </main>

  <div id="add-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:1.5rem">
        <h3 class="heading" id="add-title" style="font-size:1.5rem">Add Habit</h3>
        <button id="close-add" class="btn btn-ghost" style="padding:0.5rem">‚úï</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <label class="small" for="add-name" style="display:block;margin-bottom:0.5rem;font-weight:600">Habit Name</label>
          <input id="add-name" placeholder="e.g., Smoking" />
        </div>
        <div id="add-category-wrap">
          <label class="small" style="display:block;margin-bottom:0.75rem;font-weight:600">Choose Category</label>
          <div id="add-category-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem"></div>
        </div>
        <div id="add-lasttime-wrap">
          <label class="small" style="display:block;margin-bottom:0.5rem;font-weight:600">Last time you did it</label>
          <input id="add-startdate" type="datetime-local" />
        </div>
        <div id="add-dailygoal-wrap" style="display:none">
          <label class="small" for="add-dailygoal" style="display:block;margin-bottom:0.5rem;font-weight:600">Daily Goal</label>
          <input id="add-dailygoal" type="number" min="1" max="100" value="1" />
          <div id="goal-unit" class="small muted" style="margin-top:0.25rem"></div>
        </div>
        <div id="add-custom-unit-wrap" style="display:none">
          <label class="small" for="add-custom-unit" style="display:block;margin-bottom:0.5rem;font-weight:600">Unit Type</label>
          <select id="add-custom-unit">
            <option value="times">Times</option>
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
            <option value="cups">Cups</option>
            <option value="glasses">Glasses</option>
            <option value="meals">Meals</option>
            <option value="pages">Pages</option>
            <option value="kg">Kilograms</option>
            <option value="lbs">Pounds</option>
          </select>
        </div>
        <div class="flex" style="gap:0.75rem;margin-top:0.5rem">
          <button id="cancel-add" class="btn btn-ghost" style="flex:1">Cancel</button>
          <button id="confirm-add" class="btn btn-primary" style="flex:1">Add Habit</button>
        </div>
      </div>
    </div>
  </div>

  <div id="relapse-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="align-items:center;gap:0.75rem;margin-bottom:1.5rem">
        <span style="font-size:2rem;color:var(--danger)">‚ö†Ô∏è</span>
        <h3 class="heading" style="font-size:1.5rem">Relapse</h3>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div class="flex" style="gap:0.75rem;align-items:center">
          <div id="relapse-emoji" style="font-size:2.5rem">üö¨</div>
          <div>
            <div id="relapse-name" class="heading" style="font-size:1.25rem">Smoking</div>
            <div id="relapse-since" class="small muted">You were clean for 0d</div>
          </div>
        </div>
        <div>
          <label class="small" for="relapse-note" style="display:block;margin-bottom:0.5rem;font-weight:600">What happened? Learning from this makes you stronger.</label>
          <textarea id="relapse-note" placeholder="What triggered it? How were you feeling? What can you do differently?"></textarea>
        </div>
        <div class="flex" style="gap:0.75rem">
          <button id="relapse-cancel" class="btn btn-ghost" style="flex:1">Cancel</button>
          <button id="relapse-confirm" class="btn btn-danger" style="flex:1">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <div id="breath-modal" class="modal-overlay" style="display:none;overflow-y:auto">
    <div class="modal card">
      <div id="breath-inner"></div>
    </div>
  </div>

  <div id="mobile-menu-overlay" role="dialog" aria-hidden="true">
    <div class="menu-grid">
      <button class="btn btn-ghost" id="m-btn-home" title="Go Home">üè†</button>
      <button class="btn btn-ghost" id="m-btn-breathe" title="Breathing">üå¨Ô∏è</button>
      <button class="btn btn-ghost" id="m-btn-why" title="Why">üìù</button>
      <button class="btn btn-ghost" id="m-btn-analytics" title="Analytics">üìä</button>
      <button class="btn btn-ghost" id="m-btn-dark" title="Toggle Mode">‚òÄÔ∏è</button>
     </div>
  </div>

  <div id="emergency-overlay" role="alert" aria-hidden="true">
    <div class="emergency-card">
      <div class="emergency-head">YOU CAN DO IT</div>
      <div class="emergency-sub">You are stronger than your urges. Look at yourself ‚Äî you got this.</div>
      <div id="video-wrap" style="margin-bottom:1rem; position: relative;">
        <video id="emergency-video" autoplay muted playsinline></video>
        <div id="camera-fallback" style="display:none">Camera access denied</div>
      </div>
      <div id="coach-text"><span id="coach-line" class="typing"></span></div>
      <div class="emergency-actions">
        <button id="emergency-done" class="btn btn-emergency btn-done">‚úÖ I Did It</button>
        <button id="emergency-relapse" class="btn btn-emergency btn-relapsed">‚ùå I Relapsed</button>
      </div>
      <div style="margin-top:1rem;font-size:0.875rem;color:rgba(255,255,255,0.85)">Camera will help you see yourself and stay strong</div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const QUESTIONS = [
    { q: "What's your name?", placeholder: "Your name", type: "text" },
    { q: "What habit do you want to quit?", type: "select", options: [
      { label: "üö¨ Smoking", value: "Smoking" },
      { label: "üç∫ Drinking", value: "Drinking" },
      { label: "üç≠ Sugar/Sweets", value: "Sugar" },
      { label: "üì± Social Media", value: "Social Media" },
      { label: "‚è∞ Procrastination", value: "Procrastination" },
      { label: "üîû Porn", value: "Porn" },
      { label: "üéÆ Gaming", value: "Gaming" },
      { label: "üõçÔ∏è Shopping", value: "Shopping" },
      { label: "‚òï Caffeine", value: "Caffeine" },
      { label: "üì∫ TV/Netflix", value: "TV" },
      { label: "‚≠ê Other", value: "Other" }
    ]},
    { q: "What new habit would you like to build?", type: "select", options: [
      { label: "üí™ Exercise", value: "Exercise" },
      { label: "üìö Reading", value: "Reading" },
      { label: "üßò Meditation", value: "Meditation" },
      { label: "üíß Drink Water", value: "Water" },
      { label: "üò¥ Sleep Better", value: "Sleep" },
      { label: "üé® Creative Work", value: "Creative" },
      { label: "üå± Healthy Eating", value: "Healthy Eating" },
      { label: "üìù Journaling", value: "Journaling" },
      { label: "‚≠ê Other", value: "Other" }
    ]},
    { q: "Why do you want to change?", placeholder: "Tell us your motivation...", type: "text" },
    { q: "How old are you?", placeholder: "Your age", type: "number" }
  ];

  const LOADING_MESSAGES = [
    "Preparing your unique UNDO plan...",
    "Analyzing your motivation...",
    "Calibrating your journey path...",
    "Creating your personalized experience...",
    "Almost ready..."
  ];

  const HABIT_ICONS = {
    smoking: 'üö¨', drinking:'üç∫', sugar:'üç≠', social_media:'üì±', procrastination:'‚è∞',
    porn:'üîû', exercise:'üí™', reading:'üìö', meditation:'üßò', water:'üíß',
    sleep:'üò¥', gaming:'üéÆ', shopping:'üõçÔ∏è', caffeine:'‚òï', tv:'üì∫', 
    other:'‚≠ê', healthy_eating:'üå±', healthy:'üå±', creative:'üé®', journaling:'üìù'
  };

  const CATEGORY_UNITS = {
    exercise: { default: 30, unit: 'minutes', max: 300 },
    reading: { default: 30, unit: 'minutes', max: 300 },
    meditation: { default: 10, unit: 'minutes', max: 120 },
    water: { default: 8, unit: 'cups', max: 20 },
    sleep: { default: 8, unit: 'hours', max: 12 },
    creative: { default: 30, unit: 'minutes', max: 300 },
    healthy_eating: { default: 3, unit: 'meals', max: 10 },
    journaling: { default: 15, unit: 'minutes', max: 120 },
    other: { default: 1, unit: 'custom', max: 100 }
  };

  const FIXING_STRATEGIES = {
    smoking: ['Use nicotine patches or gum','Keep your hands busy with a stress ball','Practice deep breathing when cravings hit','Chew gum or eat healthy snacks','Avoid triggers (coffee, alcohol, smoking areas)','Call a friend or support person','Go for a walk or exercise','Drink water slowly'],
    drinking: ['Have non-alcoholic alternatives ready','Avoid bars and drinking buddies initially','Find new social activities','Practice saying "no thanks"','Keep busy during usual drinking times','Join a support group (AA)','Remove alcohol from your home','Track how much money you save'],
    sugar: ['Replace with fruit when craving sweets','Eat protein to reduce cravings','Drink water first when craving sugar','Get enough sleep (reduces cravings)','Keep healthy snacks visible','Brush teeth after meals','Plan treats in advance','Read labels to avoid hidden sugar'],
    social_media: ['Delete apps from phone','Use website blockers','Turn off all notifications','Keep phone in another room','Set specific check-in times','Replace scrolling with reading','Use grayscale mode','Track screen time daily'],
    procrastination: ['Use the 2-minute rule (just start)','Break tasks into tiny steps','Set a timer for 25 minutes (Pomodoro)','Remove all distractions first','Do hardest task first thing','Create accountability (tell someone)','Reward yourself after completing tasks','Visualize the finished result'],
    porn: ['Install content filters and blockers','Keep devices in common areas','Identify your triggers','Exercise when urges hit','Cold shower technique','Call accountability partner','Practice mindfulness meditation','Join recovery community (NoFap, etc)','Seek professional therapy if needed','Replace habit with productive activity'],
    gaming: ['Uninstall games from devices','Set strict time limits','Find alternative hobbies','Exercise instead of gaming','Play only with real friends (scheduled)','Use parental controls','Keep gaming devices in another room','Track time spent gaming'],
    shopping: ['Unsubscribe from marketing emails','Use cash only (no cards)','Wait 48 hours before buying','Uninstall shopping apps','Make a list and stick to it','Calculate cost in hours worked','Find free activities','Track every purchase'],
    caffeine: ['Gradually reduce intake','Switch to decaf slowly','Drink herbal tea instead','Get enough sleep','Exercise for natural energy','Stay hydrated with water','Eat energy-boosting foods','Take short power naps'],
    tv: ['Cancel streaming subscriptions','Remove TV from bedroom','Set viewing time limits','Only watch with others','Replace with reading or hobbies','Unplug TV during week','Use app timers','Find outdoor activities'],
    other: ['Identify your specific triggers','Find healthier alternatives','Build a support system','Track your progress daily','Reward small victories','Practice self-compassion','Seek professional help if needed','Stay accountable to someone']
  };

  const BREATHING_TECHNIQUES = {
    box: { name:'Box Breathing', description:'Equal counts - stress relief', icon:'üì¶', phases:[
      {name:'Inhale',duration:4,instruction:'Breathe in slowly through your nose'},
      {name:'Hold',duration:4,instruction:'Hold your breath'},
      {name:'Exhale',duration:4,instruction:'Breathe out slowly'},
      {name:'Hold',duration:4,instruction:'Hold your breath'}
    ]},
    deep: { name:'Deep Breathing', description:'Simple and effective', icon:'üåä', phases:[
      {name:'Inhale',duration:5,instruction:'Take a deep breath in'},
      {name:'Hold',duration:3,instruction:'Hold it'},
      {name:'Exhale',duration:7,instruction:'Let it all out slowly'}
    ]},
    resonance: { name:'Resonance Breathing', description:'Heart-mind coherence', icon:'üíó', phases:[
      {name:'Inhale',duration:5,instruction:'Breathe in smoothly'},
      {name:'Exhale',duration:5,instruction:'Breathe out smoothly'}
    ]}
  };

  const MILESTONES = [1, 3, 7, 14, 30, 60, 90, 180, 365];
  const celebratedMilestones = new Set();

  let state = loadState() || {
    screen: 'welcome',
    page: 'dashboard',
    darkMode: false,
    showAddModal: false,
    habitType: 'quit',
    showRelapseModal: false,
    selectedHabitForRelapse: null,
    showBreathingModal: false,
    breathingTechnique: 'box',
    breathingActive: false,
    breathCounter: 4,
    breathCycle: 0,
    quitHabits: [],
    buildHabits: [],
    questionIndex: 0,
    answers: {},
    loading: false,
    userData: { name:'', quitHabit:'', buildHabit:'', why:'', age:'' },
    newHabit: {
      name:'', category:'smoking', startDate: new Date().toISOString(),
      dailyGoal:1, icon:'üö¨', unit: 'times'
    },
    hourlyProgress: {},
    weeklyAnalytics: {},
    dailyAnalytics: {}
  };

  const $ = id => document.getElementById(id);

  function uid(){
    return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,10);
  }

  function saveState() {
    try {
      const toSave = {
        ...state,
        showAddModal: false,
        showRelapseModal: false,
        showBreathingModal: false,
        breathingActive: false
      };
      localStorage.setItem('undoAppState', JSON.stringify(toSave));
    } catch(e) {
      console.error('Failed to save state:', e);
    }
  }

  function loadState() {
    try {
      const saved = localStorage.getItem('undoAppState');
      if (saved) {
        return JSON.parse(saved);
      }
    } catch(e) {
      console.error('Failed to load state:', e);
    }
    return null;
  }

  function showNotification(msg, time=3000){
    const el = $('notification');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(()=>{ el.classList.remove('show'); }, time);
  }

  function celebrate(days, habitName) {
    const messages = {
      1: `üéâ 1 day clean from ${habitName}! You've started something amazing!`,
      3: `üåü 3 days! You're building momentum!`,
      7: `üî• One week! You're proving you can do this!`,
      14: `üíé 2 weeks! Your body is thanking you!`,
      30: `üèÜ 30 DAYS! This is HUGE! You're a champion!`,
      60: `üëë 2 months! You're unstoppable!`,
      90: `üöÄ 90 DAYS! You've broken the habit loop!`,
      180: `‚≠ê Half a year! You're a completely different person!`,
      365: `üéä ONE YEAR! You did it! Incredible achievement!`
    };
    
    const msg = messages[days] || `üéØ ${days} days clean!`;
    showNotification(msg, 5000);
  }

  const desktopHome = document.getElementById("btn-home");
  const mobileHome = document.getElementById("m-btn-home");

  function goHome() {
    state.page = "dashboard";
    renderAll();
    document.getElementById("mobile-menu-overlay").classList.remove("show");
  }

  if (desktopHome) desktopHome.addEventListener("click", goHome);
  if (mobileHome) mobileHome.addEventListener("click", goHome);

  function formatCleanTime(startDate){
    const t = calculateTimeSince(startDate);
    if(t.days > 0) return `${t.days}d ${t.hours}h ${t.minutes}m`;
    if(t.hours > 0) return `${t.hours}h ${t.minutes}m ${t.seconds}s`;
    if(t.minutes > 0) return `${t.minutes}m ${t.seconds}s`;
    return `${t.seconds}s`;
  }

  function calculateTimeSince(startDate){
    const start = new Date(startDate);
    const now = new Date();
    const diff = Math.max(0, now - start);
    return {
      days: Math.floor(diff / (1000*60*60*24)),
      hours: Math.floor((diff % (1000*60*60*24)) / (1000*60*60)),
      minutes: Math.floor((diff % (1000*60*60)) / (1000*60)),
      seconds: Math.floor((diff % (1000*60)) / 1000),
      totalHours: Math.floor(diff / (1000*60*60))
    };
  }

  function calculateStreak(completions, goal){
    let streak=0;
    const today=new Date();
    for(let i=0;i<365;i++){
      const d=new Date(today);
      d.setDate(d.getDate()-i);
      const s=d.toISOString().split('T')[0];
      if((completions[s]||0) >= goal) streak++;
      else if(i>0) break;
    }
    return streak;
  }

  function getCalendarDays(habit){
    const days=[];
    const today=new Date();
    for(let i=29;i>=0;i--){
      const d=new Date(today);
      d.setDate(d.getDate()-i);
      const s=d.toISOString().split('T')[0];
      days.push({ date: s, completed: (habit.completions && habit.completions[s] || 0) >= habit.dailyGoal });
    }
    return days;
  }

  function updateAnalytics(habit, isRelapse = false) {
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const weekKey = getWeekKey(now);
    
    if (!state.dailyAnalytics[habit.id]) {
      state.dailyAnalytics[habit.id] = {};
    }
    if (!state.weeklyAnalytics[habit.id]) {
      state.weeklyAnalytics[habit.id] = {};
    }

    if (isRelapse) {
      state.dailyAnalytics[habit.id][dateStr] = {
        date: dateStr,
        status: 'relapsed',
        hours: calculateTimeSince(habit.startDate).totalHours
      };
      
      state.weeklyAnalytics[habit.id][weekKey] = {
        week: weekKey,
        relapseCount: (state.weeklyAnalytics[habit.id][weekKey]?.relapseCount || 0) + 1,
        totalHours: calculateTimeSince(habit.startDate).totalHours
      };
    } else {
      if (!state.dailyAnalytics[habit.id][dateStr]) {
        state.dailyAnalytics[habit.id][dateStr] = {
          date: dateStr,
          status: 'clean',
          hours: calculateTimeSince(habit.startDate).totalHours
        };
      }
    }
    
    saveState();
  }

  function getWeekKey(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(d.setDate(diff));
    return monday.toISOString().split('T')[0];
  }

  function renderAll(){
    if(state.darkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    
    $('greeting').textContent = `Hey ${state.userData.name || 'Friend'}!`;
    
    if(state.screen === 'welcome'){
      $('welcome').style.display = 'flex';
      $('app-main').style.display = 'none';
      $('main-header').style.display = 'none';
    } else {
      $('welcome').style.display = 'none';
      $('app-main').style.display = 'block';
      $('main-header').style.display = 'block';
    }
    
    $('quit-count').textContent = state.quitHabits.length;
    $('build-count').textContent = state.buildHabits.length;
    
    $('dashboard-view').style.display = state.page === 'dashboard' ? 'block' : 'none';
    $('analytics-page').style.display = state.page === 'analytics' ? 'block' : 'none';
    $('why-page').style.display = state.page === 'why' ? 'block' : 'none';
    
    renderQuitList();
    renderBuildList();
    renderWhyList();
    renderAnalytics();
    renderQuestion();
    
    try {
      const greetEl = document.getElementById('greeting');
      if(greetEl){
        if(state.screen !== 'welcome' && state.page === 'dashboard'){
          greetEl.style.display = 'block';
          greetEl.style.fontSize = '1.125rem';
          greetEl.style.fontWeight = '800';
        } else {
          greetEl.style.display = 'none';
        }
      }
    } catch(e){}
    
    saveState();
  }

  function renderQuitList(){
    const container = $('quit-list');
    container.innerHTML = '';
    
    if(state.quitHabits.length === 0){
      const box = document.createElement('div');
      box.className = 'card';
      box.style.padding = '2.5rem';
      box.innerHTML = `<div style="text-align:center"><div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">‚ùå</div><p class="muted" style="font-size:1.125rem">No quit habits yet</p></div>`;
      container.appendChild(box);
      return;
    }
    
    state.quitHabits.forEach(habit => {
      const t = calculateTimeSince(habit.startDate);
      const card = document.createElement('div');
      card.className = 'habit-card card';
      
      const topSection = document.createElement('div');
      topSection.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem';
      topSection.innerHTML = `
        <div style="display:flex;gap:0.75rem;align-items:center">
          <div style="font-size:3rem">${habit.icon}</div>
          <div>
            <div class="heading" style="font-size:1.25rem">${habit.name}</div>
            <div class="small muted" style="margin-top:0.25rem">Since ${new Date(habit.startDate).toLocaleString()}</div>
          </div>
        </div>
      `;
      
      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-ghost';
      delBtn.style.padding = '0.5rem';
      delBtn.innerHTML = 'üóëÔ∏è';
      delBtn.onclick = ()=>{
        if(confirm('Delete this habit?')){
          state.quitHabits = state.quitHabits.filter(h=>h.id !== habit.id);
          showNotification('Habit removed');
          renderAll();
        }
      };
      topSection.appendChild(delBtn);
      
      const green = document.createElement('div');
      green.className = 'green-panel';
      green.setAttribute('data-habit-id', habit.id);
      green.setAttribute('data-start', habit.startDate);
      green.style.marginBottom = '1.25rem';
      green.innerHTML = `
        <div class="small" style="font-weight:600;margin-bottom:0.75rem">Clean for</div>
        <div style="font-size:2rem;font-weight:800;margin-bottom:1rem" data-clean-time>${formatCleanTime(habit.startDate)}</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem">
          <div class="stat-box" style="background:rgba(255,255,255,0.2)">
            <div style="font-size:1.5rem;font-weight:800" data-days>${t.days}</div>
            <div style="font-size:0.75rem">days</div>
          </div>
          <div class="stat-box" style="background:rgba(255,255,255,0.2)">
            <div style="font-size:1.5rem;font-weight:800" data-hours>${t.hours}</div>
            <div style="font-size:0.75rem">hrs</div>
          </div>
          <div class="stat-box" style="background:rgba(255,255,255,0.2)">
            <div style="font-size:1.5rem;font-weight:800" data-minutes>${t.minutes}</div>
            <div style="font-size:0.75rem">min</div>
          </div>
          <div class="stat-box" style="background:rgba(255,255,255,0.2)">
            <div style="font-size:1.5rem;font-weight:800" data-seconds>${t.seconds}</div>
            <div style="font-size:0.75rem">sec</div>
          </div>
        </div>
      `;
      
      const stats = document.createElement('div');
      stats.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem';
      stats.innerHTML = `
        <div class="stat-box yellow">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üèÜ</div>
          <div class="heading" style="font-size:1.5rem">${habit.bestStreak||0}</div>
          <div class="small muted">Best ${habit.bestStreak === 1 ? 'day' : 'days'}</div>
        </div>
        <div class="stat-box red">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üîÑ</div>
          <div class="heading" style="font-size:1.5rem">${(habit.relapses||[]).length}</div>
          <div class="small muted">Relapses</div>
        </div>
      `;
      
      const relapseBtn = document.createElement('button');
      relapseBtn.className = 'btn btn-danger btn-wide';
      relapseBtn.style.marginBottom = '1rem';
      relapseBtn.innerHTML = '<span style="font-size:1.125rem">üö®</span> I Will Relapse';
      relapseBtn.onclick = ()=> openEmergencyModal(habit);
      
      const details = document.createElement('details');
      details.style.cssText = 'padding:1rem;border-radius:12px;background:rgba(59,130,246,0.1)';
      const summary = document.createElement('summary');
      summary.style.cssText = 'cursor:pointer;font-weight:700;font-size:0.9375rem;list-style:none;display:flex;align-items:center;gap:0.5rem';
      summary.innerHTML = '<span style="font-size:1.25rem">üí°</span> How to Fix This';
      details.appendChild(summary);
      
      const ul = document.createElement('ul');
      ul.style.cssText = 'margin-top:0.75rem;padding-left:0;list-style:none';
      const strategies = FIXING_STRATEGIES[habit.category] || FIXING_STRATEGIES.other;
      strategies.forEach(s=>{
        const li = document.createElement('li');
        li.style.cssText = 'margin-bottom:0.625rem;font-size:0.875rem;display:flex;align-items:flex-start;gap:0.5rem;padding:0.5rem;border-radius:8px;background:rgba(255,255,255,0.5)';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.style.cssText = 'margin-top:0.125rem;cursor:pointer;width:1rem;height:1rem;flex-shrink:0';
        const label = document.createElement('span');
        label.textContent = s;
        label.style.cssText = 'flex:1';
        checkbox.addEventListener('change', (e) => {
          if(e.target.checked){
            label.style.textDecoration = 'line-through';
            label.style.opacity = '0.6';
          } else {
            label.style.textDecoration = 'none';
            label.style.opacity = '1';
          }
        });
        li.appendChild(checkbox);
        li.appendChild(label);
        ul.appendChild(li);
      });
      details.appendChild(ul);
      
      card.appendChild(topSection);
      card.appendChild(green);
      card.appendChild(stats);
      card.appendChild(relapseBtn);
      card.appendChild(details);
      container.appendChild(card);
    });
  }

  function renderBuildList(){
    const container = $('build-list');
    container.innerHTML='';
    
    if(state.buildHabits.length === 0){
      const box = document.createElement('div');
      box.className = 'card';
      box.style.padding = '2.5rem';
      box.innerHTML = `<div style="text-align:center"><div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">‚úÖ</div><p class="muted" style="font-size:1.125rem">No build habits yet</p></div>`;
      container.appendChild(box);
      return;
    }
    
    state.buildHabits.forEach(habit => {
      const today = (new Date()).toISOString().split('T')[0];
      const todayCount = (habit.completions && habit.completions[today]) || 0;
      const progress = Math.round((todayCount / habit.dailyGoal) * 100);
      
      const card = document.createElement('div');
      card.className = 'habit-card card';
      card.setAttribute('data-habit-id', habit.id);
      
      const topSection = document.createElement('div');
      topSection.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem';
      topSection.innerHTML = `
        <div style="display:flex;gap:0.75rem;align-items:center">
          <div style="font-size:3rem">${habit.icon}</div>
          <div>
            <div class="heading" style="font-size:1.25rem">${habit.name}</div>
            <div class="small muted" style="margin-top:0.25rem">Goal: ${habit.dailyGoal} ${habit.unit || 'times'}/day</div>
          </div>
        </div>
      `;
      
      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-ghost';
      delBtn.style.padding = '0.5rem';
      delBtn.innerHTML = 'üóëÔ∏è';
      delBtn.onclick = ()=>{
        if(confirm('Delete this habit?')){
          state.buildHabits = state.buildHabits.filter(h=>h.id !== habit.id);
          showNotification('Habit removed');
          renderAll();
        }
      };
      topSection.appendChild(delBtn);
      
      const progressSection = document.createElement('div');
      progressSection.style.marginBottom = '1.25rem';
      progressSection.innerHTML = `
        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
          <span class="small muted" style="font-weight:600">Today</span>
          <span class="heading" style="font-size:1.125rem" data-today-count>${todayCount}/${habit.dailyGoal} ${habit.unit || 'times'}</span>
        </div>
        <div style="height:1rem;border-radius:999px;background:var(--border);overflow:hidden">
          <div data-progress-bar style="height:100%;background:linear-gradient(90deg,var(--green-from),var(--green-to));width:${Math.min(100,progress)}%;transition:width 0.3s"></div>
        </div>
      `;
      
      const stats = document.createElement('div');
      stats.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem';
      stats.innerHTML = `
        <div class="stat-box orange">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üî•</div>
          <div class="heading" style="font-size:1.5rem">${habit.currentStreak||0}</div>
          <div class="small muted">Current</div>
        </div>
        <div class="stat-box yellow">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üèÜ</div>
          <div class="heading" style="font-size:1.5rem">${habit.bestStreak||0}</div>
          <div class="small muted">Best</div>
        </div>
      `;
      
      const calendarSection = document.createElement('div');
      calendarSection.style.marginBottom = '1.25rem';
      const calTitle = document.createElement('div');
      calTitle.className = 'small muted';
      calTitle.style.cssText = 'margin-bottom:0.75rem;font-weight:600';
      calTitle.textContent = 'Last 30 Days';
      calendarSection.appendChild(calTitle);
      
      const calGrid = document.createElement('div');
      calGrid.className = 'calendar-grid';
      const days = getCalendarDays(habit);
      days.forEach(d => {
        const dd = document.createElement('div');
        dd.className = 'day' + (d.completed ? ' done' : '');
        calGrid.appendChild(dd);
      });
      calendarSection.appendChild(calGrid);
      
      const toggleBtn = document.createElement('button');
      toggleBtn.className = `btn btn-wide ${todayCount>=habit.dailyGoal ? 'btn-ghost' : 'btn-success'}`;
      toggleBtn.innerHTML = todayCount>=habit.dailyGoal ? '‚úÖ Goal Complete!' : '‚úÖ Check In';
      toggleBtn.setAttribute('data-toggle', habit.id);
      toggleBtn.onclick = ()=> toggleBuildHabit(habit.id);
      
      // Add workout plan for exercise category
      if(habit.category === 'exercise') {
        const workoutDetails = document.createElement('details');
        workoutDetails.style.cssText = 'margin-top:1rem;padding:1rem;border-radius:12px;background:rgba(124,58,237,0.1)';
        const workoutSummary = document.createElement('summary');
        workoutSummary.style.cssText = 'cursor:pointer;font-weight:700;font-size:0.9375rem;list-style:none;display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem';
        workoutSummary.innerHTML = '<span style="font-size:1.25rem">üí°</span> Weekly Workout Plans';
        workoutDetails.appendChild(workoutSummary);
        
        const workoutContent = document.createElement('div');
        workoutContent.style.cssText = 'display:grid;grid-template-columns:1fr;gap:1rem';
        
        // Home Workout Plan
        const homeWorkout = document.createElement('div');
        homeWorkout.style.cssText = 'padding:1rem;border-radius:8px;background:rgba(255,255,255,0.5);border:2px solid rgba(16,185,129,0.3)';
        homeWorkout.innerHTML = `
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
            <span style="font-size:1.5rem">üè†</span>
            <div class="heading" style="font-size:1rem">At Home Plan</div>
          </div>
          <div style="font-size:0.8125rem;line-height:1.6">
            <div style="margin-bottom:0.5rem"><strong>Monday:</strong> Push-ups (3√ó15), Squats (3√ó20), Plank (3√ó45s)</div>
            <div style="margin-bottom:0.5rem"><strong>Tuesday:</strong> Jumping Jacks (3√ó30), Lunges (3√ó15), Mountain Climbers (3√ó20)</div>
            <div style="margin-bottom:0.5rem"><strong>Wednesday:</strong> Rest or Light Yoga (20 min)</div>
            <div style="margin-bottom:0.5rem"><strong>Thursday:</strong> Burpees (3√ó10), Wall Sit (3√ó45s), High Knees (3√ó30)</div>
            <div style="margin-bottom:0.5rem"><strong>Friday:</strong> Push-ups (3√ó15), Bicycle Crunches (3√ó20), Jump Squats (3√ó15)</div>
            <div style="margin-bottom:0.5rem"><strong>Weekend:</strong> Long Walk/Jog (30-45 min) or Active Rest</div>
          </div>
        `;
        
        // Gym Workout Plan
        const gymWorkout = document.createElement('div');
        gymWorkout.style.cssText = 'padding:1rem;border-radius:8px;background:rgba(255,255,255,0.5);border:2px solid rgba(124,58,237,0.3)';
        gymWorkout.innerHTML = `
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
            <span style="font-size:1.5rem">üèãÔ∏è</span>
            <div class="heading" style="font-size:1rem">Gym Plan</div>
          </div>
          <div style="font-size:0.8125rem;line-height:1.6">
            <div style="margin-bottom:0.5rem"><strong>Monday:</strong> Chest & Triceps - Bench Press (3√ó10), Dumbbell Flyes (3√ó12), Tricep Dips (3√ó12)</div>
            <div style="margin-bottom:0.5rem"><strong>Tuesday:</strong> Back & Biceps - Pull-ups (3√ó8), Rows (3√ó10), Bicep Curls (3√ó12)</div>
            <div style="margin-bottom:0.5rem"><strong>Wednesday:</strong> Legs - Squats (3√ó10), Leg Press (3√ó12), Calf Raises (3√ó15)</div>
            <div style="margin-bottom:0.5rem"><strong>Thursday:</strong> Shoulders & Abs - Shoulder Press (3√ó10), Lateral Raises (3√ó12), Planks (3√ó60s)</div>
            <div style="margin-bottom:0.5rem"><strong>Friday:</strong> Full Body - Deadlifts (3√ó8), Push-ups (3√ó15), Squats (3√ó12)</div>
            <div style="margin-bottom:0.5rem"><strong>Weekend:</strong> Cardio (30 min) & Stretching or Rest</div>
          </div>
        `;
        
        workoutContent.appendChild(homeWorkout);
        workoutContent.appendChild(gymWorkout);
        workoutDetails.appendChild(workoutContent);
        
        card.appendChild(topSection);
        card.appendChild(progressSection);
        card.appendChild(stats);
        card.appendChild(calendarSection);
        card.appendChild(toggleBtn);
        card.appendChild(workoutDetails);
      } else {
        card.appendChild(topSection);
        card.appendChild(progressSection);
        card.appendChild(stats);
        card.appendChild(calendarSection);
        card.appendChild(toggleBtn);
      }
      
      container.appendChild(card);
    });
  }

  function renderAnalytics(){
    const el = $('analytics-content');
    el.innerHTML = '';
    
    if(state.page !== 'analytics') return;
    
    if(state.quitHabits.length === 0 && state.buildHabits.length === 0){
      const box = document.createElement('div');
      box.className='card';
      box.style.padding='2.5rem';
      box.innerHTML = `<div style="text-align:center"><div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">üìä</div><p class="muted" style="font-size:1.125rem;margin-bottom:0.5rem">No data yet</p><p class="small muted">Add habits to see analytics</p></div>`;
      el.appendChild(box);
      return;
    }
    
    state.quitHabits.forEach(habit => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.cssText = 'padding:1.5rem;margin-bottom:1.5rem';
      
      const header = document.createElement('div');
      header.style.cssText = 'display:flex;gap:0.75rem;align-items:center;margin-bottom:1.5rem';
      header.innerHTML = `
        <div style="font-size:2.5rem">${habit.icon}</div>
        <div style="flex:1">
          <div class="heading" style="font-size:1.25rem">${habit.name}</div>
          <div class="small muted">24-Hour Real-time Progress</div>
        </div>
      `;
      card.appendChild(header);
      
      const timeSince = calculateTimeSince(habit.startDate);
      const totalHours = timeSince.totalHours;
      const currentDay = Math.floor(totalHours / 24) + 1;
      
      const dayLabel = document.createElement('div');
      dayLabel.style.cssText = 'text-align:center;margin-bottom:1rem;font-weight:600;color:var(--muted)';
      dayLabel.textContent = `Day ${currentDay} - ${totalHours} hours clean`;
      card.appendChild(dayLabel);
      
      const chartContainer = document.createElement('div');
      chartContainer.style.cssText = 'display:flex;gap:0.25rem;align-items:flex-end;height:200px;padding:1rem;background:rgba(16,185,129,0.05);border-radius:12px';
      
      const currentHour = (totalHours % 24) + 1;
      
      for(let i = 1; i <= 24; i++){
        const bar = document.createElement('div');
        bar.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end';
        
        const isActive = i <= currentHour;
        
        const barInner = document.createElement('div');
        barInner.style.cssText = `
          width:100%;
          background:${isActive ? 'linear-gradient(180deg, var(--green-from), var(--green-to))' : 'var(--border)'};
          border-radius:4px 4px 0 0;
          transition:all 0.3s;
          height:${isActive ? '100%' : '20%'};
        `;
        
        const label = document.createElement('div');
        label.style.cssText = 'font-size:0.625rem;color:var(--muted);margin-top:0.25rem;text-align:center';
        label.textContent = i + 'h';
        
        bar.appendChild(barInner);
        bar.appendChild(label);
        chartContainer.appendChild(bar);
      }
      
      card.appendChild(chartContainer);
      
      const weekStats = document.createElement('div');
      weekStats.style.cssText = 'margin-top:1.5rem';
      weekStats.innerHTML = `<div class="small muted" style="font-weight:600;margin-bottom:0.75rem">Weekly Analytics</div>`;
      
      const weekGrid = document.createElement('div');
      weekGrid.style.cssText = 'display:flex;gap:0.5rem;overflow-x:auto;padding-bottom:0.5rem';
      
      const weeklyData = state.weeklyAnalytics[habit.id] || {};
      const weeks = Object.keys(weeklyData).sort().slice(-8);
      
      if(weeks.length > 0) {
        weeks.forEach(week => {
          const data = weeklyData[week];
          const weekCard = document.createElement('div');
          weekCard.style.cssText = 'min-width:100px;padding:0.75rem;border-radius:8px;text-align:center;background:rgba(16,185,129,0.1)';
          weekCard.innerHTML = `
            <div class="small muted" style="font-size:0.625rem;margin-bottom:0.25rem">${new Date(week).toLocaleDateString('en', {month:'short', day:'numeric'})}</div>
            <div class="heading" style="font-size:1.25rem">${data.relapseCount || 0}</div>
            <div class="small muted" style="font-size:0.625rem">relapses</div>
          `;
          weekGrid.appendChild(weekCard);
        });
      } else {
        weekGrid.innerHTML = '<div class="small muted">No weekly data yet</div>';
      }
      
      weekStats.appendChild(weekGrid);
      card.appendChild(weekStats);
      
      const stats = document.createElement('div');
      stats.style.cssText = 'display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1.5rem';
      stats.innerHTML = `
        <div style="text-align:center;padding:1rem;border-radius:12px;background:rgba(16,185,129,0.1)">
          <div class="heading" style="font-size:1.5rem">${totalHours}h</div>
          <div class="small muted">Total Hours</div>
        </div>
        <div style="text-align:center;padding:1rem;border-radius:12px;background:rgba(16,185,129,0.1)">
          <div class="heading" style="font-size:1.5rem">${timeSince.days}</div>
          <div class="small muted">Days</div>
        </div>
        <div style="text-align:center;padding:1rem;border-radius:12px;background:rgba(16,185,129,0.1)">
          <div class="heading" style="font-size:1.5rem">${habit.bestStreak}</div>
          <div class="small muted">Best Streak</div>
        </div>
      `;
      card.appendChild(stats);
      
      el.appendChild(card);
      
      updateAnalytics(habit, false);
    });
    
    state.buildHabits.forEach(habit => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.cssText = 'padding:1.5rem;margin-bottom:1.5rem';
      
      const header = document.createElement('div');
      header.style.cssText = 'display:flex;gap:0.75rem;align-items:center;margin-bottom:1.5rem';
      header.innerHTML = `
        <div style="font-size:2.5rem">${habit.icon}</div>
        <div style="flex:1">
          <div class="heading" style="font-size:1.25rem">${habit.name}</div>
          <div class="small muted">Daily Progress Tracking</div>
        </div>
      `;
      card.appendChild(header);
      
      const chartContainer = document.createElement('div');
      chartContainer.style.cssText = 'display:flex;gap:0.5rem;align-items:flex-end;height:200px;padding:1rem;background:rgba(16,185,129,0.05);border-radius:12px';
      
      const today = new Date();
      for(let i = 6; i >= 0; i--){
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const completions = habit.completions[dateStr] || 0;
        const percentage = Math.min(100, (completions / habit.dailyGoal) * 100);
        
        const bar = document.createElement('div');
        bar.style.cssText = 'flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end';
        
        const barInner = document.createElement('div');
        barInner.style.cssText = `
          width:100%;
          background:${percentage >= 100 ? 'linear-gradient(180deg, var(--green-from), var(--green-to))' : percentage > 0 ? 'linear-gradient(180deg, #fbbf24, #f59e0b)' : 'var(--border)'};
          border-radius:4px 4px 0 0;
          transition:all 0.3s;
          height:${Math.max(20, percentage)}%;
        `;
        
        const label = document.createElement('div');
        label.style.cssText = 'font-size:0.625rem;color:var(--muted);margin-top:0.25rem;text-align:center';
        label.textContent = date.toLocaleDateString('en', {weekday:'short'});
        
        bar.appendChild(barInner);
        bar.appendChild(label);
        chartContainer.appendChild(bar);
      }
      
      card.appendChild(chartContainer);
      
      const stats = document.createElement('div');
      stats.style.cssText = 'display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1.5rem';
      
      const today7 = new Date().toISOString().split('T')[0];
      const todayCount = habit.completions[today7] || 0;
      const weekTotal = Object.entries(habit.completions || {})
        .filter(([date]) => {
          const d = new Date(date);
          const diff = (new Date() - d) / (1000 * 60 * 60 * 24);
          return diff <= 7;
        })
        .reduce((sum, [, count]) => sum + count, 0);
      
      stats.innerHTML = `
        <div style="text-align:center;padding:1rem;border-radius:12px;background:rgba(16,185,129,0.1)">
          <div class="heading" style="font-size:1.5rem">${todayCount}/${habit.dailyGoal}</div>
          <div class="small muted">Today</div>
        </div>
        <div style="text-align:center;padding:1rem;border-radius:12px;background:rgba(16,185,129,0.1)">
          <div class="heading" style="font-size:1.5rem">${weekTotal}</div>
          <div class="small muted">This Week</div>
        </div>
        <div style="text-align:center;padding:1rem;border-radius:12px;background:rgba(16,185,129,0.1)">
          <div class="heading" style="font-size:1.5rem">${habit.currentStreak}</div>
          <div class="small muted">Streak</div>
        </div>
      `;
      card.appendChild(stats);
      
      el.appendChild(card);
    });
  }

  function renderWhyList(){
    const el = $('why-list');
    el.innerHTML = '';
    
    if(state.page !== 'why') return;
    
    const relapsed = state.quitHabits.filter(h=> (h.relapses && h.relapses.length>0));
    
    if(relapsed.length===0){
      const box = document.createElement('div');
      box.className='card';
      box.style.padding='2.5rem';
      box.innerHTML = `<div style="text-align:center"><div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">üìù</div><p class="muted" style="font-size:1.125rem;margin-bottom:0.5rem">No relapses recorded</p><p class="small muted">Stay strong!</p></div>`;
      el.appendChild(box);
      return;
    }
    
    relapsed.forEach(habit=>{
      const wrap = document.createElement('div');
      wrap.className='card';
      wrap.style.cssText = 'padding:1.5rem;margin-bottom:1.5rem';
      
      const header = document.createElement('div');
      header.style.cssText = 'display:flex;gap:0.75rem;align-items:center;margin-bottom:1.25rem';
      header.innerHTML = `
        <div style="font-size:2.5rem">${habit.icon}</div>
        <div>
          <div class="heading" style="font-size:1.25rem">${habit.name}</div>
          <div class="small muted">${(habit.relapses||[]).length} ${habit.relapses.length === 1 ? 'relapse' : 'relapses'}</div>
        </div>
      `;
      wrap.appendChild(header);
      
      (habit.relapses || []).slice().reverse().forEach(rel=>{
        const r = document.createElement('div');
        r.style.cssText = 'padding:1rem;border-radius:12px;margin-bottom:0.75rem;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.2)';
        r.innerHTML = `
          <div style="display:flex;justify-content:space-between;margin-bottom:0.75rem">
            <div>
              <div class="heading">${new Date(rel.date).toLocaleDateString()}</div>
              <div class="small muted" style="margin-top:0.25rem">Made it ${rel.daysSince} ${rel.daysSince===1?'day':'days'}</div>
            </div>
          </div>
          <div style="background:var(--card);padding:0.75rem;border-radius:8px;border:1px solid var(--border)">
            <div class="small muted" style="margin-bottom:0.25rem;font-weight:600">Why:</div>
            <div style="font-style:italic;font-size:0.9375rem">"${rel.note}"</div>
          </div>
        `;
        wrap.appendChild(r);
      });
      
      el.appendChild(wrap);
    });
  }

  function renderQuestion(){
    const idx = state.questionIndex;
    const q = QUESTIONS[idx];
    $('q-text').textContent = q.q;
    
    const wrap = $('q-input-wrap');
    wrap.innerHTML='';
    
    $('btn-back-question').style.display = idx > 0 ? 'inline-flex' : 'none';
    
    if(q.type === 'select'){
      const list = document.createElement('div');
      list.className = 'options-list';
      q.options.forEach(opt => {
        const b = document.createElement('button');
        b.textContent = opt.label || opt.value;
        b.onclick = ()=>{
          state.answers[idx] = opt.value || opt.label;
          setTimeout(()=> handleQuestionSubmit(), 200);
        };
        list.appendChild(b);
      });
      wrap.appendChild(list);
    } else {
      const input = document.createElement('input');
      input.type = q.type || 'text';
      input.placeholder = q.placeholder || '';
      input.value = state.answers[idx] || '';
      input.oninput = (e)=> state.answers[idx] = e.target.value;
      input.onkeydown = (e)=> { if(e.key==='Enter' && state.answers[idx]) handleQuestionSubmit(); };
      wrap.appendChild(input);
      setTimeout(()=>input.focus(),50);
    }
    
    const dots = $('dotbar');
    dots.innerHTML='';
    QUESTIONS.forEach((_,i)=>{
      const d = document.createElement('div');
      d.className = 'dot' + (i === idx || i < idx ? ' active' : '');
      dots.appendChild(d);
    });
  }

  function handleQuestionSubmit(){
    const idx = state.questionIndex;
    const answer = state.answers[idx];
    if(!answer) return;
    
    if(idx < QUESTIONS.length - 1){
      state.questionIndex++;
      renderQuestion();
    } else {
      state.loading = true;
      $('welcome-loading').style.display='block';
      $('welcome-content').style.display='none';
      
      let msgIdx = 0;
      $('loading-text').textContent = LOADING_MESSAGES[msgIdx];
      
      const li = setInterval(()=>{
        msgIdx++;
        if(msgIdx < LOADING_MESSAGES.length){
          $('loading-text').textContent = LOADING_MESSAGES[msgIdx];
        } else {
          clearInterval(li);
          
          state.userData = {
            name: state.answers[0] || 'Friend',
            quitHabit: state.answers[1] || '',
            buildHabit: state.answers[2] || '',
            why: state.answers[3] || '',
            age: state.answers[4] || ''
          };
          
          if(state.answers[1]){
            const cat = state.answers[1].toLowerCase().replace(/\s+/g,'_').replace(/\//g,'_');
            state.quitHabits = [{
              id: uid(),
              name: state.answers[1],
              icon: HABIT_ICONS[cat] || 'üö¨',
              startDate: new Date().toISOString(),
              relapses: [],
              bestStreak:0,
              category:cat,
              currentStreak:0
            }];
          }
          
          if(state.answers[2]){
            const bc = state.answers[2].toLowerCase().replace(/\s+/g,'_');
            const unitInfo = CATEGORY_UNITS[bc] || CATEGORY_UNITS.other;
            state.buildHabits = [{
              id: uid(),
              name: state.answers[2],
              icon: HABIT_ICONS[bc] || 'üí™',
              dailyGoal: unitInfo.default,
              unit: unitInfo.unit,
              completions:{},
              currentStreak:0,
              bestStreak:0,
              category:bc
            }];
          }
          
          state.loading=false;
          $('welcome-loading').style.display='none';
          $('welcome-content').style.display='block';
          state.screen = 'dashboard';
          renderAll();
        }
      }, 1500);
    }
  }

  function openAddModal(type){
    state.habitType = type;
    state.showAddModal = true;
    
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    
    state.newHabit = {
      name:'',
      category: type==='quit' ? 'smoking' : 'exercise',
      startDate: now.toISOString().slice(0, 16),
      dailyGoal: type==='quit' ? 1 : (CATEGORY_UNITS['exercise']?.default || 1),
      icon: type==='quit' ? 'üö¨' : 'üí™',
      unit: type==='quit' ? 'times' : 'minutes'
    };
    
    $('add-title').textContent = `Add ${type === 'quit' ? 'Quit' : 'Build'} Habit`;
    $('add-name').value = '';
    $('add-startdate').value = state.newHabit.startDate;
    $('add-dailygoal').value = state.newHabit.dailyGoal;
    
    const grid = $('add-category-grid');
    grid.innerHTML = '';
    
    let categories = [];
    if(type === 'quit'){
      categories = [
        {cat:'smoking', label:'üö¨ Smoking'},
        {cat:'drinking', label:'üç∫ Drinking'},
        {cat:'sugar', label:'üç≠ Sugar'},
        {cat:'social_media', label:'üì± Social Media'},
        {cat:'procrastination', label:'‚è∞ Procrastination'},
        {cat:'porn', label:'üîû Porn'},
        {cat:'gaming', label:'üéÆ Gaming'},
        {cat:'shopping', label:'üõçÔ∏è Shopping'},
        {cat:'caffeine', label:'‚òï Caffeine'},
        {cat:'tv', label:'üì∫ TV'},
        {cat:'other', label:'‚≠ê Other'}
      ];
      $('add-lasttime-wrap').style.display='block';
      $('add-dailygoal-wrap').style.display='none';
      $('add-custom-unit-wrap').style.display='none';
    } else {
      categories = [
        {cat:'exercise', label:'üí™ Exercise'},
        {cat:'reading', label:'üìö Reading'},
        {cat:'meditation', label:'üßò Meditation'},
        {cat:'water', label:'üíß Water'},
        {cat:'sleep', label:'üò¥ Sleep'},
        {cat:'creative', label:'üé® Creative'},
        {cat:'healthy_eating', label:'üå± Healthy Eating'},
        {cat:'journaling', label:'üìù Journaling'},
        {cat:'other', label:'‚≠ê Other'}
      ];
      $('add-lasttime-wrap').style.display='none';
      $('add-dailygoal-wrap').style.display='block';
      $('add-custom-unit-wrap').style.display='none';
      
      const unitInfo = CATEGORY_UNITS[state.newHabit.category] || CATEGORY_UNITS.other;
      $('add-dailygoal').value = unitInfo.default;
      $('add-dailygoal').max = unitInfo.max;
      $('goal-unit').textContent = `${unitInfo.unit} per day`;
    }
    
    categories.forEach(item => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-ghost';
      btn.style.cssText = 'padding:1rem;border:2px solid var(--border);text-align:center;transition:all 0.2s';
      btn.textContent = item.label;
      btn.onclick = ()=>{
        grid.querySelectorAll('button').forEach(b => {
          b.style.borderColor = 'var(--border)';
          b.style.background = 'transparent';
        });
        btn.style.borderColor = type === 'quit' ? 'var(--danger)' : 'var(--green-from)';
        btn.style.background = type === 'quit' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
        
        state.newHabit.category = item.cat;
        state.newHabit.icon = HABIT_ICONS[item.cat] || (type === 'quit' ? 'üö¨' : 'üí™');
        
        if(type === 'build') {
          if(item.cat === 'other') {
            $('add-custom-unit-wrap').style.display='block';
            $('goal-unit').textContent = 'Select your unit type';
            state.newHabit.unit = 'times';
          } else {
            $('add-custom-unit-wrap').style.display='none';
            const unitInfo = CATEGORY_UNITS[item.cat] || CATEGORY_UNITS.other;
            $('add-dailygoal').value = unitInfo.default;
            $('add-dailygoal').max = unitInfo.max;
            state.newHabit.dailyGoal = unitInfo.default;
            state.newHabit.unit = unitInfo.unit;
            $('goal-unit').textContent = `${unitInfo.unit} per day`;
          }
        }
      };
      
      if(item.cat === state.newHabit.category){
        btn.style.borderColor = type === 'quit' ? 'var(--danger)' : 'var(--green-from)';
        btn.style.background = type === 'quit' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
      }
      
      grid.appendChild(btn);
    });
    
    $('add-custom-unit').addEventListener('change', (e) => {
      state.newHabit.unit = e.target.value;
    });
    
    $('add-modal').style.display='flex';
    setTimeout(()=>{
      $('add-modal').classList.add('show');
      $('add-modal').querySelector('.modal').classList.add('show');
    }, 10);
  }

  function closeAddModal(){
    $('add-modal').classList.remove('show');
    $('add-modal').querySelector('.modal').classList.remove('show');
    setTimeout(()=>{
      $('add-modal').style.display='none';
    }, 300);
  }

  function confirmAddHabit(){
    const name = $('add-name').value.trim();
    if(!name) return;
    
    const icon = state.newHabit.icon;
    
    if(state.habitType === 'quit'){
      const startDateTime = $('add-startdate').value;
      const h = {
        id: uid(),
        name,
        icon,
        startDate: new Date(startDateTime).toISOString(),
        relapses:[],
        bestStreak:0,
        category: state.newHabit.category,
        currentStreak:0
      };
      state.quitHabits.push(h);
      showNotification(`"${name}" added! üéØ`);
    } else {
      const daily = Math.max(1, parseInt($('add-dailygoal').value) || 1);
      const unit = state.newHabit.category === 'other' ? $('add-custom-unit').value : state.newHabit.unit;
      const h = {
        id: uid(),
        name,
        icon,
        dailyGoal: daily,
        unit: unit,
        completions:{},
        currentStreak:0,
        bestStreak:0,
        category: state.newHabit.category
      };
      state.buildHabits.push(h);
      showNotification(`"${name}" added! üí™`);
    }
    
    closeAddModal();
    renderAll();
  }

  function openRelapseModal(habit){
    state.showRelapseModal = true;
    state.selectedHabitForRelapse = habit;
    
    $('relapse-emoji').textContent = habit.icon;
    $('relapse-name').textContent = habit.name;
    $('relapse-since').textContent = `You were clean for ${formatCleanTime(habit.startDate)}`;
    $('relapse-note').value = '';
    
    $('relapse-modal').style.display='flex';
    setTimeout(()=>{
      $('relapse-modal').classList.add('show');
      $('relapse-modal').querySelector('.modal').classList.add('show');
    }, 10);
  }

  function closeRelapseModal(){
    $('relapse-modal').classList.remove('show');
    $('relapse-modal').querySelector('.modal').classList.remove('show');
    setTimeout(()=>{
      $('relapse-modal').style.display='none';
      state.selectedHabitForRelapse = null;
    }, 300);
  }

  function confirmRelapse(){
    const note = $('relapse-note').value.trim() || 'No note provided';
    const habit = state.selectedHabitForRelapse;
    if(!habit) return;
    
    const timeSince = calculateTimeSince(habit.startDate);
    const totalDays = timeSince.days;
    
    const relapse = {
      date: (new Date()).toISOString(),
      daysSince: totalDays,
      note,
      cleanTime: formatCleanTime(habit.startDate)
    };
    
    state.quitHabits = state.quitHabits.map(h => {
      if(h.id === habit.id){
        const updated = {...h};
        updated.relapses = [...(h.relapses||[]), relapse];
        updated.bestStreak = Math.max(updated.bestStreak || 0, totalDays);
        updated.startDate = (new Date()).toISOString();
        updated.currentStreak = 0;
        
        updateAnalytics(updated, true);
        
        if(totalDays > 0){
          showNotification(`üèÜ New record! ${totalDays} ${totalDays === 1 ? 'day' : 'days'}!`);
        }
        
        return updated;
      }
      return h;
    });
    
    closeRelapseModal();
    showNotification('Logged. Tomorrow is new! üí™');
    renderAll();
  }

  function toggleBuildHabit(id){
    const today = (new Date()).toISOString().split('T')[0];
    
    state.buildHabits = state.buildHabits.map(h => {
      if(h.id === id){
        const completions = {...(h.completions || {})};
        const current = completions[today] || 0;
        
        // Toggle: if complete, reset to 0; if not complete, set to goal
        if(current >= h.dailyGoal){
          completions[today] = 0;
          showNotification('Reset for today');
        } else {
          completions[today] = h.dailyGoal;
          showNotification('‚úÖ Goal complete!');
        }
        
        const streak = calculateStreak(completions, h.dailyGoal);
        const best = Math.max(h.bestStreak||0, streak);
        
        if(streak > (h.bestStreak||0) && streak > 0){
          showNotification(`üî• New best: ${streak} days!`);
        }
        
        return {...h, completions, currentStreak: streak, bestStreak: best};
      }
      return h;
    });
    
    renderAll();
  }

  let breathInterval = null;

  function openBreathModal(){
    state.showBreathingModal = true;
    state.breathingActive = false;
    
    $('breath-modal').style.display='flex';
    setTimeout(()=>{
      $('breath-modal').classList.add('show');
      $('breath-modal').querySelector('.modal').classList.add('show');
      renderBreathInner();
    }, 10);
  }

  function closeBreathModal(){
    stopBreathing();
    $('breath-modal').classList.remove('show');
    $('breath-modal').querySelector('.modal').classList.remove('show');
    setTimeout(()=>{
      $('breath-modal').style.display='none';
    }, 300);
  }

  function renderBreathInner(){
    const wrap = $('breath-inner');
    wrap.innerHTML = '';
    
    if(!state.breathingActive){
      const header = document.createElement('div');
      header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem';
      header.innerHTML = `
        <div style="display:flex;gap:0.75rem;align-items:center">
          <div style="font-size:2rem;color:#3b82f6">üå¨Ô∏è</div>
          <div class="heading" style="font-size:1.75rem">Breathing</div>
        </div>
      `;
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-ghost';
      closeBtn.style.padding = '0.5rem';
      closeBtn.innerHTML = '‚úï';
      closeBtn.onclick = closeBreathModal;
      header.appendChild(closeBtn);
      
      wrap.appendChild(header);
      
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:1fr;gap:1rem';
      
      if(window.innerWidth >= 768){
        grid.style.gridTemplateColumns = '1fr 1fr';
      }
      
      Object.entries(BREATHING_TECHNIQUES).forEach(([key,tech])=>{
        const btn = document.createElement('button');
        btn.className = 'btn btn-ghost';
        btn.style.cssText = 'text-align:left;padding:1.25rem;height:auto;border:2px solid var(--border)';
        btn.innerHTML = `
          <div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:0.75rem">
            <div style="font-size:2.5rem">${tech.icon}</div>
            <div class="heading" style="font-size:1.125rem">${tech.name}</div>
          </div>
          <div class="small muted">${tech.description}</div>
        `;
        btn.onclick = ()=>{
          state.breathingTechnique = key;
          state.breathingActive = true;
          state.breathCycle = 0;
          state.breathCounter = tech.phases[0].duration;
          startBreathing();
          renderBreathInner();
        };
        grid.appendChild(btn);
      });
      
      wrap.appendChild(grid);
    } else {
      const tech = BREATHING_TECHNIQUES[state.breathingTechnique];
      
      const header = document.createElement('div');
      header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem';
      header.innerHTML = `<div class="heading" style="font-size:1.5rem">${tech.name}</div>`;
      
      const stopBtn = document.createElement('button');
      stopBtn.className = 'btn btn-danger';
      stopBtn.textContent = 'Stop';
      stopBtn.onclick = ()=>{
        stopBreathing();
        renderBreathInner();
      };
      header.appendChild(stopBtn);
      
      wrap.appendChild(header);
      
      const center = document.createElement('div');
      center.style.textAlign = 'center';
      
      const circle = document.createElement('div');
      circle.className = 'breath-circle';
      circle.id = 'breath-circle-anim';
      circle.innerHTML = `
        <div id="breath-counter" style="font-size:3rem;font-weight:800">${state.breathCounter}</div>
        <div id="breath-phase" style="margin-top:0.5rem;font-weight:700;font-size:1.25rem"></div>
      `;
      
      center.appendChild(circle);
      wrap.appendChild(center);
      
      const inst = document.createElement('div');
      inst.id = 'breath-instruction';
      inst.style.cssText = 'padding:1rem;border-radius:12px;margin-top:1.5rem;background:rgba(59,130,246,0.1);text-align:center;font-size:1.125rem';
      wrap.appendChild(inst);
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-ghost btn-wide';
      closeBtn.style.marginTop = '1.5rem';
      closeBtn.textContent = 'Close';
      closeBtn.onclick = closeBreathModal;
      wrap.appendChild(closeBtn);
      
      updateBreathUI();
    }
  }

  function updateBreathUI(){
    const tech = BREATHING_TECHNIQUES[state.breathingTechnique];
    const cur = tech.phases[state.breathCycle % tech.phases.length];
    
    const elCounter = $('breath-counter');
    const elPhase = $('breath-phase');
    const elInst = $('breath-instruction');
    const circle = $('breath-circle-anim');
    
    if(elCounter) elCounter.textContent = state.breathCounter;
    if(elPhase) elPhase.textContent = cur.name;
    if(elInst) elInst.textContent = cur.instruction;
    
    if(circle){
      circle.className = 'breath-circle';
      if(cur.name.toLowerCase().includes('inhale')){
        circle.classList.add('inhale');
      } else if(cur.name.toLowerCase().includes('exhale')){
        circle.classList.add('exhale');
      }
    }
  }

  function startBreathing(){
    if(breathInterval) clearInterval(breathInterval);
    
    breathInterval = setInterval(()=>{
      state.breathCounter -= 1;
      
      if(state.breathCounter <= 0){
        state.breathCycle += 1;
        const tech = BREATHING_TECHNIQUES[state.breathingTechnique];
        const phaseObj = tech.phases[state.breathCycle % tech.phases.length];
        state.breathCounter = phaseObj.duration;
      }
      
      updateBreathUI();
    }, 1000);
  }

  function stopBreathing(){
    state.breathingActive = false;
    if(breathInterval){
      clearInterval(breathInterval);
      breathInterval = null;
    }
    state.breathCycle = 0;
  }

  function updateTimers(){
    document.querySelectorAll('.green-panel[data-habit-id]').forEach(panel => {
      const start = panel.getAttribute('data-start');
      const t = calculateTimeSince(start);
      
      const cleanEl = panel.querySelector('[data-clean-time]');
      const daysEl = panel.querySelector('[data-days]');
      const hoursEl = panel.querySelector('[data-hours]');
      const minsEl = panel.querySelector('[data-minutes]');
      const secsEl = panel.querySelector('[data-seconds]');
      
      if(cleanEl) cleanEl.textContent = formatCleanTime(start);
      if(daysEl) daysEl.textContent = t.days;
      if(hoursEl) hoursEl.textContent = t.hours;
      if(minsEl) minsEl.textContent = t.minutes;
      if(secsEl) secsEl.textContent = t.seconds;
    });
    
    if(state.showRelapseModal && state.selectedHabitForRelapse){
      $('relapse-since').textContent = `You were clean for ${formatCleanTime(state.selectedHabitForRelapse.startDate)}`;
    }
    
    document.querySelectorAll('[data-habit-id]').forEach(holder=>{
      const id = holder.getAttribute('data-habit-id');
      const build = state.buildHabits.find(h=>h.id===id);
      
      if(build){
        const today = (new Date()).toISOString().split('T')[0];
        const todayCount = (build.completions && build.completions[today]) || 0;
        
        const countEl = holder.querySelector('[data-today-count]');
        if(countEl) countEl.textContent = `${todayCount}/${build.dailyGoal} ${build.unit || 'times'}`;
        
        const bar = holder.querySelector('[data-progress-bar]');
        if(bar){
          const progress = Math.round((todayCount / build.dailyGoal) * 100);
          bar.style.width = Math.min(100, progress) + '%';
        }
        
        const toggleBtn = holder.querySelector('[data-toggle]');
        if(toggleBtn){
          toggleBtn.textContent = todayCount>=build.dailyGoal ? '‚úÖ Goal Complete!' : '‚úÖ Check In';
          toggleBtn.className = `btn btn-wide ${todayCount>=build.dailyGoal ? 'btn-ghost' : 'btn-success'}`;
        }
      }
    });
  }

  function checkMilestones(){
    state.quitHabits.forEach(habit => {
      const timeSince = calculateTimeSince(habit.startDate);
      const totalDays = timeSince.days;
      
      if(MILESTONES.includes(totalDays)){
        const milestoneKey = `milestone_${habit.id}_${totalDays}`;
        
        if(!celebratedMilestones.has(milestoneKey)){
          celebratedMilestones.add(milestoneKey);
          celebrate(totalDays, habit.name);
        }
      }
    });
  }

  $('btn-back-question').addEventListener('click', ()=>{
    if(state.questionIndex>0){
      state.questionIndex--;
      renderQuestion();
    }
  });

  $('btn-next-question').addEventListener('click', handleQuestionSubmit);

  $('add-quit').addEventListener('click', ()=> { state.page = 'dashboard'; openAddModal('quit'); });
  $('add-build').addEventListener('click', ()=> { state.page = 'dashboard'; openAddModal('build'); });
  $('close-add').addEventListener('click', closeAddModal);
  $('cancel-add').addEventListener('click', closeAddModal);
  $('confirm-add').addEventListener('click', confirmAddHabit);

  $('relapse-cancel').addEventListener('click', closeRelapseModal);
  $('relapse-confirm').addEventListener('click', confirmRelapse);

  $('btn-breathe').addEventListener('click', openBreathModal);
  
  $('btn-analytics').addEventListener('click', ()=>{
    state.page = 'analytics';
    renderAll();
  });
  
  $('btn-why').addEventListener('click', ()=>{
    state.page = 'why';
    renderAll();
  });
  
  $('btn-dark').addEventListener('click', ()=>{
    state.darkMode = !state.darkMode;
    $('btn-dark').textContent = state.darkMode ? '‚òÄÔ∏è' : 'üåô';
    $('btn-dark').setAttribute('aria-pressed', String(state.darkMode));
    renderAll();
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(state.showAddModal) closeAddModal();
      if(state.showRelapseModal) closeRelapseModal();
      if(state.showBreathingModal) closeBreathModal();
    }
  });

  setInterval(()=>{
    if(state.screen === 'dashboard'){
      updateTimers();
      checkMilestones();
    }
  }, 1000);

  function init(){
    state.breathCounter = BREATHING_TECHNIQUES[state.breathingTechnique].phases[0].duration;
    renderAll();
  }

  init();
  
  window.UNDO = { state, renderAll };

  try {
    const burger = document.getElementById('btn-burger');
    const mobileOverlay = document.getElementById('mobile-menu-overlay');
    const mobileClose = document.getElementById('mobile-close');
    
    if(burger && mobileOverlay){
      burger.addEventListener('click', ()=> {
        mobileOverlay.classList.toggle('show');
        if(mobileOverlay.classList.contains('show')) {
          mobileOverlay.setAttribute('aria-hidden', 'false');
        }
      });
      
      if(mobileClose) {
        mobileClose.addEventListener('click', ()=> {
          mobileOverlay.classList.remove('show');
          mobileOverlay.setAttribute('aria-hidden', 'true');
        });
      }
      
      // Close menu when clicking outside
      mobileOverlay.addEventListener('click', (e) => {
        if(e.target === mobileOverlay) {
          mobileOverlay.classList.remove('show');
          mobileOverlay.setAttribute('aria-hidden', 'true');
        }
      });
      
      document.getElementById('m-btn-home').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        state.page='dashboard'; 
        renderAll(); 
      });
      document.getElementById('m-btn-breathe').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        openBreathModal(); 
      });
      document.getElementById('m-btn-why').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        state.page='why'; 
        renderAll(); 
      });
      document.getElementById('m-btn-analytics').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        state.page='analytics'; 
        renderAll(); 
      });
      document.getElementById('m-btn-dark').addEventListener('click', ()=> { 
        state.darkMode = !state.darkMode;
        const moonBtn = document.getElementById('m-btn-dark').querySelector('span:first-child');
        if(moonBtn) moonBtn.textContent = state.darkMode ? '‚òÄÔ∏è' : 'üåô';
        renderAll();
      });
    }
  } catch(e){}

  let emergencyStream = null;
  const COACH_LINES = [
    "You're stronger than this craving.",
    "Remember why you started this journey.",
    "Take a deep breath. This moment will pass.",
    "You've come so far. Don't give up now.",
    "Your future self will thank you for resisting.",
    "One craving at a time. You can do this.",
    "Think about how proud you'll feel tomorrow.",
    "You are in control, not the addiction."
  ];
  let coachIndex = 0;
  let typingInterval = null;
  let currentText = '';
  let targetText = '';
  let charIndex = 0;

  function openEmergencyModal(habit){
    try {
      const overlay = document.getElementById('emergency-overlay');
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');

      const video = document.getElementById('emergency-video');
      const fallback = document.getElementById('camera-fallback');
      video.style.display = 'block';
      fallback.style.display = 'none';

      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false })
          .then(stream => {
            emergencyStream = stream;
            try { video.srcObject = stream; } catch(e){ video.src = URL.createObjectURL(stream); }
            video.play().catch(()=>{});
          })
          .catch(err => {
            console.warn('Camera access denied or failed', err);
            video.style.display = 'none';
            fallback.style.display = 'flex';
            fallback.style.background = 'black';
          });
      } else {
        video.style.display = 'none';
        fallback.style.display = 'flex';
      }

      startCoachTyping();

      document.getElementById('emergency-done').onclick = ()=> {
        closeEmergencyModal();
        showNotification('Well done ‚Äî keep going! üí™');
      };

      document.getElementById('emergency-relapse').onclick = ()=> {
        if(habit){
          const timeSince = calculateTimeSince(habit.startDate);
          const totalDays = timeSince.days;
          const relapse = { 
            date: (new Date()).toISOString(), 
            daysSince: totalDays, 
            note: 'Emergency relapse logged', 
            cleanTime: formatCleanTime(habit.startDate) 
          };
          state.quitHabits = state.quitHabits.map(h => {
            if(h.id === habit.id){
              const updated = {...h};
              updated.relapses = [...(h.relapses||[]), relapse];
              updated.bestStreak = Math.max(updated.bestStreak || 0, totalDays);
              updated.startDate = (new Date()).toISOString();
              updated.currentStreak = 0;
              updateAnalytics(updated, true);
              return updated;
            }
            return h;
          });
          showNotification('Relapse logged. New start recorded.');
          renderAll();
        }
        closeEmergencyModal();
      };
    } catch(err){ console.error(err); }
  }

  function closeEmergencyModal(){
    try{
      const overlay = document.getElementById('emergency-overlay');
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      stopCoachTyping();
      if(emergencyStream){
        emergencyStream.getTracks().forEach(t=>t.stop());
        emergencyStream = null;
      }
    } catch(e){}
  }

  function startCoachTyping(){
    stopCoachTyping();
    const el = document.getElementById('coach-line');
    if(!el) return;
    
    currentText = '';
    charIndex = 0;
    coachIndex = 0;
    targetText = COACH_LINES[coachIndex];
    
    typingInterval = setInterval(()=> {
      if(!el) return;
      
      if(charIndex < targetText.length){
        currentText += targetText[charIndex];
        el.textContent = currentText;
        charIndex++;
      } else {
        setTimeout(()=>{
          currentText = '';
          charIndex = 0;
          coachIndex = (coachIndex + 1) % COACH_LINES.length;
          targetText = COACH_LINES[coachIndex];
        }, 3000);
      }
    }, 80);
  }

  function stopCoachTyping(){
    if(typingInterval) clearInterval(typingInterval);
    typingInterval = null;
    const el = document.getElementById('coach-line');
    if(el) el.textContent='';
  }

  try { window.openEmergencyModal = openEmergencyModal; } catch(e) {}
});
</script>

</body>
</html>