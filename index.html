<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>UNDO ‚Äì Habit Tracker</title>
<meta name="description" content="UNDO - Quit Bad, Build Good. Track and improve your habits."/>

<!-- Content Security Policy: restrict to this site, Supabase endpoint and CDN used -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  connect-src 'self' https://rovycvzndmdtgjehdthe.supabase.co;
  script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data:;
">

<style>
  :root {
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#0f1724;
    --muted:#6b7280;
    --border:#e6e7ea;
    --accent-from:#7c3aed;
    --accent-to:#ec4899;
    --green-from:#10b981;
    --green-to:#059669;
    --danger:#ef4444;
    --radius: 16px;
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
  }

  .dark {
    --bg:#0b1220;
    --card:#0f1724;
    --text:#ffffff;
    --muted:#94a3b8;
    --border:#22303b;
    --shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html { height: 100%; font-size: 16px; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    line-height: 1.5;
    min-height: 100vh;
    transition: background-color 0.5s, color 0.3s;
  }

  .wrap { max-width: 1200px; margin: 0 auto; padding: 1rem; }
  .card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); transition: all 0.3s; }
  h1,h2,h3 { margin:0; font-weight:800; }
  .muted { color: var(--muted); }
  .small { font-size:0.875rem; }
  .heading { font-weight:800; }

  .btn {
    cursor:pointer;border:0;padding:0.75rem 1rem;border-radius:calc(var(--radius)-4px);
    font-weight:600;font-size:0.9375rem;display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;transition:all 0.2s;
  }
  .btn:active { transform: scale(0.98); }
  .btn-primary { background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); color:white; }
  .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-danger { background:var(--danger); color:white; }
  .btn-success { background: linear-gradient(135deg,var(--green-from),var(--green-to)); color:white; }
  .btn-wide { width:100%; }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }

  input, select, textarea {
    width:100%; padding:0.75rem 1rem; border-radius:calc(var(--radius)-4px); border:2px solid var(--border);
    background:var(--card); color:var(--text); font-size:1rem; transition:border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { outline:none; border-color:var(--accent-from); }
  textarea { min-height:100px; resize:vertical; }

  .flex { display:flex; }
  .grid { display:grid; }
  .gap-4 { gap:1rem; }
  .mb-4 { margin-bottom:1rem; }

  .dotbar { display:flex; gap:0.5rem; justify-content:center; margin-top:1rem; }
  .dot { height:0.5rem; border-radius:999px; background:#e5e7eb; width:0.5rem; transition:all 0.3s; }
  .dot.active { width:2rem; background: linear-gradient(90deg,var(--accent-from),var(--accent-to)); }

  header.appbar {
    position: sticky; top:0; z-index:40; padding:1rem 0; background:var(--card); backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border); box-shadow:var(--shadow);
  }

  .notif {
    position: fixed; left:50%; transform:translateX(-50%); top:1rem; z-index:80;
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); color:white; padding:1rem 1.5rem;
    border-radius:var(--radius); font-weight:600; box-shadow:var(--shadow); opacity:0; transition:opacity 0.3s; max-width:90%; text-align:center;
  }
  .notif.show { opacity:1; animation: bounce 0.5s; }
  @keyframes bounce { 0%,100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

  .welcome-wrap { display:flex; align-items:center; justify-content:center; min-height:80vh; padding:1.5rem; }
  .options-list button { display:block; width:100%; text-align:left; padding:1rem; border-radius:calc(var(--radius)-4px);
    border:2px solid var(--border); background:transparent; color:var(--text); margin-bottom:0.75rem; font-weight:600; transition:all 0.2s; font-size:1rem; }
  .options-list button:hover { border-color:var(--accent-from); transform:translateX(4px); }

  .cols { display:grid; grid-template-columns:1fr; gap:1.5rem; }
  @media (min-width: 992px) { .cols { grid-template-columns:1fr 1fr; } }

  .habit-card { padding:1.5rem; border-radius:var(--radius); border:1px solid var(--border); margin-bottom:1.25rem; box-shadow:var(--shadow); }
  .green-panel { background: linear-gradient(135deg,var(--green-from),var(--green-to)); color:white; padding:1.5rem; border-radius:calc(var(--radius)-4px); text-align:center; box-shadow: 0 10px 30px rgba(16,185,129,0.3); }

  .calendar-grid { display:grid; grid-template-columns: repeat(10,1fr); gap:0.375rem; }
  .day { aspect-ratio:1/1; border-radius:4px; background:var(--border); transition:all 0.2s; }
  .day.done { background:var(--green-from); }

  .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display:flex; align-items:center; justify-content:center; padding:1.25rem; z-index:60; opacity:0; transition:opacity 0.3s; }
  .modal-overlay.show { opacity:1; }
  .modal { max-width:640px; width:100%; background:var(--card); padding:1.5rem; border-radius:var(--radius); border:1px solid var(--border); transform: scale(0.95); opacity:0; transition:all 0.3s; max-height:90vh; overflow-y:auto; }
  .modal.show { transform: scale(1); opacity:1; }

  @keyframes spin { to { transform: rotate(360deg); } }
  .spin { animation: spin 1s linear infinite; }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  .pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }

  .stat-box { padding:1rem; border-radius:12px; text-align:center; }
  .stat-box.yellow { background: linear-gradient(135deg,#fef3c7,#fde68a); }
  .stat-box.orange { background: linear-gradient(135deg,#fed7aa,#fdba74); }
  .stat-box.red { background: linear-gradient(135deg,#fecaca,#fca5a5); }
  .dark .stat-box { background: rgba(255,255,255,0.05); }

  .discord-banner {
    background: linear-gradient(135deg, #5865F2, #7289DA);
    color: white;
    padding: 1.5rem;
    border-radius: var(--radius);
    text-align: center;
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 30px rgba(88,101,242,0.3);
    transition: transform 0.2s;
  }
  .discord-banner:hover { transform: translateY(-2px); }
  .discord-btn {
    background: white;
    color: #5865F2;
    padding: 0.75rem 1.5rem;
    border-radius: 999px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }
  .discord-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

  .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; }
  .section-title { display:flex; align-items:center; gap:0.75rem; }

  /* Analytics styles */
  .analytics-header { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-bottom:1.5rem; }
  .kpi { padding:1.25rem; border-radius:12px; background:rgba(16,185,129,0.05); text-align:center; border:1px solid var(--border); }
  .kpi .num { font-weight:800; font-size:1.75rem; margin-top:0.5rem; }
  .chart-grid { display:grid; grid-template-columns:1fr; gap:1.5rem; margin-bottom:1.5rem; }
  .chart-card { padding:1.5rem; border-radius:12px; background:var(--card); border:1px solid var(--border); }
  .chart-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .fixed-chart { width: 100%; height: 300px; max-width: 800px; display: block; }

  @media (max-width: 640px) {
    :root { --radius: 12px; }
    .modal { padding:1rem; }
    .welcome-wrap { padding:1rem; }
    .habit-card { padding:1rem; }
    .btn { padding:0.625rem 0.875rem; }
    input, select, textarea { padding:0.625rem 0.875rem; }
    .calendar-grid { gap:0.25rem; }
    .analytics-header { grid-template-columns:1fr 1fr; }
    .fixed-chart { height: 220px; }
  }

  @media (max-width: 640px) { #header-buttons { display:none !important; } #btn-burger { display:inline-flex !important; } }

  #mobile-menu-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.5); 
    backdrop-filter: blur(8px);
    display: none; 
    z-index: 120; 
    align-items: flex-start; 
    justify-content: flex-end;
    padding: 0;
  }
  #mobile-menu-overlay.show { display:flex; }
  
  #mobile-menu-panel {
    width: 280px;
    height: 100vh;
    background: linear-gradient(180deg, #2c3e50 0%, #1a1f2e 100%);
    box-shadow: -5px 0 30px rgba(0,0,0,0.3);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  
  #mobile-menu-overlay.show #mobile-menu-panel {
    transform: translateX(0);
  }
  
  .mobile-menu-header {
    padding: 2rem 1.5rem 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .mobile-user-name {
    font-size: 1.5rem;
    font-weight: 800;
    color: white;
  }
  
  .mobile-menu-nav {
    flex: 1;
    padding: 1rem 0;
  }
  
  .mobile-menu-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    color: rgba(255,255,255,0.8);
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.2s;
    position: relative;
    cursor: pointer;
  }
  
  .mobile-menu-item:hover,
  .mobile-menu-item.active {
    background: rgba(124,58,237,0.15);
    color: white;
  }
  
  .mobile-menu-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, var(--accent-from), var(--accent-to));
  }
  
  .mobile-menu-icon {
    font-size: 1.25rem;
    width: 24px;
    text-align: center;
  }
  
  .mobile-menu-badge {
    margin-left: auto;
    background: var(--danger);
    color: white;
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 999px;
    font-weight: 700;
  }
  
  .mobile-menu-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  #emergency-overlay { position: fixed; inset: 0; background: linear-gradient(180deg, rgba(220,38,38,0.98), rgba(153,27,27,0.95)); display: none; z-index: 200; color: white; align-items: center; justify-content: center; padding: 1.25rem; }
  #emergency-overlay.show { display:flex; }
  .emergency-card { width:100%; max-width:720px; text-align:center; border-radius:18px; padding:1.5rem; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(239,68,68,0.45); border:1px solid rgba(255,255,255,0.06); }
  .emergency-head { font-size:2.5rem; font-weight:900; letter-spacing:2px; margin-bottom:0.5rem; }
  .emergency-sub { font-size:1.25rem; margin-bottom:1rem; opacity:0.95; }
  #emergency-video { width:100%; height:360px; max-height:60vh; background:black; border-radius:12px; object-fit:cover; border:4px solid rgba(0,0,0,0.2); }
  #camera-fallback { width:100%; height:360px; background:black; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; opacity:1; }

  #coach-text { font-size:1.125rem; min-height:60px; margin-top:1rem; font-weight:700; }
  .typing { display:inline-block; }

  /* Breathing widget styles */
  @keyframes subtle-glow { 0% { box-shadow: 0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } 50% { box-shadow: 0 0 10px rgba(99,102,241,0.4), 0 0 30px rgba(99,102,241,0.2); } 100% { box-shadow:0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } }
  #breathingCircle { width:100%; height:100%; background: linear-gradient(135deg,#a5b4fc,#3b82f6); border-radius:50%; box-shadow:0 5px 15px rgba(0,0,0,0.1), 0 10px 30px rgba(0,0,0,0.05); transform: scale(0.3); will-change: transform, box-shadow; }
  .glowing { animation: subtle-glow 5s infinite alternate ease-in-out; }

  select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%236B7280' d='M10 12l-6-6h12z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position: right 0.75rem center; background-size:1.5em 1.5em; }

  #breathingContainer { display:flex; align-items:center; justify-content:center; width:70vw; height:70vw; max-width:300px; max-height:300px; margin:0 auto; }

</style>
</head>
<body>
<div id="app">
  <div id="notification" class="notif" role="alert" aria-live="polite"></div>

  <header class="appbar" role="banner" id="main-header" style="display:none">
    <div class="wrap">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div>
          <h1 class="flex heading" style="align-items:center;gap:0.625rem;font-size:1.75rem">
            <span>UNDO</span>
          </h1>
          <div id="greeting" class="small muted">Hey Friend!</div>
        </div>
        <div class="flex" style="gap:0.5rem;align-items:center">
          <button id="btn-burger" class="btn btn-ghost" title="Menu" aria-label="Open menu" style="display:none;font-size:1.25rem">‚ò∞</button>
          <div id="header-buttons" style="display:flex;gap:0.5rem;align-items:center">
            <button id="btn-home" class="btn btn-ghost" title="Go Home">üè†</button>
            <button id="btn-breathe" class="btn btn-ghost" title="Breathing Exercise" aria-label="Open breathing exercise">üå¨Ô∏è</button>
            <button id="btn-why" class="btn btn-ghost" title="Why I Relapsed">üìù</button>
            <button id="btn-analytics" class="btn btn-ghost" title="Analytics">üìä</button>
            <button id="btn-leaderboard" class="btn btn-ghost" title="Leaderboard">üèÜ</button>
            <button id="btn-dark" class="btn btn-ghost" title="Toggle Light/Dark Mode" aria-pressed="false">‚òÄÔ∏è</button>
            <button id="btn-login-toggle" class="btn btn-ghost" title="Sign in">üîê Login</button>
            <div id="user-chip" style="display:none;align-items:center;gap:0.5rem;padding:0.25rem 0.5rem;border-radius:999px;border:1px solid var(--border)"></div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:1.5rem">
    <section id="welcome" class="welcome-wrap">
      <div class="card" style="max-width:760px;padding:2rem;width:100%">
        <div id="welcome-loading" style="display:none;text-align:center">
          <div class="spin" style="width:4rem;height:4rem;border-radius:999px;border:0.375rem solid rgba(124,58,237,0.2);border-top-color:var(--accent-from);margin:0 auto 1.5rem"></div>
          <div id="loading-text" class="heading" style="font-size:1.25rem;animation:pulse 2s infinite"></div>
        </div>

        <div id="welcome-content">
          <div style="text-align:center;margin-bottom:2rem">
            <div style="font-size:4rem;margin-bottom:0.5rem">‚Ü©Ô∏è</div>
            <h2 class="heading" style="font-size:2.5rem;margin:0.5rem 0">UNDO</h2>
            <div class="small muted" style="font-size:1.125rem">Quit Bad. Build Good.</div>
          </div>

          <div id="question-wrap" class="flex" style="flex-direction:column;gap:1rem">
            <div>
              <p id="q-text" class="heading" style="font-size:1.5rem;margin-bottom:1rem">What's your name?</p>
              <div id="q-input-wrap"></div>
            </div>

            <div class="flex" style="gap:0.75rem">
              <button id="btn-back-question" class="btn btn-ghost" style="flex:1;display:none">Back</button>
              <button id="btn-next-question" class="btn btn-primary" style="flex:1">Continue</button>
            </div>

            <div id="dotbar" class="dotbar"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="app-main" style="display:none">
      <div id="dashboard-view">
        <!-- Discord Community Banner -->
        <a href="https://discord.gg/G93mYyyzYJ" target="_blank" rel="noopener noreferrer" style="text-decoration:none;display:block">
          <div class="discord-banner">
            <div style="font-size:2rem;margin-bottom:0.5rem">üí¨</div>
            <div style="font-size:1.5rem;font-weight:800;margin-bottom:0.5rem">Join Our Community!</div>
            <div style="margin-bottom:1rem;opacity:0.95">Connect with others on their journey. Share wins, get support, stay motivated.</div>
            <div class="discord-btn" style="display:inline-flex">
              <svg width="24" height="24" viewBox="0 0 71 55" fill="currentColor">
                <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
              </svg>
              Join Discord Server
            </div>
            <div style="margin-top:0.75rem;font-size:0.875rem;opacity:0.85">
              <span style="font-weight:700">üî• Live now:</span> Daily challenges, accountability partners & expert tips
            </div>
          </div>
        </a>

        <div class="cols">
          <div>
            <div class="section-header">
              <div class="section-title">
                <div style="font-size:1.5rem;color:var(--danger)">‚ùå</div>
                <div>
                  <div class="heading" style="font-size:1.5rem">Quit Habits (<span id="quit-count">0</span>)</div>
                  <div class="small muted">Track what you want to stop</div>
                </div>
              </div>
              <button id="add-quit" class="btn btn-danger">+ Add</button>
            </div>
            <div id="quit-list"></div>
          </div>

          <div>
            <div class="section-header">
              <div class="section-title">
                <div style="font-size:1.5rem;color:var(--green-from)">‚úÖ</div>
                <div>
                  <div class="heading" style="font-size:1.5rem">Build Habits (<span id="build-count">0</span>)</div>
                  <div class="small muted">Habits to build</div>
                </div>
              </div>
              <button id="add-build" class="btn btn-success">+ Add</button>
            </div>
            <div id="build-list"></div>
          </div>
        </div>
      </div>

      <div id="analytics-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üìä</span>
          Analytics
        </h2>
        
        <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
          <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
              <label class="small muted" for="habitSelectAnalytics" style="display:block;margin-bottom:0.5rem;font-weight:600">Select Habit</label>
              <select id="habitSelectAnalytics" aria-label="Select habit"></select>
            </div>
            <div>
              <label class="small muted" for="rangeSelect" style="display:block;margin-bottom:0.5rem;font-weight:600">Time Range</label>
              <select id="rangeSelect" aria-label="Select range">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
              </select>
            </div>
            <div style="margin-top:auto">
              <button id="exportCsv" class="btn btn-ghost">Export CSV</button>
              <button id="refreshAnalytics" class="btn btn-primary">Refresh</button>
            </div>
          </div>

          <div id="analyticsMain">
            <div id="kpiRow" class="analytics-header"></div>
            
            <div id="chartsWrap" class="chart-grid">
              <div class="chart-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                  <div class="small muted" style="font-weight:600">7-Day Trend</div>
                  <div id="chartTitle" class="small muted"></div>
                </div>
                <div class="chart-scroll">
                  <canvas id="chart7" class="fixed-chart" aria-label="7 day chart"></canvas>
                </div>
              </div>

              <div class="chart-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                  <div class="small muted" style="font-weight:600">Today - Hourly Progress</div>
                  <div class="small muted" id="hourSubtitle"></div>
                </div>
                <div class="chart-scroll">
                  <canvas id="chart24" class="fixed-chart" aria-label="24 hour chart"></canvas>
                </div>
              </div>
            </div>

            <div id="emptyState" class="empty" style="display:none;padding:3rem;text-align:center">
              <div style="font-size:3rem;opacity:0.3;margin-bottom:1rem">üìä</div>
              <p class="muted" style="font-size:1.125rem">No habits found. Add a habit to see analytics here.</p>
            </div>
          </div>
        </div>
      </div>

      <div id="why-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üìù</span>
          Why I Relapsed
        </h2>
        <div id="why-list"></div>
      </div>

      <div id="leaderboard-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üèÜ</span>
          Global Leaderboard
        </h2>
        
        <div class="card" style="padding:1.5rem;margin-bottom:1.5rem;background:linear-gradient(135deg,rgba(124,58,237,0.05),rgba(236,72,153,0.05))">
          <div style="text-align:center;margin-bottom:1rem">
            <div style="font-size:1.125rem;margin-bottom:0.5rem">üåü <strong>Join the Challenge!</strong></div>
            <div class="small muted">Compete with others on your journey to better habits</div>
          </div>
          
          <div id="leaderboard-join" style="display:none">
            <div style="display:flex;flex-direction:column;gap:1rem;max-width:400px;margin:0 auto">
              <input id="leaderboard-name" type="text" placeholder="Your display name" maxlength="30" />
              <input id="leaderboard-email" type="email" placeholder="Your email (optional, for verification)" />
              <div class="small muted" style="text-align:center">Your progress will be visible to others. Email is optional but helps prevent duplicates.</div>
              <button id="join-leaderboard-btn" class="btn btn-primary btn-wide">üöÄ Join Leaderboard</button>
            </div>
          </div>

          <div id="leaderboard-joined" style="display:none;text-align:center">
            <div style="font-size:1.125rem;margin-bottom:0.5rem">‚úÖ You're on the leaderboard as <strong id="leaderboard-display-name"></strong></div>
            <button id="leave-leaderboard-btn" class="btn btn-ghost">Leave Leaderboard</button>
          </div>
        </div>

        <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
          <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
              <label class="small muted" for="leaderboard-habit-select" style="display:block;margin-bottom:0.5rem;font-weight:600">Select Habit</label>
              <select id="leaderboard-habit-select"></select>
            </div>
            <div style="margin-top:auto">
              <button id="refresh-leaderboard" class="btn btn-primary">üîÑ Refresh</button>
            </div>
          </div>

          <div id="leaderboard-content">
            <div id="leaderboard-empty" style="text-align:center;padding:3rem">
              <div style="font-size:3rem;opacity:0.3;margin-bottom:1rem">üèÜ</div>
              <p class="muted">No leaderboard data yet. Be the first to join!</p>
            </div>

            <div id="leaderboard-table" style="display:none">
              <div style="margin-bottom:1rem;text-align:center">
                <div class="small muted">Top performers this month</div>
              </div>
              <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr style="border-bottom:2px solid var(--border)">
                      <th style="padding:0.75rem;text-align:left;font-weight:700">Rank</th>
                      <th style="padding:0.75rem;text-align:left;font-weight:700">Name</th>
                      <th style="padding:0.75rem;text-align:right;font-weight:700">Streak</th>
                      <th style="padding:0.75rem;text-align:right;font-weight:700">Best</th>
                      <th style="padding:0.75rem;text-align:right;font-weight:700">Clean Days</th>
                    </tr>
                  </thead>
                  <tbody id="leaderboard-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="small muted" style="text-align:center;padding:1rem">
          üîí Your email is private and never shared. Only your display name and stats are visible.
        </div>
      </div>
    </section>

    <!-- Breathing UI -->
    <section id="breathing-section" style="display:none; margin-top:1.5rem;">
      <div class="card" style="padding:1.5rem; max-width:760px; margin:0 auto;">
        <header style="text-align:center; margin-bottom:1rem;">
          <h2 class="heading" style="font-size:1.5rem">Breathwork Guide üå¨Ô∏è</h2>
        </header>

        <div style="text-align:center; margin-bottom:1rem;">
          <p id="statusText" class="heading" style="font-size:1.5rem">Ready</p>
          <p id="timerText" class="small muted" style="margin-top:0.25rem;"><span id="currentPhaseTime">Select a Mode</span></p>
        </div>

        <div id="breathingContainer" style="margin-bottom:1rem;">
            <div id="breathingCircle"></div>
        </div>

        <div style="display:grid; gap:0.75rem;">
          <div>
            <label for="modeSelector" class="small muted" style="display:block;margin-bottom:0.35rem;font-weight:700">Breathing Mode</label>
            <select id="modeSelector" style="padding:0.75rem;border-radius:12px;border:1px solid var(--border);background:var(--card)">
                <option value="coherence" selected>üòå Stress Coherence (5:5)</option>
                <option value="sleep">üò¥ Sleep Inducer (4:7:8)</option>
                <option value="box">üì¶ Calm Box Breathing (4:4:4:4)</option>
                <option value="calm">üí° Anxiety Focus (4:6:4)</option>
            </select>
          </div>

          <div>
            <label for="freqSelector" class="small muted" style="display:block;margin-bottom:0.35rem;font-weight:700">Background Frequency (Hz)</label>
            <select id="freqSelector" style="padding:0.75rem;border-radius:12px;border:1px solid var(--border);background:var(--card)">
                <option value="none">üîá No Sound</option>
                <option value="432">üéµ 432 Hz - Relaxation & Peace</option>
                <option value="528">üß¨ 528 Hz - Transformation & Repair</option>
                <option value="7.83">üåç 7.83 Hz - Schumann Resonance (Grounding)</option>
            </select>
          </div>

          <div style="display:flex;gap:0.5rem;">
            <button id="startButton" class="btn btn-primary btn-wide">‚ñ∂Ô∏è BEGIN SESSION</button>
            <button id="stopButton" class="btn btn-danger btn-wide" style="display:none">üõë END SESSION</button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <div id="add-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:1.5rem">
        <h3 class="heading" id="add-title" style="font-size:1.5rem">Add Habit</h3>
        <button id="close-add" class="btn btn-ghost" style="padding:0.5rem">‚úï</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <label class="small" for="add-name" style="display:block;margin-bottom:0.5rem;font-weight:600">Habit Name</label>
          <input id="add-name" placeholder="e.g., Smoking" />
        </div>
        <div id="add-category-wrap">
          <label class="small" style="display:block;margin-bottom:0.75rem;font-weight:600">Choose Category</label>
          <div id="add-category-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem"></div>
        </div>
        <div id="add-lasttime-wrap">
          <label class="small" style="display:block;margin-bottom:0.5rem;font-weight:600">Last time you did it</label>
          <input id="add-startdate" type="datetime-local" />
        </div>
        <div id="add-dailygoal-wrap" style="display:none">
          <label class="small" for="add-dailygoal" style="display:block;margin-bottom:0.5rem;font-weight:600">Daily Goal</label>
          <input id="add-dailygoal" type="number" min="1" max="100" value="1" />
          <div id="goal-unit" class="small muted" style="margin-top:0.25rem"></div>
        </div>
        <div id="add-custom-unit-wrap" style="display:none">
          <label class="small" for="add-custom-unit" style="display:block;margin-bottom:0.5rem;font-weight:600">Unit Type</label>
          <select id="add-custom-unit">
            <option value="times">Times</option>
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
            <option value="cups">Cups</option>
            <option value="glasses">Glasses</option>
            <option value="meals">Meals</option>
            <option value="pages">Pages</option>
            <option value="kg">Kilograms</option>
            <option value="lbs">Pounds</option>
          </select>
        </div>
        <div class="flex" style="gap:0.75rem;margin-top:0.5rem">
          <button id="cancel-add" class="btn btn-ghost" style="flex:1">Cancel</button>
          <button id="confirm-add" class="btn btn-primary" style="flex:1">Add Habit</button>
        </div>
      </div>
    </div>
  </div>

  <div id="relapse-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="align-items:center;gap:0.75rem;margin-bottom:1.5rem">
        <span style="font-size:2rem;color:var(--danger)">‚ö†Ô∏è</span>
        <h3 class="heading" style="font-size:1.5rem">Relapse</h3>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div class="flex" style="gap:0.75rem;align-items:center">
          <div id="relapse-emoji" style="font-size:2.5rem">üö¨</div>
          <div>
            <div id="relapse-name" class="heading" style="font-size:1.25rem">Smoking</div>
            <div id="relapse-since" class="small muted">You were clean for 0d</div>
          </div>
        </div>
        <div>
          <label class="small" for="relapse-note" style="display:block;margin-bottom:0.5rem;font-weight:600">What happened? Learning from this makes you stronger.</label>
          <textarea id="relapse-note" placeholder="What triggered it? How were you feeling? What can you do differently?"></textarea>
        </div>
        <div class="flex" style="gap:0.75rem">
          <button id="relapse-cancel" class="btn btn-ghost" style="flex:1">Cancel</button>
          <button id="relapse-confirm" class="btn btn-danger" style="flex:1">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <div id="login-overlay" class="modal-overlay" style="display:none">
    <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="login-title">
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
          <h3 id="login-title" class="heading" style="font-size:1.25rem">Sign in to sync your habits</h3>
          <button id="login-close" class="btn btn-ghost" style="padding:0.5rem">‚úï</button>
        </div>
        <div>
          <label class="small" for="login-email" style="display:block;margin-bottom:0.5rem;font-weight:600">Email</label>
          <input id="login-email" type="email" placeholder="you@example.com" />
        </div>
        <div style="display:flex;gap:0.5rem">
          <button id="login-send" class="btn btn-primary" style="flex:1">Send Magic Link</button>
          <button id="login-demo" class="btn btn-ghost" style="flex:1">Continue Offline</button>
        </div>
        <div id="login-helper" class="small muted">We use email magic links ‚Äì no passwords required.</div>
      </div>
    </div>
  </div>

  <div id="mobile-menu-overlay" role="dialog" aria-hidden="true">
    <div id="mobile-menu-panel">
      <div class="mobile-menu-header">
        <div class="mobile-user-name" id="mobile-user-name">Hey Friend!</div>
      </div>
      
      <div class="mobile-menu-nav">
        <button class="mobile-menu-item active" id="m-btn-home">
          <span class="mobile-menu-icon">üè†</span>
          <span>Dashboard</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-analytics">
          <span class="mobile-menu-icon">üìä</span>
          <span>Analytics</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-leaderboard">
          <span class="mobile-menu-icon">üèÜ</span>
          <span>Leaderboard</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-breathe">
          <span class="mobile-menu-icon">üå¨Ô∏è</span>
          <span>Breathwork</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-why">
          <span class="mobile-menu-icon">üìù</span>
          <span>Why I Relapsed</span>
        </button>
      </div>
      
      <div class="mobile-menu-footer">
        <button class="mobile-menu-item" id="m-btn-dark">
          <span class="mobile-menu-icon">üåô</span>
          <span>Dark Mode</span>
        </button>
      </div>
    </div>
  </div>

  <div id="emergency-overlay" role="alert" aria-hidden="true">
    <div class="emergency-card">
      <div class="emergency-head">YOU CAN DO IT</div>
      <div class="emergency-sub">You are stronger than your urges. Look at yourself ‚Äì you got this.</div>
      <div id="video-wrap" style="margin-bottom:1rem; position: relative;">
        <video id="emergency-video" autoplay muted playsinline></video>
        <div id="camera-fallback" style="display:none">Camera access denied</div>
      </div>
      <div id="coach-text"><span id="coach-line" class="typing"></span></div>
      <div class="emergency-actions">
        <button id="emergency-done" class="btn btn-emergency btn-done">‚úÖ I Did It</button>
        <button id="emergency-relapse" class="btn btn-emergency btn-relapsed">‚ùå I Relapsed</button>
      </div>
      <div style="margin-top:1rem;font-size:0.875rem;color:rgba(255,255,255,0.85)">Camera will help you see yourself and stay strong</div>
    </div>
  </div>
</div>

<!-- Supabase module -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://rovycvzndmdtgjehdthe.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvdnljdnpuZG1kdGdqZWhkdGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjAwMjEsImV4cCI6MjA3NjczNjAyMX0.Z6g6hmcU_qsR7oTTQGFbCvFTq4Oc6aDDvzvg3T79WB4'

export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, storage: localStorage }
});

window.supabase = supabase;
</script>

<!-- Chart.js for Analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Main application script -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const QUESTIONS = [
    { q: "What's your name?", placeholder: "Your name", type: "text" },
    { q: "What habit do you want to quit?", type: "select", options: [
      { label: "üö¨ Smoking", value: "Smoking" },
      { label: "üç∫ Drinking", value: "Drinking" },
      { label: "üç≠ Sugar/Sweets", value: "Sugar" },
      { label: "üì± Social Media", value: "Social Media" },
      { label: "‚è∞ Procrastination", value: "Procrastination" },
      { label: "üîû Porn", value: "Porn" },
      { label: "üéÆ Gaming", value: "Gaming" },
      { label: "üõçÔ∏è Shopping", value: "Shopping" },
      { label: "‚òï Caffeine", value: "Caffeine" },
      { label: "üì∫ TV/Netflix", value: "TV" },
      { label: "‚≠ê Other", value: "Other" }
    ]},
    { q: "What new habit would you like to build?", type: "select", options: [
      { label: "üí™ Exercise", value: "Exercise" },
      { label: "üìö Reading", value: "Reading" },
      { label: "üßò Meditation", value: "Meditation" },
      { label: "üíß Drink Water", value: "Water" },
      { label: "üò¥ Sleep Better", value: "Sleep" },
      { label: "üé® Creative Work", value: "Creative" },
      { label: "üå± Healthy Eating", value: "Healthy Eating" },
      { label: "üìì Journaling", value: "Journaling" },
      { label: "‚≠ê Other", value: "Other" }
    ]},
    { q: "Why do you want to change?", placeholder: "Tell us your motivation...", type: "text" },
    { q: "How old are you?", placeholder: "Your age", type: "number" }
  ];

  const LOADING_MESSAGES = [
    "Preparing your unique UNDO plan...",
    "Analyzing your motivation...",
    "Calibrating your journey path...",
    "Creating your personalized experience...",
    "Almost ready..."
  ];

  const HABIT_ICONS = {
    smoking: 'üö¨', drinking:'üç∫', sugar:'üç≠', social_media:'üì±', procrastination:'‚è∞',
    porn:'üîû', exercise:'üí™', reading:'üìö', meditation:'üßò', water:'üíß',
    sleep:'üò¥', gaming:'üéÆ', shopping:'üõçÔ∏è', caffeine:'‚òï', tv:'üì∫',
    other:'‚≠ê', healthy_eating:'üå±', healthy:'üå±', creative:'üé®', journaling:'üìì'
  };

  const CATEGORY_UNITS = {
    exercise: { default: 30, unit: 'minutes', max: 300 },
    reading: { default: 30, unit: 'minutes', max: 300 },
    meditation: { default: 10, unit: 'minutes', max: 120 },
    water: { default: 8, unit: 'cups', max: 20 },
    sleep: { default: 8, unit: 'hours', max: 12 },
    creative: { default: 30, unit: 'minutes', max: 300 },
    healthy_eating: { default: 3, unit: 'meals', max: 10 },
    journaling: { default: 15, unit: 'minutes', max: 120 },
    other: { default: 1, unit: 'custom', max: 100 }
  };

  const FIXING_STRATEGIES = {
    smoking: ['Use nicotine patches or gum','Keep your hands busy with a stress ball','Practice deep breathing when cravings hit','Chew gum or eat healthy snacks','Avoid triggers (coffee, alcohol, smoking areas)','Call a friend or support person','Go for a walk or exercise','Drink water slowly'],
    drinking: ['Have non-alcoholic alternatives ready','Avoid bars and drinking buddies initially','Find new social activities','Practice saying "no thanks"','Keep busy during usual drinking times','Join a support group (AA)','Remove alcohol from your home','Track how much money you save'],
    sugar: ['Replace with fruit when craving sweets','Eat protein to reduce cravings','Drink water first when craving sugar','Get enough sleep (reduces cravings)','Keep healthy snacks visible','Brush teeth after meals','Plan treats in advance','Read labels to avoid hidden sugar'],
    social_media: ['Delete apps from phone','Use website blockers','Turn off all notifications','Keep phone in another room','Set specific check-in times','Replace scrolling with reading','Use grayscale mode','Track screen time daily'],
    procrastination: ['Use the 2-minute rule (just start)','Break tasks into tiny steps','Set a timer for 25 minutes (Pomodoro)','Remove all distractions first','Do hardest task first thing','Create accountability (tell someone)','Reward yourself after completing tasks','Visualize the finished result'],
    porn: ['Install content filters and blockers','Keep devices in common areas','Identify your triggers','Exercise when urges hit','Cold shower technique','Call accountability partner','Practice mindfulness meditation','Join recovery community (NoFap, etc)','Seek professional therapy if needed','Replace habit with productive activity'],
    gaming: ['Uninstall games from devices','Set strict time limits','Find alternative hobbies','Exercise instead of gaming','Play only with real friends (scheduled)','Use parental controls','Keep gaming devices in another room','Track time spent gaming'],
    shopping: ['Unsubscribe from marketing emails','Use cash only (no cards)','Wait 48 hours before buying','Uninstall shopping apps','Make a list and stick to it','Calculate cost in hours worked','Find free activities','Track every purchase'],
    caffeine: ['Gradually reduce intake','Switch to decaf slowly','Drink herbal tea instead','Get enough sleep','Exercise for natural energy','Stay hydrated with water','Eat energy-boosting foods','Take short power naps'],
    tv: ['Cancel streaming subscriptions','Remove TV from bedroom','Set viewing time limits','Only watch with others','Replace with reading or hobbies','Unplug TV during week','Use app timers','Find outdoor activities'],
    other: ['Identify your specific triggers','Find healthier alternatives','Build a support system','Track your progress daily','Reward small victories','Practice self-compassion','Seek professional help if needed','Stay accountable to someone']
  };

  const MILESTONES = [1, 3, 7, 14, 30, 60, 90, 180, 365];
  const celebratedMilestones = new Set();

  let state = loadState() || {
    screen: 'welcome',
    page: 'dashboard',
    darkMode: false,
    showAddModal: false,
    habitType: 'quit',
    showRelapseModal: false,
    selectedHabitForRelapse: null,
    showBreathingModal: false,
    breathingTechnique: 'box',
    breathingActive: false,
    breathCounter: 4,
    breathCycle: 0,
    quitHabits: [],
    buildHabits: [],
    questionIndex: 0,
    answers: {},
    loading: false,
    userData: { name:'', quitHabit:'', buildHabit:'', why:'', age:'' },
    newHabit: {
      name:'', category:'smoking', startDate: new Date().toISOString(),
      dailyGoal:1, icon:'üö¨', unit: 'times'
    },
    hourlyProgress: {},
    weeklyAnalytics: {},
    dailyAnalytics: {},
    user: null,
    leaderboard: {
      joined: false,
      displayName: '',
      email: ''
    }
  };

  const $ = id => document.getElementById(id);

  function uid(){
    if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,10);
  }

  function saveState() {
    try {
      const toSave = {
        ...state,
        showAddModal: false,
        showRelapseModal: false,
        showBreathingModal: false,
        breathingActive: false
      };
      localStorage.setItem('undoAppState', JSON.stringify(toSave));
    } catch(e) {
      console.error('Failed to save state:', e);
    }
  }

  function loadState() {
    try {
      const saved = localStorage.getItem('undoAppState');
      if (saved) {
        const parsed = JSON.parse(saved);
        // Ensure leaderboard object exists
        if (!parsed.leaderboard) {
          parsed.leaderboard = {
            joined: false,
            displayName: '',
            email: ''
          };
        }
        return parsed;
      }
    } catch(e) {
      console.error('Failed to load state:', e);
    }
    return null;
  }

  function showNotification(msg, time=3000){
    const el = $('notification');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(()=>{ el.classList.remove('show'); }, time);
  }

  function celebrate(days, habitName) {
    const messages = {
      1: `üéâ 1 day clean from ${habitName}! You've started something amazing!`,
      3: `üåü 3 days! You're building momentum!`,
      7: `üî• One week! You're proving you can do this!`,
      14: `üíé 2 weeks! Your body is thanking you!`,
      30: `üèÜ 30 DAYS! This is HUGE! You're a champion!`,
      60: `üëë 2 months! You're unstoppable!`,
      90: `üöÄ 90 DAYS! You've broken the habit loop!`,
      180: `‚≠ê Half a year! You're a completely different person!`,
      365: `üéä ONE YEAR! You did it! Incredible achievement!`
    };

    const msg = messages[days] || `üéØ ${days} days clean!`;
    showNotification(msg, 5000);

    // Show Discord invite on major milestones
    if ([7, 30, 90].includes(days)) {
      setTimeout(() => {
        showDiscordMilestoneModal(days, habitName);
      }, 3000);
    }
  }

  function showDiscordMilestoneModal(days, habitName) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.style.display = 'flex';
    modal.style.zIndex = '100';
    
    modal.innerHTML = `
      <div class="modal card show" style="max-width:500px;text-align:center">
        <div style="font-size:3rem;margin-bottom:1rem">üéâ</div>
        <h3 class="heading" style="font-size:1.75rem;margin-bottom:1rem">${days} Days Achievement!</h3>
        <p style="margin-bottom:1.5rem;font-size:1.125rem">You've reached ${days} days clean from ${habitName}! This is incredible progress.</p>
        
        <div class="discord-banner" style="margin-bottom:1rem">
          <div style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem">üåü Celebrate with the Community!</div>
          <div style="margin-bottom:1rem;font-size:0.95rem">Share your win, inspire others, and get support from people who understand your journey.</div>
          <a href="https://discord.gg/G93mYyyzYJ" target="_blank" class="discord-btn" onclick="this.closest('.modal-overlay').remove()">
            <svg width="20" height="20" viewBox="0 0 71 55" fill="currentColor">
              <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
            </svg>
            Join Discord & Share Your Win
          </a>
        </div>
        
        <button class="btn btn-ghost btn-wide" onclick="this.closest('.modal-overlay').remove()">
          Maybe Later
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Auto-remove after 30 seconds if not interacted with
    setTimeout(() => {
      if (modal.parentNode) modal.remove();
    }, 30000);
  }

  const desktopHome = document.getElementById("btn-home");
  const mobileHome = document.getElementById("m-btn-home");

  function goHome() {
    state.page = "dashboard";
    const mobileOverlay = document.getElementById("mobile-menu-overlay");
    if (mobileOverlay) {
      mobileOverlay.classList.remove("show");
      mobileOverlay.setAttribute("aria-hidden", "true");
    }
    renderAll();
  }

  if (desktopHome) desktopHome.addEventListener("click", goHome);
  if (mobileHome) mobileHome.addEventListener("click", goHome);

  function formatCleanTime(startDate){
    const t = calculateTimeSince(startDate);
    if(t.days > 0) return `${t.days}d ${t.hours}h ${t.minutes}m`;
    if(t.hours > 0) return `${t.hours}h ${t.minutes}m ${t.seconds}s`;
    if(t.minutes > 0) return `${t.minutes}m ${t.seconds}s`;
    return `${t.seconds}s`;
  }

  function calculateTimeSince(startDate){
    const start = new Date(startDate);
    const now = new Date();
    const diff = Math.max(0, now - start);
    return {
      days: Math.floor(diff / (1000*60*60*24)),
      hours: Math.floor((diff % (1000*60*60*24)) / (1000*60*60)),
      minutes: Math.floor((diff % (1000*60*60)) / (1000*60)),
      seconds: Math.floor((diff % (1000*60)) / 1000),
      totalHours: Math.floor(diff / (1000*60*60))
    };
  }

  function calculateStreak(completions, goal){
    let streak=0;
    const today=new Date();
    for(let i=0;i<365;i++){
      const d=new Date(today);
      d.setDate(d.getDate()-i);
      const s=d.toISOString().split('T')[0];
      if((completions[s]||0) >= goal) streak++;
      else if(i>0) break;
    }
    return streak;
  }

  function getCalendarDays(habit){
    const days=[];
    const today=new Date();
    for(let i=29;i>=0;i--){
      const d=new Date(today);
      d.setDate(d.getDate()-i);
      const s=d.toISOString().split('T')[0];
      days.push({ date: s, completed: (habit.completions && habit.completions[s] || 0) >= habit.dailyGoal });
    }
    return days;
  }

  function updateAnalytics(habit, isRelapse = false) {
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const weekKey = getWeekKey(now);

    if (!state.dailyAnalytics[habit.id]) {
      state.dailyAnalytics[habit.id] = {};
    }
    if (!state.weeklyAnalytics[habit.id]) {
      state.weeklyAnalytics[habit.id] = {};
    }

    if (isRelapse) {
      state.dailyAnalytics[habit.id][dateStr] = {
        date: dateStr,
        status: 'relapsed',
        hours: calculateTimeSince(habit.startDate).totalHours
      };

      state.weeklyAnalytics[habit.id][weekKey] = {
        week: weekKey,
        relapseCount: (state.weeklyAnalytics[habit.id][weekKey]?.relapseCount || 0) + 1,
        totalHours: calculateTimeSince(habit.startDate).totalHours
      };
    } else {
      if (!state.dailyAnalytics[habit.id][dateStr]) {
        state.dailyAnalytics[habit.id][dateStr] = {
          date: dateStr,
          status: 'clean',
          hours: calculateTimeSince(habit.startDate).totalHours
        };
      }
    }

    saveState();
  }

  function getWeekKey(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(d.setDate(diff));
    return monday.toISOString().split('T')[0];
  }

  async function signInEmail(email) {
    try {
      const { error } = await window.supabase.auth.signInWithOtp({ email });
      if (error) throw error;
      return 'Check your email for the magic link.';
    } catch (err) {
      throw err;
    }
  }

  async function signOut() {
    try {
      const { error } = await window.supabase.auth.signOut();
      if (error) throw error;
      state.user = null;
      renderAuthUI();
      saveState();
    } catch (err) {
      console.error('Sign out error', err);
    }
  }

  function onAuthChange(callback) {
    window.supabase.auth.onAuthStateChange((event, session) => {
      callback(event, session);
    });
  }

  async function getCurrentUser() {
    try {
      const { data } = await window.supabase.auth.getUser();
      return data?.user || null;
    } catch (err) {
      console.warn('getCurrentUser error', err);
      return null;
    }
  }

  function serverRowToLocal(r) {
    return {
      id: r.id,
      name: r.name,
      icon: (r.meta && r.meta.icon) || HABIT_ICONS[r.category] || '‚≠ê',
      category: r.category,
      startDate: r.start_date || r.startDate || new Date().toISOString(),
      completions: r.completions || {},
      relapses: r.relapses || [],
      bestStreak: r.best_streak || 0,
      currentStreak: (r.meta && r.meta.currentStreak) || 0,
      dailyGoal: (r.meta && r.meta.dailyGoal) || (r.meta && r.meta.daily_goal) || 1,
      unit: (r.meta && r.meta.unit) || 'times',
      type: r.type || 'quit',
      meta: r.meta || {},
      created_at: r.created_at,
      updated_at: r.updated_at
    };
  }

  async function upsertLocalHabitsToServer() {
    if (!state.user) return;
    try {
      const toUpsert = [];
      const all = state.quitHabits.concat(state.buildHabits);
      all.forEach(h => {
        const payload = {
          id: h.id,
          user_id: state.user.id,
          type: h.type || (state.quitHabits.find(q => q.id===h.id) ? 'quit' : 'build'),
          name: h.name,
          category: h.category || null,
          start_date: h.startDate || h.start_date || new Date().toISOString(),
          completions: h.completions || {},
          relapses: h.relapses || [],
          best_streak: h.bestStreak || 0,
          meta: {
            ...h.meta,
            icon: h.icon,
            dailyGoal: h.dailyGoal,
            unit: h.unit,
            currentStreak: h.currentStreak
          }
        };
        toUpsert.push(payload);
      });

      for (let i = 0; i < toUpsert.length; i += 25) {
        const chunk = toUpsert.slice(i, i + 25);
        const { error } = await window.supabase.from('habits').upsert(chunk, { returning: 'minimal' });
        if (error) {
          console.warn('Upsert chunk error', error);
        }
      }
      return await loadHabitsFromServer();
    } catch (err) {
      console.error('Sync upsert error', err);
    }
  }

  async function loadHabitsFromServer() {
    if (!state.user) return [];
    try {
      const { data, error } = await window.supabase
        .from('habits')
        .select('*')
        .eq('user_id', state.user.id);

      if (error) {
        console.error('loadHabitsFromServer error', error);
        return [];
      }
      const rows = data.map(serverRowToLocal);
      const quit = rows.filter(r => r.type === 'quit');
      const build = rows.filter(r => r.type === 'build');
      state.quitHabits = quit.map(r => ({ ...r }));
      state.buildHabits = build.map(r => ({ ...r }));
      saveState();
      renderAll();
      return rows;
    } catch (err) {
      console.error('loadHabitsFromServer exception', err);
      return [];
    }
  }

  async function syncHabitsWithServer() {
    if (!navigator.onLine) {
      console.log('Offline: skipping server sync');
      return;
    }
    if (!state.user) {
      console.log('No user: skipping server sync');
      return;
    }
    try {
      await upsertLocalHabitsToServer();
      await loadHabitsFromServer();
      showNotification('Synced your habits ‚ú®', 1800);
    } catch (err) {
      console.warn('syncHabitsWithServer failed', err);
    }
  }

  async function maybeSyncSoon() {
    setTimeout(() => {
      if (state.user && navigator.onLine) {
        syncHabitsWithServer();
      } else {
        saveState();
      }
    }, 400);
  }

  onAuthChange(async (event, session) => {
    const user = session?.user || null;
    state.user = user;
    renderAuthUI();
    if (user) {
      await syncHabitsWithServer();
    }
    saveState();
  });

  (async function initAuthCheck(){
    try {
      const { data } = await window.supabase.auth.getSession();
      const user = data?.session?.user || null;
      state.user = user;
      renderAuthUI();
      if (user && navigator.onLine) {
        await syncHabitsWithServer();
      }
    } catch (err) {
      console.warn('initAuthCheck error', err);
    }
  })();

  function renderAuthUI() {
    const overlay = $('login-overlay');
    const loginToggle = $('btn-login-toggle');
    const userChip = $('user-chip');

    if(state.user){
      overlay.style.display = 'none';
      overlay.classList.remove('show');
      loginToggle.style.display = 'none';
      userChip.style.display = 'flex';
      userChip.textContent = state.user.email || state.user.user_metadata?.email || 'You';
      userChip.innerHTML = `${state.user.email || 'You'} <button id="btn-signout" class="btn btn-ghost" style="margin-left:0.5rem;padding:0.25rem 0.5rem">Sign out</button>`;
      const signoutBtn = document.getElementById('btn-signout');
      if(signoutBtn) signoutBtn.onclick = async () => {
        await signOut();
        showNotification('Signed out');
      };
    } else {
      userChip.style.display = 'none';
      loginToggle.style.display = 'inline-flex';
      loginToggle.textContent = 'üîê Login';
      loginToggle.onclick = () => {
        $('login-overlay').style.display = 'flex';
        setTimeout(()=> {
          $('login-overlay').classList.add('show');
          $('login-overlay').querySelector('.modal').classList.add('show');
          $('login-email').focus();
        }, 10);
      };
    }
  }

  $('login-send').addEventListener('click', async () => {
    const email = $('login-email').value.trim();
    if(!email) return alert('Enter your email');
    $('login-send').disabled = true;
    try {
      const { error } = await window.supabase.auth.signInWithOtp({ email });
      if (error) throw error;
      $('login-helper').textContent = 'Magic link sent ‚Äì check your email.';
    } catch (err) {
      console.error(err);
      $('login-helper').textContent = 'Error sending link: ' + (err.message || err);
    } finally {
      setTimeout(()=> $('login-send').disabled = false, 800);
    }
  });

  $('login-demo').addEventListener('click', () => {
    $('login-overlay').classList.remove('show');
    $('login-overlay').querySelector('.modal').classList.remove('show');
    setTimeout(()=> $('login-overlay').style.display='none', 300);
    showNotification('Continuing offline ‚Äì your data is stored locally', 2200);
  });

  $('login-close').addEventListener('click', () => {
    $('login-overlay').classList.remove('show');
    $('login-overlay').querySelector('.modal').classList.remove('show');
    setTimeout(()=> $('login-overlay').style.display='none', 300);
  });

  $('login-overlay').addEventListener('click', (e) => {
    if(e.target === $('login-overlay')) {
      $('login-overlay').classList.remove('show');
      $('login-overlay').querySelector('.modal').classList.remove('show');
      setTimeout(()=> $('login-overlay').style.display='none', 300);
    }
  });

  function renderAll(){
    if(state.darkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');

    $('greeting').textContent = `Hey ${state.userData.name || 'Friend'}!`;

    if(state.screen === 'welcome'){
      $('welcome').style.display = 'flex';
      $('app-main').style.display = 'none';
      $('main-header').style.display = 'none';
    } else {
      $('welcome').style.display = 'none';
      $('app-main').style.display = 'block';
      $('main-header').style.display = 'block';
    }

    $('quit-count').textContent = state.quitHabits.length;
    $('build-count').textContent = state.buildHabits.length;

    $('dashboard-view').style.display = state.page === 'dashboard' ? 'block' : 'none';
    $('analytics-page').style.display = state.page === 'analytics' ? 'block' : 'none';
    $('why-page').style.display = state.page === 'why' ? 'block' : 'none';
    $('leaderboard-page').style.display = state.page === 'leaderboard' ? 'block' : 'none';

    $('breathing-section').style.display = state.page === 'breathing' ? 'block' : 'none';

    renderQuitList();
    renderBuildList();
    renderWhyList();
    if(state.page === 'analytics') renderAnalytics();
    if(state.page === 'leaderboard') renderLeaderboard();
    renderQuestion();

    try {
      const greetEl = document.getElementById('greeting');
      if(greetEl){
        if(state.screen !== 'welcome' && state.page === 'dashboard'){
          greetEl.style.display = 'block';
          greetEl.style.fontSize = '1.125rem';
          greetEl.style.fontWeight = '800';
        } else {
          greetEl.style.display = 'none';
        }
      }
    } catch(e){}

    renderAuthUI();
    saveState();
  }

  function renderQuitList(){
    const container = $('quit-list');
    container.innerHTML = '';

    if(state.quitHabits.length === 0){
      const box = document.createElement('div');
      box.className = 'card';
      box.style.padding = '2.5rem';
      box.innerHTML = `<div style="text-align:center"><div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">‚ùå</div><p class="muted" style="font-size:1.125rem">No quit habits yet</p></div>`;
      container.appendChild(box);
      return;
    }

    state.quitHabits.forEach(habit => {
      const t = calculateTimeSince(habit.startDate);
      const card = document.createElement('div');
      card.className = 'habit-card card';

      const topSection = document.createElement('div');
      topSection.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem';
      topSection.innerHTML = `
        <div style="display:flex;gap:0.75rem;align-items:center">
          <div style="font-size:3rem">${habit.icon}</div>
          <div>
            <div class="heading" style="font-size:1.25rem">${habit.name}</div>
            <div class="small muted" style="margin-top:0.25rem">Since ${new Date(habit.startDate).toLocaleString()}</div>
          </div>
        </div>
      `;

      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-ghost';
      delBtn.style.padding = '0.5rem';
      delBtn.innerHTML = 'üóëÔ∏è';
      delBtn.onclick = async ()=>{
        if(confirm('Delete this habit?')){
          state.quitHabits = state.quitHabits.filter(h=>h.id !== habit.id);
          showNotification('Habit removed');
          saveState();
          await maybeSyncSoon();
          renderAll();
        }
      };
      topSection.appendChild(delBtn);

      const green = document.createElement('div');
      green.className = 'green-panel';
      green.setAttribute('data-habit-id', habit.id);
      green.setAttribute('data-start', habit.startDate);
      green.style.marginBottom = '1.25rem';
      green.innerHTML = `
        <div class="small" style="font-weight:600;margin-bottom:0.75rem">Clean for</div>
        <div style="font-size:2rem;font-weight:800;margin-bottom:1rem" data-clean-time>${formatCleanTime(habit.startDate)}</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem">
          <div class="stat-box" style="background:rgba(255,255,255,0.2)">
            <div style="font-size:1.5rem;font-weight:800" data-days>${t.days}</div>
            <div style="font-size:0.75rem">days</div>
          </div>
          <div class="stat-box" style="background:rgba(255,255,255,0.2)">
            <div style="font-size:1.5rem;font-weight:800" data-hours>${t.hours}</div>
            <div style="font-size:0.75rem">hrs</div>
          </div>
          <div class="stat-box" style="background:rgba(255,255,255,0.2)">
            <div style="font-size:1.5rem;font-weight:800" data-minutes>${t.minutes}</div>
            <div style="font-size:0.75rem">min</div>
          </div>
          <div class="stat-box" style="background:rgba(255,255,255,0.2)">
            <div style="font-size:1.5rem;font-weight:800" data-seconds>${t.seconds}</div>
            <div style="font-size:0.75rem">sec</div>
          </div>
        </div>
      `;

      const stats = document.createElement('div');
      stats.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem';
      stats.innerHTML = `
        <div class="stat-box yellow">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üèÜ</div>
          <div class="heading" style="font-size:1.5rem">${habit.bestStreak||0}</div>
          <div class="small muted">Best ${habit.bestStreak === 1 ? 'day' : 'days'}</div>
        </div>
        <div class="stat-box red">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üîÑ</div>
          <div class="heading" style="font-size:1.5rem">${(habit.relapses||[]).length}</div>
          <div class="small muted">Relapses</div>
        </div>
      `;

      const relapseBtn = document.createElement('button');
      relapseBtn.className = 'btn btn-danger btn-wide';
      relapseBtn.style.marginBottom = '1rem';
      relapseBtn.innerHTML = '<span style="font-size:1.125rem">üö®</span> I Will Relapse';
      relapseBtn.onclick = ()=> openEmergencyModal(habit);

      const details = document.createElement('details');
      details.style.cssText = 'padding:1rem;border-radius:12px;background:rgba(59,130,246,0.1)';
      const summary = document.createElement('summary');
      summary.style.cssText = 'cursor:pointer;font-weight:700;font-size:0.9375rem;list-style:none;display:flex;align-items:center;gap:0.5rem';
      summary.innerHTML = '<span style="font-size:1.25rem">üí°</span> How to Fix This';
      details.appendChild(summary);

      const ul = document.createElement('ul');
      ul.style.cssText = 'margin-top:0.75rem;padding-left:0;list-style:none';
      const strategies = FIXING_STRATEGIES[habit.category] || FIXING_STRATEGIES.other;
      strategies.forEach(s=>{
        const li = document.createElement('li');
        li.style.cssText = 'margin-bottom:0.625rem;font-size:0.875rem;display:flex;align-items:flex-start;gap:0.5rem;padding:0.5rem;border-radius:8px;background:rgba(255,255,255,0.5)';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.style.cssText = 'margin-top:0.125rem;cursor:pointer;width:1rem;height:1rem;flex-shrink:0';
        const label = document.createElement('span');
        label.textContent = s;
        label.style.cssText = 'flex:1';
        checkbox.addEventListener('change', (e) => {
          if(e.target.checked){
            label.style.textDecoration = 'line-through';
            label.style.opacity = '0.6';
          } else {
            label.style.textDecoration = 'none';
            label.style.opacity = '1';
          }
        });
        li.appendChild(checkbox);
        li.appendChild(label);
        ul.appendChild(li);
      });
      details.appendChild(ul);

      card.appendChild(topSection);
      card.appendChild(green);
      card.appendChild(stats);
      card.appendChild(relapseBtn);
      card.appendChild(details);
      container.appendChild(card);
    });
  }

  function renderBuildList(){
    const container = $('build-list');
    container.innerHTML='';

    if(state.buildHabits.length === 0){
      const box = document.createElement('div');
      box.className = 'card';
      box.style.padding = '2.5rem';
      box.innerHTML = `<div style="text-align:center"><div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">‚úÖ</div><p class="muted" style="font-size:1.125rem">No build habits yet</p></div>`;
      container.appendChild(box);
      return;
    }

    state.buildHabits.forEach(habit => {
      const today = (new Date()).toISOString().split('T')[0];
      const todayCount = (habit.completions && habit.completions[today]) || 0;
      const progress = Math.round((todayCount / habit.dailyGoal) * 100);

      const card = document.createElement('div');
      card.className = 'habit-card card';
      card.setAttribute('data-habit-id', habit.id);

      const topSection = document.createElement('div');
      topSection.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem';
      topSection.innerHTML = `
        <div style="display:flex;gap:0.75rem;align-items:center">
          <div style="font-size:3rem">${habit.icon}</div>
          <div>
            <div class="heading" style="font-size:1.25rem">${habit.name}</div>
            <div class="small muted" style="margin-top:0.25rem">Goal: ${habit.dailyGoal} ${habit.unit || 'times'}/day</div>
          </div>
        </div>
      `;

      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-ghost';
      delBtn.style.padding = '0.5rem';
      delBtn.innerHTML = 'üóëÔ∏è';
      delBtn.onclick = async ()=>{
        if(confirm('Delete this habit?')){
          state.buildHabits = state.buildHabits.filter(h=>h.id !== habit.id);
          showNotification('Habit removed');
          saveState();
          await maybeSyncSoon();
          renderAll();
        }
      };
      topSection.appendChild(delBtn);

      const progressSection = document.createElement('div');
      progressSection.style.marginBottom = '1.25rem';
      progressSection.innerHTML = `
        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
          <span class="small muted" style="font-weight:600">Today</span>
          <span class="heading" style="font-size:1.125rem" data-today-count>${todayCount}/${habit.dailyGoal} ${habit.unit || 'times'}</span>
        </div>
        <div style="height:1rem;border-radius:999px;background:var(--border);overflow:hidden">
          <div data-progress-bar style="height:100%;background:linear-gradient(90deg,var(--green-from),var(--green-to));width:${Math.min(100,progress)}%;transition:width 0.3s"></div>
        </div>
      `;

      const stats = document.createElement('div');
      stats.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem';
      stats.innerHTML = `
        <div class="stat-box orange">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üî•</div>
          <div class="heading" style="font-size:1.5rem">${habit.currentStreak||0}</div>
          <div class="small muted">Current</div>
        </div>
        <div class="stat-box yellow">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üèÜ</div>
          <div class="heading" style="font-size:1.5rem">${habit.bestStreak||0}</div>
          <div class="small muted">Best</div>
        </div>
      `;

      const calendarSection = document.createElement('div');
      calendarSection.style.marginBottom = '1.25rem';
      const calTitle = document.createElement('div');
      calTitle.className = 'small muted';
      calTitle.style.cssText = 'margin-bottom:0.75rem;font-weight:600';
      calTitle.textContent = 'Last 30 Days';
      calendarSection.appendChild(calTitle);

      const calGrid = document.createElement('div');
      calGrid.className = 'calendar-grid';
      const days = getCalendarDays(habit);
      days.forEach(d => {
        const dd = document.createElement('div');
        dd.className = 'day' + (d.completed ? ' done' : '');
        calGrid.appendChild(dd);
      });
      calendarSection.appendChild(calGrid);

      const toggleBtn = document.createElement('button');
      toggleBtn.className = `btn btn-wide ${todayCount>=habit.dailyGoal ? 'btn-ghost' : 'btn-success'}`;
      toggleBtn.innerHTML = todayCount>=habit.dailyGoal ? '‚úÖ Goal Complete!' : '‚úÖ Check In';
      toggleBtn.setAttribute('data-toggle', habit.id);
      toggleBtn.onclick = async ()=> {
        toggleBuildHabit(habit.id);
        await maybeSyncSoon();
      };

      if(habit.category === 'exercise') {
        const workoutDetails = document.createElement('details');
        workoutDetails.style.cssText = 'margin-top:1rem;padding:1rem;border-radius:12px;background:rgba(124,58,237,0.1)';
        const workoutSummary = document.createElement('summary');
        workoutSummary.style.cssText = 'cursor:pointer;font-weight:700;font-size:0.9375rem;list-style:none;display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem';
        workoutSummary.innerHTML = '<span style="font-size:1.25rem">üí°</span> Weekly Workout Plans';
        workoutDetails.appendChild(workoutSummary);

        const workoutContent = document.createElement('div');
        workoutContent.style.cssText = 'display:grid;grid-template-columns:1fr;gap:1rem';

        const homeWorkout = document.createElement('div');
        homeWorkout.style.cssText = 'padding:1rem;border-radius:8px;background:rgba(255,255,255,0.5);border:2px solid rgba(16,185,129,0.3)';
        homeWorkout.innerHTML = `
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
            <span style="font-size:1.5rem">üè†</span>
            <div class="heading" style="font-size:1rem">At Home Plan</div>
          </div>
          <div style="font-size:0.8125rem;line-height:1.6">
            <div style="margin-bottom:0.5rem"><strong>Monday:</strong> Push-ups (3√ó15), Squats (3√ó20), Plank (3√ó45s)</div>
            <div style="margin-bottom:0.5rem"><strong>Tuesday:</strong> Jumping Jacks (3√ó30), Lunges (3√ó15), Mountain Climbers (3√ó20)</div>
            <div style="margin-bottom:0.5rem"><strong>Wednesday:</strong> Rest or Light Yoga (20 min)</div>
            <div style="margin-bottom:0.5rem"><strong>Thursday:</strong> Burpees (3√ó10), Wall Sit (3√ó45s), High Knees (3√ó30)</div>
            <div style="margin-bottom:0.5rem"><strong>Friday:</strong> Push-ups (3√ó15), Bicycle Crunches (3√ó20), Jump Squats (3√ó15)</div>
            <div style="margin-bottom:0.5rem"><strong>Weekend:</strong> Long Walk/Jog (30-45 min) or Active Rest</div>
          </div>
        `;

        const gymWorkout = document.createElement('div');
        gymWorkout.style.cssText = 'padding:1rem;border-radius:8px;background:rgba(255,255,255,0.5);border:2px solid rgba(124,58,237,0.3)';
        gymWorkout.innerHTML = `
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
            <span style="font-size:1.5rem">üèãÔ∏è</span>
            <div class="heading" style="font-size:1rem">Gym Plan</div>
          </div>
          <div style="font-size:0.8125rem;line-height:1.6">
            <div style="margin-bottom:0.5rem"><strong>Monday:</strong> Chest & Triceps - Bench Press (3√ó10), Dumbbell Flyes (3√ó12), Tricep Dips (3√ó12)</div>
            <div style="margin-bottom:0.5rem"><strong>Tuesday:</strong> Back & Biceps - Pull-ups (3√ó8), Rows (3√ó10), Bicep Curls (3√ó12)</div>
            <div style="margin-bottom:0.5rem"><strong>Wednesday:</strong> Legs - Squats (3√ó10), Leg Press (3√ó12), Calf Raises (3√ó15)</div>
            <div style="margin-bottom:0.5rem"><strong>Thursday:</strong> Shoulders & Abs - Shoulder Press (3√ó10), Lateral Raises (3√ó12), Planks (3√ó60s)</div>
            <div style="margin-bottom:0.5rem"><strong>Friday:</strong> Full Body - Deadlifts (3√ó8), Push-ups (3√ó15), Squats (3√ó12)</div>
            <div style="margin-bottom:0.5rem"><strong>Weekend:</strong> Cardio (30 min) & Stretching or Rest</div>
          </div>
        `;

        workoutContent.appendChild(homeWorkout);
        workoutContent.appendChild(gymWorkout);
        workoutDetails.appendChild(workoutContent);

        card.appendChild(topSection);
        card.appendChild(progressSection);
        card.appendChild(stats);
        card.appendChild(calendarSection);
        card.appendChild(toggleBtn);
        card.appendChild(workoutDetails);
      } else {
        card.appendChild(topSection);
        card.appendChild(progressSection);
        card.appendChild(stats);
        card.appendChild(calendarSection);
        card.appendChild(toggleBtn);
      }

      container.appendChild(card);
    });
  }

  // NEW: Chart.js Analytics Rendering
  let chart7 = null;
  let chart24 = null;

  function renderAnalytics() {
    if(state.page !== 'analytics') return;

    populateHabitSelectorAnalytics();
    const selectedId = $('habitSelectAnalytics').value;
    const habit = findHabitById(selectedId);
    const range = parseInt($('rangeSelect').value, 10) || 30;

    if(!habit || (state.quitHabits.length === 0 && state.buildHabits.length === 0)) {
      $('kpiRow').innerHTML = '';
      $('chartsWrap').style.display = 'none';
      $('emptyState').style.display = '';
      return;
    }

    $('emptyState').style.display = 'none';
    $('chartsWrap').style.display = '';
    
    renderKPIs(habit, range);
    updateCharts(habit, range);
  }

  function populateHabitSelectorAnalytics() {
    const select = $('habitSelectAnalytics');
    select.innerHTML = '';
    const all = [].concat(state.buildHabits || [], state.quitHabits || []);
    if(all.length === 0){
      const opt = document.createElement('option'); 
      opt.value=''; 
      opt.textContent='No habits yet'; 
      select.appendChild(opt);
      return;
    }
    all.forEach(h => {
      const o = document.createElement('option'); 
      o.value = h.id; 
      o.textContent = h.name + (h.type === 'build' ? ' (build)' : ' (quit)');
      select.appendChild(o);
    });
    const prev = select.dataset.selected;
    if(prev){
      const found = Array.from(select.options).find(o=>o.value===prev);
      if(found) select.value = prev;
    }
  }

  function findHabitById(id){
    const all = [].concat(state.buildHabits || [], state.quitHabits || []);
    return all.find(h => h.id === id) || null;
  }

  function clamp0to100(v){
    if(typeof v !== 'number' || !isFinite(v)) return 0;
    if(v < 0) return 0;
    if(v > 100) return 100;
    return v;
  }

  function sanitizeArray(arr){
    return arr.map(v => clamp0to100(Number(v) || 0));
  }

  function lastNDates(n){
    const labels = [];
    const keys = [];
    for (let i = n-1; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      labels.push(d.toLocaleDateString(undefined, { weekday: 'short' }));
      keys.push(d.toISOString().split('T')[0]);
    }
    return { labels, keys };
  }

  function habit7Day(habit, n=7){
    const { labels, keys } = lastNDates(n);
    const data = keys.map(k => {
      if(!habit) return 0;
      if(habit.type === 'build'){
        const raw = (habit.completions && habit.completions[k]) || 0;
        const pct = Math.round((Number(raw) || 0) / (habit.dailyGoal || 1) * 100);
        return clamp0to100(pct);
      } else {
        // For quit habits: only show green if the day is AFTER the start date AND no relapse
        const habitStartDate = new Date(habit.startDate);
        const checkDate = new Date(k);
        
        // If the date is before the habit started, show 0 (not tracked yet)
        if(checkDate < habitStartDate) {
          return 0;
        }
        
        // If there was a relapse on this day, show 0
        const relapse = (habit.relapses || []).some(r => r.date && r.date.startsWith(k));
        return relapse ? 0 : 100;
      }
    });
    return { labels, data: sanitizeArray(data) };
  }

  function habit24Hour(habit){
    const labels = [];
    const data = [];
    for(let i=0;i<24;i++){ labels.push(i + 'h'); data.push(10); }

    if(!habit) return { labels, data };

    if(habit.type === 'quit' && habit.startDate){
      const hoursSince = Math.floor((Date.now() - new Date(habit.startDate)) / (1000*60*60));
      const passed = Math.max(0, Math.min(24, (hoursSince % 24) + 1));
      for(let i=0;i<24;i++) data[i] = (i < passed) ? 100 : 10;
    } else {
      const today = new Date().toISOString().split('T')[0];
      const raw = (habit.completions && habit.completions[today]) || 0;
      const pct = Math.round((Number(raw) || 0) / (habit.dailyGoal || 1) * 100);
      const p = clamp0to100(pct);
      const curHour = new Date().getHours();
      for(let i=0;i<24;i++) data[i] = (i === curHour) ? p : 10;
    }

    return { labels, data: sanitizeArray(data) };
  }

  function renderKPIs(habit, rangeDays){
    const kpiRow = $('kpiRow');
    kpiRow.innerHTML = '';
    const make = (title, value) => {
      const el = document.createElement('div');
      el.className = 'kpi';
      el.innerHTML = `<div class="small muted">${title}</div><div class="num">${value}</div>`;
      return el;
    };

    let total = 0, current = 0, best = 0, rel30 = 0;
    if(habit){
      if(habit.type === 'quit'){
        total = Math.floor((Date.now() - new Date(habit.startDate)) / (1000*60*60));
        current = Math.floor(total / 24);
        best = habit.bestStreak || 0;
        const since = new Date(); since.setDate(since.getDate()-30);
        rel30 = (habit.relapses || []).filter(r => new Date(r.date) >= since).length;
      } else {
        const now = new Date();
        let sum=0;
        for(let i=rangeDays-1;i>=0;i--){
          const d=new Date(now); d.setDate(d.getDate()-i); const key = d.toISOString().split('T')[0];
          sum += Number((habit.completions && habit.completions[key]) || 0);
        }
        total = sum;
        current = habit.currentStreak || 0;
        best = habit.bestStreak || 0;
        rel30 = (habit.relapses || []).filter(r => new Date(r.date) >= new Date(Date.now() - 30*86400000)).length;
      }
    }

    kpiRow.appendChild(make(habit && habit.type==='build' ? 'Total Completions' : 'Total Hours Clean', total));
    kpiRow.appendChild(make('Current Streak', current));
    kpiRow.appendChild(make('Best Streak', best));
    kpiRow.appendChild(make('Relapses (30d)', rel30));
  }

  function updateCharts(habit, rangeDays){
    if(!habit){
      $('chartsWrap').style.display = 'none';
      $('emptyState').style.display = '';
      return;
    }
    $('chartsWrap').style.display = '';
    $('emptyState').style.display = 'none';
    $('chartTitle').textContent = habit.name || '';
    $('hourSubtitle').textContent = new Date().toLocaleString();

    const d7 = habit7Day(habit, 7);
    const d24 = habit24Hour(habit);

    if(chart7){ try{ chart7.destroy(); }catch(e){} chart7 = null; }
    if(chart24){ try{ chart24.destroy(); }catch(e){} chart24 = null; }

    const ctx7 = document.getElementById('chart7').getContext('2d');
    chart7 = new Chart(ctx7, {
      type: 'bar',
      data: {
        labels: d7.labels,
        datasets: [{
          label: '7-day',
          data: d7.data,
          backgroundColor: d7.data.map(v => v >= 100 ? 'rgba(16,185,129,0.9)' : (v > 0 ? 'rgba(251,191,36,0.9)' : 'rgba(239,68,68,0.9)')),
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: { y: { beginAtZero: true, min: 0, max: 100, ticks: { callback: v => v + '%' } } },
        plugins: { legend: { display: false } }
      }
    });

    const ctx24 = document.getElementById('chart24').getContext('2d');
    chart24 = new Chart(ctx24, {
      type: 'bar',
      data: {
        labels: d24.labels,
        datasets: [{
          label: '24h',
          data: d24.data,
          backgroundColor: d24.data.map(v => v >= 80 ? 'rgba(16,185,129,0.9)' : 'rgba(148,163,184,0.9)'),
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: { y: { beginAtZero: true, min: 0, max: 100, ticks: { callback: v => v + '%' } } },
        plugins: { legend: { display: false } }
      }
    });
  }

  function exportCSV(){
    const habit = findHabitById($('habitSelectAnalytics').value);
    if(!habit){ alert('No habit selected'); return; }
    const days = parseInt($('rangeSelect').value, 10) || 30;
    const rows = ['date,completions,relapse_note'];
    for(let i=days-1;i>=0;i--){
      const d = new Date(); d.setDate(d.getDate() - i);
      const key = d.toISOString().split('T')[0];
      const completions = (habit.completions && habit.completions[key]) || 0;
      const relapse = (habit.relapses || []).find(r => r.date && r.date.startsWith(key));
      const note = relapse ? `"${String(relapse.note||'').replace(/"/g,'""')}"` : '';
      rows.push(`${key},${completions},${note}`);
    }
    const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = `${(habit.name||'habit').replace(/\s+/g,'_')}_analytics.csv`; 
    document.body.appendChild(a); 
    a.click(); 
    a.remove(); 
    URL.revokeObjectURL(url);
  }

  // Analytics event listeners
  if($('habitSelectAnalytics')) {
    $('habitSelectAnalytics').addEventListener('change', ()=> {
      $('habitSelectAnalytics').dataset.selected = $('habitSelectAnalytics').value;
      const habit = findHabitById($('habitSelectAnalytics').value);
      renderKPIs(habit, parseInt($('rangeSelect').value,10));
      updateCharts(habit, parseInt($('rangeSelect').value,10));
    });
  }

  if($('rangeSelect')) {
    $('rangeSelect').addEventListener('change', ()=> {
      const habit = findHabitById($('habitSelectAnalytics').value);
      renderKPIs(habit, parseInt($('rangeSelect').value,10));
      updateCharts(habit, parseInt($('rangeSelect').value,10));
    });
  }

  if($('exportCsv')) {
    $('exportCsv').addEventListener('click', exportCSV);
  }

  if($('refreshAnalytics')) {
    $('refreshAnalytics').addEventListener('click', renderAnalytics);
  }

  function renderWhyList(){
    const el = $('why-list');
    el.innerHTML = '';

    if(state.page !== 'why') return;

    const relapsed = state.quitHabits.filter(h=> (h.relapses && h.relapses.length>0));

    if(relapsed.length===0){
      const box = document.createElement('div');
      box.className='card';
      box.style.padding='2.5rem';
      box.innerHTML = `<div style="text-align:center"><div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">üìù</div><p class="muted" style="font-size:1.125rem;margin-bottom:0.5rem">No relapses recorded</p><p class="small muted">Stay strong!</p></div>`;
      el.appendChild(box);
      return;
    }

    relapsed.forEach(habit=>{
      const wrap = document.createElement('div');
      wrap.className='card';
      wrap.style.cssText = 'padding:1.5rem;margin-bottom:1.5rem';

      const header = document.createElement('div');
      header.style.cssText = 'display:flex;gap:0.75rem;align-items:center;margin-bottom:1.25rem';
      header.innerHTML = `
        <div style="font-size:2.5rem">${habit.icon}</div>
        <div>
          <div class="heading" style="font-size:1.25rem">${habit.name}</div>
          <div class="small muted">${(habit.relapses||[]).length} ${habit.relapses.length === 1 ? 'relapse' : 'relapses'}</div>
        </div>
      `;
      wrap.appendChild(header);

      (habit.relapses || []).slice().reverse().forEach(rel=>{
        const r = document.createElement('div');
        r.style.cssText = 'padding:1rem;border-radius:12px;margin-bottom:0.75rem;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.2)';
        r.innerHTML = `
          <div style="display:flex;justify-content:space-between;margin-bottom:0.75rem">
            <div>
              <div class="heading">${new Date(rel.date).toLocaleDateString()}</div>
              <div class="small muted" style="margin-top:0.25rem">Made it ${rel.daysSince} ${rel.daysSince===1?'day':'days'}</div>
            </div>
          </div>
          <div style="background:var(--card);padding:0.75rem;border-radius:8px;border:1px solid var(--border)">
            <div class="small muted" style="margin-bottom:0.25rem;font-weight:600">Why:</div>
            <div style="font-style:italic;font-size:0.9375rem">"${rel.note}"</div>
          </div>
        `;
        wrap.appendChild(r);
      });

      el.appendChild(wrap);
    });
  }

  function renderQuestion(){
    const idx = state.questionIndex;
    const q = QUESTIONS[idx];
    $('q-text').textContent = q.q;

    const wrap = $('q-input-wrap');
    wrap.innerHTML='';

    $('btn-back-question').style.display = idx > 0 ? 'inline-flex' : 'none';

    if(q.type === 'select'){
      const list = document.createElement('div');
      list.className = 'options-list';
      q.options.forEach(opt => {
        const b = document.createElement('button');
        b.textContent = opt.label || opt.value;
        b.onclick = ()=>{
          state.answers[idx] = opt.value || opt.label;
          setTimeout(()=> handleQuestionSubmit(), 200);
        };
        list.appendChild(b);
      });
      wrap.appendChild(list);
    } else {
      const input = document.createElement('input');
      input.type = q.type || 'text';
      input.placeholder = q.placeholder || '';
      input.value = state.answers[idx] || '';
      input.oninput = (e)=> state.answers[idx] = e.target.value;
      input.onkeydown = (e)=> { if(e.key==='Enter' && state.answers[idx]) handleQuestionSubmit(); };
      wrap.appendChild(input);
      setTimeout(()=>input.focus(),50);
    }

    const dots = $('dotbar');
    dots.innerHTML='';
    QUESTIONS.forEach((_,i)=>{
      const d = document.createElement('div');
      d.className = 'dot' + (i === idx || i < idx ? ' active' : '');
      dots.appendChild(d);
    });
  }

  function handleQuestionSubmit(){
    const idx = state.questionIndex;
    const answer = state.answers[idx];
    if(!answer) return;

    if(idx < QUESTIONS.length - 1){
      state.questionIndex++;
      renderQuestion();
    } else {
      state.loading = true;
      $('welcome-loading').style.display='block';
      $('welcome-content').style.display='none';

      let msgIdx = 0;
      $('loading-text').textContent = LOADING_MESSAGES[msgIdx];

      const li = setInterval(()=>{
        msgIdx++;
        if(msgIdx < LOADING_MESSAGES.length){
          $('loading-text').textContent = LOADING_MESSAGES[msgIdx];
        } else {
          clearInterval(li);

          state.userData = {
            name: state.answers[0] || 'Friend',
            quitHabit: state.answers[1] || '',
            buildHabit: state.answers[2] || '',
            why: state.answers[3] || '',
            age: state.answers[4] || ''
          };

          if(state.answers[1]){
            const cat = state.answers[1].toLowerCase().replace(/\s+/g,'_').replace(/\//g,'_');
            state.quitHabits = [{
              id: uid(),
              name: state.answers[1],
              icon: HABIT_ICONS[cat] || 'üö¨',
              startDate: new Date().toISOString(),
              relapses: [],
              bestStreak:0,
              category:cat,
              currentStreak:0,
              type: 'quit'
            }];
          }

          if(state.answers[2]){
            const bc = state.answers[2].toLowerCase().replace(/\s+/g,'_');
            const unitInfo = CATEGORY_UNITS[bc] || CATEGORY_UNITS.other;
            state.buildHabits = [{
              id: uid(),
              name: state.answers[2],
              icon: HABIT_ICONS[bc] || 'üí™',
              dailyGoal: unitInfo.default,
              unit: unitInfo.unit,
              completions:{},
              currentStreak:0,
              bestStreak:0,
              category:bc,
              type: 'build'
            }];
          }

          state.loading=false;
          $('welcome-loading').style.display='none';
          $('welcome-content').style.display='block';
          state.screen = 'dashboard';
          saveState();
          renderAll();
          maybeSyncSoon();
          
          // Show Discord invite after onboarding
          setTimeout(() => {
            showWelcomeDiscordModal();
          }, 2000);
        }
      }, 1500);
    }
  }

  function showWelcomeDiscordModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.style.display = 'flex';
    modal.style.zIndex = '100';
    
    modal.innerHTML = `
      <div class="modal card show" style="max-width:500px;text-align:center">
        <div style="font-size:3rem;margin-bottom:1rem">üëã</div>
        <h3 class="heading" style="font-size:1.75rem;margin-bottom:1rem">Welcome to UNDO!</h3>
        <p style="margin-bottom:1.5rem;font-size:1.125rem">You're not alone on this journey. Thousands are using UNDO to transform their lives.</p>
        
        <div class="discord-banner" style="margin-bottom:1rem">
          <div style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem">üí¨ Join Our Community</div>
          <div style="margin-bottom:1rem;font-size:0.95rem">
            ‚úÖ Get daily motivation & accountability<br>
            ‚úÖ Share wins and challenges<br>
            ‚úÖ Connect with people who understand<br>
            ‚úÖ Access expert tips & resources
          </div>
          <a href="https://discord.gg/G93mYyyzYJ" target="_blank" class="discord-btn" onclick="this.closest('.modal-overlay').remove()">
            <svg width="20" height="20" viewBox="0 0 71 55" fill="currentColor">
              <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
            </svg>
            Join Free Discord Community
          </a>
        </div>
        
        <button class="btn btn-ghost btn-wide" onclick="this.closest('.modal-overlay').remove()">
          Start My Journey
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  function openAddModal(type){
    state.habitType = type;
    state.showAddModal = true;

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());

    state.newHabit = {
      name:'',
      category: type==='quit' ? 'smoking' : 'exercise',
      startDate: now.toISOString().slice(0, 16),
      dailyGoal: type==='quit' ? 1 : (CATEGORY_UNITS['exercise']?.default || 1),
      icon: type==='quit' ? 'üö¨' : 'üí™',
      unit: type==='quit' ? 'times' : 'minutes'
    };

    $('add-title').textContent = `Add ${type === 'quit' ? 'Quit' : 'Build'} Habit`;
    $('add-name').value = '';
    $('add-startdate').value = state.newHabit.startDate;
    $('add-dailygoal').value = state.newHabit.dailyGoal;

    const grid = $('add-category-grid');
    grid.innerHTML = '';

    let categories = [];
    if(type === 'quit'){
      categories = [
        {cat:'smoking', label:'üö¨ Smoking'},
        {cat:'drinking', label:'üç∫ Drinking'},
        {cat:'sugar', label:'üç≠ Sugar'},
        {cat:'social_media', label:'üì± Social Media'},
        {cat:'procrastination', label:'‚è∞ Procrastination'},
        {cat:'porn', label:'üîû Porn'},
        {cat:'gaming', label:'üéÆ Gaming'},
        {cat:'shopping', label:'üõçÔ∏è Shopping'},
        {cat:'caffeine', label:'‚òï Caffeine'},
        {cat:'tv', label:'üì∫ TV'},
        {cat:'other', label:'‚≠ê Other'}
      ];
      $('add-lasttime-wrap').style.display='block';
      $('add-dailygoal-wrap').style.display='none';
      $('add-custom-unit-wrap').style.display='none';
    } else {
      categories = [
        {cat:'exercise', label:'üí™ Exercise'},
        {cat:'reading', label:'üìö Reading'},
        {cat:'meditation', label:'üßò Meditation'},
        {cat:'water', label:'üíß Water'},
        {cat:'sleep', label:'üò¥ Sleep'},
        {cat:'creative', label:'üé® Creative'},
        {cat:'healthy_eating', label:'üå± Healthy Eating'},
        {cat:'journaling', label:'üìì Journaling'},
        {cat:'other', label:'‚≠ê Other'}
      ];
      $('add-lasttime-wrap').style.display='none';
      $('add-dailygoal-wrap').style.display='block';
      $('add-custom-unit-wrap').style.display='none';

      const unitInfo = CATEGORY_UNITS[state.newHabit.category] || CATEGORY_UNITS.other;
      $('add-dailygoal').value = unitInfo.default;
      $('add-dailygoal').max = unitInfo.max;
      $('goal-unit').textContent = `${unitInfo.unit} per day`;
    }

    categories.forEach(item => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-ghost';
      btn.style.cssText = 'padding:1rem;border:2px solid var(--border);text-align:center;transition:all 0.2s';
      btn.textContent = item.label;
      btn.onclick = ()=>{
        grid.querySelectorAll('button').forEach(b => {
          b.style.borderColor = 'var(--border)';
          b.style.background = 'transparent';
        });
        btn.style.borderColor = type === 'quit' ? 'var(--danger)' : 'var(--green-from)';
        btn.style.background = type === 'quit' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';

        state.newHabit.category = item.cat;
        state.newHabit.icon = HABIT_ICONS[item.cat] || (type === 'quit' ? 'üö¨' : 'üí™');

        if(type === 'build') {
          if(item.cat === 'other') {
            $('add-custom-unit-wrap').style.display='block';
            $('goal-unit').textContent = 'Select your unit type';
            state.newHabit.unit = 'times';
          } else {
            $('add-custom-unit-wrap').style.display='none';
            const unitInfo = CATEGORY_UNITS[item.cat] || CATEGORY_UNITS.other;
            $('add-dailygoal').value = unitInfo.default;
            $('add-dailygoal').max = unitInfo.max;
            state.newHabit.dailyGoal = unitInfo.default;
            state.newHabit.unit = unitInfo.unit;
            $('goal-unit').textContent = `${unitInfo.unit} per day`;
          }
        }
      };

      if(item.cat === state.newHabit.category){
        btn.style.borderColor = type === 'quit' ? 'var(--danger)' : 'var(--green-from)';
        btn.style.background = type === 'quit' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
      }

      grid.appendChild(btn);
    });

    $('add-custom-unit').addEventListener('change', (e) => {
      state.newHabit.unit = e.target.value;
    });

    $('add-modal').style.display='flex';
    setTimeout(()=>{
      $('add-modal').classList.add('show');
      $('add-modal').querySelector('.modal').classList.add('show');
    }, 10);
  }

  function closeAddModal(){
    $('add-modal').classList.remove('show');
    $('add-modal').querySelector('.modal').classList.remove('show');
    setTimeout(()=>{
      $('add-modal').style.display='none';
    }, 300);
  }

  async function confirmAddHabit(){
    const name = $('add-name').value.trim();
    if(!name) return;

    const icon = state.newHabit.icon;

    if(state.habitType === 'quit'){
      const startDateTime = $('add-startdate').value;
      const h = {
        id: uid(),
        name,
        icon,
        startDate: new Date(startDateTime).toISOString(),
        relapses:[],
        bestStreak:0,
        category: state.newHabit.category,
        currentStreak:0,
        type: 'quit'
      };
      state.quitHabits.push(h);
      showNotification(`"${name}" added! üéØ`);
    } else {
      const daily = Math.max(1, parseInt($('add-dailygoal').value) || 1);
      const unit = state.newHabit.category === 'other' ? $('add-custom-unit').value : state.newHabit.unit;
      const h = {
        id: uid(),
        name,
        icon,
        dailyGoal: daily,
        unit: unit,
        completions:{},
        currentStreak:0,
        bestStreak:0,
        category: state.newHabit.category,
        type: 'build'
      };
      state.buildHabits.push(h);
      showNotification(`"${name}" added! üí™`);
    }

    closeAddModal();
    saveState();
    renderAll();
    await maybeSyncSoon();
  }

  function openRelapseModal(habit){
    state.showRelapseModal = true;
    state.selectedHabitForRelapse = habit;

    $('relapse-emoji').textContent = habit.icon;
    $('relapse-name').textContent = habit.name;
    $('relapse-since').textContent = `You were clean for ${formatCleanTime(habit.startDate)}`;
    $('relapse-note').value = '';

    $('relapse-modal').style.display='flex';
    setTimeout(()=>{
      $('relapse-modal').classList.add('show');
      $('relapse-modal').querySelector('.modal').classList.add('show');
    }, 10);
  }

  function closeRelapseModal(){
    $('relapse-modal').classList.remove('show');
    $('relapse-modal').querySelector('.modal').classList.remove('show');
    setTimeout(()=>{
      $('relapse-modal').style.display='none';
      state.selectedHabitForRelapse = null;
    }, 300);
  }

  async function confirmRelapse(){
    const note = $('relapse-note').value.trim() || 'No note provided';
    const habit = state.selectedHabitForRelapse;
    if(!habit) return;

    const timeSince = calculateTimeSince(habit.startDate);
    const totalDays = timeSince.days;

    const relapse = {
      date: (new Date()).toISOString(),
      daysSince: totalDays,
      note,
      cleanTime: formatCleanTime(habit.startDate)
    };

    state.quitHabits = state.quitHabits.map(h => {
      if(h.id === habit.id){
        const updated = {...h};
        updated.relapses = [...(h.relapses||[]), relapse];
        updated.bestStreak = Math.max(updated.bestStreak || 0, totalDays);
        updated.startDate = (new Date()).toISOString();
        updated.currentStreak = 0;
        updateAnalytics(updated, true);
        return updated;
      }
      return h;
    });

    closeRelapseModal();
    showNotification('Logged. Tomorrow is new! üí™');
    saveState();
    await maybeSyncSoon();
    
    // Sync to leaderboard if joined
    if (state.leaderboard && state.leaderboard.joined) {
      await syncLeaderboardEntry();
    }
    
    renderAll();
  }

  async function toggleBuildHabit(id){
    const today = (new Date()).toISOString().split('T')[0];

    state.buildHabits = state.buildHabits.map(h => {
      if(h.id === id){
        const completions = {...(h.completions || {})};
        const current = completions[today] || 0;

        if(current >= h.dailyGoal){
          completions[today] = 0;
          showNotification('Reset for today');
        } else {
          completions[today] = h.dailyGoal;
          showNotification('‚úÖ Goal complete!');
        }

        const streak = calculateStreak(completions, h.dailyGoal);
        const best = Math.max(h.bestStreak||0, streak);

        if(streak > (h.bestStreak||0) && streak > 0){
          showNotification(`üî• New best: ${streak} days!`);
        }

        return {...h, completions, currentStreak: streak, bestStreak: best};
      }
      return h;
    });

    saveState();
    await maybeSyncSoon();
    
    // Sync to leaderboard if joined
    if (state.leaderboard && state.leaderboard.joined) {
      await syncLeaderboardEntry();
    }
    
    renderAll();
  }

  function updateTimers(){
    document.querySelectorAll('.green-panel[data-habit-id]').forEach(panel => {
      const start = panel.getAttribute('data-start');
      const t = calculateTimeSince(start);

      const cleanEl = panel.querySelector('[data-clean-time]');
      const daysEl = panel.querySelector('[data-days]');
      const hoursEl = panel.querySelector('[data-hours]');
      const minsEl = panel.querySelector('[data-minutes]');
      const secsEl = panel.querySelector('[data-seconds]');

      if(cleanEl) cleanEl.textContent = formatCleanTime(start);
      if(daysEl) daysEl.textContent = t.days;
      if(hoursEl) hoursEl.textContent = t.hours;
      if(minsEl) minsEl.textContent = t.minutes;
      if(secsEl) secsEl.textContent = t.seconds;
    });

    if(state.showRelapseModal && state.selectedHabitForRelapse){
      $('relapse-since').textContent = `You were clean for ${formatCleanTime(state.selectedHabitForRelapse.startDate)}`;
    }

    document.querySelectorAll('[data-habit-id]').forEach(holder=>{
      const id = holder.getAttribute('data-habit-id');
      const build = state.buildHabits.find(h=>h.id===id);

      if(build){
        const today = (new Date()).toISOString().split('T')[0];
        const todayCount = (build.completions && build.completions[today]) || 0;

        const countEl = holder.querySelector('[data-today-count]');
        if(countEl) countEl.textContent = `${todayCount}/${build.dailyGoal} ${build.unit || 'times'}`;

        const bar = holder.querySelector('[data-progress-bar]');
        if(bar){
          const progress = Math.round((todayCount / build.dailyGoal) * 100);
          bar.style.width = Math.min(100, progress) + '%';
        }

        const toggleBtn = holder.querySelector('[data-toggle]');
        if(toggleBtn){
          toggleBtn.textContent = todayCount>=build.dailyGoal ? '‚úÖ Goal Complete!' : '‚úÖ Check In';
          toggleBtn.className = `btn btn-wide ${todayCount>=build.dailyGoal ? 'btn-ghost' : 'btn-success'}`;
        }
      }
    });
  }

  function checkMilestones(){
    state.quitHabits.forEach(habit => {
      const timeSince = calculateTimeSince(habit.startDate);
      const totalDays = timeSince.days;

      if(MILESTONES.includes(totalDays)){
        const milestoneKey = `milestone_${habit.id}_${totalDays}`;

        if(!celebratedMilestones.has(milestoneKey)){
          celebratedMilestones.add(milestoneKey);
          celebrate(totalDays, habit.name);
        }
      }
    });
  }

  $('btn-back-question').addEventListener('click', ()=>{
    if(state.questionIndex>0){
      state.questionIndex--;
      renderQuestion();
    }
  });

  $('btn-next-question').addEventListener('click', handleQuestionSubmit);

  $('add-quit').addEventListener('click', ()=> { state.page = 'dashboard'; openAddModal('quit'); });
  $('add-build').addEventListener('click', ()=> { state.page = 'dashboard'; openAddModal('build'); });
  $('close-add').addEventListener('click', closeAddModal);
  $('cancel-add').addEventListener('click', closeAddModal);
  $('confirm-add').addEventListener('click', confirmAddHabit);

  $('relapse-cancel').addEventListener('click', closeRelapseModal);
  $('relapse-confirm').addEventListener('click', confirmRelapse);

  $('btn-breathe').addEventListener('click', ()=> {
    state.page = 'breathing';
    renderAll();
    setTimeout(()=> {
      const el = document.getElementById('breathing-section');
      if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  });

  $('btn-analytics').addEventListener('click', ()=>{
    state.page = 'analytics';
    renderAll();
  });

  $('btn-why').addEventListener('click', ()=>{
    state.page = 'why';
    renderAll();
  });

  $('btn-leaderboard').addEventListener('click', ()=>{
    state.page = 'leaderboard';
    renderAll();
  });

  $('btn-dark').addEventListener('click', ()=>{
    state.darkMode = !state.darkMode;
    $('btn-dark').textContent = state.darkMode ? '‚òÄÔ∏è' : 'üåô';
    $('btn-dark').setAttribute('aria-pressed', String(state.darkMode));
    renderAll();
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(state.showAddModal) closeAddModal();
      if(state.showRelapseModal) closeRelapseModal();
    }
  });

  window.addEventListener('online', async () => {
    if (state.user) {
      await syncHabitsWithServer();
    }
  });

  setInterval(()=>{
    if(state.screen === 'dashboard'){
      updateTimers();
      checkMilestones();
    }
  }, 1000);

  function init(){
    renderAll();
  }

  init();

  window.UNDO = { state, renderAll, sync: async () => { await syncHabitsWithServer(); } };

  try {
    const burger = document.getElementById('btn-burger');
    const mobileOverlay = document.getElementById('mobile-menu-overlay');

    if(burger && mobileOverlay){
      burger.addEventListener('click', ()=> {
        mobileOverlay.classList.toggle('show');
        if(mobileOverlay.classList.contains('show')) {
          mobileOverlay.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
        } else {
          mobileOverlay.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
        }
      });

      // Close when clicking overlay background
      mobileOverlay.addEventListener('click', (e) => {
        if(e.target === mobileOverlay) {
          mobileOverlay.classList.remove('show');
          mobileOverlay.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
        }
      });

      // Update user info in mobile menu
      function updateMobileUserInfo() {
        const mobileUserName = document.getElementById('mobile-user-name');
        
        if (mobileUserName) {
          const name = state.userData.name || 'Friend';
          mobileUserName.textContent = `Hey ${name}!`;
        }
      }

      // Call on state changes
      const originalRenderAll = renderAll;
      renderAll = function() {
        originalRenderAll();
        updateMobileUserInfo();
      };

      // Set active menu item
      function setActiveMobileMenuItem(page) {
        document.querySelectorAll('.mobile-menu-item').forEach(item => {
          item.classList.remove('active');
        });
        
        const pageMap = {
          'dashboard': 'm-btn-home',
          'analytics': 'm-btn-analytics',
          'leaderboard': 'm-btn-leaderboard',
          'breathing': 'm-btn-breathe',
          'why': 'm-btn-why'
        };
        
        const activeBtn = document.getElementById(pageMap[page]);
        if (activeBtn) activeBtn.classList.add('active');
      }

      document.getElementById('m-btn-home').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        state.page='dashboard'; 
        setActiveMobileMenuItem('dashboard');
        renderAll(); 
      });
      document.getElementById('m-btn-breathe').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        state.page='breathing';
        setActiveMobileMenuItem('breathing');
        renderAll();
      });
      document.getElementById('m-btn-why').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        state.page='why'; 
        setActiveMobileMenuItem('why');
        renderAll(); 
      });
      document.getElementById('m-btn-analytics').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        state.page='analytics'; 
        setActiveMobileMenuItem('analytics');
        renderAll(); 
      });
      document.getElementById('m-btn-leaderboard').addEventListener('click', ()=> { 
        mobileOverlay.classList.remove('show'); 
        mobileOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        state.page='leaderboard'; 
        setActiveMobileMenuItem('leaderboard');
        renderAll(); 
      });
      document.getElementById('m-btn-dark').addEventListener('click', ()=> { 
        state.darkMode = !state.darkMode;
        const icon = document.querySelector('#m-btn-dark .mobile-menu-icon');
        if (icon) icon.textContent = state.darkMode ? '‚òÄÔ∏è' : 'üåô';
        renderAll();
      });
      
      updateMobileUserInfo();
    }
  } catch(e){}

  let emergencyStream = null;
  const COACH_LINES = [
    "You're stronger than this craving.",
    "Remember why you started this journey.",
    "Take a deep breath. This moment will pass.",
    "You've come so far. Don't give up now.",
    "Your future self will thank you for resisting.",
    "One craving at a time. You can do this.",
    "Think about how proud you'll feel tomorrow.",
    "You are in control, not the addiction."
  ];
  let coachIndex = 0;
  let typingInterval = null;
  let currentText = '';
  let targetText = '';
  let charIndex = 0;

  function openEmergencyModal(habit){
    try {
      const overlay = document.getElementById('emergency-overlay');
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');

      const video = document.getElementById('emergency-video');
      const fallback = document.getElementById('camera-fallback');
      video.style.display = 'block';
      fallback.style.display = 'none';

      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false })
          .then(stream => {
            emergencyStream = stream;
            try { video.srcObject = stream; } catch(e){ video.src = URL.createObjectURL(stream); }
            video.play().catch(()=>{});
          })
          .catch(err => {
            console.warn('Camera access denied or failed', err);
            video.style.display = 'none';
            fallback.style.display = 'flex';
            fallback.style.background = 'black';
          });
      } else {
        video.style.display = 'none';
        fallback.style.display = 'flex';
      }

      startCoachTyping();

      document.getElementById('emergency-done').onclick = async ()=> {
        closeEmergencyModal();
        showNotification('Well done ‚Äì keep going! üí™');
        try {
          if(state.user) {
            await window.supabase.from('events').insert({ user_id: state.user.id, event_type: 'emergency_done', payload: { habit: habit?.name || null } });
          }
        } catch (e) {}
      };

      document.getElementById('emergency-relapse').onclick = async ()=> {
        if(habit){
          const timeSince = calculateTimeSince(habit.startDate);
          const totalDays = timeSince.days;
          const relapse = { 
            date: (new Date()).toISOString(), 
            daysSince: totalDays, 
            note: 'Emergency relapse logged', 
            cleanTime: formatCleanTime(habit.startDate) 
          };
          state.quitHabits = state.quitHabits.map(h => {
            if(h.id === habit.id){
              const updated = {...h};
              updated.relapses = [...(h.relapses||[]), relapse];
              updated.bestStreak = Math.max(updated.bestStreak || 0, totalDays);
              updated.startDate = (new Date()).toISOString();
              updated.currentStreak = 0;
              updateAnalytics(updated, true);
              return updated;
            }
            return h;
          });
          showNotification('Relapse logged. New start recorded.');
          saveState();
          await maybeSyncSoon();
          renderAll();
        }
        closeEmergencyModal();
      };
    } catch(err){ console.error(err); }
  }

  function closeEmergencyModal(){
    try{
      const overlay = document.getElementById('emergency-overlay');
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      stopCoachTyping();
      if(emergencyStream){
        emergencyStream.getTracks().forEach(t=>t.stop());
        emergencyStream = null;
      }
    } catch(e){}
  }

  function startCoachTyping(){
    stopCoachTyping();
    const el = document.getElementById('coach-line');
    if(!el) return;

    currentText = '';
    charIndex = 0;
    coachIndex = 0;
    targetText = COACH_LINES[coachIndex];

    typingInterval = setInterval(()=> {
      if(!el) return;

      if(charIndex < targetText.length){
        currentText += targetText[charIndex];
        el.textContent = currentText;
        charIndex++;
      } else {
        setTimeout(()=>{
          currentText = '';
          charIndex = 0;
          coachIndex = (coachIndex + 1) % COACH_LINES.length;
          targetText = COACH_LINES[coachIndex];
        }, 3000);
      }
    }, 80);
  }

  function stopCoachTyping(){
    if(typingInterval) clearInterval(typingInterval);
    typingInterval = null;
    const el = document.getElementById('coach-line');
    if(el) el.textContent='';
  }

  try { window.openEmergencyModal = openEmergencyModal; } catch(e) {}

  // ==================== LEADERBOARD FUNCTIONALITY ====================
  
  async function syncLeaderboardEntry() {
    if (!state.leaderboard || !state.leaderboard.joined) return;
    if (!navigator.onLine) {
      console.log('Offline: skipping leaderboard sync');
      return;
    }

    try {
      const allHabits = [...state.quitHabits, ...state.buildHabits];
      
      for (const habit of allHabits) {
        let currentStreak = 0;
        let bestStreak = habit.bestStreak || 0;
        let cleanDays = 0;

        if (habit.type === 'quit') {
          const timeSince = calculateTimeSince(habit.startDate);
          currentStreak = timeSince.days;
          cleanDays = timeSince.days;
        } else {
          currentStreak = habit.currentStreak || 0;
          cleanDays = Object.values(habit.completions || {}).filter(v => v >= habit.dailyGoal).length;
        }

        const leaderboardEntry = {
          display_name: state.leaderboard.displayName,
          email: state.leaderboard.email || null,
          habit_name: habit.name,
          habit_category: habit.category,
          habit_type: habit.type,
          current_streak: currentStreak,
          best_streak: bestStreak,
          clean_days: cleanDays,
          last_updated: new Date().toISOString()
        };

        const { data, error } = await window.supabase
          .from('leaderboard')
          .upsert(leaderboardEntry, { 
            onConflict: 'email,habit_name',
            ignoreDuplicates: false 
          });

        if (error) {
          console.error('Leaderboard sync error:', error);
        }
      }
    } catch (err) {
      console.error('Leaderboard sync failed:', err);
    }
  }

  async function loadLeaderboard(habitName) {
    try {
      const { data, error } = await window.supabase
        .from('leaderboard')
        .select('*')
        .eq('habit_name', habitName)
        .order('current_streak', { ascending: false })
        .limit(100);

      if (error) {
        console.error('Load leaderboard error:', error);
        return [];
      }

      return data || [];
    } catch (err) {
      console.error('Load leaderboard failed:', err);
      return [];
    }
  }

  function renderLeaderboard() {
    if (state.page !== 'leaderboard') return;

    // Ensure leaderboard state exists
    if (!state.leaderboard) {
      state.leaderboard = {
        joined: false,
        displayName: '',
        email: ''
      };
    }

    // Show/hide join form
    if (state.leaderboard.joined) {
      $('leaderboard-join').style.display = 'none';
      $('leaderboard-joined').style.display = 'block';
      $('leaderboard-display-name').textContent = state.leaderboard.displayName;
    } else {
      $('leaderboard-join').style.display = 'block';
      $('leaderboard-joined').style.display = 'none';
    }

    // Populate habit selector
    const select = $('leaderboard-habit-select');
    select.innerHTML = '';
    const allHabits = [...state.quitHabits, ...state.buildHabits];
    
    if (allHabits.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No habits yet';
      select.appendChild(opt);
      $('leaderboard-table').style.display = 'none';
      $('leaderboard-empty').style.display = 'block';
      return;
    }

    allHabits.forEach(h => {
      const opt = document.createElement('option');
      opt.value = h.name;
      opt.textContent = `${h.icon} ${h.name} (${h.type})`;
      select.appendChild(opt);
    });

    // Load leaderboard data
    loadAndDisplayLeaderboard(allHabits[0].name);
  }

  async function loadAndDisplayLeaderboard(habitName) {
    if (!habitName) return;

    const data = await loadLeaderboard(habitName);
    
    if (data.length === 0) {
      $('leaderboard-table').style.display = 'none';
      $('leaderboard-empty').style.display = 'block';
      return;
    }

    $('leaderboard-empty').style.display = 'none';
    $('leaderboard-table').style.display = 'block';

    const tbody = $('leaderboard-tbody');
    tbody.innerHTML = '';

    data.forEach((entry, index) => {
      const tr = document.createElement('tr');
      tr.style.cssText = 'border-bottom:1px solid var(--border)';
      
      // Highlight current user
      const isCurrentUser = state.leaderboard.joined && 
                           entry.email === state.leaderboard.email && 
                           entry.display_name === state.leaderboard.displayName;
      
      if (isCurrentUser) {
        tr.style.background = 'rgba(124,58,237,0.1)';
        tr.style.fontWeight = '700';
      }

      // Rank with medal
      let rankDisplay = index + 1;
      if (index === 0) rankDisplay = 'ü•á';
      else if (index === 1) rankDisplay = 'ü•à';
      else if (index === 2) rankDisplay = 'ü•â';

      tr.innerHTML = `
        <td style="padding:0.75rem">${rankDisplay}</td>
        <td style="padding:0.75rem">${entry.display_name}${isCurrentUser ? ' (You)' : ''}</td>
        <td style="padding:0.75rem;text-align:right">${entry.current_streak} days</td>
        <td style="padding:0.75rem;text-align:right">${entry.best_streak} days</td>
        <td style="padding:0.75rem;text-align:right">${entry.clean_days} days</td>
      `;
      
      tbody.appendChild(tr);
    });
  }

  // Event listeners for leaderboard
  if ($('join-leaderboard-btn')) {
    $('join-leaderboard-btn').addEventListener('click', async () => {
      const name = $('leaderboard-name').value.trim();
      const email = $('leaderboard-email').value.trim();

      if (!name) {
        alert('Please enter a display name');
        return;
      }

      if (name.length < 2) {
        alert('Display name must be at least 2 characters');
        return;
      }

      state.leaderboard.joined = true;
      state.leaderboard.displayName = name;
      state.leaderboard.email = email;

      saveState();
      showNotification('Welcome to the leaderboard! üèÜ');
      
      await syncLeaderboardEntry();
      renderAll();
    });
  }

  if ($('leave-leaderboard-btn')) {
    $('leave-leaderboard-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to leave the leaderboard? Your progress will be removed.')) {
        state.leaderboard.joined = false;
        state.leaderboard.displayName = '';
        state.leaderboard.email = '';
        saveState();
        showNotification('You left the leaderboard');
        renderAll();
      }
    });
  }

  if ($('leaderboard-habit-select')) {
    $('leaderboard-habit-select').addEventListener('change', (e) => {
      loadAndDisplayLeaderboard(e.target.value);
    });
  }

  if ($('refresh-leaderboard')) {
    $('refresh-leaderboard').addEventListener('click', async () => {
      const habitName = $('leaderboard-habit-select').value;
      if (habitName) {
        showNotification('Refreshing leaderboard...');
        await syncLeaderboardEntry();
        await loadAndDisplayLeaderboard(habitName);
        showNotification('Leaderboard updated! ‚ú®');
      }
    });
  }

  // Auto-sync leaderboard when habits change
  async function wrappedToggleBuildHabit(id) {
    await toggleBuildHabit(id);
    if (state.leaderboard && state.leaderboard.joined) {
      await syncLeaderboardEntry();
    }
  }

  async function wrappedConfirmRelapse() {
    await confirmRelapse();
    if (state.leaderboard && state.leaderboard.joined) {
      await syncLeaderboardEntry();
    }
  }

  // Note: These wrappers are available but the original functions are still used in event handlers
  window.wrappedToggleBuildHabit = wrappedToggleBuildHabit;
  window.wrappedConfirmRelapse = wrappedConfirmRelapse;
});
</script>

<!-- Breathwork widget: robust & self-contained -->
<script>
(function(){
  'use strict';
  document.addEventListener('DOMContentLoaded', () => {
    const BREATH_CONFIG = {
      coherence: { inhale: 5, holdIn: 0, exhale: 5, holdOut: 0, label: "Stress Coherence (5:5)" },
      sleep: { inhale: 4, holdIn: 7, exhale: 8, holdOut: 0, label: "Sleep Inducer (4:7:8)" },
      box: { inhale: 4, holdIn: 4, exhale: 4, holdOut: 4, label: "Calm Box Breathing (4:4:4:4)" },
      calm: { inhale: 4, holdIn: 6, exhale: 4, holdOut: 0, label: "Anxiety Focus (4:6:4)" }
    };

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    let oscillator = null;
    let gainNode = null;

    const el = {
      circle: document.getElementById('breathingCircle'),
      status: document.getElementById('statusText'),
      timer: document.getElementById('currentPhaseTime'),
      startBtn: document.getElementById('startButton'),
      stopBtn: document.getElementById('stopButton'),
      modeSelect: document.getElementById('modeSelector'),
      freqSelect: document.getElementById('freqSelector')
    };

    if(!el.startBtn || !el.stopBtn || !el.modeSelect || !el.freqSelect || !el.circle){
      console.error('[breathwork] required elements missing - breathing will not initialize.');
      return;
    }

    function safeParseFreq(value){ const n=parseFloat(value); return Number.isFinite(n) ? n : null; }

    function startTone(freqVal){
      if(!freqVal || freqVal === 'none') return;
      const f = safeParseFreq(freqVal); if(!f) return;
      try { if(!audioCtx) audioCtx = new AudioCtx(); } catch(err){ console.warn('[breathwork] cannot create AudioContext', err); return; }
      stopTone();
      oscillator = audioCtx.createOscillator();
      gainNode = audioCtx.createGain();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(f, audioCtx.currentTime);
      gainNode.gain.setValueAtTime(0.06, audioCtx.currentTime);
      oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
      try { if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{}); oscillator.start(); } catch(e){ console.warn('[breathwork] oscillator start failed', e); }
    }

    function stopTone(){
      try {
        if(oscillator){ try{ oscillator.stop(audioCtx.currentTime + 0.01); } catch(e){} oscillator.disconnect(); oscillator=null; }
        if(gainNode){ gainNode.disconnect(); gainNode=null; }
      } catch(e){ console.warn('[breathwork] stopTone error', e); }
    }

    function easeScale(progress){
      const t = Math.max(0, Math.min(1, progress));
      return 0.3 + 0.7 * (t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2);
    }
    function getCycleMs(cfg){ return (cfg.inhale + cfg.holdIn + cfg.exhale + cfg.holdOut) * 1000; }

    let currentConfig = null;
    let animId = null;
    let running = false;
    let startTime = 0;

    function animate(time){
      if(!running) return;
      if(!startTime) startTime = time;
      const elapsed = time - startTime;
      const cycleMs = getCycleMs(currentConfig);
      const pos = elapsed % cycleMs;

      const IN = currentConfig.inhale * 1000;
      const HI = currentConfig.holdIn * 1000;
      const EX = currentConfig.exhale * 1000;
      const HO = currentConfig.holdOut * 1000;

      let phase='INHALE', phaseStart=0, phaseDur=IN;

      if(pos < IN){
        phase='INHALE ‚¨ÜÔ∏è'; phaseStart=0; phaseDur=IN;
        const p = pos/IN; el.circle.style.transform = `scale(${easeScale(p)})`; el.circle.classList.add('glowing'); el.circle.style.animationDuration = `${currentConfig.inhale}s`;
      } else if(pos < IN + HI){
        phase='HOLD ‚∏è'; phaseStart=IN; phaseDur=HI; el.circle.style.transform='scale(1.0)'; el.circle.classList.remove('glowing');
      } else if(pos < IN + HI + EX){
        phase='EXHALE ‚¨áÔ∏è'; phaseStart=IN+HI; phaseDur=EX; const p=(pos-phaseStart)/EX; el.circle.style.transform = `scale(${easeScale(1-p)})`; el.circle.classList.remove('glowing');
      } else {
        phase='HOLD ‚∏è'; phaseStart=IN+HI+EX; phaseDur=HO; el.circle.style.transform='scale(0.3)'; el.circle.classList.remove('glowing');
      }

      const remaining = Math.max(0, Math.ceil((phaseDur - (pos - phaseStart))/1000));
      if(el.status) el.status.textContent = phase;
      if(el.timer) el.timer.innerHTML = `${remaining}s`;

      animId = requestAnimationFrame(animate);
    }

    function startSession(){
      try {
        if(running) stopSession();
        const key = el.modeSelect.value || 'coherence';
        currentConfig = BREATH_CONFIG[key] || BREATH_CONFIG.coherence;
        el.startBtn.style.display='none'; el.stopBtn.style.display=''; el.modeSelect.disabled=true; el.freqSelect.disabled=true;
        startTone(el.freqSelect.value);
        running = true; startTime = 0; animId = requestAnimationFrame(animate);
      } catch(e){ console.error('[breathwork] startSession failed', e); }
    }

    function stopSession(){
      try {
        running = false; if(animId){ cancelAnimationFrame(animId); animId = null; } stopTone();
        el.circle.style.transform='scale(0.3)'; el.circle.classList.remove('glowing');
        if(el.status) el.status.textContent='Ready'; if(el.timer) el.timer.textContent='Select a Mode';
        if(el.stopBtn) el.stopBtn.style.display='none'; if(el.startBtn) el.startBtn.style.display='';
        if(el.modeSelect) el.modeSelect.disabled=false; if(el.freqSelect) el.freqSelect.disabled=false;
      } catch(e){ console.error('[breathwork] stopSession error', e); }
    }

    el.startBtn.addEventListener('click', (ev) => {
      try { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{}); } catch(e){}
      startSession();
    });
    el.stopBtn.addEventListener('click', (ev) => stopSession());

    window.breathwork = { startSession, stopSession, startTone, stopTone, BREATH_CONFIG };
    if (console && console.log) {
      console.log('[breathwork] ready');
    }
  });
})();
</script>
</body>
</html>
