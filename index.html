<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>UNDO ‚Äì Habit Tracker</title>
    <meta name="description" content="UNDO - Quit Bad, Build Good. Track and improve your habits with AI coaching."/>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#7c3aed">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f1724;
            --muted: #6b7280;
            --border: #e6e7ea;
            --accent-from: #7c3aed;
            --accent-to: #ec4899;
            --green-from: #10b981;
            --green-to: #059669;
            --danger: #ef4444;
            --gold: #fbbf24;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(2,6,23,0.06);
        }

        .dark {
            --bg: #0b1220;
            --card: #0f1724;
            --text: #ffffff;
            --muted: #94a3b8;
            --border: #22303b;
            --shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        html { 
            height: 100%; 
            font-size: 16px; 
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
            min-height: 100vh;
            transition: background-color 0.5s, color 0.3s;
        }

        /* Auth Styles */
        .auth-page { 
            display: none; 
            min-height: 100vh;
        }
        
        .auth-page.active { 
            display: block; 
            animation: fadeIn 0.3s ease-in; 
        }

        .welcome-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 2rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* App Styles */
        .wrap { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 1rem; 
        }
        
        .card { 
            background: var(--card); 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            transition: all 0.3s; 
        }
        
        h1, h2, h3 { 
            margin: 0; 
            font-weight: 800; 
        }
        
        .muted { 
            color: var(--muted); 
        }
        
        .small { 
            font-size: 0.875rem; 
        }
        
        .heading { 
            font-weight: 800; 
        }

        .btn {
            cursor: pointer;
            border: 0;
            padding: 0.75rem 1rem;
            border-radius: calc(var(--radius) - 4px);
            font-weight: 600;
            font-size: 0.9375rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn:active { 
            transform: scale(0.98); 
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--accent-from), var(--accent-to)); 
            color: white; 
        }
        
        .btn-ghost { 
            background: transparent; 
            border: 1px solid var(--border); 
            color: var(--text); 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-success { 
            background: linear-gradient(135deg, var(--green-from), var(--green-to)); 
            color: white; 
        }
        
        .btn-wide { 
            width: 100%; 
        }
        
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: calc(var(--radius) - 4px);
            border: 2px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--accent-from); 
        }
        
        textarea { 
            min-height: 100px; 
            resize: vertical; 
        }

        .flex { 
            display: flex; 
        }
        
        .grid { 
            display: grid; 
        }
        
        .gap-4 { 
            gap: 1rem; 
        }
        
        .mb-4 { 
            margin-bottom: 1rem; 
        }

        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1.5rem; 
        }
        
        .section-title { 
            display: flex; 
            gap: 0.75rem; 
            align-items: center; 
        }

        header.appbar {
            position: sticky;
            top: 0;
            z-index: 40;
            padding: 1rem 0;
            background: var(--card);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .notif {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            top: 1rem;
            z-index: 80;
            background: linear-gradient(135deg, var(--accent-from), var(--accent-to));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 90%;
            text-align: center;
        }
        
        .notif.show { 
            opacity: 1; 
            animation: bounce 0.5s; 
        }
        
        @keyframes bounce { 
            0%, 100% { transform: translateX(-50%) translateY(0); } 
            50% { transform: translateX(-50%) translateY(-10px); } 
        }

        .cols { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 1.5rem; 
        }
        
        .habit-card { 
            padding: 1.5rem; 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            margin-bottom: 1.25rem; 
            box-shadow: var(--shadow); 
        }
        
        .green-panel { 
            background: linear-gradient(135deg, var(--green-from), var(--green-to)); 
            color: white; 
            padding: 1.5rem; 
            border-radius: calc(var(--radius) - 4px); 
            text-align: center; 
            box-shadow: 0 10px 30px rgba(16,185,129,0.3); 
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.25rem;
            z-index: 60;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .modal-overlay.show { 
            opacity: 1; 
        }
        
        .modal {
            max-width: 640px;
            width: 100%;
            background: var(--card);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal.show { 
            transform: scale(1); 
            opacity: 1; 
        }

        .level-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
        }

        .xp-bar {
            height: 8px;
            background: var(--border);
            border-radius: 999px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .xp-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-from), var(--accent-to));
            transition: width 0.3s;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            max-height: 70vh;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-message {
            display: flex;
            gap: 0.75rem;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--accent-from), var(--accent-to));
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-message.assistant .chat-bubble {
            background: var(--border);
            color: var(--text);
            border-bottom-left-radius: 0.25rem;
        }

        .quick-questions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .quick-question-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
            background: rgba(124,58,237,0.1);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-question-btn:hover {
            background: rgba(124,58,237,0.2);
            transform: translateY(-2px);
        }

        .stat-box {
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }

        .analytics-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi {
            padding: 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-align: center;
        }

        .num {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text);
            margin-top: 0.25rem;
        }

        @media (min-width: 992px) {
            .cols {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 640px) {
            :root {
                --radius: 12px;
            }
            
            .modal {
                padding: 1rem;
            }
            
            .habit-card {
                padding: 1rem;
            }
            
            .btn {
                padding: 0.625rem 0.875rem;
            }
            
            input, select, textarea {
                padding: 0.625rem 0.875rem;
            }
            
            .chat-bubble {
                max-width: 85%;
            }
            
            #header-buttons {
                display: none !important;
            }
            
            #btn-burger {
                display: inline-flex !important;
            }
        }
    </style>
</head>
<body>
    <!-- AUTHENTICATION -->
    <div id="auth-app">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="auth-page active">
            <div class="welcome-screen">
                <div style="max-width:600px">
                    <div style="font-size:5rem;margin-bottom:1rem">‚Ü©Ô∏è</div>
                    <h1 style="font-size:3rem;margin-bottom:1rem;font-weight:900">UNDO</h1>
                    <p style="font-size:1.5rem;margin-bottom:2rem;opacity:0.95">Undo the habits holding you back.</p>
                    
                    <div style="display:flex;flex-direction:column;gap:1rem;max-width:400px;margin:0 auto">
                        <button id="btn-new-user" class="btn btn-primary">I'm New Here</button>
                        <button id="btn-existing-user" class="btn btn-ghost" style="color:white;border-color:rgba(255,255,255,0.3)">Already a User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Page -->
        <div id="login" class="auth-page">
            <div style="max-width:600px;margin:0 auto;padding:3rem 1rem 1rem">
                <div class="card" style="padding:1.5rem">
                    <div style="text-align:center;margin-bottom:2rem">
                        <div style="font-size:3rem;margin-bottom:0.5rem">üîê</div>
                        <h2 style="font-size:2rem;margin-bottom:0.5rem">Welcome Back</h2>
                        <p class="small muted">Log in to continue your journey</p>
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:1rem">
                        <div>
                            <label style="display:block;margin-bottom:0.5rem;font-weight:600">Email</label>
                            <input id="login-email" type="email" placeholder="you@example.com">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:0.5rem;font-weight:600">Password</label>
                            <input id="login-password" type="password" placeholder="Your password">
                        </div>
                        <button id="btn-login" class="btn btn-primary">Log In</button>
                        <div style="text-align:center">
                            <button class="btn btn-ghost" id="btn-back-welcome">‚Üê Back to Welcome</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="main-app-container" style="display:none">
        <div id="app">
            <div id="notification" class="notif" role="alert" aria-live="polite"></div>

            <header class="appbar" role="banner" id="main-header">
                <div class="wrap">
                    <div class="flex" style="justify-content:space-between;align-items:center">
                        <div>
                            <h1 class="flex heading" style="align-items:center;gap:0.625rem;font-size:1.75rem">
                                <span>UNDO</span>
                            </h1>
                            <div id="greeting" class="small muted">Hey Friend!</div>
                        </div>
                        <div class="flex" style="gap:0.5rem;align-items:center">
                            <button id="btn-burger" class="btn btn-ghost" title="Menu" aria-label="Open menu" style="display:none;font-size:1.25rem">‚ò∞</button>
                            <div id="header-buttons" style="display:flex;gap:0.5rem;align-items:center">
                                <button id="btn-ai-coach" class="btn btn-ghost" title="AI Coach">ü§ñ</button>
                                <button id="btn-analytics" class="btn btn-ghost" title="Analytics">üìä</button>
                                <button id="btn-logout" class="btn btn-ghost" title="Logout">üö™</button>
                                <button id="btn-dark" class="btn btn-ghost" title="Toggle Light/Dark Mode" aria-pressed="false">‚òÄÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="wrap" style="padding-top:1.5rem">
                <section id="app-main">
                    <!-- DASHBOARD VIEW -->
                    <div id="dashboard-view">
                        <!-- Level and XP Bar -->
                        <div class="level-indicator">
                            <div style="font-size:1.5rem;font-weight:800">üéØ</div>
                            <div style="flex:1">
                                <div style="display:flex;justify-content:space-between;margin-bottom:0.25rem">
                                    <span class="small muted">Level <strong id="user-level">1</strong></span>
                                    <span class="small muted"><span id="user-xp">0</span>/<span id="next-level-xp">100</span> XP</span>
                                </div>
                                <div class="xp-bar">
                                    <div class="xp-progress" id="xp-progress" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="cols">
                            <!-- Quit Habits -->
                            <div>
                                <div class="section-header">
                                    <div class="section-title">
                                        <div style="font-size:1.5rem;color:var(--danger)">‚ùå</div>
                                        <div>
                                            <div class="heading" style="font-size:1.5rem">Quit Habits (<span id="quit-count">0</span>)</div>
                                            <div class="small muted">Track what you want to stop</div>
                                        </div>
                                    </div>
                                    <button id="add-quit" class="btn btn-danger">+ Add</button>
                                </div>
                                <div id="quit-list"></div>
                            </div>

                            <!-- Build Habits -->
                            <div>
                                <div class="section-header">
                                    <div class="section-title">
                                        <div style="font-size:1.5rem;color:var(--green-from)">‚úÖ</div>
                                        <div>
                                            <div class="heading" style="font-size:1.5rem">Build Habits (<span id="build-count">0</span>)</div>
                                            <div class="small muted">Habits to build</div>
                                        </div>
                                    </div>
                                    <button id="add-build" class="btn btn-success">+ Add</button>
                                </div>
                                <div id="build-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- AI COACH PAGE -->
                    <div id="ai-coach-page" style="display:none">
                        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
                            <span style="font-size:2rem">ü§ñ</span>
                            AI Coach
                        </h2>

                        <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
                            <div class="chat-container">
                                <div class="chat-messages" id="chat-messages">
                                    <div class="chat-message assistant">
                                        <div class="chat-avatar">ü§ñ</div>
                                        <div class="chat-bubble">
                                            Hi! I'm your AI coach. I'm here to support you on your journey. How can I help you today?
                                        </div>
                                    </div>
                                </div>

                                <div class="chat-input-area">
                                    <div class="quick-questions" id="quick-questions">
                                        <button class="quick-question-btn" data-question="How do I stay motivated?">üí™ Stay motivated</button>
                                        <button class="quick-question-btn" data-question="I'm having cravings, help!">üÜò Craving help</button>
                                        <button class="quick-question-btn" data-question="Tips for my habits?">üí° Get tips</button>
                                        <button class="quick-question-btn" data-question="I relapsed, what now?">üîÑ After relapse</button>
                                    </div>
                                    
                                    <div style="display:flex;gap:0.5rem">
                                        <input 
                                            type="text" 
                                            id="chat-input" 
                                            placeholder="Ask me anything about your habits..." 
                                            style="flex:1"
                                        />
                                        <button id="chat-send" class="btn btn-primary" style="padding:0.75rem 1.5rem">
                                            Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ANALYTICS PAGE -->
                    <div id="analytics-page" style="display:none">
                        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
                            <span style="font-size:2rem">üìä</span>
                            Analytics
                        </h2>
                        
                        <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
                            <div id="analyticsMain">
                                <div class="analytics-header">
                                    <div class="kpi"><div class="small muted">Total Habits</div><div class="num" id="total-habits">0</div></div>
                                    <div class="kpi"><div class="small muted">Quit Habits</div><div class="num" id="analytics-quit-count">0</div></div>
                                    <div class="kpi"><div class="small muted">Build Habits</div><div class="num" id="analytics-build-count">0</div></div>
                                    <div class="kpi"><div class="small muted">Current Streak</div><div class="num" id="current-streak">0</div></div>
                                </div>
                                
                                <div style="text-align:center;padding:3rem">
                                    <div style="font-size:3rem;opacity:0.3;margin-bottom:1rem">üìä</div>
                                    <p class="muted" style="font-size:1.125rem">
                                        Analytics features coming soon! Track your progress and insights here.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- ADD HABIT MODAL -->
        <div id="add-modal" class="modal-overlay" style="display:none">
            <div class="modal card">
                <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                    <h3 class="heading" id="add-title" style="font-size:1.5rem">Add Habit</h3>
                    <button id="close-add" class="btn btn-ghost" style="padding:0.5rem">‚úï</button>
                </div>
                <div style="display:flex;flex-direction:column;gap:1rem">
                    <div>
                        <label class="small" for="add-name" style="display:block;margin-bottom:0.5rem;font-weight:600">Habit Name</label>
                        <input id="add-name" placeholder="e.g., Smoking" />
                    </div>
                    <div id="add-category-wrap">
                        <label class="small" style="display:block;margin-bottom:0.75rem;font-weight:600">Choose Category</label>
                        <div id="add-category-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem"></div>
                    </div>
                    <div class="flex" style="gap:0.75rem;margin-top:0.5rem">
                        <button id="cancel-add" class="btn btn-ghost" style="flex:1">Cancel</button>
                        <button id="confirm-add" class="btn btn-primary" style="flex:1">Add Habit</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- EMERGENCY MODAL -->
        <div id="emergency-modal" class="modal-overlay" style="display:none">
            <div class="modal card" style="background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);box-shadow:0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(239,68,68,0.45);color:white;text-align:center">
                <div style="font-size:2.5rem;font-weight:900;letter-spacing:2px;margin-bottom:0.5rem">YOU CAN DO IT</div>
                <div style="font-size:1.25rem;margin-bottom:1rem;opacity:0.95">You are stronger than your urges. Look at yourself ‚Äì you got this.</div>

                <div style="margin-bottom:1rem;position:relative">
                    <video id="emergency-video" autoplay muted playsinline style="width:100%;height:360px;max-height:60vh;background:black;border-radius:12px;object-fit:cover;border:4px solid rgba(0,0,0,0.2)"></video>
                    <div id="camera-fallback" style="display:none;width:100%;height:360px;background:black;border-radius:12px;display:flex;align-items:center;justify-content:center;color:white">Camera access denied</div>
                </div>

                <div style="font-size:1.125rem;min-height:60px;margin-top:1rem;font-weight:700" id="coach-text"></div>

                <div style="display:flex;flex-direction:column;gap:0.5rem;margin-top:1.5rem">
                    <button id="emergency-done" class="btn btn-success btn-wide">‚úÖ I Did It</button>
                    <button id="emergency-relapse" class="btn btn-danger btn-wide">‚ùå I Relapsed</button>
                </div>

                <div style="margin-top:1rem;font-size:0.875rem;color:rgba(255,255,255,0.85)">Camera will help you see yourself and stay strong</div>
            </div>
        </div>
    </div>

    <script>
        // ===== SUPABASE CONFIGURATION =====
        const SUPABASE_URL = 'https://kpsipkobzdcekqfhvfyl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtwc2lwa29iemRjZWtxZmh2ZnlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNzUwNjIsImV4cCI6MjA3OTc1MTA2Mn0.kkfbIsf1Zkf13p4o9QAy4NGUeXxcVl4CXqBMQKPPUaY';

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== APP STATE =====
        let appState = {
            session: null,
            habits: { quit: [], build: [] },
            profile: null,
            currentPage: 'dashboard',
            darkMode: false,
            selectedHabit: null
        };

        // ===== UTILITY FUNCTIONS =====
        function showNotification(message, duration = 3000) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), duration);
        }

        function calculateDaysClean(startDate) {
            if (!startDate) return 0;
            const start = new Date(startDate);
            const now = new Date();
            const diff = now - start;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        const HABIT_ICONS = {
            smoking: 'üö¨', alcohol: 'üç∫', sugar: 'üç≠', social_media: 'üì±', procrastination: '‚è∞',
            porn: 'üîû', exercise: 'üí™', reading: 'üìö', meditation: 'üßò', water: 'üíß',
            sleep: 'üò¥', gaming: 'üéÆ', shopping: 'üõçÔ∏è', caffeine: '‚òï', tv: 'üì∫',
            other: '‚≠ê', healthy_eating: 'üå±', creative: 'üé®', journaling: 'üìì', learning: 'üéì',
            productivity: '‚ö°'
        };

        // ===== AUTHENTICATION =====
        function showAuthPage(pageName) {
            document.querySelectorAll('.auth-page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
        }

        async function handleSignUp() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showNotification('Please enter email and password');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                });
                
                if (error) throw error;
                
                showNotification('Check your email for verification link!');
                setTimeout(() => showAuthPage('login'), 2000);
            } catch (error) {
                showNotification('Error: ' + error.message);
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showNotification('Please enter email and password');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password,
                });
                
                if (error) throw error;
                
                showNotification('Login successful!');
                appState.session = data.session;
                switchToMainApp();
            } catch (error) {
                showNotification('Login failed: ' + error.message);
            }
        }

        function switchToMainApp() {
            document.getElementById('auth-app').style.display = 'none';
            document.getElementById('main-app-container').style.display = 'block';
            loadUserData();
        }

        async function logout() {
            if (confirm('Are you sure you want to log out?')) {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    showNotification('Error logging out: ' + error.message);
                } else {
                    document.getElementById('main-app-container').style.display = 'none';
                    document.getElementById('auth-app').style.display = 'block';
                    showAuthPage('welcome-screen');
                    appState = { session: null, habits: { quit: [], build: [] }, profile: null, currentPage: 'dashboard', darkMode: false };
                }
            }
        }

        // ===== DATA MANAGEMENT =====
        async function loadUserData() {
            try {
                // Get or create user profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', appState.session.user.id)
                    .single();

                if (profileError && profileError.code === 'PGRST116') {
                    // Profile doesn't exist, create one
                    const { data: newProfile, error: createError } = await supabase
                        .from('profiles')
                        .insert([
                            {
                                id: appState.session.user.id,
                                email: appState.session.user.email,
                                xp: 0,
                                level: 1,
                                streak: 0,
                                best_streak: 0
                            }
                        ])
                        .select()
                        .single();

                    if (createError) throw createError;
                    appState.profile = newProfile;
                } else if (profileError) {
                    throw profileError;
                } else {
                    appState.profile = profile;
                }

                // Update greeting
                document.getElementById('greeting').textContent = `Hey ${appState.session.user.email.split('@')[0]}!`;

                // Load habits
                await loadHabits();
                
                // Update UI
                updateXPDisplay();
                renderDashboard();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Error loading data');
            }
        }

        async function loadHabits() {
            try {
                const { data: quitHabits, error: quitError } = await supabase
                    .from('habits')
                    .select('*')
                    .eq('user_id', appState.session.user.id)
                    .eq('type', 'quit')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                const { data: buildHabits, error: buildError } = await supabase
                    .from('habits')
                    .select('*')
                    .eq('user_id', appState.session.user.id)
                    .eq('type', 'build')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                if (quitError || buildError) {
                    throw new Error(quitError?.message || buildError?.message);
                }

                appState.habits.quit = quitHabits || [];
                appState.habits.build = buildHabits || [];
                
                updateHabitCounts();
            } catch (error) {
                console.error('Error loading habits:', error);
                showNotification('Error loading habits');
            }
        }

        function updateHabitCounts() {
            document.getElementById('quit-count').textContent = appState.habits.quit.length;
            document.getElementById('build-count').textContent = appState.habits.build.length;
            document.getElementById('analytics-quit-count').textContent = appState.habits.quit.length;
            document.getElementById('analytics-build-count').textContent = appState.habits.build.length;
            document.getElementById('total-habits').textContent = appState.habits.quit.length + appState.habits.build.length;
        }

        function updateXPDisplay() {
            if (!appState.profile) return;
            
            document.getElementById('user-level').textContent = appState.profile.level;
            document.getElementById('user-xp').textContent = appState.profile.xp;
            document.getElementById('next-level-xp').textContent = appState.profile.level * 100;
            document.getElementById('current-streak').textContent = appState.profile.streak;
            
            const progress = (appState.profile.xp / (appState.profile.level * 100)) * 100;
            document.getElementById('xp-progress').style.width = `${progress}%`;
        }

        // ===== HABIT MANAGEMENT =====
        function openAddModal(type) {
            appState.habitModalType = type;
            const modal = document.getElementById('add-modal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
                modal.querySelector('.modal').classList.add('show');
            }, 10);

            document.getElementById('add-title').textContent = `Add ${type === 'quit' ? 'Quit' : 'Build'} Habit`;
            
            // Set up category grid
            const grid = document.getElementById('add-category-grid');
            grid.innerHTML = '';
            
            const categories = type === 'quit' ? [
                { value: 'smoking', label: 'üö¨ Smoking' },
                { value: 'alcohol', label: 'üç∫ Alcohol' },
                { value: 'sugar', label: 'üç≠ Sugar' },
                { value: 'social_media', label: 'üì± Social Media' },
                { value: 'procrastination', label: '‚è∞ Procrastination' },
                { value: 'porn', label: 'üîû Porn' },
                { value: 'gaming', label: 'üéÆ Gaming' },
                { value: 'shopping', label: 'üõçÔ∏è Shopping' },
                { value: 'caffeine', label: '‚òï Caffeine' },
                { value: 'other', label: '‚≠ê Other' }
            ] : [
                { value: 'exercise', label: 'üí™ Exercise' },
                { value: 'reading', label: 'üìö Reading' },
                { value: 'meditation', label: 'üßò Meditation' },
                { value: 'water', label: 'üíß Water' },
                { value: 'sleep', label: 'üò¥ Sleep' },
                { value: 'healthy_eating', label: 'üå± Healthy Eating' },
                { value: 'journaling', label: 'üìî Journaling' },
                { value: 'learning', label: 'üéì Learning' },
                { value: 'productivity', label: '‚ö° Productivity' },
                { value: 'other', label: '‚≠ê Other' }
            ];
            
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-ghost';
                btn.style.cssText = 'padding:1rem;border:2px solid var(--border);text-align:center;transition:all 0.2s';
                btn.textContent = category.label;
                btn.onclick = () => {
                    grid.querySelectorAll('button').forEach(b => {
                        b.style.borderColor = 'var(--border)';
                        b.style.background = 'transparent';
                    });
                    btn.style.borderColor = type === 'quit' ? 'var(--danger)' : 'var(--green-from)';
                    btn.style.background = type === 'quit' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
                    appState.newHabitCategory = category.value;
                };
                
                if (category.value === (type === 'quit' ? 'smoking' : 'exercise')) {
                    btn.style.borderColor = type === 'quit' ? 'var(--danger)' : 'var(--green-from)';
                    btn.style.background = type === 'quit' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
                    appState.newHabitCategory = category.value;
                }
                
                grid.appendChild(btn);
            });
        }

        function closeAddModal() {
            const modal = document.getElementById('add-modal');
            modal.classList.remove('show');
            modal.querySelector('.modal').classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function addHabit() {
            const name = document.getElementById('add-name').value.trim();
            if (!name) {
                showNotification('Please enter a habit name');
                return;
            }
            
            if (!appState.newHabitCategory) {
                showNotification('Please select a category');
                return;
            }
            
            try {
                const habitData = {
                    user_id: appState.session.user.id,
                    name: name,
                    type: appState.habitModalType,
                    category: appState.newHabitCategory,
                    icon: HABIT_ICONS[appState.newHabitCategory] || '‚≠ê',
                    start_date: appState.habitModalType === 'quit' ? new Date().toISOString() : null,
                    daily_goal: appState.habitModalType === 'build' ? 1 : null,
                    goal_unit: appState.habitModalType === 'build' ? 'times' : null,
                    current_streak: 0,
                    best_streak: 0,
                    total_completions: 0,
                    total_relapses: 0
                };
                
                const { data, error } = await supabase
                    .from('habits')
                    .insert([habitData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                appState.habits[appState.habitModalType].unshift(data);
                updateHabitCounts();
                renderDashboard();
                closeAddModal();
                showNotification(`"${name}" added! ${appState.habitModalType === 'quit' ? 'üéØ' : 'üí™'}`);
                
                // Award XP for adding habit
                await awardXP(10, 'habit_creation', `Created habit: ${name}`);
                
            } catch (error) {
                console.error('Error adding habit:', error);
                showNotification('Error adding habit');
            }
        }

        async function completeHabit(habitId) {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('habit_completions')
                    .insert([
                        {
                            habit_id: habitId,
                            user_id: appState.session.user.id,
                            completed_date: today,
                            completed_count: 1
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                // Update local state
                const habit = appState.habits.build.find(h => h.id === habitId);
                if (habit) {
                    habit.current_streak = (habit.current_streak || 0) + 1;
                    habit.best_streak = Math.max(habit.best_streak || 0, habit.current_streak);
                    habit.total_completions = (habit.total_completions || 0) + 1;
                }
                
                renderDashboard();
                showNotification('‚úÖ Habit completed! Great job!');
                
                // Award XP
                await awardXP(5, 'habit_completion', 'Completed a habit');
                
            } catch (error) {
                console.error('Error completing habit:', error);
                showNotification('Error completing habit');
            }
        }

        async function deleteHabit(habitId, type) {
            if (!confirm('Are you sure you want to delete this habit?')) return;
            
            try {
                const { error } = await supabase
                    .from('habits')
                    .update({ is_active: false })
                    .eq('id', habitId);
                
                if (error) throw error;
                
                appState.habits[type] = appState.habits[type].filter(h => h.id !== habitId);
                updateHabitCounts();
                renderDashboard();
                showNotification('Habit deleted');
            } catch (error) {
                console.error('Error deleting habit:', error);
                showNotification('Error deleting habit');
            }
        }

        // ===== EMERGENCY SYSTEM =====
        function openEmergencyModal(habit) {
            appState.selectedHabit = habit;
            const modal = document.getElementById('emergency-modal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
                modal.querySelector('.modal').classList.add('show');
            }, 10);
            
            startCoachTyping();
            startCamera();
        }

        function closeEmergencyModal() {
            const modal = document.getElementById('emergency-modal');
            modal.classList.remove('show');
            modal.querySelector('.modal').classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                stopCamera();
            }, 300);
        }

        const COACH_LINES = [
            "You're stronger than this craving.",
            "Remember why you started this journey.",
            "Take a deep breath. This moment will pass.",
            "You've come so far. Don't give up now.",
            "Your future self will thank you for resisting.",
            "One craving at a time. You can do this.",
            "Think about how proud you'll feel tomorrow.",
            "You are in control, not the addiction."
        ];

        function startCoachTyping() {
            const coachText = document.getElementById('coach-text');
            coachText.innerHTML = '';
            
            let currentIndex = 0;
            let charIndex = 0;
            let currentText = '';
            
            function type() {
                if (currentIndex < COACH_LINES.length) {
                    const targetText = COACH_LINES[currentIndex];
                    
                    if (charIndex < targetText.length) {
                        currentText += targetText[charIndex];
                        coachText.textContent = currentText;
                        charIndex++;
                        setTimeout(type, 50);
                    } else {
                        setTimeout(() => {
                            currentText = '';
                            charIndex = 0;
                            currentIndex = (currentIndex + 1) % COACH_LINES.length;
                            type();
                        }, 3000);
                    }
                }
            }
            
            type();
        }

        let emergencyStream = null;

        async function startCamera() {
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user' }, 
                        audio: false 
                    });
                    emergencyStream = stream;
                    const video = document.getElementById('emergency-video');
                    video.srcObject = stream;
                    video.style.display = 'block';
                    document.getElementById('camera-fallback').style.display = 'none';
                } else {
                    document.getElementById('emergency-video').style.display = 'none';
                    document.getElementById('camera-fallback').style.display = 'flex';
                }
            } catch (error) {
                console.error('Camera error:', error);
                document.getElementById('emergency-video').style.display = 'none';
                document.getElementById('camera-fallback').style.display = 'flex';
            }
        }

        function stopCamera() {
            if (emergencyStream) {
                emergencyStream.getTracks().forEach(track => track.stop());
                emergencyStream = null;
            }
        }

        async function handleEmergencySuccess() {
            closeEmergencyModal();
            showNotification('Well done ‚Äì you stayed strong! üí™');
            await awardXP(15, 'emergency_success', 'Resisted an urge');
        }

        async function handleEmergencyRelapse() {
            if (appState.selectedHabit) {
                try {
                    const { error } = await supabase
                        .from('habit_relapses')
                        .insert([
                            {
                                habit_id: appState.selectedHabit.id,
                                user_id: appState.session.user.id,
                                trigger_description: 'Used emergency button',
                                emotions: 'Urge overcame resistance',
                                learned: 'Need stronger coping strategies',
                                severity: 5
                            }
                        ]);
                    
                    if (error) throw error;
                    
                    // Update habit stats
                    const habit = appState.habits.quit.find(h => h.id === appState.selectedHabit.id);
                    if (habit) {
                        habit.total_relapses = (habit.total_relapses || 0) + 1;
                        habit.current_streak = 0;
                    }
                    
                } catch (error) {
                    console.error('Error logging relapse:', error);
                }
            }
            
            closeEmergencyModal();
            showNotification('Logged. Tomorrow is new! üí™');
            renderDashboard();
        }

        // ===== XP SYSTEM =====
        async function awardXP(amount, type, description) {
            if (!appState.profile) return;
            
            try {
                // Update profile
                const newXP = appState.profile.xp + amount;
                const newLevel = Math.floor(newXP / 100) + 1;
                
                const { error } = await supabase
                    .from('profiles')
                    .update({
                        xp: newXP,
                        level: newLevel,
                        streak: appState.profile.streak + 1,
                        best_streak: Math.max(appState.profile.best_streak, appState.profile.streak + 1)
                    })
                    .eq('id', appState.session.user.id);
                
                if (error) throw error;
                
                // Update local state
                appState.profile.xp = newXP;
                appState.profile.level = newLevel;
                appState.profile.streak += 1;
                appState.profile.best_streak = Math.max(appState.profile.best_streak, appState.profile.streak);
                
                // Log XP transaction
                await supabase
                    .from('xp_transactions')
                    .insert([
                        {
                            user_id: appState.session.user.id,
                            amount: amount,
                            type: type,
                            description: description
                        }
                    ]);
                
                updateXPDisplay();
                
                if (newLevel > appState.profile.level - 1) {
                    showNotification(`üéâ Level Up! You're now level ${newLevel}`, 5000);
                }
                
            } catch (error) {
                console.error('Error awarding XP:', error);
            }
        }

        // ===== RENDERING =====
        function renderDashboard() {
            renderQuitList();
            renderBuildList();
        }

        function renderQuitList() {
            const container = document.getElementById('quit-list');
            if (!container) return;
            
            if (appState.habits.quit.length === 0) {
                container.innerHTML = `
                    <div class="card" style="padding:2.5rem;text-align:center">
                        <div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">‚ùå</div>
                        <p class="muted" style="font-size:1.125rem">No quit habits yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appState.habits.quit.map(habit => `
                <div class="habit-card">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem">
                        <div style="display:flex;gap:0.75rem;align-items:center">
                            <div style="font-size:3rem">${habit.icon}</div>
                            <div>
                                <div class="heading" style="font-size:1.25rem">${habit.name}</div>
                                <div class="small muted" style="margin-top:0.25rem">Since ${new Date(habit.start_date).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <button onclick="deleteHabit('${habit.id}', 'quit')" class="btn btn-ghost" style="padding:0.5rem">üóëÔ∏è</button>
                    </div>

                    <div class="green-panel" style="margin-bottom:1.25rem">
                        <div class="small" style="font-weight:600;margin-bottom:0.75rem">Clean for</div>
                        <div style="font-size:2rem;font-weight:800;margin-bottom:1rem">${calculateDaysClean(habit)} days</div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem">
                        <div class="stat-box" style="background:linear-gradient(135deg,#fef3c7,#fde68a)">
                            <div style="font-size:1.5rem;margin-bottom:0.25rem">üèÜ</div>
                            <div class="heading" style="font-size:1.5rem">${habit.best_streak || 0}</div>
                            <div class="small muted">Best streak</div>
                        </div>
                        <div class="stat-box" style="background:linear-gradient(135deg,#fecaca,#fca5a5)">
                            <div style="font-size:1.5rem;margin-bottom:0.25rem">üîÑ</div>
                            <div class="heading" style="font-size:1.5rem">${habit.total_relapses || 0}</div>
                            <div class="small muted">Relapses</div>
                        </div>
                    </div>

                    <button onclick="openEmergencyModal(${JSON.stringify(habit).replace(/"/g, '&quot;')})" class="btn btn-danger btn-wide" style="margin-bottom:1rem">
                        <span style="font-size:1.125rem">üö®</span> Emergency Urge
                    </button>
                </div>
            `).join('');
        }

        function renderBuildList() {
            const container = document.getElementById('build-list');
            if (!container) return;
            
            if (appState.habits.build.length === 0) {
                container.innerHTML = `
                    <div class="card" style="padding:2.5rem;text-align:center">
                        <div style="font-size:3rem;opacity:0.3;margin-bottom:0.5rem">‚úÖ</div>
                        <p class="muted" style="font-size:1.125rem">No build habits yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appState.habits.build.map(habit => `
                <div class="habit-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem">
                        <div style="display:flex;gap:0.75rem;align-items:center">
                            <div style="font-size:3rem">${habit.icon}</div>
                            <div>
                                <div class="heading" style="font-size:1.25rem">${habit.name}</div>
                                <div class="small muted" style="margin-top:0.25rem">
                                    Goal: ${habit.daily_goal} ${habit.goal_unit}/day ‚Ä¢ ${habit.current_streak || 0} day streak
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteHabit('${habit.id}', 'build')" class="btn btn-ghost" style="padding:0.5rem">üóëÔ∏è</button>
                    </div>

                    <div style="margin-bottom:1.25rem">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
                            <span class="small muted" style="font-weight:600">Today</span>
                            <span class="heading" style="font-size:1.125rem">0/${habit.daily_goal} ${habit.goal_unit}</span>
                        </div>
                        <div style="height:1rem;border-radius:999px;background:var(--border);overflow:hidden">
                            <div style="height:100%;background:linear-gradient(90deg,var(--green-from),var(--green-to));width:0%;transition:width 0.3s"></div>
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem">
                        <div class="stat-box" style="background:linear-gradient(135deg,#fed7aa,#fdba74)">
                            <div style="font-size:1.5rem;margin-bottom:0.25rem">üî•</div>
                            <div class="heading" style="font-size:1.5rem">${habit.current_streak || 0}</div>
                            <div class="small muted">Current streak</div>
                        </div>
                        <div class="stat-box" style="background:linear-gradient(135deg,#fef3c7,#fde68a)">
                            <div style="font-size:1.5rem;margin-bottom:0.25rem">üèÜ</div>
                            <div class="heading" style="font-size:1.5rem">${habit.best_streak || 0}</div>
                            <div class="small muted">Best streak</div>
                        </div>
                    </div>

                    <button onclick="completeHabit('${habit.id}')" class="btn btn-success btn-wide">‚úÖ Check In</button>
                </div>
            `).join('');
        }

        function showPage(page) {
            // Hide all pages
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('ai-coach-page').style.display = 'none';
            document.getElementById('analytics-page').style.display = 'none';
            
            // Show selected page
            document.getElementById(`${page}-view` || `${page}-page`).style.display = 'block';
            appState.currentPage = page;
        }

        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            document.body.classList.toggle('dark', appState.darkMode);
            document.getElementById('btn-dark').textContent = appState.darkMode ? 'üåô' : '‚òÄÔ∏è';
            
            // Save preference to profile
            if (appState.profile) {
                supabase
                    .from('profiles')
                    .update({ dark_mode: appState.darkMode })
                    .eq('id', appState.session.user.id)
                    .then(({ error }) => {
                        if (error) console.error('Error saving theme preference:', error);
                    });
            }
        }

        // ===== AI COACH =====
        function handleChatSend() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage('user', message);
            input.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-message assistant';
            typingIndicator.innerHTML = `
                <div class="chat-avatar">ü§ñ</div>
                <div class="chat-bubble">
                    <div style="display:flex;gap:0.25rem;padding:0.75rem 1rem">
                        <div style="width:8px;height:8px;border-radius:50%;background:var(--muted);animation:typing 1.4s infinite"></div>
                        <div style="width:8px;height:8px;border-radius:50%;background:var(--muted);animation:typing 1.4s infinite;animation-delay:0.2s"></div>
                        <div style="width:8px;height:8px;border-radius:50%;background:var(--muted);animation:typing 1.4s infinite;animation-delay:0.4s"></div>
                    </div>
                </div>
            `;
            document.getElementById('chat-messages').appendChild(typingIndicator);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
            
            // Simulate AI response
            setTimeout(() => {
                typingIndicator.remove();
                
                const responses = [
                    "I understand you're working on your habits. Remember that progress takes time and consistency is key.",
                    "That's a common challenge. Many people find success by breaking habits into smaller, manageable steps.",
                    "Have you tried identifying your triggers? Understanding what leads to the habit can help you prepare alternative responses.",
                    "Progress isn't always linear. What's important is that you're aware and trying to improve.",
                    "Consider tracking your mood alongside your habits. You might notice patterns that can help you succeed."
                ];
                
                const response = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage('assistant', response);
            }, 1000 + Math.random() * 1000);
        }

        function addChatMessage(role, content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.innerHTML = `
                <div class="chat-avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
                <div class="chat-bubble">${content}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Auth event listeners
            document.getElementById('btn-new-user').addEventListener('click', () => {
                showAuthPage('login');
                // Change button to sign up
                document.getElementById('btn-login').textContent = 'Sign Up';
                document.getElementById('btn-login').onclick = handleSignUp;
            });
            
            document.getElementById('btn-existing-user').addEventListener('click', () => {
                showAuthPage('login');
                document.getElementById('btn-login').textContent = 'Log In';
                document.getElementById('btn-login').onclick = handleLogin;
            });
            
            document.getElementById('btn-back-welcome').addEventListener('click', () => {
                showAuthPage('welcome-screen');
            });
            
            document.getElementById('btn-login').addEventListener('click', handleLogin);

            // Main app event listeners
            document.getElementById('btn-ai-coach').addEventListener('click', () => showPage('ai-coach'));
            document.getElementById('btn-analytics').addEventListener('click', () => showPage('analytics'));
            document.getElementById('btn-logout').addEventListener('click', logout);
            document.getElementById('btn-dark').addEventListener('click', toggleDarkMode);
            
            // Habit buttons
            document.getElementById('add-quit').addEventListener('click', () => openAddModal('quit'));
            document.getElementById('add-build').addEventListener('click', () => openAddModal('build'));
            
            // Modal controls
            document.getElementById('close-add').addEventListener('click', closeAddModal);
            document.getElementById('cancel-add').addEventListener('click', closeAddModal);
            document.getElementById('confirm-add').addEventListener('click', addHabit);
            
            // Emergency modal controls
            document.getElementById('emergency-done').addEventListener('click', handleEmergencySuccess);
            document.getElementById('emergency-relapse').addEventListener('click', handleEmergencyRelapse);
            
            // Chat functionality
            document.getElementById('chat-send').addEventListener('click', handleChatSend);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChatSend();
            });
            
            // Quick questions
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('quick-question-btn')) {
                    const question = e.target.dataset.question;
                    document.getElementById('chat-input').value = question;
                    handleChatSend();
                }
            });

            // Check for existing session
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    appState.session = session;
                    switchToMainApp();
                }
            });

            // Listen for auth changes
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    appState.session = session;
                    switchToMainApp();
                } else if (event === 'SIGNED_OUT') {
                    document.getElementById('main-app-container').style.display = 'none';
                    document.getElementById('auth-app').style.display = 'block';
                    showAuthPage('welcome-screen');
                }
            });
        });

        // Make functions available globally for onclick handlers
        window.openAddModal = openAddModal;
        window.closeAddModal = closeAddModal;
        window.addHabit = addHabit;
        window.completeHabit = completeHabit;
        window.deleteHabit = deleteHabit;
        window.openEmergencyModal = openEmergencyModal;
        window.handleEmergencySuccess = handleEmergencySuccess;
        window.handleEmergencyRelapse = handleEmergencyRelapse;
        window.showPage = showPage;
        window.toggleDarkMode = toggleDarkMode;
    </script>
</body>
</html>
