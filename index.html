<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>UNDO ‚Äì Habit Tracker</title>
<meta name="description" content="UNDO - Quit Bad, Build Good. Track and improve your habits with AI coaching."/>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#7c3aed">
<link rel="apple-touch-icon" href="/icon-192.png">

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Chart.js for Analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Configuration will be injected by build.js -->
<script id="env-config">
  // This script will be replaced by build.js with actual environment variables
  window.env = window.env || {
    SUPABASE_URL: 'https://wtmvefqfzzhplcwpdtdk.supabase.co',
    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0bXZlZnFmenpocGxjd3BkdGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMTcwODgsImV4cCI6MjA3OTg5MzA4OH0.dUIPn_duNhzPGbuavEKXpFcyXnAHi50xC7vCAVtCqUw',
    OPENROUTER_API_KEY: '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'
  };
</script>

<style>
  /* ===== ENHANCED 10/10 STYLES ===== */
  :root {
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#0f1724;
    --muted:#475569; /* Improved contrast */
    --border:#e6e7ea;
    --accent-from:#7c3aed;
    --accent-to:#ec4899;
    --green-from:#10b981;
    --green-to:#059669;
    --danger:#ef4444;
    --gold:#fbbf24;
    --radius: 16px;
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
    
    /* NEW: Consistent spacing system */
    --space-xs: 0.5rem;
    --space-sm: 0.75rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    
    /* NEW: Typography scale */
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
  }

  .dark {
    --bg:#0b1220;
    --card:#0f1724;
    --text:#ffffff;
    --muted:#cbd5e1; /* Improved contrast */
    --border:#22303b;
    --shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  * { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
  }
  
  html { 
    height: 100%; 
    font-size: 16px; 
  }
  
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    line-height: 1.5;
    min-height: 100vh;
    transition: background-color 0.5s, color 0.3s;
  }

  /* NEW: Consistent input styles */
  .input-standard,
  input:not([type="button"]):not([type="submit"]):not([type="reset"]),
  select,
  textarea {
    padding: var(--space-md);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    color: var(--text);
    font-size: var(--text-base);
    width: 100%;
    transition: all 0.2s;
    margin-bottom: var(--space-sm);
  }

  .input-standard:focus,
  input:focus:not([type="button"]):not([type="submit"]):not([type="reset"]),
  select:focus,
  textarea:focus {
    border-color: var(--accent-from);
    outline: none;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
  }

  /* NEW: Focus styles for accessibility */
  button:focus-visible,
  .btn:focus-visible,
  input:focus-visible,
  select:focus-visible {
    outline: 2px solid var(--accent-from);
    outline-offset: 2px;
  }

  /* NEW: Skeleton Loading */
  .skeleton-card {
    padding: var(--space-lg);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-bottom: var(--space-md);
    background: var(--card);
  }

  .skeleton-header {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .skeleton-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.5) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  .skeleton-text {
    flex: 1;
    height: 20px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.5) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  .skeleton-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .skeleton-line {
    height: 12px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.5) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  .skeleton-line.short {
    width: 60%;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* NEW: Risk Assessment */
  .insight-card {
    padding: var(--space-lg);
    border-radius: var(--radius);
    border: 2px solid var(--border);
    margin-bottom: var(--space-lg);
    background: var(--card);
  }

  .insight-card.high-risk {
    border-color: #ef4444;
    background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(239,68,68,0.02));
  }

  .insight-card.medium-risk {
    border-color: #f59e0b;
    background: linear-gradient(135deg, rgba(245,158,11,0.05), rgba(245,158,11,0.02));
  }

  .insight-card.low-risk {
    border-color: #10b981;
    background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(16,185,129,0.02));
  }

  .risk-meter {
    height: 8px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
    margin: var(--space-md) 0;
  }

  .risk-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
    transition: width 0.5s ease-in-out;
  }

  .recommendation {
    padding: var(--space-md);
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    margin-top: var(--space-md);
    border-left: 4px solid var(--accent-from);
  }

  /* NEW: Implementation Intentions */
  .implementation-plan {
    padding: var(--space-lg);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    margin: var(--space-lg) 0;
    background: rgba(124,58,237,0.03);
  }

  .plan-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--card);
    border-radius: 8px;
    margin-bottom: var(--space-sm);
    border: 1px solid var(--border);
  }

  .plan-trigger {
    font-weight: 600;
    color: var(--accent-from);
  }

  .plan-response {
    flex: 1;
  }

  /* NEW: Confetti Animation */
  .confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: var(--accent-from);
    border-radius: 2px;
    animation: fall linear forwards;
    z-index: 10000;
  }

  @keyframes fall {
    to {
      transform: translateY(100vh) rotate(360deg);
      opacity: 0;
    }
  }

  /* Auth Pages */
  .auth-page { 
    display: none; 
    min-height: 100vh;
  }
  .auth-page.active { 
    display: block; 
    animation: fadeIn 0.3s ease-in; 
  }

  .welcome-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    padding: var(--space-xl);
  }

  .auth-wrap { 
    max-width: 600px; 
    margin: 0 auto; 
    padding: var(--space-md);
  }

  .auth-card { 
    background: var(--card); 
    border-radius: var(--radius); 
    border: 1px solid var(--border); 
    box-shadow: var(--shadow); 
    padding: var(--space-lg); 
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Main App Styles */
  .wrap { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: var(--space-md); 
  }
  
  .card { 
    background: var(--card); 
    border-radius: var(--radius); 
    border: 1px solid var(--border); 
    box-shadow: var(--shadow); 
    transition: all 0.3s; 
  }
  
  h1,h2,h3 { 
    margin:0; 
    font-weight:800; 
    line-height: 1.2;
  }
  
  .muted { 
    color: var(--muted); 
    font-size: var(--text-sm);
  }
  
  .small { 
    font-size: var(--text-sm); 
  }
  
  .heading { 
    font-weight:800; 
  }

  .btn {
    cursor:pointer;
    border:0;
    padding: var(--space-md) var(--space-lg);
    border-radius:calc(var(--radius)-4px);
    font-weight:600;
    font-size:var(--text-sm);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:var(--space-sm);
    transition:all 0.2s;
    text-decoration: none;
    min-height: 44px; /* Accessibility minimum */
  }
  
  .btn:active { 
    transform: scale(0.98); 
  }
  
  .btn-primary { 
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); 
    color:white; 
  }
  
  .btn-ghost { 
    background:transparent; 
    border:1px solid var(--border); 
    color:var(--text); 
  }
  
  .btn-danger { 
    background:var(--danger); 
    color:white; 
  }
  
  .btn-success { 
    background: linear-gradient(135deg,var(--green-from),var(--green-to)); 
    color:white; 
  }
  
  .btn-gold { 
    background: linear-gradient(135deg,#fbbf24,#f59e0b); 
    color:#78350f; 
    font-weight:700; 
  }
  
  .btn-wide { 
    width:100%; 
  }
  
  .btn:disabled { 
    opacity:0.5; 
    cursor:not-allowed; 
  }

  /* Enhanced Components */
  .friends-panel, .journal-entry, .achievement-badge, .level-indicator, .xp-bar, .xp-progress,
  .mood-selector, .mood-option, .emergency-game, .game-button, .friend-card, .friend-avatar {
    /* Enhanced component styles */
  }

  .achievement-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #78350f;
    border-radius: 999px;
    font-size: var(--text-sm);
    font-weight: 700;
    margin: var(--space-xs);
  }

  .xp-bar {
    height: 8px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
    margin: var(--space-sm) 0;
  }

  .xp-progress {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-from), var(--accent-to));
    transition: width 0.3s;
  }

  .level-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-lg);
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }

  .section-header { 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    margin-bottom:var(--space-lg); 
  }
  
  .section-title { 
    display:flex; 
    gap:var(--space-sm); 
    align-items:center; 
  }

  header.appbar {
    position: sticky; 
    top:0; 
    z-index:40; 
    padding:var(--space-md) 0; 
    background:var(--card); 
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border); 
    box-shadow:var(--shadow);
  }

  .notif {
    position: fixed; 
    left:50%; 
    transform:translateX(-50%); 
    top:var(--space-md); 
    z-index:80;
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); 
    color:white; 
    padding:var(--space-md) var(--space-lg);
    border-radius:var(--radius); 
    font-weight:600; 
    box-shadow:var(--shadow); 
    opacity:0; 
    transition:opacity 0.3s; 
    max-width:90%; 
    text-align:center;
  }
  
  .notif.show { 
    opacity:1; 
    animation: bounce 0.5s; 
  }
  
  @keyframes bounce { 
    0%,100% { transform: translateX(-50%) translateY(0); } 
    50% { transform: translateX(-50%) translateY(-10px); } 
  }

  .cols { 
    display:grid; 
    grid-template-columns:1fr; 
    gap:var(--space-lg); 
  }
  
  @media (min-width: 992px) { 
    .cols { 
      grid-template-columns:1fr 1fr; 
    } 
  }

  .habit-card { 
    padding:var(--space-lg); 
    border-radius:var(--radius); 
    border:1px solid var(--border); 
    margin-bottom:var(--space-md); 
    box-shadow:var(--shadow); 
  }
  
  .green-panel { 
    background: linear-gradient(135deg,var(--green-from),var(--green-to)); 
    color:white; 
    padding:var(--space-lg); 
    border-radius:calc(var(--radius)-4px); 
    text-align:center; 
    box-shadow: 0 10px 30px rgba(16,185,129,0.3); 
  }

  .modal-overlay { 
    position: fixed; 
    inset:0; 
    background: rgba(0,0,0,0.7); 
    backdrop-filter: blur(4px); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    padding:var(--space-md); 
    z-index:60; 
    opacity:0; 
    transition:opacity 0.3s; 
  }
  
  .modal-overlay.show { 
    opacity:1; 
  }
  
  .modal { 
    max-width:640px; 
    width:100%; 
    background:var(--card); 
    padding:var(--space-lg); 
    border-radius:var(--radius); 
    border:1px solid var(--border); 
    transform: scale(0.95); 
    opacity:0; 
    transition:all 0.3s; 
    max-height:90vh; 
    overflow-y:auto; 
  }
  
  .modal.show { 
    transform: scale(1); 
    opacity:1; 
  }

  /* Chat Styles */
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
    max-height: 70vh;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-md);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .chat-message {
    display: flex;
    gap: var(--space-sm);
    animation: slideIn 0.3s;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-message.user {
    flex-direction: row-reverse;
  }

  .chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-2xl);
    flex-shrink: 0;
  }

  .chat-bubble {
    max-width: 70%;
    padding: var(--space-md) var(--space-lg);
    border-radius: 1rem;
    word-wrap: break-word;
    line-height: 1.6;
  }

  .chat-message.user .chat-bubble {
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to));
    color: white;
    border-bottom-right-radius: 0.25rem;
  }

  .chat-message.assistant .chat-bubble {
    background: var(--border);
    color: var(--text);
    border-bottom-left-radius: 0.25rem;
  }

  .chat-input-area {
    padding: var(--space-md);
    border-top: 1px solid var(--border);
  }

  .quick-questions {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
    flex-wrap: wrap;
  }

  .quick-question-btn {
    padding: var(--space-sm) var(--space-md);
    border-radius: 999px;
    background: rgba(124,58,237,0.1);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: var(--text-xs);
    cursor: pointer;
    transition: all 0.2s;
    min-height: 44px; /* Accessibility */
    min-width: 44px;
  }

  .quick-question-btn:hover {
    background: rgba(124,58,237,0.2);
    transform: translateY(-2px);
  }

  .typing-indicator {
    display: flex;
    gap: var(--space-xs);
    padding: var(--space-md) var(--space-lg);
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    animation: typing 1.4s infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
    30% { transform: translateY(-10px); opacity: 1; }
  }

  /* Loading States */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .spinner {
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 640px) {
    :root { 
      --radius: 12px; 
    }
    
    .modal { 
      padding:var(--space-md); 
    }
    
    .habit-card { 
      padding:var(--space-md); 
    }
    
    .btn { 
      padding:var(--space-sm) var(--space-md); 
      min-height: 44px; /* Mobile accessibility */
    }
    
    .chat-bubble { 
      max-width: 85%; 
    }
    
    #header-buttons { 
      display:none !important; 
    }
    
    #btn-burger { 
      display:inline-flex !important; 
    }

    /* Improved mobile touch targets */
    .mobile-menu-item,
    .quick-question-btn,
    .btn {
      min-height: 44px;
      min-width: 44px;
    }
  }

  /* Main app container - initially hidden */
  #main-app-container {
    display: none;
  }

  .error-msg {
    color: var(--danger);
    font-size: var(--text-sm);
    margin-top: var(--space-xs);
    display: none;
  }
  
  .error-msg.show {
    display: block;
  }

  /* Analytics Styles */
  .kpi { 
    padding:var(--space-md); 
    background:var(--card); 
    border:1px solid var(--border); 
    border-radius:var(--radius); 
    text-align:center; 
  }
  
  .num { 
    font-size:var(--text-2xl); 
    font-weight:800; 
    color:var(--text); 
    margin-top:var(--space-xs); 
  }
  
  .analytics-header { 
    display:grid; 
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); 
    gap:var(--space-md); 
    margin-bottom:var(--space-lg); 
  }
  
  .chart-grid { 
    display:grid; 
    grid-template-columns:1fr; 
    gap:var(--space-lg); 
  }
  
  @media (min-width: 768px) { 
    .chart-grid { 
      grid-template-columns:1fr 1fr; 
    } 
  }
  
  .chart-card { 
    background:var(--card); 
    border:1px solid var(--border); 
    border-radius:var(--radius); 
    padding:var(--space-lg); 
  }
  
  .chart-scroll { 
    overflow-x:auto; 
  }
  
  .fixed-chart { 
    min-width:300px; 
  }
  
  .empty { 
    text-align:center; 
    padding:var(--space-xl); 
  }

  #emergency-overlay { 
    position: fixed; 
    inset: 0; 
    background: linear-gradient(180deg, rgba(220,38,38,0.98), rgba(153,27,27,0.95)); 
    display: none; 
    z-index: 200; 
    color: white; 
    align-items: center; 
    justify-content: center; 
    padding: var(--space-md); 
  }
  
  #emergency-overlay.show { 
    display:flex; 
  }
  
  .emergency-card { 
    width:100%; 
    max-width:720px; 
    text-align:center; 
    border-radius:var(--radius); 
    padding:var(--space-lg); 
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); 
    box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(239,68,68,0.45); 
    border:1px solid rgba(255,255,255,0.06); 
  }
  
  .emergency-head { 
    font-size:var(--text-3xl); 
    font-weight:900; 
    letter-spacing:2px; 
    margin-bottom:var(--space-sm); 
  }
  
  .emergency-sub { 
    font-size:var(--text-xl); 
    margin-bottom:var(--space-md); 
    opacity:0.95; 
  }
  
  #emergency-video { 
    width:100%; 
    height:360px; 
    max-height:60vh; 
    background:black; 
    border-radius:var(--radius); 
    object-fit:cover; 
    border:4px solid rgba(0,0,0,0.2); 
  }
  
  #camera-fallback { 
    width:100%; 
    height:360px; 
    background:black; 
    border-radius:var(--radius); 
    display:flex;
    align-items:center;
    justify-content:center;
    color:white; 
  }

  #coach-text { 
    font-size:var(--text-lg); 
    min-height:60px; 
    margin-top:var(--space-md); 
    font-weight:700; 
  }

  /* NEW: Challenge Cards */
  .challenge-card {
    padding: var(--space-lg);
    border-radius: var(--radius);
    border: 2px solid var(--border);
    margin-bottom: var(--space-lg);
    background: var(--card);
    transition: all 0.3s;
  }

  .challenge-card:hover {
    border-color: var(--accent-from);
    transform: translateY(-2px);
  }

  .challenge-card.active {
    border-color: var(--green-from);
    background: rgba(16,185,129,0.05);
  }

  .challenge-progress {
    height: 8px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
    margin: var(--space-md) 0;
  }

  .challenge-progress-bar {
    height: 100%;
    background: linear-gradient(90deg,var(--green-from),var(--green-to));
    transition: width 0.3s;
  }

  /* NEW: Breathing Exercise */
  #breathing-page { 
    display:none; 
    margin-top:var(--space-lg); 
  }

  #breathingContainer { 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    width:70vw; 
    height:70vw; 
    max-width:300px; 
    max-height:300px; 
    margin:0 auto; 
  }

  #breathingCircle { 
    width:100%; 
    height:100%; 
    background: linear-gradient(135deg,#a5b4fc,#3b82f6); 
    border-radius:50%; 
    box-shadow:0 5px 15px rgba(0,0,0,0.1), 0 10px 30px rgba(0,0,0,0.05); 
    transform: scale(0.3); 
    will-change: transform, box-shadow; 
  }

  @keyframes subtle-glow { 
    0% { box-shadow: 0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } 
    50% { box-shadow: 0 0 10px rgba(99,102,241,0.4), 0 0 30px rgba(99,102,241,0.2); } 
    100% { box-shadow:0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } 
  }

  .glowing { animation: subtle-glow 5s infinite alternate ease-in-out; }

  /* NEW: Leaderboard Cards */
  .leaderboard-card {
    padding: var(--space-md);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-bottom: var(--space-md);
  }

  /* NEW: Mobile Menu */
  #mobile-menu-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.5); 
    backdrop-filter: blur(8px);
    display: none; 
    z-index: 120; 
    align-items: flex-start; 
    justify-content: flex-end;
    padding: 0;
  }
  
  #mobile-menu-overlay.show { 
    display:flex; 
  }
  
  #mobile-menu-panel {
    width: 280px;
    height: 100vh;
    background: linear-gradient(180deg, #2c3e50 0%, #1a1f2e 100%);
    box-shadow: -5px 0 30px rgba(0,0,0,0.3);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  
  #mobile-menu-overlay.show #mobile-menu-panel {
    transform: translateX(0);
  }
  
  .mobile-menu-header {
    padding: var(--space-xl) var(--space-lg) var(--space-lg);
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .mobile-user-name {
    font-size: var(--text-2xl);
    font-weight: 800;
    color: white;
  }
  
  .mobile-menu-nav {
    flex: 1;
    padding: var(--space-md) 0;
  }
  
  .mobile-menu-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md) var(--space-lg);
    color: rgba(255,255,255,0.8);
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
    font-size: var(--text-base);
    font-weight: 600;
    transition: all 0.2s;
    position: relative;
    cursor: pointer;
    min-height: 48px; /* Better touch targets */
  }
  
  .mobile-menu-item:hover,
  .mobile-menu-item.active {
    background: rgba(124,58,237,0.15);
    color: white;
  }
  
  .mobile-menu-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, var(--accent-from), var(--accent-to));
  }
  
  .mobile-menu-icon {
    font-size: var(--text-xl);
    width: 24px;
    text-align: center;
  }
  
  .mobile-menu-footer {
    padding: var(--space-md) var(--space-lg);
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  /* NEW: Relapse Modal */
  #relapse-modal { display: none; }

  /* NEW: Enhanced Styles */
  .streak-dots {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
    margin: var(--space-sm) 0;
  }

  .streak-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid var(--border);
    transition: all 0.3s;
  }

  .streak-dot.active {
    background: linear-gradient(135deg, var(--green-from), var(--green-to));
  }

  .streak-dot.previous {
    background: var(--muted);
  }

  .streak-dot.future {
    background: var(--border);
  }

  .education-grid, .stories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-md);
  }

  .education-card, .story-card {
    padding: var(--space-lg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
  }

  .duration-badge {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    background: rgba(124,58,237,0.1);
    color: var(--accent-from);
    border-radius: 999px;
    font-size: var(--text-xs);
    font-weight: 600;
    margin-top: var(--space-sm);
  }

  .friend-challenge-card {
    padding: var(--space-md);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: var(--space-md);
    background: var(--card);
  }

  .badge-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-md);
  }

  .badge-card {
    padding: var(--space-lg);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    text-align: center;
    background: var(--card);
    transition: all 0.3s;
  }

  .badge-card.unlocked {
    border-color: var(--gold);
    background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05));
  }

  .badge-icon {
    font-size: 3rem;
    margin-bottom: var(--space-md);
  }

  .time-display {
    font-family: monospace;
    font-size: var(--text-2xl);
    font-weight: 800;
    letter-spacing: 2px;
  }

  .stat-box {
    padding: var(--space-md);
    border-radius: var(--radius);
    text-align: center;
  }

  /* NEW: Improved empty states */
  .empty-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: var(--space-md);
  }

  /* NEW: Navigation groups */
  .nav-group {
    display: flex;
    gap: var(--space-xs);
    padding: var(--space-sm);
    background: var(--card);
    border-radius: var(--radius);
    margin-bottom: var(--space-md);
    border: 1px solid var(--border);
  }

  .nav-group-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--muted);
    margin-bottom: var(--space-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
</style>
</head>
<body>

<!-- AUTHENTICATION & ONBOARDING -->
<div id="auth-app">
  <!-- Welcome Screen -->
  <div id="welcome-screen" class="auth-page active">
    <div class="welcome-screen">
      <div style="max-width:600px">
        <div style="font-size:5rem;margin-bottom:1rem">‚Ü©Ô∏è</div>
        <h1 style="font-size:3rem;margin-bottom:1rem;font-weight:900">UNDO</h1>
        <p style="font-size:1.5rem;margin-bottom:2rem;opacity:0.95">Undo the habits holding you back.</p>
        <div style="display:flex;flex-direction:column;gap:1rem;max-width:400px;margin:0 auto">
          <button id="btn-new-user" class="btn btn-primary">I'm New Here</button>
          <button id="btn-existing-user" class="btn btn-ghost" style="color:white;border-color:rgba(255,255,255,0.3)">Already a User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Onboarding Flow -->
  <div id="onboarding" class="auth-page">
    <div class="auth-wrap" style="padding-top:2rem">
      <div class="auth-card">
        <div style="margin-bottom:2rem">
          <div style="height:4px;background:var(--border);border-radius:999px;overflow:hidden;margin-bottom:1rem">
            <div id="onboarding-progress" style="height:100%;background:linear-gradient(90deg,#7c3aed,#a78bfa);width:20%;transition:width 0.3s"></div>
          </div>
          <div style="text-align:center">
            <span class="small muted">Step <span id="onboarding-step">1</span> of 5</span>
          </div>
        </div>
        
        <div id="onboarding-content"></div>
        
        <div style="display:flex;gap:0.75rem;margin-top:2rem">
          <button id="btn-onboarding-back" class="btn btn-ghost" style="display:none">Back</button>
          <button id="btn-onboarding-next" class="btn btn-primary" style="flex:1">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Page -->
  <div id="login" class="auth-page">
    <div class="auth-wrap" style="padding-top:3rem">
      <div class="auth-card">
        <div style="text-align:center;margin-bottom:2rem">
          <div style="font-size:3rem;margin-bottom:0.5rem">üîê</div>
          <h2 style="font-size:2rem;margin-bottom:0.5rem">Welcome Back</h2>
          <p class="small muted">Log in to continue your journey</p>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:1rem">
          <div>
            <label style="display:block;margin-bottom:0.5rem;font-weight:600">Email</label>
            <input id="login-email" type="email" class="input-standard" placeholder="you@example.com">
          </div>
          <div>
            <label style="display:block;margin-bottom:0.5rem;font-weight:600">Password</label>
            <input id="login-password" type="password" class="input-standard" placeholder="Your password">
          </div>
          <button id="btn-login" class="btn btn-primary">Log In</button>
          <div style="text-align:center">
            <button class="btn btn-ghost" onclick="showAuthPage('welcome-screen')">‚Üê Back to Welcome</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Confirmation Page -->
  <div id="email-confirmation" class="auth-page">
    <div class="auth-wrap" style="padding-top:3rem">
      <div class="auth-card" style="text-align:center">
        <div style="font-size:5rem;margin-bottom:1rem">üìß</div>
        <h2 style="font-size:2rem;margin-bottom:1rem">Check Your Email</h2>
        <p style="margin-bottom:1.5rem;line-height:1.8">
          We've sent a confirmation link to<br>
          <strong id="confirmation-email" style="color:var(--accent-from)">your email</strong>
        </p>
        <button class="btn btn-primary" onclick="showAuthPage('login')">Go to Login</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APPLICATION -->
<div id="main-app-container">
  <div id="app">
    <div id="notification" class="notif" role="alert" aria-live="polite"></div>

    <header class="appbar" role="banner" id="main-header">
      <div class="wrap">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <div>
            <h1 class="flex heading" style="align-items:center;gap:0.625rem;font-size:1.75rem">
              <span>UNDO</span>
            </h1>
            <div id="greeting" class="small muted">Hey Friend!</div>
          </div>
          <div class="flex" style="gap:0.5rem;align-items:center">
            <button id="btn-burger" class="btn btn-ghost" title="Menu" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-menu-panel" style="display:none;font-size:1.25rem">‚ò∞</button>
            <div id="header-buttons" style="display:flex;gap:0.5rem;align-items:center">
              <button id="btn-social" class="btn btn-ghost" title="Social">üë•</button>
              <button id="btn-journal" class="btn btn-ghost" title="Journal">üìî</button>
              <button id="btn-achievements" class="btn btn-ghost" title="Achievements">üèÜ</button>
              <button id="btn-education" class="btn btn-ghost" title="Learn">üìö</button>
              <button id="btn-settings" class="btn btn-ghost" title="Settings">‚öôÔ∏è</button>
              <button id="btn-home" class="btn btn-ghost" title="Go Home">üè†</button>
              <button id="btn-ai-coach" class="btn btn-ghost" title="AI Coach">ü§ñ</button>
              <button id="btn-challenges" class="btn btn-ghost" title="Challenges">üéØ</button>
              <button id="btn-breathe" class="btn btn-ghost" title="Breathing Exercise" aria-label="Open breathing exercise">üå¨Ô∏è</button>
              <button id="btn-analytics" class="btn btn-ghost" title="Analytics">üìä</button>
              <button id="btn-leaderboard" class="btn btn-ghost" title="Leaderboard">üèÜ</button>
              <button id="btn-logout" class="btn btn-ghost" title="Logout">üö™</button>
              <button id="btn-dark" class="btn btn-ghost" title="Toggle Light/Dark Mode" aria-pressed="false">‚òÄÔ∏è</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="wrap" style="padding-top:1.5rem">
      <section id="app-main">
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view">
          <!-- Level and XP Bar -->
          <div class="level-indicator" style="margin-bottom: 1.5rem;">
            <div style="font-size: 1.5rem; font-weight: 800;">üéØ</div>
            <div style="flex: 1">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                <span class="small muted">Level <strong id="user-level">1</strong></span>
                <span class="small muted"><span id="user-xp">0</span>/<span id="next-level-xp">100</span> XP</span>
              </div>
              <div class="xp-bar">
                <div class="xp-progress" id="xp-progress" style="width: 0%"></div>
              </div>
            </div>
          </div>

          <!-- NEW: Risk Assessment Card -->
          <div id="risk-assessment-container"></div>

          <div class="cols">
            <!-- Quit Habits -->
            <div>
              <div class="section-header">
                <div class="section-title">
                  <div style="font-size:1.5rem;color:var(--danger)">‚ùå</div>
                  <div>
                    <div class="heading" style="font-size:1.5rem">Quit Habits (<span id="quit-count">0</span>)</div>
                    <div class="small muted">Track what you want to stop</div>
                  </div>
                </div>
                <button id="add-quit" class="btn btn-danger">+ Add</button>
              </div>
              <div id="quit-list"></div>
            </div>

            <!-- Build Habits -->
            <div>
              <div class="section-header">
                <div class="section-title">
                  <div style="font-size:1.5rem;color:var(--green-from)">‚úÖ</div>
                  <div>
                    <div class="heading" style="font-size:1.5rem">Build Habits (<span id="build-count">0</span>)</div>
                    <div class="small muted">Habits to build</div>
                  </div>
                </div>
                <button id="add-build" class="btn btn-success">+ Add</button>
              </div>
              <div id="build-list"></div>
            </div>
          </div>
        </div>

        <!-- AI COACH PAGE -->
        <div id="ai-coach-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">ü§ñ</span>
            AI Coach
          </h2>

          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <div class="chat-container">
              <div class="chat-messages" id="chat-messages">
                <div class="chat-message assistant">
                  <div class="chat-avatar">ü§ñ</div>
                  <div class="chat-bubble">
                    Hi! I'm your AI coach. I'm here to support you on your journey. How can I help you today?
                  </div>
                </div>
              </div>

              <div class="chat-input-area">
                <div class="quick-questions" id="quick-questions">
                  <button class="quick-question-btn" data-question="How do I stay motivated?">üí™ Stay motivated</button>
                  <button class="quick-question-btn" data-question="I'm having cravings, help!">üÜò Craving help</button>
                  <button class="quick-question-btn" data-question="Tips for my habits?">üí° Get tips</button>
                  <button class="quick-question-btn" data-question="I relapsed, what now?">üîÑ After relapse</button>
                </div>
                
                <div style="display:flex;gap:0.5rem">
                  <input 
                    type="text" 
                    id="chat-input" 
                    class="input-standard"
                    placeholder="Ask me anything about your habits..." 
                    style="flex:1"
                  />
                  <button id="chat-send" class="btn btn-primary" style="padding:0.75rem 1.5rem">
                    Send
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CHALLENGES PAGE -->
        <div id="challenges-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üéØ</span>
            Challenge Packs
          </h2>

          <div id="challenges-container">
            <!-- Challenges will be rendered here -->
          </div>
        </div>

        <!-- BREATHING EXERCISE PAGE -->
        <div id="breathing-page">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üå¨Ô∏è</span>
            Breathwork Guide
          </h2>

          <div class="card" style="padding:1.5rem; max-width:760px; margin:0 auto;">
            <header style="text-align:center; margin-bottom:1rem;">
              <h2 class="heading" style="font-size:1.5rem">Breathwork Guide üå¨Ô∏è</h2>
            </header>

            <div style="text-align:center; margin-bottom:1rem;">
              <p id="breath-status-text" class="heading" style="font-size:1.5rem">Ready</p>
              <p id="breath-timer-text" class="small muted" style="margin-top:0.25rem;"><span id="current-phase-time">Select a Mode</span></p>
            </div>

            <div id="breathingContainer">
                <div id="breathingCircle"></div>
            </div>

            <div style="display:grid; gap:0.75rem;">
              <div>
                <label for="mode-selector" class="small muted" style="display:block;margin-bottom:0.35rem;font-weight:700">Breathing Mode</label>
                <select id="mode-selector" class="input-standard">
                    <option value="coherence" selected>üòå Stress Coherence (5:5)</option>
                    <option value="sleep">üò¥ Sleep Inducer (4:7:8)</option>
                    <option value="box">üì¶ Calm Box Breathing (4:4:4:4)</option>
                    <option value="calm">üí° Anxiety Focus (4:6:4)</option>
                </select>
              </div>

              <div>
                <label for="freq-selector" class="small muted" style="display:block;margin-bottom:0.35rem;font-weight:700">Background Frequency (Hz)</label>
                <select id="freq-selector" class="input-standard">
                    <option value="none">üîá No Sound</option>
                    <option value="432">üéµ 432 Hz - Relaxation & Peace</option>
                    <option value="528">üß¨ 528 Hz - Transformation & Repair</option>
                    <option value="7.83">üåç 7.83 Hz - Schumann Resonance (Grounding)</option>
                </select>
              </div>

              <div style="display:flex;gap:0.5rem;">
                <button id="breath-start-button" class="btn btn-primary btn-wide">‚ñ∂Ô∏è BEGIN SESSION</button>
                <button id="breath-stop-button" class="btn btn-danger btn-wide" style="display:none">üõë END SESSION</button>
              </div>
            </div>
          </div>
        </div>

        <!-- LEADERBOARD PAGE -->
        <div id="leaderboard-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üèÜ</span>
            Global Leaderboard
            <button id="refresh-leaderboard" class="btn btn-ghost" style="margin-left:auto">üîÑ Refresh</button>
          </h2>

          <div id="leaderboard-cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem"></div>

          <div style="margin-top:1rem;text-align:center">
            <small class="muted">Updates every 30s ‚Ä¢ Sorted by XP</small>
          </div>
        </div>

        <!-- ANALYTICS PAGE -->
        <div id="analytics-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üìä</span>
            Analytics
          </h2>
          
          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <div id="analyticsMain">
              <div class="analytics-header">
                <div class="kpi"><div class="small muted">Total Habits</div><div class="num" id="total-habits">0</div></div>
                <div class="kpi"><div class="small muted">Quit Habits</div><div class="num" id="analytics-quit-count">0</div></div>
                <div class="kpi"><div class="small muted">Build Habits</div><div class="num" id="analytics-build-count">0</div></div>
                <div class="kpi"><div class="small muted">Current Streak</div><div class="num" id="current-streak">0</div></div>
              </div>
              
              <!-- NEW: Predictive Analytics -->
              <div id="predictive-analytics-container"></div>
              
              <div style="margin-bottom: 1.5rem;">
                <label for="analytics-period" class="small muted" style="display:block;margin-bottom:0.5rem;font-weight:600">Time Period</label>
                <select id="analytics-period" class="input-standard">
                  <option value="7">Last 7 Days</option>
                  <option value="30" selected>Last 30 Days</option>
                  <option value="90">Last 90 Days</option>
                  <option value="365">Last Year</option>
                  <option value="all">All Time</option>
                </select>
              </div>
              
              <div class="chart-grid">
                <div class="chart-card">
                  <h3 class="heading" style="margin-bottom:1rem">Habit Completion Trend</h3>
                  <canvas id="completion-chart" height="250"></canvas>
                </div>
                <div class="chart-card">
                  <h3 class="heading" style="margin-bottom:1rem">Habit Distribution</h3>
                  <canvas id="distribution-chart" height="250"></canvas>
                </div>
                <div class="chart-card">
                  <h3 class="heading" style="margin-bottom:1rem">Weekly Progress</h3>
                  <canvas id="weekly-chart" height="250"></canvas>
                </div>
                <div class="chart-card">
                  <h3 class="heading" style="margin-bottom:1rem">Success Rate</h3>
                  <canvas id="success-chart" height="250"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- EDUCATION PAGE -->
        <div id="education-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üìö</span>
            Learn & Grow
          </h2>
          
          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <h3 class="heading" style="margin-bottom:1rem">üéì Habit Formation Science</h3>
            <div class="education-grid" id="education-content">
              <!-- Educational content will be loaded here -->
            </div>
          </div>
          
          <div class="card" style="padding:1.5rem">
            <h3 class="heading" style="margin-bottom:1rem">üåü Success Stories</h3>
            <div class="stories-grid" id="success-stories">
              <!-- Success stories will be loaded here -->
            </div>
          </div>
        </div>

        <!-- ACHIEVEMENTS PAGE -->
        <div id="achievements-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üèÜ</span>
            Achievements & Badges
          </h2>
          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <div class="badge-grid" id="badges-container">
              <!-- Badges will be rendered here -->
            </div>
          </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div id="settings-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">‚öôÔ∏è</span>
            Settings & Backup
          </h2>

          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <h3 class="heading" style="font-size:1.25rem;margin-bottom:1rem">üì¶ Data Backup</h3>
            
            <div style="display:grid;gap:1rem;margin-bottom:1.5rem">
              <button id="export-data-btn" class="btn btn-primary btn-wide">
                üíæ Export All Data (JSON)
              </button>
              
              <div>
                <label for="import-data-file" class="btn btn-ghost btn-wide" style="margin:0;cursor:pointer">
                  üìÇ Import Data (JSON)
                </label>
                <input type="file" id="import-data-file" accept=".json" style="display:none">
              </div>
            </div>

            <div class="small muted" style="padding:1rem;background:rgba(251,191,36,0.1);border-radius:8px">
              <strong>üí° Tip:</strong> Regular backups ensure your data is safe. Export your data monthly and keep it somewhere secure.
            </div>
          </div>

          <div class="card" style="padding:1.5rem">
            <h3 class="heading" style="font-size:1.25rem;margin-bottom:1rem;color:var(--danger)">‚ö†Ô∏è Danger Zone</h3>
            
            <button id="clear-all-data-btn" class="btn btn-danger btn-wide">
              üóëÔ∏è Clear All Data
            </button>
            
            <div class="small muted" style="margin-top:0.75rem">
              This will permanently delete all your habits, progress, and settings. This action cannot be undone.
            </div>
          </div>
        </div>

        <!-- Additional simplified pages for demo -->
        <div id="social-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üë•</span>
            Social & Friends
          </h2>
          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <h3 class="heading" style="margin-bottom:1rem">ü§ù Friend Challenges</h3>
            <div id="friend-challenges-list">
              <div class="empty-state">
                <div class="empty-state-icon">üë•</div>
                <p class="muted">No active challenges with friends</p>
                <button class="btn btn-primary" onclick="startFriendChallenge()" style="margin-top:1rem">
                  Start a Challenge with Friends
                </button>
              </div>
            </div>
          </div>
          <div class="card" style="padding:1.5rem">
            <h3 class="heading" style="margin-bottom:1rem">üë§ Your Friends</h3>
            <div id="friends-list">
              <div class="empty-state">
                <div class="empty-state-icon">üë§</div>
                <p class="muted">No friends yet</p>
                <button class="btn btn-ghost" onclick="showNotification('Friend features coming soon!')" style="margin-top:1rem">
                  Add Friends
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="journal-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üìî</span>
            Journal
          </h2>
          <div class="card" style="padding:2rem;text-align:center">
            <div class="empty-state">
              <div class="empty-state-icon">üìî</div>
              <p class="muted">Journal features coming soon!</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALS -->
  <div id="add-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:1.5rem">
        <h3 class="heading" id="add-title" style="font-size:1.5rem">Add Habit</h3>
        <button id="close-add" class="btn btn-ghost" style="padding:0.5rem" aria-label="Close modal">‚úï</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <label class="small" for="add-name" style="display:block;margin-bottom:0.5rem;font-weight:600">Habit Name</label>
          <input id="add-name" class="input-standard" placeholder="e.g., Smoking" />
          <div id="add-name-error" class="error-msg"></div>
        </div>
        <div id="add-category-wrap">
          <label class="small" style="display:block;margin-bottom:0.75rem;font-weight:600">Choose Category</label>
          <div id="add-category-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem"></div>
        </div>
        
        <!-- NEW: Implementation Intentions Section -->
        <div id="implementation-intentions-section" style="display:none">
          <label class="small" style="display:block;margin-bottom:0.75rem;font-weight:600">üìù Create Implementation Plan (Optional)</label>
          <div id="implementation-plans-container">
            <div class="plan-item">
              <div style="flex:1">
                <div class="plan-trigger">When I feel stressed...</div>
                <div class="plan-response">I will take 5 deep breaths instead</div>
              </div>
              <button class="btn btn-ghost" onclick="removePlanItem(this)" aria-label="Remove plan">üóëÔ∏è</button>
            </div>
          </div>
          <button type="button" class="btn btn-ghost btn-wide" onclick="addNewPlanItem()">+ Add Trigger Response</button>
        </div>
        
        <div class="flex" style="gap:0.75rem;margin-top:0.5rem">
          <button id="cancel-add" class="btn btn-ghost" style="flex:1">Cancel</button>
          <button id="confirm-add" class="btn btn-primary" style="flex:1">Add Habit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RELAPSE MODAL -->
  <div id="relapse-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="align-items:center;gap:0.75rem;margin-bottom:1.5rem">
        <span style="font-size:2rem;color:var(--danger)">‚ö†Ô∏è</span>
        <h3 class="heading" style="font-size:1.5rem">Relapse</h3>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div class="flex" style="gap:0.75rem;align-items:center">
          <div id="relapse-emoji" style="font-size:2.5rem">üö¨</div>
          <div>
            <div id="relapse-name" class="heading" style="font-size:1.25rem">Smoking</div>
            <div id="relapse-since" class="small muted">You were clean for 0d</div>
          </div>
        </div>
        <div>
          <label class="small" for="relapse-note" style="display:block;margin-bottom:0.5rem;font-weight:600">What happened? Learning from this makes you stronger.</label>
          <textarea id="relapse-note" class="input-standard" placeholder="What triggered it? How were you feeling? What can you do differently?"></textarea>
        </div>
        <div class="flex" style="gap:0.75rem">
          <button id="relapse-cancel" class="btn btn-ghost" style="flex:1">Cancel</button>
          <button id="relapse-confirm" class="btn btn-danger" style="flex:1">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MOBILE MENU -->
  <div id="mobile-menu-overlay" role="dialog" aria-hidden="true">
    <div id="mobile-menu-panel">
      <div class="mobile-menu-header">
        <div class="mobile-user-name" id="mobile-user-name">Hey Friend!</div>
      </div>
      
      <div class="mobile-menu-nav">
        <button class="mobile-menu-item active" id="m-btn-home">
          <span class="mobile-menu-icon">üè†</span>
          <span>Dashboard</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-ai-coach">
          <span class="mobile-menu-icon">ü§ñ</span>
          <span>AI Coach</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-challenges">
          <span class="mobile-menu-icon">üéØ</span>
          <span>Challenges</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-education">
          <span class="mobile-menu-icon">üìö</span>
          <span>Learn</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-analytics">
          <span class="mobile-menu-icon">üìä</span>
          <span>Analytics</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-breathe">
          <span class="mobile-menu-icon">üå¨Ô∏è</span>
          <span>Breathwork</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-leaderboard">
          <span class="mobile-menu-icon">üèÜ</span>
          <span>Leaderboard</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-social">
          <span class="mobile-menu-icon">üë•</span>
          <span>Social</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-achievements">
          <span class="mobile-menu-icon">üèÜ</span>
          <span>Achievements</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-settings">
          <span class="mobile-menu-icon">‚öôÔ∏è</span>
          <span>Settings</span>
        </button>
      </div>
      
      <div class="mobile-menu-footer">
        <button class="mobile-menu-item" id="m-btn-dark">
          <span class="mobile-menu-icon">üåô</span>
          <span>Dark Mode</span>
        </button>
      </div>
    </div>
  </div>

  <!-- EMERGENCY OVERLAY -->
  <div id="emergency-overlay" role="alert" aria-hidden="true">
    <div class="emergency-card">
      <div class="emergency-head">YOU CAN DO IT</div>
      <div class="emergency-sub">You are stronger than your urges. Look at yourself ‚Äì you got this.</div>
      <div style="margin-bottom:1rem;position:relative">
        <video id="emergency-video" autoplay muted playsinline style="width:100%;height:360px;max-height:60vh;background:black;border-radius:12px;object-fit:cover;border:4px solid rgba(0,0,0,0.2)"></video>
        <div id="camera-fallback" style="display:none;width:100%;height:360px;background:black;border-radius:12px;display:flex;align-items:center;justify-content:center;color:white">Camera access denied</div>
      </div>
      <div style="font-size:1.125rem;min-height:60px;margin-top:1rem;font-weight:700" id="coach-text"></div>
      <div style="display:flex;flex-direction:column;gap:0.5rem;margin-top:1.5rem">
        <button id="emergency-done" class="btn btn-success btn-wide">‚úÖ I Did It</button>
        <button id="emergency-relapse" class="btn btn-danger btn-wide">‚ùå I Relapsed</button>
      </div>
      <div style="margin-top:1rem;font-size:0.875rem;color:rgba(255,255,255,0.85)">Camera will help you see yourself and stay strong</div>
    </div>
  </div>
</div>

<script>
// ===== ENVIRONMENT VARIABLE CONFIGURATION =====
// Use the environment variables injected by build.js
const SUPABASE_URL = window.env.SUPABASE_URL;
const SUPABASE_ANON_KEY = window.env.SUPABASE_ANON_KEY;
const OPENROUTER_API_KEY = window.env.OPENROUTER_API_KEY;

// Initialize Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===== OPENROUTER AI CONFIG =====
// OPENROUTER_API_KEY is already loaded from window.env

// ===== 10/10 ENHANCEMENTS =====

// NEW: Enhanced Error Handling
class ErrorBoundary {
  static async wrap(operation, fallbackMessage, context = {}) {
    try {
      const startTime = performance.now();
      const result = await operation();
      const duration = performance.now() - startTime;
      
      console.log(`‚úÖ Operation completed in ${duration.toFixed(2)}ms`, context);
      return result;
    } catch (error) {
      console.error('‚ùå Operation failed:', { error, context });
      
      showNotification(`‚ùå ${fallbackMessage}`);
      this.logError(error, context);
      
      return null;
    }
  }
  
  static logError(error, context) {
    // In production, send to error tracking service
    if (window.analytics) {
      window.analytics.track('Error Occurred', {
        error: error.message,
        stack: error.stack,
        ...context
      });
    }
  }
}

// ... (ALL THE REST OF YOUR EXISTING JAVASCRIPT CODE GOES HERE EXACTLY AS IT WAS)
// This includes:
// - All the classes (HabitInsights, SmartCoach, etc.)
// - All the constants (CHALLENGE_PACKS, BREATH_CONFIG, etc.)
// - All the appState and other variables
// - All the functions (showNotification, setLoading, etc.)
// - All the event listeners and initialization code

// Just make sure to KEEP EVERYTHING from your original JavaScript exactly as it was
// The only change needed is at the top where we define the constants:
// They should use window.env variables instead of hardcoded values

// IMPORTANT: The entire JavaScript code from your original file should be pasted here
// starting from line 1976 of your original file (after the CSS)

// ===== 10/10 UTILITY FUNCTIONS =====
function showNotification(message, duration = 3000) {
  const notif = document.getElementById('notification');
  notif.textContent = message;
  notif.classList.add('show');
  // NEW: Screen reader announcement
  notif.setAttribute('aria-live', 'polite');
  setTimeout(() => {
    notif.classList.remove('show');
    notif.removeAttribute('aria-live');
  }, duration);
}

function setLoading(button, isLoading) {
  if (isLoading) {
    button.disabled = true;
    const originalText = button.innerHTML;
    button.dataset.originalText = originalText;
    button.innerHTML = '<div class="spinner"></div> Loading...';
  } else {
    button.disabled = false;
    button.innerHTML = button.dataset.originalText || button.textContent;
  }
}

// ... (CONTINUE WITH ALL YOUR ORIGINAL JAVASCRIPT CODE)

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  // NEW: Custom habit input handling
  document.addEventListener('change', function(e) {
    if (e.target.id === 'quit-habit') {
      const customContainer = document.getElementById('quit-custom-container');
      if (customContainer) {
        customContainer.style.display = e.target.value === 'other' ? 'block' : 'none';
      }
    } else if (e.target.id === 'build-habit') {
      const customContainer = document.getElementById('build-custom-container');
      if (customContainer) {
        customContainer.style.display = e.target.value === 'other' ? 'block' : 'none';
      }
    }
  });

  // Auth event listeners
  document.getElementById('btn-new-user').addEventListener('click', () => {
    showAuthPage('onboarding');
    renderOnboardingStep();
  });

  document.getElementById('btn-existing-user').addEventListener('click', () => {
    showAuthPage('login');
  });

  document.getElementById('btn-onboarding-next').addEventListener('click', nextOnboardingStep);

  document.getElementById('btn-onboarding-back').addEventListener('click', () => {
    if (authState.onboardingStep > 0) {
      authState.onboardingStep--;
      renderOnboardingStep();
    }
  });

  document.getElementById('btn-login').addEventListener('click', handleLogin);
  
  // Check for existing session
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      appState.session = session;
      switchToMainApp();
    }
  });

  // Listen for auth changes
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      appState.session = session;
      switchToMainApp();
    } else if (event === 'SIGNED_OUT') {
      document.getElementById('main-app-container').style.display = 'none';
      document.getElementById('auth-app').style.display = 'block';
      showAuthPage('welcome-screen');
    }
  });
});

// Make functions available globally for onclick handlers
window.openAddModal = openAddModal;
window.closeAddModal = closeAddModal;
window.addHabit = confirmAddHabit;
window.completeHabit = completeHabit;
window.deleteHabit = deleteHabit;
window.openEmergencyModal = openEmergencyModal;
window.handleEmergencySuccess = handleEmergencySuccess;
window.handleEmergencyRelapse = handleEmergencyRelapse;
window.showMainPage = showMainPage;
window.toggleDarkMode = toggleDarkMode;
window.startChallenge = startChallenge;
window.startFriendChallenge = startFriendChallenge;
window.addNewPlanItem = addNewPlanItem;
window.removePlanItem = removePlanItem;

console.log('üéâ UNDO 10/10 App loaded successfully with environment variables!');
console.log('Environment:', window.env.SUPABASE_URL ? 'Loaded from build' : 'Using defaults');
</script>
</body>
</html>
