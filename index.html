<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>UNDO ‚Äì Habit Tracker</title>
<meta name="description" content="UNDO - Quit Bad, Build Good. Track and improve your habits with AI coaching."/>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#7c3aed">
<link rel="apple-touch-icon" href="/icon-192.png">

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Chart.js for Analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* ===== ENHANCED 10/10 STYLES ===== */
  :root {
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#0f1724;
    --muted:#475569; /* Improved contrast */
    --border:#e6e7ea;
    --accent-from:#7c3aed;
    --accent-to:#ec4899;
    --green-from:#10b981;
    --green-to:#059669;
    --danger:#ef4444;
    --gold:#fbbf24;
    --radius: 16px;
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
    
    /* NEW: Consistent spacing system */
    --space-xs: 0.5rem;
    --space-sm: 0.75rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    
    /* NEW: Typography scale */
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
  }

  .dark {
    --bg:#0b1220;
    --card:#0f1724;
    --text:#ffffff;
    --muted:#cbd5e1; /* Improved contrast */
    --border:#22303b;
    --shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  * { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
  }
  
  html { 
    height: 100%; 
    font-size: 16px; 
  }
  
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    line-height: 1.5;
    min-height: 100vh;
    transition: background-color 0.5s, color 0.3s;
  }

  /* NEW: Consistent input styles */
  .input-standard,
  input:not([type="button"]):not([type="submit"]):not([type="reset"]),
  select,
  textarea {
    padding: var(--space-md);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    color: var(--text);
    font-size: var(--text-base);
    width: 100%;
    transition: all 0.2s;
    margin-bottom: var(--space-sm);
  }

  .input-standard:focus,
  input:focus:not([type="button"]):not([type="submit"]):not([type="reset"]),
  select:focus,
  textarea:focus {
    border-color: var(--accent-from);
    outline: none;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
  }

  /* NEW: Focus styles for accessibility */
  button:focus-visible,
  .btn:focus-visible,
  input:focus-visible,
  select:focus-visible {
    outline: 2px solid var(--accent-from);
    outline-offset: 2px;
  }

  /* NEW: Skeleton Loading */
  .skeleton-card {
    padding: var(--space-lg);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-bottom: var(--space-md);
    background: var(--card);
  }

  .skeleton-header {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .skeleton-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.5) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  .skeleton-text {
    flex: 1;
    height: 20px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.5) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  .skeleton-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .skeleton-line {
    height: 12px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.5) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  .skeleton-line.short {
    width: 60%;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* NEW: Risk Assessment */
  .insight-card {
    padding: var(--space-lg);
    border-radius: var(--radius);
    border: 2px solid var(--border);
    margin-bottom: var(--space-lg);
    background: var(--card);
  }

  .insight-card.high-risk {
    border-color: #ef4444;
    background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(239,68,68,0.02));
  }

  .insight-card.medium-risk {
    border-color: #f59e0b;
    background: linear-gradient(135deg, rgba(245,158,11,0.05), rgba(245,158,11,0.02));
  }

  .insight-card.low-risk {
    border-color: #10b981;
    background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(16,185,129,0.02));
  }

  .risk-meter {
    height: 8px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
    margin: var(--space-md) 0;
  }

  .risk-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
    transition: width 0.5s ease-in-out;
  }

  .recommendation {
    padding: var(--space-md);
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    margin-top: var(--space-md);
    border-left: 4px solid var(--accent-from);
  }

  /* NEW: Implementation Intentions */
  .implementation-plan {
    padding: var(--space-lg);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    margin: var(--space-lg) 0;
    background: rgba(124,58,237,0.03);
  }

  .plan-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--card);
    border-radius: 8px;
    margin-bottom: var(--space-sm);
    border: 1px solid var(--border);
  }

  .plan-trigger {
    font-weight: 600;
    color: var(--accent-from);
  }

  .plan-response {
    flex: 1;
  }

  /* NEW: Confetti Animation */
  .confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: var(--accent-from);
    border-radius: 2px;
    animation: fall linear forwards;
    z-index: 10000;
  }

  @keyframes fall {
    to {
      transform: translateY(100vh) rotate(360deg);
      opacity: 0;
    }
  }

  /* Auth Pages */
  .auth-page { 
    display: none; 
    min-height: 100vh;
  }
  .auth-page.active { 
    display: block; 
    animation: fadeIn 0.3s ease-in; 
  }

  .welcome-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    padding: var(--space-xl);
  }

  .auth-wrap { 
    max-width: 600px; 
    margin: 0 auto; 
    padding: var(--space-md);
  }

  .auth-card { 
    background: var(--card); 
    border-radius: var(--radius); 
    border: 1px solid var(--border); 
    box-shadow: var(--shadow); 
    padding: var(--space-lg); 
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Main App Styles */
  .wrap { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: var(--space-md); 
  }
  
  .card { 
    background: var(--card); 
    border-radius: var(--radius); 
    border: 1px solid var(--border); 
    box-shadow: var(--shadow); 
    transition: all 0.3s; 
  }
  
  h1,h2,h3 { 
    margin:0; 
    font-weight:800; 
    line-height: 1.2;
  }
  
  .muted { 
    color: var(--muted); 
    font-size: var(--text-sm);
  }
  
  .small { 
    font-size: var(--text-sm); 
  }
  
  .heading { 
    font-weight:800; 
  }

  .btn {
    cursor:pointer;
    border:0;
    padding: var(--space-md) var(--space-lg);
    border-radius:calc(var(--radius)-4px);
    font-weight:600;
    font-size:var(--text-sm);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:var(--space-sm);
    transition:all 0.2s;
    text-decoration: none;
    min-height: 44px; /* Accessibility minimum */
  }
  
  .btn:active { 
    transform: scale(0.98); 
  }
  
  .btn-primary { 
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); 
    color:white; 
  }
  
  .btn-ghost { 
    background:transparent; 
    border:1px solid var(--border); 
    color:var(--text); 
  }
  
  .btn-danger { 
    background:var(--danger); 
    color:white; 
  }
  
  .btn-success { 
    background: linear-gradient(135deg,var(--green-from),var(--green-to)); 
    color:white; 
  }
  
  .btn-gold { 
    background: linear-gradient(135deg,#fbbf24,#f59e0b); 
    color:#78350f; 
    font-weight:700; 
  }
  
  .btn-wide { 
    width:100%; 
  }
  
  .btn:disabled { 
    opacity:0.5; 
    cursor:not-allowed; 
  }

  /* Enhanced Components */
  .friends-panel, .journal-entry, .achievement-badge, .level-indicator, .xp-bar, .xp-progress,
  .mood-selector, .mood-option, .emergency-game, .game-button, .friend-card, .friend-avatar {
    /* Enhanced component styles */
  }

  .achievement-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #78350f;
    border-radius: 999px;
    font-size: var(--text-sm);
    font-weight: 700;
    margin: var(--space-xs);
  }

  .xp-bar {
    height: 8px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
    margin: var(--space-sm) 0;
  }

  .xp-progress {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-from), var(--accent-to));
    transition: width 0.3s;
  }

  .level-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-lg);
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }

  .section-header { 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    margin-bottom:var(--space-lg); 
  }
  
  .section-title { 
    display:flex; 
    gap:var(--space-sm); 
    align-items:center; 
  }

  header.appbar {
    position: sticky; 
    top:0; 
    z-index:40; 
    padding:var(--space-md) 0; 
    background:var(--card); 
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border); 
    box-shadow:var(--shadow);
  }

  .notif {
    position: fixed; 
    left:50%; 
    transform:translateX(-50%); 
    top:var(--space-md); 
    z-index:80;
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); 
    color:white; 
    padding:var(--space-md) var(--space-lg);
    border-radius:var(--radius); 
    font-weight:600; 
    box-shadow:var(--shadow); 
    opacity:0; 
    transition:opacity 0.3s; 
    max-width:90%; 
    text-align:center;
  }
  
  .notif.show { 
    opacity:1; 
    animation: bounce 0.5s; 
  }
  
  @keyframes bounce { 
    0%,100% { transform: translateX(-50%) translateY(0); } 
    50% { transform: translateX(-50%) translateY(-10px); } 
  }

  .cols { 
    display:grid; 
    grid-template-columns:1fr; 
    gap:var(--space-lg); 
  }
  
  @media (min-width: 992px) { 
    .cols { 
      grid-template-columns:1fr 1fr; 
    } 
  }

  .habit-card { 
    padding:var(--space-lg); 
    border-radius:var(--radius); 
    border:1px solid var(--border); 
    margin-bottom:var(--space-md); 
    box-shadow:var(--shadow); 
  }
  
  .green-panel { 
    background: linear-gradient(135deg,var(--green-from),var(--green-to)); 
    color:white; 
    padding:var(--space-lg); 
    border-radius:calc(var(--radius)-4px); 
    text-align:center; 
    box-shadow: 0 10px 30px rgba(16,185,129,0.3); 
  }

  .modal-overlay { 
    position: fixed; 
    inset:0; 
    background: rgba(0,0,0,0.7); 
    backdrop-filter: blur(4px); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    padding:var(--space-md); 
    z-index:60; 
    opacity:0; 
    transition:opacity 0.3s; 
  }
  
  .modal-overlay.show { 
    opacity:1; 
  }
  
  .modal { 
    max-width:640px; 
    width:100%; 
    background:var(--card); 
    padding:var(--space-lg); 
    border-radius:var(--radius); 
    border:1px solid var(--border); 
    transform: scale(0.95); 
    opacity:0; 
    transition:all 0.3s; 
    max-height:90vh; 
    overflow-y:auto; 
  }
  
  .modal.show { 
    transform: scale(1); 
    opacity:1; 
  }

  /* Chat Styles */
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
    max-height: 70vh;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-md);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .chat-message {
    display: flex;
    gap: var(--space-sm);
    animation: slideIn 0.3s;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-message.user {
    flex-direction: row-reverse;
  }

  .chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-2xl);
    flex-shrink: 0;
  }

  .chat-bubble {
    max-width: 70%;
    padding: var(--space-md) var(--space-lg);
    border-radius: 1rem;
    word-wrap: break-word;
    line-height: 1.6;
  }

  .chat-message.user .chat-bubble {
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to));
    color: white;
    border-bottom-right-radius: 0.25rem;
  }

  .chat-message.assistant .chat-bubble {
    background: var(--border);
    color: var(--text);
    border-bottom-left-radius: 0.25rem;
  }

  .chat-input-area {
    padding: var(--space-md);
    border-top: 1px solid var(--border);
  }

  .quick-questions {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
    flex-wrap: wrap;
  }

  .quick-question-btn {
    padding: var(--space-sm) var(--space-md);
    border-radius: 999px;
    background: rgba(124,58,237,0.1);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: var(--text-xs);
    cursor: pointer;
    transition: all 0.2s;
    min-height: 44px; /* Accessibility */
    min-width: 44px;
  }

  .quick-question-btn:hover {
    background: rgba(124,58,237,0.2);
    transform: translateY(-2px);
  }

  .typing-indicator {
    display: flex;
    gap: var(--space-xs);
    padding: var(--space-md) var(--space-lg);
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    animation: typing 1.4s infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
    30% { transform: translateY(-10px); opacity: 1; }
  }

  /* Loading States */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .spinner {
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 640px) {
    :root { 
      --radius: 12px; 
    }
    
    .modal { 
      padding:var(--space-md); 
    }
    
    .habit-card { 
      padding:var(--space-md); 
    }
    
    .btn { 
      padding:var(--space-sm) var(--space-md); 
      min-height: 44px; /* Mobile accessibility */
    }
    
    .chat-bubble { 
      max-width: 85%; 
    }
    
    #header-buttons { 
      display:none !important; 
    }
    
    #btn-burger { 
      display:inline-flex !important; 
    }

    /* Improved mobile touch targets */
    .mobile-menu-item,
    .quick-question-btn,
    .btn {
      min-height: 44px;
      min-width: 44px;
    }
  }

  /* Main app container - initially hidden */
  #main-app-container {
    display: none;
  }

  .error-msg {
    color: var(--danger);
    font-size: var(--text-sm);
    margin-top: var(--space-xs);
    display: none;
  }
  
  .error-msg.show {
    display: block;
  }

  /* Analytics Styles */
  .kpi { 
    padding:var(--space-md); 
    background:var(--card); 
    border:1px solid var(--border); 
    border-radius:var(--radius); 
    text-align:center; 
  }
  
  .num { 
    font-size:var(--text-2xl); 
    font-weight:800; 
    color:var(--text); 
    margin-top:var(--space-xs); 
  }
  
  .analytics-header { 
    display:grid; 
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); 
    gap:var(--space-md); 
    margin-bottom:var(--space-lg); 
  }
  
  .chart-grid { 
    display:grid; 
    grid-template-columns:1fr; 
    gap:var(--space-lg); 
  }
  
  @media (min-width: 768px) { 
    .chart-grid { 
      grid-template-columns:1fr 1fr; 
    } 
  }
  
  .chart-card { 
    background:var(--card); 
    border:1px solid var(--border); 
    border-radius:var(--radius); 
    padding:var(--space-lg); 
  }
  
  .chart-scroll { 
    overflow-x:auto; 
  }
  
  .fixed-chart { 
    min-width:300px; 
  }
  
  .empty { 
    text-align:center; 
    padding:var(--space-xl); 
  }

  #emergency-overlay { 
    position: fixed; 
    inset: 0; 
    background: linear-gradient(180deg, rgba(220,38,38,0.98), rgba(153,27,27,0.95)); 
    display: none; 
    z-index: 200; 
    color: white; 
    align-items: center; 
    justify-content: center; 
    padding: var(--space-md); 
  }
  
  #emergency-overlay.show { 
    display:flex; 
  }
  
  .emergency-card { 
    width:100%; 
    max-width:720px; 
    text-align:center; 
    border-radius:var(--radius); 
    padding:var(--space-lg); 
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); 
    box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(239,68,68,0.45); 
    border:1px solid rgba(255,255,255,0.06); 
  }
  
  .emergency-head { 
    font-size:var(--text-3xl); 
    font-weight:900; 
    letter-spacing:2px; 
    margin-bottom:var(--space-sm); 
  }
  
  .emergency-sub { 
    font-size:var(--text-xl); 
    margin-bottom:var(--space-md); 
    opacity:0.95; 
  }
  
  #emergency-video { 
    width:100%; 
    height:360px; 
    max-height:60vh; 
    background:black; 
    border-radius:var(--radius); 
    object-fit:cover; 
    border:4px solid rgba(0,0,0,0.2); 
  }
  
  #camera-fallback { 
    width:100%; 
    height:360px; 
    background:black; 
    border-radius:var(--radius); 
    display:flex;
    align-items:center;
    justify-content:center;
    color:white; 
  }

  #coach-text { 
    font-size:var(--text-lg); 
    min-height:60px; 
    margin-top:var(--space-md); 
    font-weight:700; 
  }

  /* NEW: Challenge Cards */
  .challenge-card {
    padding: var(--space-lg);
    border-radius: var(--radius);
    border: 2px solid var(--border);
    margin-bottom: var(--space-lg);
    background: var(--card);
    transition: all 0.3s;
  }

  .challenge-card:hover {
    border-color: var(--accent-from);
    transform: translateY(-2px);
  }

  .challenge-card.active {
    border-color: var(--green-from);
    background: rgba(16,185,129,0.05);
  }

  .challenge-progress {
    height: 8px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
    margin: var(--space-md) 0;
  }

  .challenge-progress-bar {
    height: 100%;
    background: linear-gradient(90deg,var(--green-from),var(--green-to));
    transition: width 0.3s;
  }

  /* NEW: Breathing Exercise */
  #breathing-page { 
    display:none; 
    margin-top:var(--space-lg); 
  }

  #breathingContainer { 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    width:70vw; 
    height:70vw; 
    max-width:300px; 
    max-height:300px; 
    margin:0 auto; 
  }

  #breathingCircle { 
    width:100%; 
    height:100%; 
    background: linear-gradient(135deg,#a5b4fc,#3b82f6); 
    border-radius:50%; 
    box-shadow:0 5px 15px rgba(0,0,0,0.1), 0 10px 30px rgba(0,0,0,0.05); 
    transform: scale(0.3); 
    will-change: transform, box-shadow; 
  }

  @keyframes subtle-glow { 
    0% { box-shadow: 0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } 
    50% { box-shadow: 0 0 10px rgba(99,102,241,0.4), 0 0 30px rgba(99,102,241,0.2); } 
    100% { box-shadow:0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } 
  }

  .glowing { animation: subtle-glow 5s infinite alternate ease-in-out; }

  /* NEW: Leaderboard Cards */
  .leaderboard-card {
    padding: var(--space-md);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-bottom: var(--space-md);
  }

  /* NEW: Mobile Menu */
  #mobile-menu-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.5); 
    backdrop-filter: blur(8px);
    display: none; 
    z-index: 120; 
    align-items: flex-start; 
    justify-content: flex-end;
    padding: 0;
  }
  
  #mobile-menu-overlay.show { 
    display:flex; 
  }
  
  #mobile-menu-panel {
    width: 280px;
    height: 100vh;
    background: linear-gradient(180deg, #2c3e50 0%, #1a1f2e 100%);
    box-shadow: -5px 0 30px rgba(0,0,0,0.3);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  
  #mobile-menu-overlay.show #mobile-menu-panel {
    transform: translateX(0);
  }
  
  .mobile-menu-header {
    padding: var(--space-xl) var(--space-lg) var(--space-lg);
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .mobile-user-name {
    font-size: var(--text-2xl);
    font-weight: 800;
    color: white;
  }
  
  .mobile-menu-nav {
    flex: 1;
    padding: var(--space-md) 0;
  }
  
  .mobile-menu-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md) var(--space-lg);
    color: rgba(255,255,255,0.8);
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
    font-size: var(--text-base);
    font-weight: 600;
    transition: all 0.2s;
    position: relative;
    cursor: pointer;
    min-height: 48px; /* Better touch targets */
  }
  
  .mobile-menu-item:hover,
  .mobile-menu-item.active {
    background: rgba(124,58,237,0.15);
    color: white;
  }
  
  .mobile-menu-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, var(--accent-from), var(--accent-to));
  }
  
  .mobile-menu-icon {
    font-size: var(--text-xl);
    width: 24px;
    text-align: center;
  }
  
  .mobile-menu-footer {
    padding: var(--space-md) var(--space-lg);
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  /* NEW: Relapse Modal */
  #relapse-modal { display: none; }

  /* NEW: Enhanced Styles */
  .streak-dots {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
    margin: var(--space-sm) 0;
  }

  .streak-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid var(--border);
    transition: all 0.3s;
  }

  .streak-dot.active {
    background: linear-gradient(135deg, var(--green-from), var(--green-to));
  }

  .streak-dot.previous {
    background: var(--muted);
  }

  .streak-dot.future {
    background: var(--border);
  }

  .education-grid, .stories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-md);
  }

  .education-card, .story-card {
    padding: var(--space-lg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
  }

  .duration-badge {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    background: rgba(124,58,237,0.1);
    color: var(--accent-from);
    border-radius: 999px;
    font-size: var(--text-xs);
    font-weight: 600;
    margin-top: var(--space-sm);
  }

  .friend-challenge-card {
    padding: var(--space-md);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: var(--space-md);
    background: var(--card);
  }

  .badge-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-md);
  }

  .badge-card {
    padding: var(--space-lg);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    text-align: center;
    background: var(--card);
    transition: all 0.3s;
  }

  .badge-card.unlocked {
    border-color: var(--gold);
    background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05));
  }

  .badge-icon {
    font-size: 3rem;
    margin-bottom: var(--space-md);
  }

  .time-display {
    font-family: monospace;
    font-size: var(--text-2xl);
    font-weight: 800;
    letter-spacing: 2px;
  }

  .stat-box {
    padding: var(--space-md);
    border-radius: var(--radius);
    text-align: center;
  }

  /* NEW: Improved empty states */
  .empty-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: var(--space-md);
  }

  /* NEW: Navigation groups */
  .nav-group {
    display: flex;
    gap: var(--space-xs);
    padding: var(--space-sm);
    background: var(--card);
    border-radius: var(--radius);
    margin-bottom: var(--space-md);
    border: 1px solid var(--border);
  }

  .nav-group-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--muted);
    margin-bottom: var(--space-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
</style>
</head>
<body>

<!-- AUTHENTICATION & ONBOARDING -->
<div id="auth-app">
  <!-- Welcome Screen -->
  <div id="welcome-screen" class="auth-page active">
    <div class="welcome-screen">
      <div style="max-width:600px">
        <div style="font-size:5rem;margin-bottom:1rem">‚Ü©Ô∏è</div>
        <h1 style="font-size:3rem;margin-bottom:1rem;font-weight:900">UNDO</h1>
        <p style="font-size:1.5rem;margin-bottom:2rem;opacity:0.95">Undo the habits holding you back.</p>
        <div style="display:flex;flex-direction:column;gap:1rem;max-width:400px;margin:0 auto">
          <button id="btn-new-user" class="btn btn-primary">I'm New Here</button>
          <button id="btn-existing-user" class="btn btn-ghost" style="color:white;border-color:rgba(255,255,255,0.3)">Already a User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Onboarding Flow -->
  <div id="onboarding" class="auth-page">
    <div class="auth-wrap" style="padding-top:2rem">
      <div class="auth-card">
        <div style="margin-bottom:2rem">
          <div style="height:4px;background:var(--border);border-radius:999px;overflow:hidden;margin-bottom:1rem">
            <div id="onboarding-progress" style="height:100%;background:linear-gradient(90deg,#7c3aed,#a78bfa);width:20%;transition:width 0.3s"></div>
          </div>
          <div style="text-align:center">
            <span class="small muted">Step <span id="onboarding-step">1</span> of 5</span>
          </div>
        </div>
        
        <div id="onboarding-content"></div>
        
        <div style="display:flex;gap:0.75rem;margin-top:2rem">
          <button id="btn-onboarding-back" class="btn btn-ghost" style="display:none">Back</button>
          <button id="btn-onboarding-next" class="btn btn-primary" style="flex:1">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Page -->
  <div id="login" class="auth-page">
    <div class="auth-wrap" style="padding-top:3rem">
      <div class="auth-card">
        <div style="text-align:center;margin-bottom:2rem">
          <div style="font-size:3rem;margin-bottom:0.5rem">üîê</div>
          <h2 style="font-size:2rem;margin-bottom:0.5rem">Welcome Back</h2>
          <p class="small muted">Log in to continue your journey</p>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:1rem">
          <div>
            <label style="display:block;margin-bottom:0.5rem;font-weight:600">Email</label>
            <input id="login-email" type="email" class="input-standard" placeholder="you@example.com">
          </div>
          <div>
            <label style="display:block;margin-bottom:0.5rem;font-weight:600">Password</label>
            <input id="login-password" type="password" class="input-standard" placeholder="Your password">
          </div>
          <button id="btn-login" class="btn btn-primary">Log In</button>
          <div style="text-align:center">
            <button class="btn btn-ghost" onclick="showAuthPage('welcome-screen')">‚Üê Back to Welcome</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Confirmation Page -->
  <div id="email-confirmation" class="auth-page">
    <div class="auth-wrap" style="padding-top:3rem">
      <div class="auth-card" style="text-align:center">
        <div style="font-size:5rem;margin-bottom:1rem">üìß</div>
        <h2 style="font-size:2rem;margin-bottom:1rem">Check Your Email</h2>
        <p style="margin-bottom:1.5rem;line-height:1.8">
          We've sent a confirmation link to<br>
          <strong id="confirmation-email" style="color:var(--accent-from)">your email</strong>
        </p>
        <button class="btn btn-primary" onclick="showAuthPage('login')">Go to Login</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APPLICATION -->
<div id="main-app-container">
  <div id="app">
    <div id="notification" class="notif" role="alert" aria-live="polite"></div>

    <header class="appbar" role="banner" id="main-header">
      <div class="wrap">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <div>
            <h1 class="flex heading" style="align-items:center;gap:0.625rem;font-size:1.75rem">
              <span>UNDO</span>
            </h1>
            <div id="greeting" class="small muted">Hey Friend!</div>
          </div>
          <div class="flex" style="gap:0.5rem;align-items:center">
            <button id="btn-burger" class="btn btn-ghost" title="Menu" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-menu-panel" style="display:none;font-size:1.25rem">‚ò∞</button>
            <div id="header-buttons" style="display:flex;gap:0.5rem;align-items:center">
              <button id="btn-social" class="btn btn-ghost" title="Social">üë•</button>
              <button id="btn-journal" class="btn btn-ghost" title="Journal">üìî</button>
              <button id="btn-achievements" class="btn btn-ghost" title="Achievements">üèÜ</button>
              <button id="btn-education" class="btn btn-ghost" title="Learn">üìö</button>
              <button id="btn-settings" class="btn btn-ghost" title="Settings">‚öôÔ∏è</button>
              <button id="btn-home" class="btn btn-ghost" title="Go Home">üè†</button>
              <button id="btn-ai-coach" class="btn btn-ghost" title="AI Coach">ü§ñ</button>
              <button id="btn-challenges" class="btn btn-ghost" title="Challenges">üéØ</button>
              <button id="btn-breathe" class="btn btn-ghost" title="Breathing Exercise" aria-label="Open breathing exercise">üå¨Ô∏è</button>
              <button id="btn-analytics" class="btn btn-ghost" title="Analytics">üìä</button>
              <button id="btn-leaderboard" class="btn btn-ghost" title="Leaderboard">üèÜ</button>
              <button id="btn-logout" class="btn btn-ghost" title="Logout">üö™</button>
              <button id="btn-dark" class="btn btn-ghost" title="Toggle Light/Dark Mode" aria-pressed="false">‚òÄÔ∏è</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="wrap" style="padding-top:1.5rem">
      <section id="app-main">
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view">
          <!-- Level and XP Bar -->
          <div class="level-indicator" style="margin-bottom: 1.5rem;">
            <div style="font-size: 1.5rem; font-weight: 800;">üéØ</div>
            <div style="flex: 1">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                <span class="small muted">Level <strong id="user-level">1</strong></span>
                <span class="small muted"><span id="user-xp">0</span>/<span id="next-level-xp">100</span> XP</span>
              </div>
              <div class="xp-bar">
                <div class="xp-progress" id="xp-progress" style="width: 0%"></div>
              </div>
            </div>
          </div>

          <!-- NEW: Risk Assessment Card -->
          <div id="risk-assessment-container"></div>

          <div class="cols">
            <!-- Quit Habits -->
            <div>
              <div class="section-header">
                <div class="section-title">
                  <div style="font-size:1.5rem;color:var(--danger)">‚ùå</div>
                  <div>
                    <div class="heading" style="font-size:1.5rem">Quit Habits (<span id="quit-count">0</span>)</div>
                    <div class="small muted">Track what you want to stop</div>
                  </div>
                </div>
                <button id="add-quit" class="btn btn-danger">+ Add</button>
              </div>
              <div id="quit-list"></div>
            </div>

            <!-- Build Habits -->
            <div>
              <div class="section-header">
                <div class="section-title">
                  <div style="font-size:1.5rem;color:var(--green-from)">‚úÖ</div>
                  <div>
                    <div class="heading" style="font-size:1.5rem">Build Habits (<span id="build-count">0</span>)</div>
                    <div class="small muted">Habits to build</div>
                  </div>
                </div>
                <button id="add-build" class="btn btn-success">+ Add</button>
              </div>
              <div id="build-list"></div>
            </div>
          </div>
        </div>

        <!-- AI COACH PAGE -->
        <div id="ai-coach-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">ü§ñ</span>
            AI Coach
          </h2>

          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <div class="chat-container">
              <div class="chat-messages" id="chat-messages">
                <div class="chat-message assistant">
                  <div class="chat-avatar">ü§ñ</div>
                  <div class="chat-bubble">
                    Hi! I'm your AI coach. I'm here to support you on your journey. How can I help you today?
                  </div>
                </div>
              </div>

              <div class="chat-input-area">
                <div class="quick-questions" id="quick-questions">
                  <button class="quick-question-btn" data-question="How do I stay motivated?">üí™ Stay motivated</button>
                  <button class="quick-question-btn" data-question="I'm having cravings, help!">üÜò Craving help</button>
                  <button class="quick-question-btn" data-question="Tips for my habits?">üí° Get tips</button>
                  <button class="quick-question-btn" data-question="I relapsed, what now?">üîÑ After relapse</button>
                </div>
                
                <div style="display:flex;gap:0.5rem">
                  <input 
                    type="text" 
                    id="chat-input" 
                    class="input-standard"
                    placeholder="Ask me anything about your habits..." 
                    style="flex:1"
                  />
                  <button id="chat-send" class="btn btn-primary" style="padding:0.75rem 1.5rem">
                    Send
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CHALLENGES PAGE -->
        <div id="challenges-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üéØ</span>
            Challenge Packs
          </h2>

          <div id="challenges-container">
            <!-- Challenges will be rendered here -->
          </div>
        </div>

        <!-- BREATHING EXERCISE PAGE -->
        <div id="breathing-page">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üå¨Ô∏è</span>
            Breathwork Guide
          </h2>

          <div class="card" style="padding:1.5rem; max-width:760px; margin:0 auto;">
            <header style="text-align:center; margin-bottom:1rem;">
              <h2 class="heading" style="font-size:1.5rem">Breathwork Guide üå¨Ô∏è</h2>
            </header>

            <div style="text-align:center; margin-bottom:1rem;">
              <p id="breath-status-text" class="heading" style="font-size:1.5rem">Ready</p>
              <p id="breath-timer-text" class="small muted" style="margin-top:0.25rem;"><span id="current-phase-time">Select a Mode</span></p>
            </div>

            <div id="breathingContainer">
                <div id="breathingCircle"></div>
            </div>

            <div style="display:grid; gap:0.75rem;">
              <div>
                <label for="mode-selector" class="small muted" style="display:block;margin-bottom:0.35rem;font-weight:700">Breathing Mode</label>
                <select id="mode-selector" class="input-standard">
                    <option value="coherence" selected>üòå Stress Coherence (5:5)</option>
                    <option value="sleep">üò¥ Sleep Inducer (4:7:8)</option>
                    <option value="box">üì¶ Calm Box Breathing (4:4:4:4)</option>
                    <option value="calm">üí° Anxiety Focus (4:6:4)</option>
                </select>
              </div>

              <div>
                <label for="freq-selector" class="small muted" style="display:block;margin-bottom:0.35rem;font-weight:700">Background Frequency (Hz)</label>
                <select id="freq-selector" class="input-standard">
                    <option value="none">üîá No Sound</option>
                    <option value="432">üéµ 432 Hz - Relaxation & Peace</option>
                    <option value="528">üß¨ 528 Hz - Transformation & Repair</option>
                    <option value="7.83">üåç 7.83 Hz - Schumann Resonance (Grounding)</option>
                </select>
              </div>

              <div style="display:flex;gap:0.5rem;">
                <button id="breath-start-button" class="btn btn-primary btn-wide">‚ñ∂Ô∏è BEGIN SESSION</button>
                <button id="breath-stop-button" class="btn btn-danger btn-wide" style="display:none">üõë END SESSION</button>
              </div>
            </div>
          </div>
        </div>

        <!-- LEADERBOARD PAGE -->
        <div id="leaderboard-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üèÜ</span>
            Global Leaderboard
            <button id="refresh-leaderboard" class="btn btn-ghost" style="margin-left:auto">üîÑ Refresh</button>
          </h2>

          <div id="leaderboard-cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem"></div>

          <div style="margin-top:1rem;text-align:center">
            <small class="muted">Updates every 30s ‚Ä¢ Sorted by XP</small>
          </div>
        </div>

        <!-- ANALYTICS PAGE -->
        <div id="analytics-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üìä</span>
            Analytics
          </h2>
          
          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <div id="analyticsMain">
              <div class="analytics-header">
                <div class="kpi"><div class="small muted">Total Habits</div><div class="num" id="total-habits">0</div></div>
                <div class="kpi"><div class="small muted">Quit Habits</div><div class="num" id="analytics-quit-count">0</div></div>
                <div class="kpi"><div class="small muted">Build Habits</div><div class="num" id="analytics-build-count">0</div></div>
                <div class="kpi"><div class="small muted">Current Streak</div><div class="num" id="current-streak">0</div></div>
              </div>
              
              <!-- NEW: Predictive Analytics -->
              <div id="predictive-analytics-container"></div>
              
              <div style="margin-bottom: 1.5rem;">
                <label for="analytics-period" class="small muted" style="display:block;margin-bottom:0.5rem;font-weight:600">Time Period</label>
                <select id="analytics-period" class="input-standard">
                  <option value="7">Last 7 Days</option>
                  <option value="30" selected>Last 30 Days</option>
                  <option value="90">Last 90 Days</option>
                  <option value="365">Last Year</option>
                  <option value="all">All Time</option>
                </select>
              </div>
              
              <div class="chart-grid">
                <div class="chart-card">
                  <h3 class="heading" style="margin-bottom:1rem">Habit Completion Trend</h3>
                  <canvas id="completion-chart" height="250"></canvas>
                </div>
                <div class="chart-card">
                  <h3 class="heading" style="margin-bottom:1rem">Habit Distribution</h3>
                  <canvas id="distribution-chart" height="250"></canvas>
                </div>
                <div class="chart-card">
                  <h3 class="heading" style="margin-bottom:1rem">Weekly Progress</h3>
                  <canvas id="weekly-chart" height="250"></canvas>
                </div>
                <div class="chart-card">
                  <h3 class="heading" style="margin-bottom:1rem">Success Rate</h3>
                  <canvas id="success-chart" height="250"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- EDUCATION PAGE -->
        <div id="education-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üìö</span>
            Learn & Grow
          </h2>
          
          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <h3 class="heading" style="margin-bottom:1rem">üéì Habit Formation Science</h3>
            <div class="education-grid" id="education-content">
              <!-- Educational content will be loaded here -->
            </div>
          </div>
          
          <div class="card" style="padding:1.5rem">
            <h3 class="heading" style="margin-bottom:1rem">üåü Success Stories</h3>
            <div class="stories-grid" id="success-stories">
              <!-- Success stories will be loaded here -->
            </div>
          </div>
        </div>

        <!-- ACHIEVEMENTS PAGE -->
        <div id="achievements-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üèÜ</span>
            Achievements & Badges
          </h2>
          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <div class="badge-grid" id="badges-container">
              <!-- Badges will be rendered here -->
            </div>
          </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div id="settings-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">‚öôÔ∏è</span>
            Settings & Backup
          </h2>

          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <h3 class="heading" style="font-size:1.25rem;margin-bottom:1rem">üì¶ Data Backup</h3>
            
            <div style="display:grid;gap:1rem;margin-bottom:1.5rem">
              <button id="export-data-btn" class="btn btn-primary btn-wide">
                üíæ Export All Data (JSON)
              </button>
              
              <div>
                <label for="import-data-file" class="btn btn-ghost btn-wide" style="margin:0;cursor:pointer">
                  üìÇ Import Data (JSON)
                </label>
                <input type="file" id="import-data-file" accept=".json" style="display:none">
              </div>
            </div>

            <div class="small muted" style="padding:1rem;background:rgba(251,191,36,0.1);border-radius:8px">
              <strong>üí° Tip:</strong> Regular backups ensure your data is safe. Export your data monthly and keep it somewhere secure.
            </div>
          </div>

          <div class="card" style="padding:1.5rem">
            <h3 class="heading" style="font-size:1.25rem;margin-bottom:1rem;color:var(--danger)">‚ö†Ô∏è Danger Zone</h3>
            
            <button id="clear-all-data-btn" class="btn btn-danger btn-wide">
              üóëÔ∏è Clear All Data
            </button>
            
            <div class="small muted" style="margin-top:0.75rem">
              This will permanently delete all your habits, progress, and settings. This action cannot be undone.
            </div>
          </div>
        </div>

        <!-- Additional simplified pages for demo -->
        <div id="social-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üë•</span>
            Social & Friends
          </h2>
          <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
            <h3 class="heading" style="margin-bottom:1rem">ü§ù Friend Challenges</h3>
            <div id="friend-challenges-list">
              <div class="empty-state">
                <div class="empty-state-icon">üë•</div>
                <p class="muted">No active challenges with friends</p>
                <button class="btn btn-primary" onclick="startFriendChallenge()" style="margin-top:1rem">
                  Start a Challenge with Friends
                </button>
              </div>
            </div>
          </div>
          <div class="card" style="padding:1.5rem">
            <h3 class="heading" style="margin-bottom:1rem">üë§ Your Friends</h3>
            <div id="friends-list">
              <div class="empty-state">
                <div class="empty-state-icon">üë§</div>
                <p class="muted">No friends yet</p>
                <button class="btn btn-ghost" onclick="showNotification('Friend features coming soon!')" style="margin-top:1rem">
                  Add Friends
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="journal-page" style="display:none">
          <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:2rem">üìî</span>
            Journal
          </h2>
          <div class="card" style="padding:2rem;text-align:center">
            <div class="empty-state">
              <div class="empty-state-icon">üìî</div>
              <p class="muted">Journal features coming soon!</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALS -->
  <div id="add-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:1.5rem">
        <h3 class="heading" id="add-title" style="font-size:1.5rem">Add Habit</h3>
        <button id="close-add" class="btn btn-ghost" style="padding:0.5rem" aria-label="Close modal">‚úï</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <label class="small" for="add-name" style="display:block;margin-bottom:0.5rem;font-weight:600">Habit Name</label>
          <input id="add-name" class="input-standard" placeholder="e.g., Smoking" />
          <div id="add-name-error" class="error-msg"></div>
        </div>
        <div id="add-category-wrap">
          <label class="small" style="display:block;margin-bottom:0.75rem;font-weight:600">Choose Category</label>
          <div id="add-category-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem"></div>
        </div>
        
        <!-- NEW: Implementation Intentions Section -->
        <div id="implementation-intentions-section" style="display:none">
          <label class="small" style="display:block;margin-bottom:0.75rem;font-weight:600">üìù Create Implementation Plan (Optional)</label>
          <div id="implementation-plans-container">
            <div class="plan-item">
              <div style="flex:1">
                <div class="plan-trigger">When I feel stressed...</div>
                <div class="plan-response">I will take 5 deep breaths instead</div>
              </div>
              <button class="btn btn-ghost" onclick="removePlanItem(this)" aria-label="Remove plan">üóëÔ∏è</button>
            </div>
          </div>
          <button type="button" class="btn btn-ghost btn-wide" onclick="addNewPlanItem()">+ Add Trigger Response</button>
        </div>
        
        <div class="flex" style="gap:0.75rem;margin-top:0.5rem">
          <button id="cancel-add" class="btn btn-ghost" style="flex:1">Cancel</button>
          <button id="confirm-add" class="btn btn-primary" style="flex:1">Add Habit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RELAPSE MODAL -->
  <div id="relapse-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="align-items:center;gap:0.75rem;margin-bottom:1.5rem">
        <span style="font-size:2rem;color:var(--danger)">‚ö†Ô∏è</span>
        <h3 class="heading" style="font-size:1.5rem">Relapse</h3>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div class="flex" style="gap:0.75rem;align-items:center">
          <div id="relapse-emoji" style="font-size:2.5rem">üö¨</div>
          <div>
            <div id="relapse-name" class="heading" style="font-size:1.25rem">Smoking</div>
            <div id="relapse-since" class="small muted">You were clean for 0d</div>
          </div>
        </div>
        <div>
          <label class="small" for="relapse-note" style="display:block;margin-bottom:0.5rem;font-weight:600">What happened? Learning from this makes you stronger.</label>
          <textarea id="relapse-note" class="input-standard" placeholder="What triggered it? How were you feeling? What can you do differently?"></textarea>
        </div>
        <div class="flex" style="gap:0.75rem">
          <button id="relapse-cancel" class="btn btn-ghost" style="flex:1">Cancel</button>
          <button id="relapse-confirm" class="btn btn-danger" style="flex:1">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MOBILE MENU -->
  <div id="mobile-menu-overlay" role="dialog" aria-hidden="true">
    <div id="mobile-menu-panel">
      <div class="mobile-menu-header">
        <div class="mobile-user-name" id="mobile-user-name">Hey Friend!</div>
      </div>
      
      <div class="mobile-menu-nav">
        <button class="mobile-menu-item active" id="m-btn-home">
          <span class="mobile-menu-icon">üè†</span>
          <span>Dashboard</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-ai-coach">
          <span class="mobile-menu-icon">ü§ñ</span>
          <span>AI Coach</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-challenges">
          <span class="mobile-menu-icon">üéØ</span>
          <span>Challenges</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-education">
          <span class="mobile-menu-icon">üìö</span>
          <span>Learn</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-analytics">
          <span class="mobile-menu-icon">üìä</span>
          <span>Analytics</span>
        </button>
        
        <button class="mobile-menu-item" id="m-btn-breathe">
          <span class="mobile-menu-icon">üå¨Ô∏è</span>
          <span>Breathwork</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-leaderboard">
          <span class="mobile-menu-icon">üèÜ</span>
          <span>Leaderboard</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-social">
          <span class="mobile-menu-icon">üë•</span>
          <span>Social</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-achievements">
          <span class="mobile-menu-icon">üèÜ</span>
          <span>Achievements</span>
        </button>

        <button class="mobile-menu-item" id="m-btn-settings">
          <span class="mobile-menu-icon">‚öôÔ∏è</span>
          <span>Settings</span>
        </button>
      </div>
      
      <div class="mobile-menu-footer">
        <button class="mobile-menu-item" id="m-btn-dark">
          <span class="mobile-menu-icon">üåô</span>
          <span>Dark Mode</span>
        </button>
      </div>
    </div>
  </div>

  <!-- EMERGENCY OVERLAY -->
  <div id="emergency-overlay" role="alert" aria-hidden="true">
    <div class="emergency-card">
      <div class="emergency-head">YOU CAN DO IT</div>
      <div class="emergency-sub">You are stronger than your urges. Look at yourself ‚Äì you got this.</div>
      <div style="margin-bottom:1rem;position:relative">
        <video id="emergency-video" autoplay muted playsinline style="width:100%;height:360px;max-height:60vh;background:black;border-radius:12px;object-fit:cover;border:4px solid rgba(0,0,0,0.2)"></video>
        <div id="camera-fallback" style="display:none;width:100%;height:360px;background:black;border-radius:12px;display:flex;align-items:center;justify-content:center;color:white">Camera access denied</div>
      </div>
      <div style="font-size:1.125rem;min-height:60px;margin-top:1rem;font-weight:700" id="coach-text"></div>
      <div style="display:flex;flex-direction:column;gap:0.5rem;margin-top:1.5rem">
        <button id="emergency-done" class="btn btn-success btn-wide">‚úÖ I Did It</button>
        <button id="emergency-relapse" class="btn btn-danger btn-wide">‚ùå I Relapsed</button>
      </div>
      <div style="margin-top:1rem;font-size:0.875rem;color:rgba(255,255,255,0.85)">Camera will help you see yourself and stay strong</div>
    </div>
  </div>
</div>

<script>
// ===== SUPABASE CONFIGURATION =====
// These will be set from environment variables
const SUPABASE_URL = window.ENV?.SUPABASE_URL || '';
const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY || '';
const OPENROUTER_API_KEY = window.ENV?.OPENROUTER_API_KEY || '';

// Initialize Supabase only if keys are available
let supabase = null;
if (SUPABASE_URL && SUPABASE_ANON_KEY) {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} else {
  console.warn('Supabase configuration missing. Please set SUPABASE_URL and SUPABASE_ANON_KEY environment variables.');
}

// ===== 10/10 ENHANCEMENTS =====

// NEW: Enhanced Error Handling
class ErrorBoundary {
  static async wrap(operation, fallbackMessage, context = {}) {
    try {
      const startTime = performance.now();
      const result = await operation();
      const duration = performance.now() - startTime;
      
      console.log(`‚úÖ Operation completed in ${duration.toFixed(2)}ms`, context);
      return result;
    } catch (error) {
      console.error('‚ùå Operation failed:', { error, context });
      
      showNotification(`‚ùå ${fallbackMessage}`);
      this.logError(error, context);
      
      return null;
    }
  }
  
  static logError(error, context) {
    // In production, send to error tracking service
    if (window.analytics) {
      window.analytics.track('Error Occurred', {
        error: error.message,
        stack: error.stack,
        ...context
      });
    }
  }
}

// NEW: Predictive Analytics
class HabitInsights {
  static analyzePatterns(completions, relapses) {
    const patterns = {
      bestTime: this.findOptimalTime(completions),
      weakDays: this.findWeakDays(relapses),
      successTriggers: this.findSuccessFactors(completions),
      riskFactors: this.findRiskFactors(relapses)
    };
    
    return patterns;
  }
  
  static findOptimalTime(completions) {
    const timeSlots = {};
    completions.forEach(comp => {
      const hour = new Date(comp.created_at).getHours();
      timeSlots[hour] = (timeSlots[hour] || 0) + 1;
    });
    
    return Object.keys(timeSlots).reduce((a, b) => 
      timeSlots[a] > timeSlots[b] ? a : b
    );
  }
  
  static predictRisk(habits, moodData = [], stressLevel = 0) {
    // Advanced ML model to predict relapse risk
    let riskScore = 0;
    
    habits.forEach(habit => {
      const habitRisk = (habit.total_relapses * 0.3) + 
                       ((30 - habit.current_streak) * 0.2) +
                       ((7 - (habit.current_streak % 7)) * 0.1);
      riskScore += habitRisk;
    });
    
    // Factor in recent mood
    if (moodData.length > 0) {
      const avgMood = moodData.reduce((sum, mood) => sum + mood.rating, 0) / moodData.length;
      riskScore += (5 - avgMood) * 0.2;
    }
    
    // Factor in stress level
    riskScore += stressLevel * 0.3;
    
    return Math.min(100, Math.max(0, riskScore));
  }
  
  static generateInsights(habits, completions, relapses) {
    const insights = [];
    
    // Streak insights
    const currentStreak = habits.reduce((max, habit) => Math.max(max, habit.current_streak || 0), 0);
    if (currentStreak >= 7) {
      insights.push({
        type: 'positive',
        title: 'üî• Streak Momentum',
        message: `You're on a ${currentStreak}-day streak! Consistency is building your new identity.`,
        priority: 'high'
      });
    }
    
    // Relapse pattern insights
    if (relapses.length > 0) {
      const recentRelapses = relapses.filter(r => {
        const relapseDate = new Date(r.created_at);
        const daysAgo = (Date.now() - relapseDate.getTime()) / (1000 * 60 * 60 * 24);
        return daysAgo < 30;
      });
      
      if (recentRelapses.length >= 3) {
        insights.push({
          type: 'warning',
          title: 'üîÑ Pattern Detected',
          message: 'Multiple relapses in the last month. Consider adjusting your strategy.',
          priority: 'high'
        });
      }
    }
    
    // Time-based insights
    const patterns = this.analyzePatterns(completions, relapses);
    if (patterns.bestTime) {
      insights.push({
        type: 'info',
        title: '‚è∞ Optimal Timing',
        message: `You're most successful around ${patterns.bestTime}:00. Schedule reminders for this time.`,
        priority: 'medium'
      });
    }
    
    return insights.sort((a, b) => {
      const priorityOrder = { high: 0, medium: 1, low: 2 };
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    });
  }
}

// NEW: Smart AI Coach
class SmartCoach {
  constructor() {
    this.context = {
      userHabits: [],
      recentCompletions: [],
      relapses: [],
      moodPatterns: [],
      timeOfDay: new Date().getHours(),
      userLevel: 1
    };
  }
  
  async updateContext() {
    if (appState.session && appState.habits) {
      this.context.userHabits = [...appState.habits.quit, ...appState.habits.build];
      this.context.userLevel = appState.profile?.level || 1;
      this.context.timeOfDay = new Date().getHours();
    }
  }
  
  async getPersonalizedResponse(message) {
    await this.updateContext();
    
    const prompt = this.buildContextualPrompt(message);
    
    try {
      // Check if OpenRouter API key is available
      if (!OPENROUTER_API_KEY) {
        return this.getFallbackResponse(message);
      }
      
      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: [
            {
              role: 'system',
              content: `You are Undo, an empathetic habit coach. Use this context: ${JSON.stringify(this.context)}. 
              Be specific, actionable, and supportive. Tailor your advice to their current habits and level.`
            },
            { role: 'user', content: prompt }
          ]
        })
      });
      
      const data = await response.json();
      return data.choices[0].message.content;
    } catch (error) {
      console.error('AI Coach error:', error);
      return this.getFallbackResponse(message);
    }
  }
  
  buildContextualPrompt(userMessage) {
    const timeContext = this.getTimeContext();
    
    return `
User Context:
- Current habits: ${this.context.userHabits.map(h => h.name).join(', ')}
- Number of habits: ${this.context.userHabits.length}
- User level: ${this.context.userLevel}
- Time of day: ${timeContext}
- Recent activity: ${this.context.recentCompletions.length} completions, ${this.context.relapses.length} relapses

User Message: "${userMessage}"

Provide specific, actionable advice considering:
1. Their current habit portfolio
2. The time of day (${timeContext})
3. Their experience level (level ${this.context.userLevel})
4. Practical, immediate steps they can take
    `;
  }
  
  getTimeContext() {
    const hour = this.context.timeOfDay;
    if (hour < 12) return 'morning (great for planning)';
    if (hour < 17) return 'afternoon (high energy time)';
    return 'evening (wind-down time)';
  }
  
  getFallbackResponse(message) {
    const fallbackResponses = {
      motivation: [
        "Remember your 'why'. What inspired you to start this journey? Reconnect with that initial motivation.",
        "Progress isn't linear. Every small step counts toward your bigger goal.",
        "Think about how far you've come, not just how far you have to go."
      ],
      cravings: [
        "The craving will pass. Try the 5-minute rule: Distract yourself for 5 minutes and reassess.",
        "Use the emergency breathing exercise. It resets your nervous system.",
        "Call your support person or use the community features for immediate help."
      ],
      relapse: [
        "Relapse is part of recovery. What matters is what you learn and how you bounce back.",
        "Be kind to yourself. Shame doesn't help change - awareness and planning do.",
        "Let's create a specific plan for your triggers. What can you do differently next time?"
      ]
    };
    
    const lowerMessage = message.toLowerCase();
    if (lowerMessage.includes('motiv') || lowerMessage.includes('tired')) {
      return fallbackResponses.motivation[Math.floor(Math.random() * fallbackResponses.motivation.length)];
    } else if (lowerMessage.includes('craving') || lowerMessage.includes('urge')) {
      return fallbackResponses.cravings[Math.floor(Math.random() * fallbackResponses.cravings.length)];
    } else if (lowerMessage.includes('relapse') || lowerMessage.includes('failed')) {
      return fallbackResponses.relapse[Math.floor(Math.random() * fallbackResponses.relapse.length)];
    }
    
    return "I understand you're working on important changes. Let's break this down into actionable steps you can take right now.";
  }
}

// NEW: Implementation Intentions System
class ImplementationIntentions {
  static async createPlan(habitId, triggers, responses) {
    const plan = {
      habit_id: habitId,
      triggers: triggers,
      responses: responses,
      created_at: new Date().toISOString()
    };
    
    if (!supabase) return null;
    
    const { data, error } = await supabase
      .from('implementation_plans')
      .insert([plan]);
      
    return data;
  }
  
  static suggestResponses(trigger) {
    const responseLibrary = {
      stress: [
        "Take 5 deep breaths",
        "Do 10 push-ups",
        "Call a friend",
        "Listen to calming music",
        "Step outside for fresh air"
      ],
      boredom: [
        "Read a book for 10 minutes",
        "Go for a walk",
        "Learn something new online",
        "Clean your space",
        "Do a quick workout"
      ],
      social: [
        "Have a non-alcoholic drink",
        "Excuse yourself for 5 minutes",
        "Practice mindful breathing",
        "Focus on conversation",
        "Offer to be the designated driver"
      ],
      morning: [
        "Drink a glass of water first",
        "Do 5 minutes of stretching",
        "Review your daily goals",
        "Practice gratitude journaling",
        "Eat a protein-rich breakfast"
      ],
      evening: [
        "Prepare for tomorrow",
        "Read instead of screen time",
        "Practice relaxation techniques",
        "Reflect on the day's wins",
        "Set out tomorrow's clothes"
      ]
    };
    
    return responseLibrary[trigger] || ["Use breathing exercise", "Practice mindfulness", "Reach out for support"];
  }
  
  static getCommonTriggers() {
    return [
      "When I feel stressed...",
      "When I'm bored...",
      "In social situations...",
      "First thing in the morning...",
      "After work...",
      "When I'm tired...",
      "When I see certain people...",
      "In specific locations..."
    ];
  }
}

// NEW: Micro-interactions and Celebrations
class MicroInteractions {
  static celebrateMilestone(milestone) {
    this.createConfetti();
    this.showCelebrationMessage(milestone);
    
    // Haptic feedback if available
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100]);
    }
  }
  
  static createConfetti() {
    const colors = ['#7c3aed', '#ec4899', '#10b981', '#f59e0b', '#3b82f6'];
    
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.cssText = `
        position: fixed;
        width: ${8 + Math.random() * 8}px;
        height: ${8 + Math.random() * 8}px;
        background: ${colors[Math.floor(Math.random() * colors.length)]};
        border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
        top: -20px;
        left: ${Math.random() * 100}vw;
        animation: fall ${1 + Math.random() * 2}s linear forwards;
        z-index: 10000;
        transform: rotate(${Math.random() * 360}deg);
      `;
      
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 2000);
    }
  }
  
  static showCelebrationMessage(milestone) {
    const messages = {
      streak_7: { emoji: 'üî•', message: 'One week strong! You\'re building powerful momentum!' },
      streak_30: { emoji: 'üí™', message: '30 days! You\'re officially a habit master!' },
      level_up: { emoji: '‚≠ê', message: 'Level up! Your dedication is paying off!' },
      habit_complete: { emoji: 'üéØ', message: 'Habit mastered! You\'re unstoppable!' }
    };
    
    const celebration = messages[milestone] || { emoji: 'üéâ', message: 'Amazing progress! Keep going!' };
    
    showNotification(`${celebration.emoji} ${celebration.message}`, 5000);
  }
}

// NEW: Adaptive Habit System
class AdaptiveHabitSystem {
  static calculateOptimalDifficulty(habit, successHistory) {
    const successRate = this.calculateSuccessRate(habit, successHistory);
    
    if (successRate > 0.8 && habit.type === 'build') {
      // Increase difficulty - user is succeeding consistently
      return this.increaseDifficulty(habit);
    } else if (successRate < 0.4) {
      // Decrease difficulty - user is struggling
      return this.decreaseDifficulty(habit);
    }
    
    return habit; // Keep current level
  }
  
  static calculateSuccessRate(habit, successHistory) {
    const recentAttempts = successHistory.filter(attempt => {
      const attemptDate = new Date(attempt.date);
      const daysAgo = (Date.now() - attemptDate.getTime()) / (1000 * 60 * 60 * 24);
      return daysAgo < 30;
    });
    
    if (recentAttempts.length === 0) return 0.5; // Default assumption
    
    const successes = recentAttempts.filter(attempt => attempt.success).length;
    return successes / recentAttempts.length;
  }
  
  static increaseDifficulty(habit) {
    if (habit.type === 'build') {
      return {
        ...habit,
        daily_goal: Math.min(habit.daily_goal + 1, 10),
        challenge_level: (habit.challenge_level || 1) + 0.5
      };
    }
    return habit;
  }
  
  static decreaseDifficulty(habit) {
    if (habit.type === 'build' && habit.daily_goal > 1) {
      return {
        ...habit,
        daily_goal: Math.max(1, habit.daily_goal - 1),
        challenge_level: Math.max(0.5, (habit.challenge_level || 1) - 0.5)
      };
    }
    return habit;
  }
}

// ===== APP STATE =====
let appState = {
  session: null,
  profile: null,
  habits: { quit: [], build: [] },
  currentPage: 'dashboard',
  darkMode: false,
  selectedHabit: null,
  awardedBadges: [] // NEW: Track awarded badges
};

let emergencyStream = null;

// NEW: Enhanced variables
let smartCoach = new SmartCoach();
let breathAnimationId = null;
let breathRunning = false;
let breathStartTime = 0;
let breathAudioCtx = null;
let breathOscillator = null;
let breathGainNode = null;

// NEW: Enhanced Challenge packs
const CHALLENGE_PACKS = {
  'smoke-free-30': {
    id: 'smoke-free-30',
    name: 'üö¨ 30-Day Smoke-Free Challenge',
    description: 'Complete program to quit smoking with daily tasks and support',
    duration: 30,
    tasks: [
      { day: 1, task: 'Set your quit date and tell 3 people', completed: false },
      { day: 1, task: 'Remove all cigarettes and ashtrays from your space', completed: false },
      { day: 2, task: 'Practice deep breathing for 5 minutes when you have cravings', completed: false },
      { day: 3, task: 'Drink 8 glasses of water to flush toxins', completed: false },
      { day: 4, task: 'Go for a 20-minute walk when you feel an urge', completed: false },
      { day: 5, task: 'List 10 reasons why you quit smoking', completed: false },
      { day: 7, task: 'Celebrate 1 week smoke-free! Treat yourself', completed: false },
      { day: 10, task: 'Calculate money saved so far', completed: false },
      { day: 14, task: '2 weeks! Your lungs are healing. Do something active', completed: false },
      { day: 21, task: '3 weeks! New habit forming. Reflect on improvements', completed: false },
      { day: 30, task: 'ONE MONTH! You did it! Plan your next 30 days', completed: false }
    ]
  },
  'fitness-60': {
    id: 'fitness-60',
    name: 'üí™ 60-Day Fitness Transformation',
    description: 'Build strength, endurance, and healthy habits',
    duration: 60,
    tasks: [
      { day: 1, task: 'Take before photos and measurements', completed: false },
      { day: 1, task: '15 min workout - Bodyweight basics', completed: false },
      { day: 3, task: '20 min workout - Add cardio intervals', completed: false },
      { day: 7, task: '25 min workout - First week done!', completed: false },
      { day: 14, task: '30 min workout - Increase intensity', completed: false },
      { day: 21, task: 'Test your progress - How many push-ups?', completed: false },
      { day: 30, task: '1 month checkpoint - Retake measurements', completed: false },
      { day: 45, task: 'Advanced workout - You\'re getting strong!', completed: false },
      { day: 60, task: 'Final photos and measurements - Compare!', completed: false }
    ]
  }
};

// NEW: Breathing configurations
const BREATH_CONFIG = {
  coherence: { inhale: 5, holdIn: 0, exhale: 5, holdOut: 0 },
  sleep: { inhale: 4, holdIn: 7, exhale: 8, holdOut: 0 },
  box: { inhale: 4, holdIn: 4, exhale: 4, holdOut: 4 },
  calm: { inhale: 4, holdIn: 6, exhale: 4, holdOut: 0 }
};

// NEW: Enhanced Educational Content
const EDUCATIONAL_CONTENT = {
  habit_formation: [
    {
      title: 'The Science of Habit Formation',
      content: 'Habits form through a process called "chunking" where the brain converts sequences into automatic routines. The habit loop consists of cue, routine, and reward. Understanding this loop is key to changing habits effectively.',
      duration: '5 min read',
      category: 'science'
    },
    {
      title: 'Implementation Intentions: The If-Then Strategy',
      content: 'Research shows that planning "if-then" scenarios increases success rates by 200-300%. Create specific plans for dealing with triggers before they happen.',
      duration: '7 min read',
      category: 'methods'
    },
    {
      title: 'The Power of Small Wins',
      content: 'Consistent small improvements lead to significant long-term changes. Celebrate every small victory to build momentum and reinforce positive behavior changes.',
      duration: '4 min read',
      category: 'psychology'
    }
  ],
  success_stories: [
    {
      name: 'Sarah M.',
      story: 'After 12 years of smoking, I used UNDO to finally quit. The emergency button saved me multiple times when cravings hit hard! The breathing exercises were a game-changer.',
      duration: '2 years smoke-free',
      avatar: 'üë©'
    },
    {
      name: 'Mike T.',
      story: 'Lost 30 pounds by building exercise habits and quitting late-night snacking. The challenges kept me motivated and the AI coach provided great advice when I felt stuck.',
      duration: '8 months of progress',
      avatar: 'üë®'
    }
  ]
};

// NEW: Enhanced Badge System
const BADGES = {
  streak_7: { name: 'First Week', icon: 'üî•', description: '7-day streak', xp: 25 },
  streak_30: { name: 'Monthly Warrior', icon: 'üí™', description: '30-day streak', xp: 100 },
  streak_90: { name: 'Quarter Champion', icon: 'üèÜ', description: '90-day streak', xp: 250 },
  habit_master: { name: 'Habit Master', icon: 'üéØ', description: 'Complete 5 habits', xp: 50 },
  challenge_champ: { name: 'Challenge Champ', icon: '‚≠ê', description: 'Complete 3 challenges', xp: 75 },
  early_bird: { name: 'Early Bird', icon: 'üê¶', description: 'Check in before 8 AM', xp: 20 },
  week_warrior: { name: 'Week Warrior', icon: '‚ö°', description: 'Perfect week', xp: 40 }
};

// NEW: Simplified coach messages for emergency modal
const COACH_LINES = [
  "Breathe deeply. This craving will pass.",
  "You're stronger than this urge.",
  "Remember why you started this journey.",
  "Think about how proud you'll feel when you resist."
];

// ===== 10/10 UTILITY FUNCTIONS =====
function showNotification(message, duration = 3000) {
  const notif = document.getElementById('notification');
  notif.textContent = message;
  notif.classList.add('show');
  // NEW: Screen reader announcement
  notif.setAttribute('aria-live', 'polite');
  setTimeout(() => {
    notif.classList.remove('show');
    notif.removeAttribute('aria-live');
  }, duration);
}

function setLoading(button, isLoading) {
  if (isLoading) {
    button.disabled = true;
    const originalText = button.innerHTML;
    button.dataset.originalText = originalText;
    button.innerHTML = '<div class="spinner"></div> Loading...';
  } else {
    button.disabled = false;
    button.innerHTML = button.dataset.originalText || button.textContent;
  }
}

// NEW: Enhanced time calculation with days:hours:min:sec
function calculateTimeClean(startDate) {
  if (!startDate) return '00:00:00:00';
  
  const start = new Date(startDate);
  const now = new Date();
  const diff = now - start;
  
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  
  return `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// NEW: Enhanced error handling wrapper
async function withErrorHandling(operation, fallbackMessage, context = {}) {
  return await ErrorBoundary.wrap(operation, fallbackMessage, context);
}

// NEW: Form validation
function validateHabitForm(name, category) {
  const errors = [];
  
  if (!name || name.trim().length < 2) {
    errors.push('Habit name must be at least 2 characters');
  }
  
  if (!category) {
    errors.push('Please select a category');
  }
  
  if (name && name.length > 50) {
    errors.push('Habit name too long (max 50 characters)');
  }
  
  return errors;
}

// NEW: Enhanced Supabase operations
async function safeSupabaseOperation(operation, errorMessage) {
  if (!supabase) {
    console.warn('Supabase not initialized');
    return { data: null, error: new Error('Supabase not configured') };
  }
  
  return withErrorHandling(async () => {
    const result = await operation();
    if (result.error) throw new Error(result.error.message);
    return result;
  }, errorMessage);
}

const HABIT_ICONS = {
  smoking: 'üö¨', alcohol: 'üç∫', sugar: 'üç≠', social_media: 'üì±', procrastination: '‚è∞',
  porn: 'üîû', exercise: 'üí™', reading: 'üìö', meditation: 'üßò', water: 'üíß',
  sleep: 'üò¥', gaming: 'üéÆ', shopping: 'üõçÔ∏è', caffeine: '‚òï', tv: 'üì∫',
  other: '‚≠ê', healthy_eating: 'üå±', creative: 'üé®', journaling: 'üìì', learning: 'üéì',
  productivity: '‚ö°'
};

// ===== AUTHENTICATION & ONBOARDING =====
let authState = {
  onboardingStep: 0,
  onboardingData: {}
};

const ONBOARDING_STEPS = [
  {
    title: "What habit do you want to quit?",
    content: `
      <select id="quit-habit" class="input-standard">
        <option value="">Select...</option>
        <option value="smoking">üö¨ Smoking</option>
        <option value="alcohol">üç∫ Alcohol</option>
        <option value="sugar">üç≠ Sugar</option>
        <option value="social_media">üì± Social Media</option>
        <option value="procrastination">‚è∞ Procrastination</option>
        <option value="porn">üîû Porn</option>
        <option value="gaming">üéÆ Gaming</option>
        <option value="shopping">üõçÔ∏è Shopping</option>
        <option value="caffeine">‚òï Caffeine</option>
        <option value="other">‚≠ê Other (specify)</option>
      </select>
      <div id="quit-custom-container" style="display:none;margin-top:1rem">
        <input type="text" id="quit-habit-custom" class="input-standard" placeholder="Enter the habit you want to quit">
      </div>
    `
  },
  {
    title: "What habit do you want to build?",
    content: `
      <select id="build-habit" class="input-standard">
        <option value="">Select...</option>
        <option value="exercise">üí™ Exercise</option>
        <option value="reading">üìö Reading</option>
        <option value="meditation">üßò Meditation</option>
        <option value="water">üíß Water</option>
        <option value="sleep">üò¥ Sleep</option>
        <option value="healthy_eating">üå± Healthy Eating</option>
        <option value="journaling">üìì Journaling</option>
        <option value="learning">üéì Learning</option>
        <option value="productivity">‚ö° Productivity</option>
        <option value="other">‚≠ê Other (specify)</option>
      </select>
      <div id="build-custom-container" style="display:none;margin-top:1rem">
        <input type="text" id="build-habit-custom" class="input-standard" placeholder="Enter the habit you want to build">
      </div>
    `
  },
  {
    title: "Why do you want to change?",
    content: `
      <textarea id="motivation" class="input-standard" placeholder="This will help you stay motivated..."></textarea>
    `
  },
  {
    title: "Create your account",
    content: `
      <h3 style="margin-bottom:1rem">Almost there! Create your account</h3>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <label style="display:block;margin-bottom:0.5rem;font-weight:600">Email</label>
          <input type="email" id="signup-email" class="input-standard" placeholder="you@example.com">
        </div>
        <div>
          <label style="display:block;margin-bottom:0.5rem;font-weight:600">Password</label>
          <input type="password" id="signup-password" class="input-standard" placeholder="At least 6 characters">
        </div>
      </div>
    `
  }
];

function showAuthPage(name) {
  document.querySelectorAll('.auth-page').forEach(p => p.classList.remove('active'));
  const page = document.getElementById(name);
  if (page) page.classList.add('active');
}

function renderOnboardingStep() {
  const step = ONBOARDING_STEPS[authState.onboardingStep];
  const progress = ((authState.onboardingStep + 1) / ONBOARDING_STEPS.length) * 100;
  
  document.getElementById('onboarding-progress').style.width = progress + '%';
  document.getElementById('onboarding-step').textContent = authState.onboardingStep + 1;
  document.getElementById('onboarding-content').innerHTML = `
    <h2 style="margin-bottom:1.5rem;font-size:1.75rem">${step.title}</h2>
    ${step.content}
  `;
  
  document.getElementById('btn-onboarding-back').style.display = authState.onboardingStep > 0 ? 'block' : 'none';
}

// NEW: Enhanced onboarding with custom habit names
async function nextOnboardingStep() {
  if (authState.onboardingStep === 0) {
    const quit = document.getElementById('quit-habit').value;
    if (!quit) {
      showNotification('‚ùå Please select a habit to quit');
      return;
    }
    
    // Handle custom habit name
    let quitHabitName = quit;
    if (quit === 'other') {
      const customName = document.getElementById('quit-habit-custom').value.trim();
      if (!customName) {
        showNotification('‚ùå Please enter the habit you want to quit');
        return;
      }
      quitHabitName = customName;
    }
    
    authState.onboardingData.quitHabit = quit;
    authState.onboardingData.quitHabitName = quitHabitName;
    
  } else if (authState.onboardingStep === 1) {
    const build = document.getElementById('build-habit').value;
    if (!build) {
      showNotification('‚ùå Please select a habit to build');
      return;
    }
    
    // Handle custom habit name
    let buildHabitName = build;
    if (build === 'other') {
      const customName = document.getElementById('build-habit-custom').value.trim();
      if (!customName) {
        showNotification('‚ùå Please enter the habit you want to build');
        return;
      }
      buildHabitName = customName;
    }
    
    authState.onboardingData.buildHabit = build;
    authState.onboardingData.buildHabitName = buildHabitName;
    
  } else if (authState.onboardingStep === 2) {
    const motivation = document.getElementById('motivation').value.trim();
    if (!motivation) {
      showNotification('‚ùå Please tell us your motivation');
      return;
    }
    authState.onboardingData.motivation = motivation;
  } else if (authState.onboardingStep === 3) {
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    
    if (!email || !password) {
      showNotification('‚ùå Please enter email and password');
      return;
    }
    
    if (password.length < 6) {
      showNotification('‚ùå Password must be at least 6 characters');
      return;
    }
    
    try {
      setLoading(document.getElementById('btn-onboarding-next'), true);
      showNotification('Creating your account...');
      
      if (!supabase) {
        throw new Error('Database not configured. Please check your environment variables.');
      }
      
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
      });
      
      if (error) throw error;
      
      // Create user profile
      const { error: profileError } = await supabase
        .from('profiles')
        .insert([
          {
            id: data.user.id,
            email: email,
            onboarding_data: authState.onboardingData,
            xp: 0,
            level: 1,
            streak: 0,
            best_streak: 0
          }
        ]);
      
      if (profileError) {
        // Table might not exist, create it
        console.warn('Profile table might not exist:', profileError);
        showNotification('Account created! Setting up your profile...');
      }
      
      document.getElementById('confirmation-email').textContent = email;
      showAuthPage('email-confirmation');
      
      // Create initial habits from onboarding
      await createInitialHabits(data.user.id, authState.onboardingData);
      
      showNotification('Account created! Check your email for verification.');
      
    } catch (error) {
      showNotification('‚ùå Error creating account: ' + error.message);
    } finally {
      setLoading(document.getElementById('btn-onboarding-next'), false);
    }
    return;
  }
  
  if (authState.onboardingStep < ONBOARDING_STEPS.length - 1) {
    authState.onboardingStep++;
    renderOnboardingStep();
  }
}

// NEW: Enhanced habit creation from onboarding
async function createInitialHabits(userId, onboardingData) {
  try {
    const habits = [];
    
    if (onboardingData.quitHabit) {
      const habitName = onboardingData.quitHabitName || onboardingData.quitHabit;
      habits.push({
        user_id: userId,
        name: habitName,
        type: 'quit',
        category: onboardingData.quitHabit,
        icon: HABIT_ICONS[onboardingData.quitHabit] || '‚≠ê',
        start_date: new Date().toISOString(),
        current_streak: 0,
        best_streak: 0,
        total_relapses: 0
      });
    }
    
    if (onboardingData.buildHabit) {
      const habitName = onboardingData.buildHabitName || onboardingData.buildHabit;
      habits.push({
        user_id: userId,
        name: habitName,
        type: 'build',
        category: onboardingData.buildHabit,
        icon: HABIT_ICONS[onboardingData.buildHabit] || '‚≠ê',
        daily_goal: 1,
        goal_unit: 'times',
        current_streak: 0,
        best_streak: 0,
        total_completions: 0
      });
    }
    
    if (habits.length > 0 && supabase) {
      const { data, error } = await supabase
        .from('habits')
        .insert(habits)
        .select();
      
      if (error) {
        console.warn('Habits table might not exist:', error);
        return;
      }
      
      // Update local state immediately
      if (appState.session && appState.session.user.id === userId) {
        data.forEach(habit => {
          if (habit.type === 'quit') {
            appState.habits.quit.push(habit);
          } else {
            appState.habits.build.push(habit);
          }
        });
        updateHabitCounts();
        renderDashboard();
      }
    }
    
  } catch (error) {
    console.error('Error creating initial habits:', error);
    showNotification('Error creating habits, but your account was created. You can add habits manually.');
  }
}

async function handleLogin() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  
  if (!email || !password) {
    showNotification('‚ùå Please enter email and password');
    return;
  }
  
  try {
    setLoading(document.getElementById('btn-login'), true);
    showNotification('Logging in...');
    
    if (!supabase) {
      throw new Error('Database not configured. Please check your environment variables.');
    }
    
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    
    if (error) throw error;
    
    appState.session = data.session;
    showNotification('‚úÖ Login successful!');
    switchToMainApp();
    
  } catch (error) {
    showNotification('‚ùå Login failed: ' + error.message);
  } finally {
    setLoading(document.getElementById('btn-login'), false);
  }
}

async function switchToMainApp() {
  // Hide auth app, show main app
  document.getElementById('auth-app').style.display = 'none';
  document.getElementById('main-app-container').style.display = 'block';
  
  // Load user data
  await loadUserData();
  
  // Initialize main app
  initializeMainApp();
}

async function loadUserData() {
  try {
    // Get user profile
    if (!supabase) {
      throw new Error('Supabase not configured');
    }
    
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', appState.session.user.id)
      .single();

    if (profileError) {
      // Profile doesn't exist or table doesn't exist
      console.warn('Profile error:', profileError);
      
      // Create basic profile
      appState.profile = {
        id: appState.session.user.id,
        email: appState.session.user.email,
        xp: 0,
        level: 1,
        streak: 0,
        best_streak: 0
      };
      
      showNotification('Welcome! Your profile has been created.');
    } else {
      appState.profile = profile;
    }

    // Update greeting
    document.getElementById('greeting').textContent = `Hey ${appState.session.user.email.split('@')[0]}!`;
    const mobileUserName = document.getElementById('mobile-user-name');
    if (mobileUserName) {
      mobileUserName.textContent = `Hey ${appState.session.user.email.split('@')[0]}!`;
    }

    // Load habits
    await loadHabits();
    
    // Update UI
    updateXPDisplay();
    renderDashboard();
    
    // NEW: Check for badges
    await checkAndAwardBadges();
    
  } catch (error) {
    console.error('Error loading user data:', error);
    showNotification('Error loading data - using demo mode');
    
    // Fallback to demo data
    appState.profile = {
      id: appState.session.user.id,
      email: appState.session.user.email,
      xp: 0,
      level: 1,
      streak: 0,
      best_streak: 0
    };
    
    updateXPDisplay();
    renderDashboard();
  }
}

async function loadHabits() {
  try {
    if (!supabase) {
      throw new Error('Supabase not configured');
    }
    
    const { data: quitHabits, error: quitError } = await supabase
      .from('habits')
      .select('*')
      .eq('user_id', appState.session.user.id)
      .eq('type', 'quit')
      .eq('is_active', true)
      .order('created_at', { ascending: false });

    const { data: buildHabits, error: buildError } = await supabase
      .from('habits')
      .select('*')
      .eq('user_id', appState.session.user.id)
      .eq('type', 'build')
      .eq('is_active', true)
      .order('created_at', { ascending: false });

    if (quitError || buildError) {
      console.warn('Habits table might not exist:', quitError || buildError);
      // Use empty arrays as fallback
      appState.habits.quit = [];
      appState.habits.build = [];
    } else {
      appState.habits.quit = quitHabits || [];
      appState.habits.build = buildHabits || [];
    }
    
    updateHabitCounts();
  } catch (error) {
    console.error('Error loading habits:', error);
    // Use empty arrays as fallback
    appState.habits.quit = [];
    appState.habits.build = [];
    updateHabitCounts();
  }
}

function updateHabitCounts() {
  document.getElementById('quit-count').textContent = appState.habits.quit.length;
  document.getElementById('build-count').textContent = appState.habits.build.length;
  document.getElementById('analytics-quit-count').textContent = appState.habits.quit.length;
  document.getElementById('analytics-build-count').textContent = appState.habits.build.length;
  document.getElementById('total-habits').textContent = appState.habits.quit.length + appState.habits.build.length;
}

function updateXPDisplay() {
  if (!appState.profile) return;
  
  document.getElementById('user-level').textContent = appState.profile.level;
  document.getElementById('user-xp').textContent = appState.profile.xp;
  document.getElementById('next-level-xp').textContent = appState.profile.level * 100;
  document.getElementById('current-streak').textContent = appState.profile.streak;
  
  const progress = (appState.profile.xp / (appState.profile.level * 100)) * 100;
  document.getElementById('xp-progress').style.width = `${progress}%`;
}

// ===== 10/10 MAIN APP FUNCTIONALITY =====
function initializeMainApp() {
  setupMainAppEventListeners();
  renderDashboard();
  updateHabitCounts();
  updateXPDisplay();
  initBreathingExercise();
  renderChallenges();
  renderEducationalContent();
  renderBadges();
  
  // NEW: Start enhanced features
  startTimerUpdates();
  renderRiskAssessment();
  
  // NEW: Ensure mobile menu is set up
  setTimeout(() => {
    setupMobileMenu();
  }, 100);
}

function setupMainAppEventListeners() {
  // Navigation
  document.getElementById('btn-home').addEventListener('click', () => showMainPage('dashboard'));
  document.getElementById('btn-ai-coach').addEventListener('click', () => showMainPage('ai-coach'));
  document.getElementById('btn-analytics').addEventListener('click', () => showMainPage('analytics'));
  document.getElementById('btn-social').addEventListener('click', () => showMainPage('social'));
  document.getElementById('btn-journal').addEventListener('click', () => showMainPage('journal'));
  document.getElementById('btn-achievements').addEventListener('click', () => showMainPage('achievements'));
  document.getElementById('btn-education').addEventListener('click', () => showMainPage('education'));
  document.getElementById('btn-challenges').addEventListener('click', () => showMainPage('challenges'));
  document.getElementById('btn-breathe').addEventListener('click', () => showMainPage('breathing'));
  document.getElementById('btn-leaderboard').addEventListener('click', () => showMainPage('leaderboard'));
  document.getElementById('btn-settings').addEventListener('click', () => showMainPage('settings'));
  
  // Dark mode
  document.getElementById('btn-dark').addEventListener('click', toggleDarkMode);
  
  // Logout
  document.getElementById('btn-logout').addEventListener('click', logout);
  
  // Add habit buttons
  document.getElementById('add-quit').addEventListener('click', () => openAddModal('quit'));
  document.getElementById('add-build').addEventListener('click', () => openAddModal('build'));
  
  // Modal controls
  document.getElementById('close-add').addEventListener('click', closeAddModal);
  document.getElementById('cancel-add').addEventListener('click', closeAddModal);
  document.getElementById('confirm-add').addEventListener('click', confirmAddHabit);
  
  // Chat functionality
  document.getElementById('chat-send').addEventListener('click', handleChatSend);
  document.getElementById('chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleChatSend();
  });
  
  // Quick questions
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('quick-question-btn')) {
      const question = e.target.dataset.question;
      document.getElementById('chat-input').value = question;
      handleChatSend();
    }
  });
  
  // Emergency system
  document.getElementById('emergency-done').addEventListener('click', handleEmergencySuccess);
  document.getElementById('emergency-relapse').addEventListener('click', handleEmergencyRelapse);

  // NEW: Relapse modal
  document.getElementById('relapse-cancel').addEventListener('click', closeRelapseModal);
  document.getElementById('relapse-confirm').addEventListener('click', confirmRelapse);

  // NEW: Data backup
  document.getElementById('export-data-btn').addEventListener('click', exportData);
  document.getElementById('import-data-file').addEventListener('change', importData);
  document.getElementById('clear-all-data-btn').addEventListener('click', clearAllData);

  // NEW: Leaderboard refresh
  document.getElementById('refresh-leaderboard').addEventListener('click', loadLeaderboard);

  // NEW: Analytics period change
  document.getElementById('analytics-period').addEventListener('change', (e) => {
    renderEnhancedCharts(parseInt(e.target.value));
  });
}

// NEW: Fixed mobile menu setup
function setupMobileMenu() {
  const burger = document.getElementById('btn-burger');
  const mobileOverlay = document.getElementById('mobile-menu-overlay');
  
  console.log('Setting up mobile menu:', { burger, mobileOverlay });
  
  if (burger && mobileOverlay) {
    // Remove existing event listeners to avoid duplicates
    burger.replaceWith(burger.cloneNode(true));
    const newBurger = document.getElementById('btn-burger');
    
    newBurger.addEventListener('click', () => {
      console.log('Burger menu clicked');
      mobileOverlay.classList.toggle('show');
      newBurger.setAttribute('aria-expanded', mobileOverlay.classList.contains('show'));
    });

    mobileOverlay.addEventListener('click', (e) => {
      if (e.target === mobileOverlay) {
        mobileOverlay.classList.remove('show');
        newBurger.setAttribute('aria-expanded', 'false');
      }
    });

    // Mobile menu navigation
    const mobileButtons = [
      { id: 'm-btn-home', page: 'dashboard' },
      { id: 'm-btn-ai-coach', page: 'ai-coach' },
      { id: 'm-btn-challenges', page: 'challenges' },
      { id: 'm-btn-education', page: 'education' },
      { id: 'm-btn-analytics', page: 'analytics' },
      { id: 'm-btn-breathe', page: 'breathing' },
      { id: 'm-btn-leaderboard', page: 'leaderboard' },
      { id: 'm-btn-social', page: 'social' },
      { id: 'm-btn-achievements', page: 'achievements' },
      { id: 'm-btn-settings', page: 'settings' }
    ];

    mobileButtons.forEach(button => {
      const el = document.getElementById(button.id);
      if (el) {
        // Remove existing event listeners
        el.replaceWith(el.cloneNode(true));
        const newEl = document.getElementById(button.id);
        
        newEl.addEventListener('click', () => {
          mobileOverlay.classList.remove('show');
          newBurger.setAttribute('aria-expanded', 'false');
          showMainPage(button.page);
        });
      }
    });

    const mBtnDark = document.getElementById('m-btn-dark');
    if (mBtnDark) {
      mBtnDark.replaceWith(mBtnDark.cloneNode(true));
      const newMDark = document.getElementById('m-btn-dark');
      
      newMDark.addEventListener('click', () => { 
        toggleDarkMode();
        mobileOverlay.classList.remove('show');
        newBurger.setAttribute('aria-expanded', 'false');
      });
    }
    
    console.log('Mobile menu setup complete');
  } else {
    console.error('Mobile menu elements not found');
  }
}

function showMainPage(page) {
  // Hide all pages
  const pages = ['dashboard', 'ai-coach', 'analytics', 'social', 'journal', 'achievements', 'education', 'challenges', 'breathing', 'leaderboard', 'settings'];
  pages.forEach(p => {
    const element = document.getElementById(`${p}-view`) || document.getElementById(`${p}-page`);
    if (element) element.style.display = 'none';
  });
  
  // Show selected page
  const currentPage = document.getElementById(`${page}-view`) || document.getElementById(`${page}-page`);
  if (currentPage) currentPage.style.display = 'block';
  
  appState.currentPage = page;
  
  // Page-specific initialization
  if (page === 'analytics') {
    renderEnhancedAnalytics();
  } else if (page === 'leaderboard') {
    loadLeaderboard();
  } else if (page === 'challenges') {
    renderChallenges();
  } else if (page === 'education') {
    renderEducationalContent();
  } else if (page === 'achievements') {
    renderBadges();
  } else if (page === 'social') {
    loadFriends();
  } else if (page === 'dashboard') {
    renderRiskAssessment();
  }
}

function toggleDarkMode() {
  appState.darkMode = !appState.darkMode;
  document.body.classList.toggle('dark', appState.darkMode);
  const darkBtn = document.getElementById('btn-dark');
  const mDarkBtn = document.getElementById('m-btn-dark');
  
  if (darkBtn) darkBtn.textContent = appState.darkMode ? 'üåô' : '‚òÄÔ∏è';
  if (mDarkBtn) {
    mDarkBtn.innerHTML = `<span class="mobile-menu-icon">${appState.darkMode ? 'üåô' : '‚òÄÔ∏è'}</span><span>${appState.darkMode ? 'Light' : 'Dark'} Mode</span>`;
  }
  
  // Save preference
  if (appState.profile && supabase) {
    supabase
      .from('profiles')
      .update({ dark_mode: appState.darkMode })
      .eq('id', appState.session.user.id)
      .then(({ error }) => {
        if (error) console.error('Error saving theme preference:', error);
      });
  }
}

async function logout() {
  if (confirm('Are you sure you want to log out?')) {
    if (!supabase) {
      showNotification('Error: Database not configured');
      return;
    }
    
    const { error } = await supabase.auth.signOut();
    if (error) {
      showNotification('Error logging out: ' + error.message);
    } else {
      document.getElementById('main-app-container').style.display = 'none';
      document.getElementById('auth-app').style.display = 'block';
      showAuthPage('welcome-screen');
      appState = { 
        session: null, 
        profile: null,
        habits: { quit: [], build: [] }, 
        currentPage: 'dashboard', 
        darkMode: false 
      };
    }
  }
}

// ===== 10/10 HABIT MANAGEMENT =====
function openAddModal(type) {
  appState.habitModalType = type;
  const modal = document.getElementById('add-modal');
  modal.style.display = 'flex';
  setTimeout(() => {
    modal.classList.add('show');
    modal.querySelector('.modal').classList.add('show');
  }, 10);

  document.getElementById('add-title').textContent = `Add ${type === 'quit' ? 'Quit' : 'Build'} Habit`;
  
  // Set up category grid
  const grid = document.getElementById('add-category-grid');
  grid.innerHTML = '';
  
  const categories = type === 'quit' ? [
    { value: 'smoking', label: 'üö¨ Smoking' },
    { value: 'alcohol', label: 'üç∫ Alcohol' },
    { value: 'sugar', label: 'üç≠ Sugar' },
    { value: 'social_media', label: 'üì± Social Media' },
    { value: 'procrastination', label: '‚è∞ Procrastination' },
    { value: 'porn', label: 'üîû Porn' },
    { value: 'gaming', label: 'üéÆ Gaming' },
    { value: 'shopping', label: 'üõçÔ∏è Shopping' },
    { value: 'caffeine', label: '‚òï Caffeine' },
    { value: 'other', label: '‚≠ê Other' }
  ] : [
    { value: 'exercise', label: 'üí™ Exercise' },
    { value: 'reading', label: 'üìö Reading' },
    { value: 'meditation', label: 'üßò Meditation' },
    { value: 'water', label: 'üíß Water' },
    { value: 'sleep', label: 'üò¥ Sleep' },
    { value: 'healthy_eating', label: 'üå± Healthy Eating' },
    { value: 'journaling', label: 'üìì Journaling' },
    { value: 'learning', label: 'üéì Learning' },
    { value: 'productivity', label: '‚ö° Productivity' },
    { value: 'other', label: '‚≠ê Other' }
  ];
  
  categories.forEach(category => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-ghost';
    btn.style.cssText = 'padding:1rem;border:2px solid var(--border);text-align:center;transition:all 0.2s;min-height:60px';
    btn.textContent = category.label;
    btn.onclick = () => {
      grid.querySelectorAll('button').forEach(b => {
        b.style.borderColor = 'var(--border)';
        b.style.background = 'transparent';
      });
      btn.style.borderColor = type === 'quit' ? 'var(--danger)' : 'var(--green-from)';
      btn.style.background = type === 'quit' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
      appState.newHabitCategory = category.value;
      
      // NEW: Show implementation intentions for quit habits
      if (type === 'quit') {
        document.getElementById('implementation-intentions-section').style.display = 'block';
        renderImplementationPlans();
      } else {
        document.getElementById('implementation-intentions-section').style.display = 'none';
      }
    };
    
    // Auto-select first category
    if (category.value === (type === 'quit' ? 'smoking' : 'exercise')) {
      btn.style.borderColor = type === 'quit' ? 'var(--danger)' : 'var(--green-from)';
      btn.style.background = type === 'quit' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
      appState.newHabitCategory = category.value;
      
      if (type === 'quit') {
        document.getElementById('implementation-intentions-section').style.display = 'block';
        renderImplementationPlans();
      }
    }
    
    grid.appendChild(btn);
  });
}

// NEW: Implementation Plans Functions
function renderImplementationPlans() {
  const container = document.getElementById('implementation-plans-container');
  container.innerHTML = '';
  
  // Add default plans based on habit type
  const defaultPlans = ImplementationIntentions.getCommonTriggers().slice(0, 2);
  
  defaultPlans.forEach(trigger => {
    const responses = ImplementationIntentions.suggestResponses(
      trigger.toLowerCase().includes('stress') ? 'stress' :
      trigger.toLowerCase().includes('bored') ? 'boredom' : 'stress'
    );
    
    addPlanItem(trigger, responses[0]);
  });
}

function addNewPlanItem() {
  const triggers = ImplementationIntentions.getCommonTriggers();
  const randomTrigger = triggers[Math.floor(Math.random() * triggers.length)];
  const responses = ImplementationIntentions.suggestResponses('stress');
  const randomResponse = responses[Math.floor(Math.random() * responses.length)];
  
  addPlanItem(randomTrigger, randomResponse);
}

function addPlanItem(trigger, response) {
  const container = document.getElementById('implementation-plans-container');
  const planItem = document.createElement('div');
  planItem.className = 'plan-item';
  planItem.innerHTML = `
    <div style="flex:1">
      <div class="plan-trigger">${trigger}</div>
      <div class="plan-response">${response}</div>
    </div>
    <button class="btn btn-ghost" onclick="removePlanItem(this)" aria-label="Remove plan">üóëÔ∏è</button>
  `;
  container.appendChild(planItem);
}

function removePlanItem(button) {
  button.parentElement.remove();
}

function closeAddModal() {
  const modal = document.getElementById('add-modal');
  modal.classList.remove('show');
  modal.querySelector('.modal').classList.remove('show');
  setTimeout(() => modal.style.display = 'none', 300);
}

async function confirmAddHabit() {
  const name = document.getElementById('add-name').value.trim();
  if (!name) {
    showNotification('Please enter a habit name');
    return;
  }
  
  if (!appState.newHabitCategory) {
    showNotification('Please select a category');
    return;
  }
  
  // NEW: Form validation
  const errors = validateHabitForm(name, appState.newHabitCategory);
  if (errors.length > 0) {
    showNotification(errors[0]);
    return;
  }
  
  try {
    setLoading(document.getElementById('confirm-add'), true);
    
    const habitData = {
      user_id: appState.session.user.id,
      name: name,
      type: appState.habitModalType,
      category: appState.newHabitCategory,
      icon: HABIT_ICONS[appState.newHabitCategory] || '‚≠ê',
      start_date: appState.habitModalType === 'quit' ? new Date().toISOString() : null,
      daily_goal: appState.habitModalType === 'build' ? 1 : null,
      goal_unit: appState.habitModalType === 'build' ? 'times' : null,
      current_streak: 0,
      best_streak: 0,
      total_completions: 0,
      total_relapses: 0
    };
    
    const { data, error } = await safeSupabaseOperation(
      () => supabase.from('habits').insert([habitData]).select().single(),
      'Error adding habit'
    );
    
    if (!data) return;
    
    appState.habits[appState.habitModalType].unshift(data);
    updateHabitCounts();
    renderDashboard();
    closeAddModal();
    showNotification(`"${name}" added! ${appState.habitModalType === 'quit' ? 'üéØ' : 'üí™'}`);
    
    // Award XP for adding habit
    await awardXP(10, 'habit_creation', `Created habit: ${name}`);
    
    // NEW: Check for badges
    await checkAndAwardBadges();
    
  } catch (error) {
    console.error('Error adding habit:', error);
    showNotification('Error adding habit');
  } finally {
    setLoading(document.getElementById('confirm-add'), false);
  }
}

async function completeHabit(habitId) {
  try {
    const today = new Date().toISOString().split('T')[0];
    
    // Record completion
    if (supabase) {
      const { error: completionError } = await supabase
        .from('habit_completions')
        .insert([
          {
            habit_id: habitId,
            user_id: appState.session.user.id,
            completed_date: today,
            completed_count: 1
          }
        ]);
      
      if (completionError) {
        console.warn('Completions table might not exist:', completionError);
        // Continue without error - this is a demo feature
      }
    }
    
    // Update habit stats
    const habit = appState.habits.build.find(h => h.id === habitId);
    const newStreak = (habit.current_streak || 0) + 1;
    const newBestStreak = Math.max(habit.best_streak || 0, newStreak);
    const newCompletions = (habit.total_completions || 0) + 1;
    
    if (supabase) {
      const { error: habitError } = await supabase
        .from('habits')
        .update({
          current_streak: newStreak,
          best_streak: newBestStreak,
          total_completions: newCompletions
        })
        .eq('id', habitId);
      
      if (habitError) {
        console.warn('Error updating habit:', habitError);
        // Update local state only
        habit.current_streak = newStreak;
        habit.best_streak = newBestStreak;
        habit.total_completions = newCompletions;
      }
    } else {
      // Update local state only
      habit.current_streak = newStreak;
      habit.best_streak = newBestStreak;
      habit.total_completions = newCompletions;
    }
    
    renderDashboard();
    showNotification('‚úÖ Habit completed! Great job!');
    
    // NEW: Celebrate milestones
    if (newStreak === 7 || newStreak === 30) {
      MicroInteractions.celebrateMilestone(`streak_${newStreak}`);
    }
    
    // Award XP
    await awardXP(5, 'habit_completion', 'Completed a habit');
    
    // NEW: Check for badges
    await checkAndAwardBadges();
    
  } catch (error) {
    console.error('Error completing habit:', error);
    showNotification('Error completing habit');
  }
}

async function deleteHabit(habitId, type) {
  if (!confirm('Are you sure you want to delete this habit?')) return;
  
  try {
    if (supabase) {
      const { error } = await supabase
        .from('habits')
        .update({ is_active: false })
        .eq('id', habitId);
      
      if (error) {
        console.warn('Error deleting habit:', error);
        // Remove from local state anyway
      }
    }
    
    appState.habits[type] = appState.habits[type].filter(h => h.id !== habitId);
    updateHabitCounts();
    renderDashboard();
    showNotification('Habit deleted');
  } catch (error) {
    console.error('Error deleting habit:', error);
    showNotification('Error deleting habit');
  }
}

// ===== 10/10 ENHANCED FEATURES =====

// NEW: Risk Assessment
async function renderRiskAssessment() {
  const container = document.getElementById('risk-assessment-container');
  if (!container) return;
  
  try {
    // Get recent data for analysis
    let recentCompletions = [];
    let recentRelapses = [];
    
    if (supabase) {
      const { data: completionsData } = await supabase
        .from('habit_completions')
        .select('*')
        .eq('user_id', appState.session.user.id)
        .gte('completed_date', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
      
      const { data: relapsesData } = await supabase
        .from('habit_relapses')
        .select('*')
        .eq('user_id', appState.session.user.id)
        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());
      
      recentCompletions = completionsData || [];
      recentRelapses = relapsesData || [];
    }
    
    // Calculate risk level
    const riskLevel = HabitInsights.predictRisk(
      appState.habits.quit, 
      [], // mood data would go here
      0   // stress level would go here
    );
    
    // Generate insights
    const insights = HabitInsights.generateInsights(
      [...appState.habits.quit, ...appState.habits.build],
      recentCompletions,
      recentRelapses
    );
    
    let riskClass = 'low-risk';
    if (riskLevel > 70) riskClass = 'high-risk';
    else if (riskLevel > 30) riskClass = 'medium-risk';
    
    container.innerHTML = `
      <div class="insight-card ${riskClass}">
        <h3 style="margin-bottom:1rem">üìä Today's Risk Assessment</h3>
        <div class="risk-meter">
          <div class="risk-fill" style="width: ${riskLevel}%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:1rem">
          <span class="small">Low Risk</span>
          <span class="small">High Risk</span>
        </div>
        <p>Based on your patterns, today's risk level is <strong>${Math.round(riskLevel)}%</strong></p>
        
        ${riskLevel > 70 ? `
          <div class="recommendation">
            <strong>üí° Recommendation:</strong> Be extra vigilant today. Use the emergency button if needed and schedule a breathing session.
          </div>
        ` : riskLevel > 30 ? `
          <div class="recommendation">
            <strong>üí° Recommendation:</strong> Stay mindful of your triggers today. You've got this!
          </div>
        ` : `
          <div class="recommendation">
            <strong>üí° Recommendation:</strong> Great job maintaining your habits! Keep up the consistency.
          </div>
        `}
        
        ${insights.length > 0 ? `
          <div style="margin-top:1rem">
            <h4 style="margin-bottom:0.5rem">üìà Insights</h4>
            ${insights.slice(0, 2).map(insight => `
              <div style="padding:0.75rem;background:rgba(255,255,255,0.1);border-radius:8px;margin-bottom:0.5rem">
                <strong>${insight.emoji || 'üí°'} ${insight.title}</strong>
                <div class="small" style="margin-top:0.25rem">${insight.message}</div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
    
  } catch (error) {
    console.error('Error rendering risk assessment:', error);
    container.innerHTML = `
      <div class="insight-card">
        <h3 style="margin-bottom:1rem">üìä Risk Assessment</h3>
        <p>Risk assessment will be available after you track some habits.</p>
      </div>
    `;
  }
}

// NEW: Enhanced streak visualization
function renderStreakVisualization(habit) {
  const streak = habit.current_streak || 0;
  const bestStreak = habit.best_streak || 0;
  const maxDots = Math.max(7, bestStreak);
  
  return `
    <div class="streak-visualization" style="margin: 1rem 0;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span class="small muted">üî• ${streak} day streak</span>
        <span class="small muted">üèÜ Best: ${bestStreak}</span>
      </div>
      <div class="streak-dots">
        ${Array.from({length: maxDots}, (_, i) => `
          <div class="streak-dot ${i < streak ? 'active' : i < bestStreak ? 'previous' : 'future'}"></div>
        `).join('')}
      </div>
      ${streak >= 7 ? `
        <div style="text-align: center; margin-top: 0.5rem;">
          <span class="achievement-badge" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
            üèÖ ${Math.floor(streak / 7)} week${Math.floor(streak / 7) > 1 ? 's' : ''}
          </span>
        </div>
      ` : ''}
    </div>
  `;
}

// NEW: Real-time timer updates
function startTimerUpdates() {
  setInterval(() => {
    const habits = appState.habits.quit;
    habits.forEach(habit => {
      const timerElement = document.querySelector(`[data-habit-id="${habit.id}"] .time-clean`);
      if (timerElement) {
        timerElement.textContent = calculateTimeClean(habit.start_date);
      }
    });
  }, 1000);
}

// ===== 10/10 RENDERING =====
function renderDashboard() {
  renderQuitList();
  renderBuildList();
}

function renderQuitList() {
  const container = document.getElementById('quit-list');
  if (!container) return;
  
  if (appState.habits.quit.length === 0) {
    container.innerHTML = `
      <div class="card" style="padding:2.5rem;text-align:center">
        <div class="empty-state-icon">‚ùå</div>
        <p class="muted" style="font-size:1.125rem">No quit habits yet</p>
        <button id="add-quit-empty" class="btn btn-danger" style="margin-top:1rem">+ Add Your First Quit Habit</button>
      </div>
    `;
    document.getElementById('add-quit-empty').addEventListener('click', () => openAddModal('quit'));
    return;
  }
  
  container.innerHTML = appState.habits.quit.map(habit => `
    <div class="habit-card" data-habit-id="${habit.id}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem">
        <div style="display:flex;gap:0.75rem;align-items:center">
          <div style="font-size:3rem">${habit.icon}</div>
          <div>
            <div class="heading" style="font-size:1.25rem">${habit.name}</div>
            <div class="small muted" style="margin-top:0.25rem">Since ${new Date(habit.start_date).toLocaleDateString()}</div>
          </div>
        </div>
        <button onclick="deleteHabit('${habit.id}', 'quit')" class="btn btn-ghost" style="padding:0.5rem" aria-label="Delete habit">üóëÔ∏è</button>
      </div>

      <div class="green-panel" style="margin-bottom:1.25rem">
        <div class="small" style="font-weight:600;margin-bottom:0.75rem">Clean for</div>
        <div class="time-display" style="margin-bottom:1rem">
          ${calculateTimeClean(habit.start_date)}
        </div>
        <div class="small" style="opacity:0.8">Days:Hours:Minutes:Seconds</div>
      </div>

      ${renderStreakVisualization(habit)}

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem">
        <div class="stat-box" style="background:linear-gradient(135deg,#fef3c7,#fde68a)">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üèÜ</div>
          <div class="heading" style="font-size:1.5rem">${habit.best_streak || 0}</div>
          <div class="small muted">Best streak</div>
        </div>
        <div class="stat-box" style="background:linear-gradient(135deg,#fecaca,#fca5a5)">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üîÑ</div>
          <div class="heading" style="font-size:1.5rem">${habit.total_relapses || 0}</div>
          <div class="small muted">Relapses</div>
        </div>
      </div>

      <button onclick="openEmergencyModal(${JSON.stringify(habit).replace(/"/g, '&quot;')})" class="btn btn-danger btn-wide" style="margin-bottom:1rem">
        <span style="font-size:1.125rem">üö®</span> Emergency Urge
      </button>
    </div>
  `).join('');
}

function renderBuildList() {
  const container = document.getElementById('build-list');
  if (!container) return;
  
  if (appState.habits.build.length === 0) {
    container.innerHTML = `
      <div class="card" style="padding:2.5rem;text-align:center">
        <div class="empty-state-icon">‚úÖ</div>
        <p class="muted" style="font-size:1.125rem">No build habits yet</p>
        <button id="add-build-empty" class="btn btn-success" style="margin-top:1rem">+ Add Your First Build Habit</button>
      </div>
    `;
    document.getElementById('add-build-empty').addEventListener('click', () => openAddModal('build'));
    return;
  }
  
  container.innerHTML = appState.habits.build.map(habit => `
    <div class="habit-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem">
        <div style="display:flex;gap:0.75rem;align-items:center">
          <div style="font-size:3rem">${habit.icon}</div>
          <div>
            <div class="heading" style="font-size:1.25rem">${habit.name}</div>
            <div class="small muted" style="margin-top:0.25rem">
              Goal: ${habit.daily_goal} ${habit.goal_unit}/day ‚Ä¢ ${habit.current_streak || 0} day streak
            </div>
          </div>
        </div>
        <button onclick="deleteHabit('${habit.id}', 'build')" class="btn btn-ghost" style="padding:0.5rem" aria-label="Delete habit">üóëÔ∏è</button>
      </div>

      <div style="margin-bottom:1.25rem">
        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
          <span class="small muted" style="font-weight:600">Today</span>
          <span class="heading" style="font-size:1.125rem">0/${habit.daily_goal} ${habit.goal_unit}</span>
        </div>
        <div style="height:1rem;border-radius:999px;background:var(--border);overflow:hidden">
          <div style="height:100%;background:linear-gradient(90deg,var(--green-from),var(--green-to));width:0%;transition:width 0.3s"></div>
        </div>
      </div>

      ${renderStreakVisualization(habit)}

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem">
        <div class="stat-box" style="background:linear-gradient(135deg,#fed7aa,#fdba74)">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üî•</div>
          <div class="heading" style="font-size:1.5rem">${habit.current_streak || 0}</div>
          <div class="small muted">Current streak</div>
        </div>
        <div class="stat-box" style="background:linear-gradient(135deg,#fef3c7,#fde68a)">
          <div style="font-size:1.5rem;margin-bottom:0.25rem">üèÜ</div>
          <div class="heading" style="font-size:1.5rem">${habit.best_streak || 0}</div>
          <div class="small muted">Best streak</div>
        </div>
      </div>

      <button onclick="completeHabit('${habit.id}')" class="btn btn-success btn-wide">‚úÖ Check In</button>
    </div>
  `).join('');
}

// ===== 10/10 AI COACH =====
async function handleChatSend() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Add user message
  addChatMessage('user', message);
  input.value = '';
  
  // Show typing indicator
  const typingIndicator = document.createElement('div');
  typingIndicator.className = 'chat-message assistant';
  typingIndicator.innerHTML = `
    <div class="chat-avatar">ü§ñ</div>
    <div class="chat-bubble">
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  `;
  document.getElementById('chat-messages').appendChild(typingIndicator);
  document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
  
  try {
    // Use the enhanced SmartCoach
    const response = await smartCoach.getPersonalizedResponse(message);
    
    // Remove typing indicator
    typingIndicator.remove();
    
    // Add AI response
    addChatMessage('assistant', response);
    
  } catch (error) {
    typingIndicator.remove();
    addChatMessage('assistant', "I'm having trouble responding right now. Please try again later.");
  }
}

function addChatMessage(role, content) {
  const messagesContainer = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${role}`;
  messageDiv.innerHTML = `
    <div class="chat-avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
    <div class="chat-bubble">${content}</div>
  `;
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ===== 10/10 ENHANCED ANALYTICS =====
function renderEnhancedAnalytics() {
  // Update KPI numbers
  document.getElementById('total-habits').textContent = appState.habits.quit.length + appState.habits.build.length;
  document.getElementById('analytics-quit-count').textContent = appState.habits.quit.length;
  document.getElementById('analytics-build-count').textContent = appState.habits.build.length;
  document.getElementById('current-streak').textContent = appState.profile.streak || 0;
  
  // NEW: Render predictive analytics
  renderPredictiveAnalyticsSection();
  
  // Render enhanced charts
  const period = parseInt(document.getElementById('analytics-period').value) || 30;
  renderEnhancedCharts(period);
}

// NEW: Predictive Analytics Section
function renderPredictiveAnalyticsSection() {
  const container = document.getElementById('predictive-analytics-container');
  if (!container) return;
  
  const riskLevel = HabitInsights.predictRisk(appState.habits.quit);
  const insights = HabitInsights.generateInsights(
    [...appState.habits.quit, ...appState.habits.build],
    [],
    []
  );
  
  container.innerHTML = `
    <div style="margin-bottom: 1.5rem;">
      <h3 class="heading" style="margin-bottom:1rem">üß† Predictive Insights</h3>
      
      <div class="cols">
        <div class="card" style="padding:1.5rem;">
          <h4 style="margin-bottom:0.5rem">üìä Success Probability</h4>
          <div style="font-size:2rem;font-weight:800;color:var(--accent-from);text-align:center;margin:1rem 0">
            ${Math.max(0, 100 - riskLevel)}%
          </div>
          <p class="small muted" style="text-align:center">
            Likelihood of maintaining your streak this week
          </p>
        </div>
        
        <div class="card" style="padding:1.5rem;">
          <h4 style="margin-bottom:0.5rem">üéØ Recommended Focus</h4>
          <div style="font-size:1.5rem;text-align:center;margin:1rem 0">
            ${riskLevel > 70 ? 'üõ°Ô∏è Defense' : riskLevel > 30 ? '‚öñÔ∏è Balance' : 'üöÄ Growth'}
          </div>
          <p class="small muted" style="text-align:center">
            ${riskLevel > 70 ? 'Focus on protecting your streak' : riskLevel > 30 ? 'Maintain current momentum' : 'Time to level up your habits'}
          </p>
        </div>
      </div>
      
      ${insights.length > 0 ? `
        <div style="margin-top:1.5rem">
          <h4 style="margin-bottom:1rem">üí° Actionable Insights</h4>
          <div class="cols">
            ${insights.slice(0, 2).map(insight => `
              <div class="card" style="padding:1.5rem;">
                <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
                  <span style="font-size:1.5rem">${insight.type === 'positive' ? '‚úÖ' : insight.type === 'warning' ? '‚ö†Ô∏è' : 'üí°'}</span>
                  <strong>${insight.title}</strong>
                </div>
                <p class="small">${insight.message}</p>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

// ===== 10/10 XP & BADGE SYSTEM =====
async function awardXP(amount, type, description) {
  if (!appState.profile) return;
  
  try {
    // Update profile
    const newXP = appState.profile.xp + amount;
    const newLevel = Math.floor(newXP / 100) + 1;
    const leveledUp = newLevel > appState.profile.level;
    
    if (supabase) {
      const { error } = await supabase
        .from('profiles')
        .update({
          xp: newXP,
          level: newLevel,
          streak: appState.profile.streak + 1,
          best_streak: Math.max(appState.profile.best_streak, appState.profile.streak + 1)
        })
        .eq('id', appState.session.user.id);
      
      if (error) {
        console.warn('Error updating profile:', error);
        // Update local state only
        appState.profile.xp = newXP;
        appState.profile.level = newLevel;
        appState.profile.streak += 1;
        appState.profile.best_streak = Math.max(appState.profile.best_streak, appState.profile.streak);
      }
      
      // Log XP transaction
      await supabase
        .from('xp_transactions')
        .insert([
          {
            user_id: appState.session.user.id,
            amount: amount,
            type: type,
            description: description
          }
        ]);
    } else {
      // Update local state only
      appState.profile.xp = newXP;
      appState.profile.level = newLevel;
      appState.profile.streak += 1;
      appState.profile.best_streak = Math.max(appState.profile.best_streak, appState.profile.streak);
    }
    
    updateXPDisplay();
    
    if (leveledUp) {
      MicroInteractions.celebrateMilestone('level_up');
      showNotification(`üéâ Level Up! You're now level ${newLevel}`, 5000);
    }
    
  } catch (error) {
    console.error('Error awarding XP:', error);
  }
}

// NEW: Enhanced badge system
async function checkAndAwardBadges() {
  if (!appState.profile) return;
  
  const badgesToAward = [];
  
  // Check streak badges
  if (appState.profile.streak >= 7 && !appState.awardedBadges?.includes('streak_7')) {
    badgesToAward.push('streak_7');
  }
  if (appState.profile.streak >= 30 && !appState.awardedBadges?.includes('streak_30')) {
    badgesToAward.push('streak_30');
  }
  if (appState.profile.streak >= 90 && !appState.awardedBadges?.includes('streak_90')) {
    badgesToAward.push('streak_90');
  }
  
  // Check habit master badge
  const totalHabits = appState.habits.quit.length + appState.habits.build.length;
  if (totalHabits >= 5 && !appState.awardedBadges?.includes('habit_master')) {
    badgesToAward.push('habit_master');
  }
  
  // Award new badges
  for (const badgeId of badgesToAward) {
    await awardBadge(badgeId);
  }
}

async function awardBadge(badgeId) {
  const badge = BADGES[badgeId];
  if (!badge) return;
  
  try {
    if (supabase) {
      const { error } = await supabase
        .from('user_badges')
        .insert([
          {
            user_id: appState.session.user.id,
            badge_id: badgeId,
            awarded_at: new Date().toISOString()
          }
        ]);
      
      if (error) {
        console.warn('Error awarding badge:', error);
        // Award locally anyway for demo
      }
    }
    
    // Update local state
    if (!appState.awardedBadges) appState.awardedBadges = [];
    appState.awardedBadges.push(badgeId);
    
    // Award XP
    await awardXP(badge.xp, 'badge_award', `Earned badge: ${badge.name}`);
    
    // Enhanced celebration
    MicroInteractions.celebrateMilestone('habit_complete');
    showNotification(`üéâ New Badge: ${badge.icon} ${badge.name}! +${badge.xp} XP`, 5000);
    
    // Re-render badges if on achievements page
    if (appState.currentPage === 'achievements') {
      renderBadges();
    }
  } catch (error) {
    console.error('Error awarding badge:', error);
  }
}

function renderBadges() {
  const container = document.getElementById('badges-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  Object.entries(BADGES).forEach(([badgeId, badge]) => {
    const isUnlocked = appState.awardedBadges?.includes(badgeId);
    
    const badgeCard = document.createElement('div');
    badgeCard.className = `badge-card ${isUnlocked ? 'unlocked' : 'locked'}`;
    
    badgeCard.innerHTML = `
      <div class="badge-icon">${badge.icon}</div>
      <h4 style="margin-bottom:0.5rem">${badge.name}</h4>
      <p class="small muted" style="margin-bottom:0.5rem">${badge.description}</p>
      <div class="small" style="color: ${isUnlocked ? 'var(--gold)' : 'var(--muted)'}; font-weight: 600;">
        ${isUnlocked ? '‚úÖ Unlocked' : 'üîí Locked'}
      </div>
      ${isUnlocked ? `<div class="small" style="margin-top:0.25rem">+${badge.xp} XP</div>` : ''}
    `;
    
    container.appendChild(badgeCard);
  });
}

// ===== EMERGENCY SYSTEM (Enhanced) =====
function openEmergencyModal(habit) {
  appState.selectedHabit = habit;
  const overlay = document.getElementById('emergency-overlay');
  overlay.classList.add('show');
  
  startCoachTyping();
  startCamera();
}

function closeEmergencyModal() {
  const overlay = document.getElementById('emergency-overlay');
  overlay.classList.remove('show');
  stopCamera();
}

// NEW: Simplified coach messages
function startCoachTyping() {
  const coachText = document.getElementById('coach-text');
  coachText.innerHTML = '';
  
  let currentIndex = 0;
  let charIndex = 0;
  let currentText = '';
  
  function type() {
    if (currentIndex < COACH_LINES.length) {
      const targetText = COACH_LINES[currentIndex];
      
      if (charIndex < targetText.length) {
        currentText += targetText[charIndex];
        coachText.textContent = currentText;
        charIndex++;
        setTimeout(type, 50);
      } else {
        setTimeout(() => {
          currentText = '';
          charIndex = 0;
          currentIndex = (currentIndex + 1) % COACH_LINES.length;
          type();
        }, 4000); // Longer delay between messages
      }
    }
  }
  
  type();
}

// NEW: Improved camera error handling
async function startCamera() {
  try {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      throw new Error('Camera not supported in this browser');
    }
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'user' }, 
      audio: false 
    });
    
    emergencyStream = stream;
    const video = document.getElementById('emergency-video');
    video.srcObject = stream;
    video.style.display = 'block';
    document.getElementById('camera-fallback').style.display = 'none';
    
  } catch (error) {
    console.error('Camera error:', error);
    document.getElementById('emergency-video').style.display = 'none';
    document.getElementById('camera-fallback').style.display = 'flex';
    document.getElementById('camera-fallback').textContent = 'Camera not available - Focus on your breathing instead';
  }
}

function stopCamera() {
  if (emergencyStream) {
    emergencyStream.getTracks().forEach(track => track.stop());
    emergencyStream = null;
  }
}

async function handleEmergencySuccess() {
  closeEmergencyModal();
  showNotification('Well done ‚Äì you stayed strong! üí™');
  await awardXP(15, 'emergency_success', 'Resisted an urge');
  await checkAndAwardBadges();
}

async function handleEmergencyRelapse() {
  if (appState.selectedHabit) {
    try {
      if (supabase) {
        const { error: relapseError } = await supabase
          .from('habit_relapses')
          .insert([
            {
              habit_id: appState.selectedHabit.id,
              user_id: appState.session.user.id,
              trigger_description: 'Used emergency button',
              emotions: 'Urge overcame resistance',
              learned: 'Need stronger coping strategies',
              severity: 5
            }
          ]);
        
        if (relapseError) {
          console.warn('Error logging relapse:', relapseError);
        }
        
        // Update habit stats
        const habit = appState.habits.quit.find(h => h.id === appState.selectedHabit.id);
        const newRelapses = (habit.total_relapses || 0) + 1;
        
        const { error: habitError } = await supabase
          .from('habits')
          .update({
            total_relapses: newRelapses,
            current_streak: 0
          })
          .eq('id', appState.selectedHabit.id);
        
        if (habitError) {
          console.warn('Error updating habit after relapse:', habitError);
          // Update local state
          habit.total_relapses = newRelapses;
          habit.current_streak = 0;
        }
      }
      
    } catch (error) {
      console.error('Error logging relapse:', error);
    }
  }
  
  closeEmergencyModal();
  openRelapseModal(appState.selectedHabit);
}

// NEW: Enhanced relapse modal functions
function openRelapseModal(habit) {
  if (!habit) return;
  
  const relapseEmoji = document.getElementById('relapse-emoji');
  const relapseName = document.getElementById('relapse-name');
  const relapseSince = document.getElementById('relapse-since');
  
  if (relapseEmoji) relapseEmoji.textContent = habit.icon;
  if (relapseName) relapseName.textContent = habit.name;
  
  // Calculate days clean for display
  const daysClean = calculateDaysClean(habit.start_date);
  if (relapseSince) relapseSince.textContent = `You were clean for ${daysClean} day${daysClean !== 1 ? 's' : ''}`;
  
  const modal = document.getElementById('relapse-modal');
  if (modal) {
    modal.style.display = 'flex';
    setTimeout(() => {
      modal.classList.add('show');
      modal.querySelector('.modal').classList.add('show');
    }, 10);
  }
}

function closeRelapseModal() {
  const modal = document.getElementById('relapse-modal');
  if (!modal) return;
  
  modal.classList.remove('show');
  modal.querySelector('.modal').classList.remove('show');
  
  setTimeout(() => {
    modal.style.display = 'none';
  }, 300);
}

async function confirmRelapse() {
  const relapseNote = document.getElementById('relapse-note');
  const note = relapseNote ? relapseNote.value.trim() || 'No note provided' : 'No note provided';
  const habit = appState.selectedHabit;
  
  if (!habit) return;

  try {
    if (supabase) {
      const { error: relapseError } = await supabase
        .from('habit_relapses')
        .insert([
          {
            habit_id: habit.id,
            user_id: appState.session.user.id,
            trigger_description: note,
            emotions: 'Urge overcame resistance',
            learned: 'Will try different strategies next time',
            severity: 5
          }
        ]);
      
      if (relapseError) {
        console.warn('Error confirming relapse:', relapseError);
      }
      
      // Update habit stats
      const { error: habitError } = await supabase
        .from('habits')
        .update({
          total_relapses: (habit.total_relapses || 0) + 1,
          current_streak: 0,
          start_date: new Date().toISOString()
        })
        .eq('id', habit.id);
      
      if (habitError) {
        console.warn('Error updating habit after relapse:', habitError);
        // Update local state
        habit.total_relapses = (habit.total_relapses || 0) + 1;
        habit.current_streak = 0;
        habit.start_date = new Date().toISOString();
      }
    } else {
      // Update local state only
      habit.total_relapses = (habit.total_relapses || 0) + 1;
      habit.current_streak = 0;
      habit.start_date = new Date().toISOString();
    }
    
    closeRelapseModal();
    showNotification('Logged. Tomorrow is new! üí™');
    renderDashboard();
    
  } catch (error) {
    console.error('Error confirming relapse:', error);
    showNotification('Error logging relapse');
  }
}

// Helper function to calculate days clean
function calculateDaysClean(startDate) {
  if (!startDate) return 0;
  const start = new Date(startDate);
  const now = new Date();
  const diff = now - start;
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}

// ===== OTHER ENHANCED FEATURES =====

// Breathing Exercise (Enhanced)
function initBreathingExercise() {
  const startBtn = document.getElementById('breath-start-button');
  const stopBtn = document.getElementById('breath-stop-button');
  const modeSelect = document.getElementById('mode-selector');
  const circle = document.getElementById('breathingCircle');
  const statusText = document.getElementById('breath-status-text');
  const timerText = document.getElementById('breath-timer-text');

  if (!startBtn || !stopBtn) return;

  function animate(time) {
    if (!breathRunning) return;
    if (!breathStartTime) breathStartTime = time;
    const elapsed = time - breathStartTime;
    
    const key = modeSelect ? modeSelect.value : 'coherence';
    const currentConfig = BREATH_CONFIG[key] || BREATH_CONFIG.coherence;
    
    const IN = currentConfig.inhale * 1000;
    const HI = currentConfig.holdIn * 1000;
    const EX = currentConfig.exhale * 1000;
    const HO = currentConfig.holdOut * 1000;
    const cycleMs = IN + HI + EX + HO;
    const pos = elapsed % cycleMs;

    let phase = 'INHALE ‚¨ÜÔ∏è', scale = 0.3, timeLeft = 0;

    if (pos < IN) {
      phase = 'INHALE ‚¨ÜÔ∏è';
      scale = 0.3 + 0.7 * (pos / IN);
      timeLeft = Math.ceil((IN - pos) / 1000);
    } else if (pos < IN + HI) {
      phase = 'HOLD ‚è∏';
      scale = 1.0;
      timeLeft = Math.ceil((IN + HI - pos) / 1000);
    } else if (pos < IN + HI + EX) {
      phase = 'EXHALE ‚¨áÔ∏è';
      scale = 1.0 - 0.7 * ((pos - IN - HI) / EX);
      timeLeft = Math.ceil((IN + HI + EX - pos) / 1000);
    } else {
      phase = 'HOLD ‚è∏';
      scale = 0.3;
      timeLeft = Math.ceil((cycleMs - pos) / 1000);
    }

    if (circle) circle.style.transform = `scale(${scale})`;
    if (statusText) statusText.textContent = phase;
    if (timerText) timerText.textContent = `${timeLeft}s`;

    breathAnimationId = requestAnimationFrame(animate);
  }

  function startSession() {
    if (breathRunning) stopSession();
    if (startBtn) startBtn.style.display = 'none';
    if (stopBtn) stopBtn.style.display = '';
    breathRunning = true;
    breathStartTime = 0;
    breathAnimationId = requestAnimationFrame(animate);
    
    // Add glowing effect
    const circle = document.getElementById('breathingCircle');
    if (circle) circle.classList.add('glowing');
  }

  function stopSession() {
    breathRunning = false;
    if (breathAnimationId) {
      cancelAnimationFrame(breathAnimationId);
      breathAnimationId = null;
    }
    const circle = document.getElementById('breathingCircle');
    if (circle) {
      circle.style.transform = 'scale(0.3)';
      circle.classList.remove('glowing');
    }
    if (statusText) statusText.textContent = 'Ready';
    if (timerText) timerText.textContent = 'Select a Mode';
    if (stopBtn) stopBtn.style.display = 'none';
    if (startBtn) startBtn.style.display = '';
  }

  if (startBtn) startBtn.addEventListener('click', startSession);
  if (stopBtn) stopBtn.addEventListener('click', stopSession);
}

// Challenges
function renderChallenges() {
  const container = document.getElementById('challenges-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  Object.values(CHALLENGE_PACKS).forEach(challenge => {
    const card = document.createElement('div');
    card.className = 'challenge-card';
    
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem">
        <div>
          <h3 class="heading" style="font-size:1.25rem;margin-bottom:0.5rem">${challenge.name}</h3>
          <p class="small muted">${challenge.description}</p>
        </div>
      </div>
      
      <div class="challenge-progress">
        <div class="challenge-progress-bar" style="width:0%"></div>
      </div>
      
      <div style="margin-top:1rem;display:flex;gap:0.5rem">
        <button class="btn btn-primary btn-wide" onclick="startChallenge('${challenge.id}')">
          üöÄ Start Challenge
        </button>
      </div>
    `;
    
    container.appendChild(card);
  });
}

function startChallenge(challengeId) {
  const challenge = CHALLENGE_PACKS[challengeId];
  showNotification(`Starting ${challenge.name}! Good luck! üéØ`);
  // Challenge implementation would go here
}

// NEW: Enhanced Educational Content
function renderEducationalContent() {
  const educationContainer = document.getElementById('education-content');
  const storiesContainer = document.getElementById('success-stories');
  
  if (educationContainer) {
    educationContainer.innerHTML = EDUCATIONAL_CONTENT.habit_formation.map(article => `
      <div class="education-card">
        <h4 style="margin-bottom:0.5rem">${article.title}</h4>
        <p class="small muted">${article.content}</p>
        <span class="duration-badge">${article.duration}</span>
      </div>
    `).join('');
  }
  
  if (storiesContainer) {
    storiesContainer.innerHTML = EDUCATIONAL_CONTENT.success_stories.map(story => `
      <div class="story-card">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
          <div style="font-size:2rem">${story.avatar}</div>
          <div>
            <div class="heading">${story.name}</div>
            <div class="small muted">${story.duration}</div>
          </div>
        </div>
        <p>"${story.story}"</p>
      </div>
    `).join('');
  }
}

// Leaderboard
async function loadLeaderboard() {
  const container = document.getElementById('leaderboard-cards');
  if (!container) return;
  
  try {
    // Get top users from Supabase
    let profiles = [];
    
    if (supabase) {
      const { data, error } = await supabase
        .from('profiles')
        .select('id, email, xp, level, streak')
        .order('xp', { ascending: false })
        .limit(10);
      
      if (error) {
        throw new Error('Leaderboard data not available');
      }
      
      profiles = data || [];
    } else {
      throw new Error('Supabase not configured');
    }
    
    let html = '';
    profiles.forEach((user, index) => {
      const emoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
      const username = user.email.split('@')[0];
      
      html += `
        <div class="card" style="padding:1rem; border-radius:12px; border:1px solid var(--border);">
          <div style="display:flex;align-items:center;gap:0.75rem">
            <div style="font-size:1.75rem">${emoji}</div>
            <div style="flex:1">
              <div style="font-weight:800; font-size:1rem">${username}</div>
              <div class="small muted" style="margin-top:0.25rem">Streak: ${user.streak} ‚Ä¢ Level: ${user.level}</div>
            </div>
            <div style="text-align:right;min-width:60px">
              <div style="font-weight:900;font-size:1.25rem">${user.xp}</div>
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading leaderboard:', error);
    // Fallback to sample data
    const leaderboardData = [
      { username: 'Alice', xp: 1250, streak: 14, level: 13 },
      { username: 'Bob', xp: 980, streak: 7, level: 10 },
      { username: 'Charlie', xp: 750, streak: 21, level: 8 },
      { username: 'Diana', xp: 620, streak: 3, level: 7 },
      { username: 'Eve', xp: 540, streak: 30, level: 6 }
    ];
    
    let html = '';
    leaderboardData.forEach((user, index) => {
      const emoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
      html += `
        <div class="card" style="padding:1rem; border-radius:12px; border:1px solid var(--border);">
          <div style="display:flex;align-items:center;gap:0.75rem">
            <div style="font-size:1.75rem">${emoji}</div>
            <div style="flex:1">
              <div style="font-weight:800; font-size:1rem">${user.username}</div>
              <div class="small muted" style="margin-top:0.25rem">Streak: ${user.streak} ‚Ä¢ Level: ${user.level}</div>
            </div>
            <div style="text-align:right;min-width:60px">
              <div style="font-weight:900;font-size:1.25rem">${user.xp}</div>
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }
}

// Data Backup & Restore
async function exportData() {
  try {
    // Get all user data
    const habits = [...appState.habits.quit, ...appState.habits.build];
    const profile = appState.profile;
    
    const data = {
      habits,
      profile,
      exportedAt: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `undo-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showNotification('Data exported successfully!');
    
  } catch (error) {
    console.error('Error exporting data:', error);
    showNotification('Error exporting data');
  }
}

async function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (confirm('This will replace your current data. Continue?')) {
        // Import habits
        if (data.habits && supabase) {
          for (const habit of data.habits) {
            const { error } = await supabase
              .from('habits')
              .upsert({
                ...habit,
                user_id: appState.session.user.id
              });
            
            if (error) {
              console.warn('Error importing habit:', error);
            }
          }
        }
        
        // Import profile
        if (data.profile && supabase) {
          const { error } = await supabase
            .from('profiles')
            .update(data.profile)
            .eq('id', appState.session.user.id);
          
          if (error) {
            console.warn('Error importing profile:', error);
          }
        }
        
        // Reload data
        await loadUserData();
        showNotification('Data imported successfully!');
      }
    } catch (error) {
      console.error('Error importing data:', error);
      showNotification('Error importing data: ' + error.message);
    }
  };
  reader.readAsText(file);
}

async function clearAllData() {
  if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
    try {
      // Delete all habits
      if (supabase) {
        const { error: habitsError } = await supabase
          .from('habits')
          .delete()
          .eq('user_id', appState.session.user.id);
        
        if (habitsError) {
          console.warn('Error clearing habits:', habitsError);
        }
        
        // Reset profile
        const { error: profileError } = await supabase
          .from('profiles')
          .update({
            xp: 0,
            level: 1,
            streak: 0,
            best_streak: 0
          })
          .eq('id', appState.session.user.id);
        
        if (profileError) {
          console.warn('Error resetting profile:', profileError);
        }
      }
      
      // Clear local state
      appState.habits = { quit: [], build: [] };
      appState.profile.xp = 0;
      appState.profile.level = 1;
      appState.profile.streak = 0;
      appState.profile.best_streak = 0;
      appState.awardedBadges = [];
      
      renderDashboard();
      updateXPDisplay();
      showNotification('All data cleared!');
      
    } catch (error) {
      console.error('Error clearing data:', error);
      showNotification('Error clearing data');
    }
  }
}

// ===== CHART FUNCTIONS (Placeholder) =====
async function renderEnhancedCharts(period = 30) {
  // In a real app, you'd fetch actual data from Supabase
  // For now, we'll use sample data
  const completionData = await fetchCompletionData(period);
  const distributionData = await fetchDistributionData();
  const weeklyData = await fetchWeeklyData(period);
  const successData = await fetchSuccessRateData(period);
  
  renderCompletionChart(completionData);
  renderDistributionChart(distributionData);
  renderWeeklyChart(weeklyData);
  renderSuccessChart(successData);
}

async function fetchCompletionData(days) {
  // Sample data - replace with actual Supabase query
  return {
    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
    datasets: [{
      label: 'Habit Completions',
      data: [3, 5, 2, 6, 4, 7, 5],
      borderColor: '#7c3aed',
      backgroundColor: 'rgba(124, 58, 237, 0.1)',
      tension: 0.4,
      fill: true
    }]
  };
}

async function fetchDistributionData() {
  const habitTypes = [...new Set([...appState.habits.quit, ...appState.habits.build].map(h => h.category))];
  const habitCounts = habitTypes.map(type => 
    [...appState.habits.quit, ...appState.habits.build].filter(h => h.category === type).length
  );
  
  return {
    labels: habitTypes,
    datasets: [{
      data: habitCounts,
      backgroundColor: [
        '#7c3aed', '#ec4899', '#10b981', '#f59e0b', '#3b82f6',
        '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
      ]
    }]
  };
}

async function fetchWeeklyData(period) {
  // Sample weekly data
  return {
    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
    datasets: [
      {
        label: 'Quit Habits',
        data: [5, 7, 6, 8],
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        tension: 0.4,
        fill: true
      },
      {
        label: 'Build Habits',
        data: [3, 5, 7, 9],
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        tension: 0.4,
        fill: true
      }
    ]
  };
}

async function fetchSuccessRateData(period) {
  // Sample success rate data
  return {
    labels: ['Quit Habits', 'Build Habits', 'Overall'],
    datasets: [{
      label: 'Success Rate (%)',
      data: [75, 85, 80],
      backgroundColor: [
        'rgba(239, 68, 68, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(124, 58, 237, 0.8)'
      ],
      borderColor: [
        '#ef4444',
        '#10b981',
        '#7c3aed'
      ],
      borderWidth: 2
    }]
  };
}

function renderCompletionChart(data) {
  const canvas = document.getElementById('completion-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Destroy existing chart if it exists
  if (window.completionChart) {
    window.completionChart.destroy();
  }
  
  try {
    window.completionChart = new Chart(ctx, {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0,0,0,0.1)'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error rendering completion chart:', error);
  }
}

function renderDistributionChart(data) {
  const canvas = document.getElementById('distribution-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  if (window.distributionChart) {
    window.distributionChart.destroy();
  }
  
  try {
    window.distributionChart = new Chart(ctx, {
      type: 'doughnut',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  } catch (error) {
    console.error('Error rendering distribution chart:', error);
  }
}

function renderWeeklyChart(data) {
  const canvas = document.getElementById('weekly-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  if (window.weeklyChart) {
    window.weeklyChart.destroy();
  }
  
  try {
    window.weeklyChart = new Chart(ctx, {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0,0,0,0.1)'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error rendering weekly chart:', error);
  }
}

function renderSuccessChart(data) {
  const canvas = document.getElementById('success-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  if (window.successChart) {
    window.successChart.destroy();
  }
  
  try {
    window.successChart = new Chart(ctx, {
      type: 'bar',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: {
              color: 'rgba(0,0,0,0.1)'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error rendering success chart:', error);
  }
}

// NEW: Friend functions placeholder
function startFriendChallenge() {
  showNotification('Friend challenge features coming soon! üë•');
}

function loadFriends() {
  // Placeholder for friend loading
  console.log('Loading friends...');
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  // NEW: Custom habit input handling
  document.addEventListener('change', function(e) {
    if (e.target.id === 'quit-habit') {
      const customContainer = document.getElementById('quit-custom-container');
      if (customContainer) {
        customContainer.style.display = e.target.value === 'other' ? 'block' : 'none';
      }
    } else if (e.target.id === 'build-habit') {
      const customContainer = document.getElementById('build-custom-container');
      if (customContainer) {
        customContainer.style.display = e.target.value === 'other' ? 'block' : 'none';
      }
    }
  });

  // Auth event listeners
  document.getElementById('btn-new-user').addEventListener('click', () => {
    showAuthPage('onboarding');
    renderOnboardingStep();
  });

  document.getElementById('btn-existing-user').addEventListener('click', () => {
    showAuthPage('login');
  });

  document.getElementById('btn-onboarding-next').addEventListener('click', nextOnboardingStep);

  document.getElementById('btn-onboarding-back').addEventListener('click', () => {
    if (authState.onboardingStep > 0) {
      authState.onboardingStep--;
      renderOnboardingStep();
    }
  });

  document.getElementById('btn-login').addEventListener('click', handleLogin);
  
  // Check for existing session
  if (supabase) {
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) {
        appState.session = session;
        switchToMainApp();
      }
    });

    // Listen for auth changes
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        appState.session = session;
        switchToMainApp();
      } else if (event === 'SIGNED_OUT') {
        document.getElementById('main-app-container').style.display = 'none';
        document.getElementById('auth-app').style.display = 'block';
        showAuthPage('welcome-screen');
      }
    });
  } else {
    console.warn('Supabase not configured. Authentication features disabled.');
  }
});

// Make functions available globally for onclick handlers
window.openAddModal = openAddModal;
window.closeAddModal = closeAddModal;
window.addHabit = confirmAddHabit;
window.completeHabit = completeHabit;
window.deleteHabit = deleteHabit;
window.openEmergencyModal = openEmergencyModal;
window.handleEmergencySuccess = handleEmergencySuccess;
window.handleEmergencyRelapse = handleEmergencyRelapse;
window.showMainPage = showMainPage;
window.toggleDarkMode = toggleDarkMode;
window.startChallenge = startChallenge;
window.startFriendChallenge = startFriendChallenge;
window.addNewPlanItem = addNewPlanItem;
window.removePlanItem = removePlanItem;

console.log('üéâ UNDO 10/10 App loaded successfully!');
</script>
</body>
</html>
