name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: openrouter
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Debug - Check files
      run: |
        echo "ğŸ“ Current directory structure:"
        ls -la
        echo "ğŸ“„ Checking if index.html exists:"
        if [ -f "index.html" ]; then
          echo "âœ… index.html exists"
          echo "ğŸ“Š File size: $(wc -l < index.html) lines"
          echo "ğŸ” Checking for placeholders:"
          grep -o "{{.*}}" index.html | head -5
        else
          echo "âŒ index.html not found!"
          exit 1
        fi

    - name: Build and Replace Secrets
      run: |
        echo "ğŸ”„ Starting secret replacement..."
        
        # Store secrets in variables
        SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
        SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
        OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}"
        
        # Debug: Check if secrets are available (without showing full values)
        echo "ğŸ” SUPABASE_URL available: ${#SUPABASE_URL} characters"
        echo "ğŸ” SUPABASE_ANON_KEY available: ${#SUPABASE_ANON_KEY} characters"
        echo "ğŸ” OPENROUTER_API_KEY available: ${#OPENROUTER_API_KEY} characters"
        
        # Create a backup
        cp index.html index.html.backup
        
        # Replace each placeholder one by one with proper escaping
        echo "ğŸ”„ Replacing SUPABASE_URL..."
        sed -i "s|{{SUPABASE_URL}}|$(echo "$SUPABASE_URL" | sed 's/[[\.*^$()+?{|]/\\&/g')|g" index.html
        
        echo "ğŸ”„ Replacing SUPABASE_ANON_KEY..."
        sed -i "s|{{SUPABASE_ANON_KEY}}|$(echo "$SUPABASE_ANON_KEY" | sed 's/[[\.*^$()+?{|]/\\&/g')|g" index.html
        
        echo "ğŸ”„ Replacing OPENROUTER_API_KEY..."
        sed -i "s|{{OPENROUTER_API_KEY}}|$(echo "$OPENROUTER_API_KEY" | sed 's/[[\.*^$()+?{|]/\\&/g')|g" index.html
        
        echo "âœ… Replacement completed"

    - name: Verify Replacements
      run: |
        echo "ğŸ” Verifying placeholder replacement..."
        
        # Check if any placeholders remain
        if grep -q "{{" index.html; then
          echo "âŒ ERROR: Some placeholders were not replaced:"
          grep -o "{{.*}}" index.html
          echo "ğŸ“‹ Showing first 10 lines with placeholders:"
          grep -n "{{" index.html | head -10
          exit 1
        else
          echo "âœ… SUCCESS: All placeholders replaced successfully!"
          echo "ğŸ“„ Sample of processed file:"
          grep -A 2 -B 2 "const SUPABASE_URL" index.html || echo "âš ï¸  Could not find config section"
        fi

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        keep_files: false
