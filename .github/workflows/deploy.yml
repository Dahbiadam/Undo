name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: openrouter
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build and Replace Secrets
      run: |
        # Create a temporary file for processing
        cp index.html index.temp.html
        
        # Replace each placeholder individually
        SUPABASE_URL="${{ secrets.SUPABASE_URL }}" && \
        SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}" && \
        OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" && \
        
        # Use a more robust replacement method
        sed -i "s|{{SUPABASE_URL}}|$SUPABASE_URL|g" index.temp.html
        sed -i "s|{{SUPABASE_ANON_KEY}}|$SUPABASE_ANON_KEY|g" index.temp.html  
        sed -i "s|{{OPENROUTER_API_KEY}}|$OPENROUTER_API_KEY|g" index.temp.html
        
        # Move the processed file back
        mv index.temp.html index.html
        
        # Verify replacements worked
        if grep -q "{{" index.html; then
          echo "❌ ERROR: Some placeholders were not replaced:"
          grep "{{" index.html
          exit 1
        else
          echo "✅ SUCCESS: All placeholders replaced successfully"
          echo "✅ Environment: openrouter"
        fi

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
